<!DOCTYPE html>
<!-- signature.html - Build 2025-11-26 (fix new commission display on ISC) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication — Review & Sign</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.font-cursive{font-family:'Brush Script MT',cursive}</style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="text-xs hover:underline" style="color:#4DA6FF;">Home</a>
      <div class="text-center">
        <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      </div>
      <a href="/advertise.html" class="text-xs hover:underline" style="color:#4DA6FF;">Advertise</a>
    </div>
  </header>

  <div class="max-w-3xl mx-auto mt-4 bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold text-center mb-6">Irrevocable Seller Communication</h2>

    <!-- Friendly invalid message -->
    <div id="invalidBox" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-900 mb-4">
      <p class="font-semibold">Listing not available</p>
      <p class="text-sm mt-1">This page requires a valid listing (id not found).</p>
      <div class="mt-3">
        <a href="/index.html#strip2Search" class="inline-block px-4 py-2 rounded bg-blue-600 text-white">Go back to Home</a>
      </div>
    </div>

    <!-- Sign UI -->
    <div id="signWrap" class="hidden">
      <div id="iscText" class="text-sm leading-relaxed whitespace-pre-line">
        Loading ISC...
      </div>

      <div class="mt-6">
        <label class="block mb-2 text-sm font-semibold">Electronic Signature:</label>
        <input
          type="text"
          id="signature"
          placeholder="Type your full name here"
          class="font-cursive w-full border p-2 rounded"
          required
          aria-describedby="sigHelp"
        >
        <p id="sigHelp" class="text-xs mt-2 text-gray-600 hidden"></p>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-semibold">Date:</label>
        <p id="date" class="text-sm"></p>
      </div>

      <div class="flex justify-between mt-6">
        <a id="viewPrintable" href="/printable-isc.html" class="bg-gray-600 text-white px-4 py-2 rounded">
          Sign / View
        </a>
        <button id="btnContinue" class="bg-green-600 text-white px-6 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Sign / Continue
        </button>
      </div>

      <p id="sigSaved" class="hidden text-green-700 font-semibold mt-3">Signature saved.</p>
    </div>
  </div>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) || fb; } catch(e) { return fb; } };

    // Resolve listing id: prefer ?id=, else localStorage.lastListingId
    const params = new URLSearchParams(location.search);
    const listingId = (params.get('id') || localStorage.getItem('lastListingId') || "").trim();
    if (!listingId) {
      $("invalidBox").classList.remove("hidden");
      throw new Error("Missing listing id");
    }

    // If an AGENT somehow reaches this page, send them back to the agent page for this listing
    (function guardAgent(){
      try {
        const role = (localStorage.getItem('userRole') || '').trim();
        if (role === 'listing_agent' || role === 'buyers_agent') {
          location.replace('/agent-detail.html?id=' + encodeURIComponent(listingId));
        }
      } catch {}
    })();

    // Always point printable to the same id
    (function linkPrintable(){
      const a = $("viewPrintable");
      if (a) a.href = `/printable-isc.html?id=${encodeURIComponent(listingId)}`;
    })();

    // Simple ISC builder - NOW accepts optional commission override for commission changes
    function buildIscTextFromDoc(d, overrideCommission, overrideCommissionType) {
      const addressFull = (d.address || "").trim();
      const short = addressFull.split(",")[0] || "[short address]";
      const apn = (d.apn || "[APN]");
      const name = (d.ownerName || "[name]");
      const plan = (d.plan || "");
      const isFSBO = plan.includes("FSBO");

      // Use override if provided (for commission changes), otherwise use existing
      const commissionType = overrideCommissionType || d.commissionType || "%";
      const cVal = overrideCommission || d.commission || "";
      
      const commissionDisplay = commissionType === "$"
        ? (cVal ? ("$" + Number(cVal).toLocaleString()) : "[commission]")
        : (cVal ? (cVal + "%") : "[commission]");
      const suffix = commissionType === "%" ? " of the total purchase price" : "";

      if (isFSBO) {
        const phone = d.ownerPhone || d.agentPhone || "[owner/seller phone]";
        const email = d.ownerEmail || "[owner/seller email]";
        return `To the escrow holder/closing agent,

I, ${name}, am the owner/seller of ${addressFull}${apn?`, # ${apn}`:""}. ${short} is listed for sale by owner (Me). My phone number is ${phone}. My email address is ${email}.

Let it be known: if a buyer's agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer's broker a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      } else {
        const brokerage  = d.brokerage  || "[listing brokerage]";
        const agentName  = d.agentName  || "[listing agent]";
        const phone      = d.agentPhone || "[agent phone]";
        const email      = d.agentEmail || "[agent email]";
        return `To the escrow holder/closing agent,

I, ${name}, am the owner/seller of ${addressFull}${apn?`, # ${apn}`:""}. ${short} is listed for sale by ${brokerage}, ${agentName}, listing agent, ${phone}, ${email}.

Let it be known: if a buyer's agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer's broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      }
    }

    (async function boot(){
      $("date").textContent = todayISO();

      let d = null;
      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (snap.exists()) d = snap.data();
      } catch (e) {
        console.warn("[signature] Firestore fetch failed", e);
      }

      if (!d) { $("invalidBox").classList.remove("hidden"); return; }

      // Check if this is a commission change - use new commission for ISC
      const checkoutData = getJSON("checkoutData", {});
      const isCommissionChange = !!(checkoutData.meta && checkoutData.meta.fromChangeCommission);
      const newCommission = (checkoutData.meta && checkoutData.meta.newCommission) || null;
      const newCommissionType = (checkoutData.meta && checkoutData.meta.newCommissionType) || null;
      
      console.log("[signature] isCommissionChange:", isCommissionChange);
      console.log("[signature] newCommission:", newCommission, "newCommissionType:", newCommissionType);

      // Paint ISC with NEW commission if this is a commission change
      if (isCommissionChange && newCommission) {
        $("iscText").textContent = buildIscTextFromDoc(d, newCommission, newCommissionType);
      } else {
        $("iscText").textContent = buildIscTextFromDoc(d);
      }
      
      $("signWrap").classList.remove("hidden");

      // Expected seller name (from Firestore)
      const expected = (d.ownerName || "").trim();

      // Pre-fill the signature input with expected name (still enforces exact match)
      const sigInput = $("signature");
      const btn = $("btnContinue");
      const help = $("sigHelp");
      if (expected) {
        sigInput.value = expected; // prefill
      }

      function check() {
        const typed = (sigInput.value || "").trim();
        const ok = expected && typed && typed.toLowerCase() === expected.toLowerCase();
        btn.disabled = !ok;

        if (!expected) {
          help.textContent = "We couldn't find the seller name on this listing. Please go back and enter your name in the communication form.";
          help.className = "text-xs mt-2 text-red-600";
          help.classList.remove('hidden');
          return;
        }
        if (!typed) {
          help.textContent = `Please type your full name exactly as entered: "${expected}".`;
          help.className = "text-xs mt-2 text-gray-600";
        } else if (!ok) {
          help.textContent = `Signature must match the seller name exactly: "${expected}".`;
          help.className = "text-xs mt-2 text-red-600";
        } else {
          help.textContent = "Signature looks good.";
          help.className = "text-xs mt-2 text-green-600";
        }
        help.classList.remove('hidden');
      }
      sigInput.addEventListener('input', check);
      sigInput.addEventListener('blur', check);
      check();

      // Save signature to Firestore, set status:"Active", and ensure ownerEmail for listed flows
      $("btnContinue").addEventListener("click", async () => {
        const typed = (sigInput.value || "").trim();
        if (!typed) return;

        const isFSBO = (d.plan || "").includes("FSBO");
        const loggedIn = (localStorage.getItem("loggedInEmail") || "").trim().toLowerCase();

        try {
          const updates = {
            signedISC: { name: typed, date: todayISO(), ts: serverTimestamp() },
            status: "Active",
            updatedAt: serverTimestamp()
          };
          if (!isFSBO && loggedIn) {
            updates.ownerEmail = loggedIn;
          }

          await updateDoc(doc(db, "listings", listingId), updates);
          $("sigSaved").classList.remove("hidden");

          // Check if this is a commission change - update the commission in Firestore
          if (isCommissionChange && newCommission) {
            try {
              // Build new history entry
              const newHistoryEntry = {
                commission: newCommission,
                commissionType: newCommissionType || "%",
                date: todayISO(),
                label: "Changed"
              };
              
              // Get existing history
              const existingHistory = d.commissionHistory || [];
              
              // Update Firestore with new commission
              await updateDoc(doc(db, "listings", listingId), {
                commission: newCommission,
                commissionType: newCommissionType || "%",
                commissionHistory: [...existingHistory, newHistoryEntry],
                commissionChangeUsed: true,
                updatedAt: serverTimestamp()
              });
              
              console.log("[signature] Commission changed successfully to:", newCommission, newCommissionType);
              
              // Clear the commission change flags from checkoutData
              const updatedCheckoutData = getJSON("checkoutData", {});
              if (updatedCheckoutData.meta) {
                delete updatedCheckoutData.meta.newCommission;
                delete updatedCheckoutData.meta.newCommissionType;
                delete updatedCheckoutData.meta.fromChangeCommission;
              }
              if (updatedCheckoutData.upgrades) {
                updatedCheckoutData.upgrades.changeCommission = false;
              }
              localStorage.setItem("checkoutData", JSON.stringify(updatedCheckoutData));
              
            } catch (err) {
              console.error("[signature] Failed to update commission:", err);
              alert("Signature saved, but commission update failed. Please contact support.");
            }
          }

        } catch (e) {
          console.warn("[signature] save failed; continuing local-only:", e);
        }

        // For commission changes, go back to seller-detail; otherwise continue normal flow
        if (isCommissionChange) {
          window.location.href = "/seller-detail.html?id=" + encodeURIComponent(listingId);
        } else {
          // Continue to intake / invite path
          window.location.href = isFSBO
            ? "/seller-detail.html?id=" + encodeURIComponent(listingId)
            : "/agent-invite.html?id=" + encodeURIComponent(listingId);
        }
      });
    })();
  </script>

  <script type="module">
    // Paid Upgrades Handler - runs after Stripe redirects user back
    (async function handlePaidUpgradesAfterPayment() {
      try {
        console.log("[paid-upgrades] Checking for payment success...");
        
        // Check if this is a return from Stripe (has session_id in URL)
        const url = new URL(window.location.href);
        const sessionId = url.searchParams.get("session_id");
        
        if (!sessionId) {
          console.log("[paid-upgrades] No session_id found, skipping");
          return;
        }

        const listingId = (localStorage.getItem("lastListingId") || "").trim();
        if (!listingId) {
          console.warn("[paid-upgrades] No listingId found");
          return;
        }

        // Get checkout data
        const getJSON = (k, fb) => { 
          try { return JSON.parse(localStorage.getItem(k)) ?? fb; } 
          catch { return fb; } 
        };
        const checkoutData = getJSON("checkoutData", {});
        
        if (!checkoutData || !checkoutData.upgrades) {
          console.warn("[paid-upgrades] No checkout data found");
          return;
        }

        // Check if we've already processed this payment
        const processingKey = `payment_processed:${sessionId}`;
        if (localStorage.getItem(processingKey)) {
          console.log("[paid-upgrades] Already processed, skipping");
          return;
        }

        // Import Firestore
        const { db } = await import("/scripts/firebase-init.js");
        if (!db) {
          console.warn("[paid-upgrades] Firestore not available");
          return;
        }
        
        const { doc, getDoc, updateDoc, serverTimestamp } = 
          await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

        // Get current listing data
        const listingRef = doc(db, "listings", listingId);
        const listingSnap = await getDoc(listingRef);
        
        if (!listingSnap.exists()) {
          console.warn("[paid-upgrades] Listing not found:", listingId);
          return;
        }

        const currentData = listingSnap.data();
        const currentPaidUpgrades = currentData.paidUpgrades || {};

        // Build paidUpgrades object (merge with existing)
        const paidUpgrades = {
          banner: !!checkoutData.upgrades?.banner || !!currentPaidUpgrades.banner,
          premium: !!checkoutData.upgrades?.premium || !!checkoutData.upgrades?.pin || !!currentPaidUpgrades.premium,
          pin: !!checkoutData.upgrades?.pin || !!currentPaidUpgrades.pin,
          confidential: !!checkoutData.upgrades?.confidential || !!currentPaidUpgrades.confidential
        };

        // Prepare update
        const updateData = {
          paidUpgrades,
          updatedAt: serverTimestamp()
        };

        // Check if plan should be upgraded
        const isFSBOPlan = (p) => typeof p === "string" && p.includes("FSBO");
        const upgraded = (checkoutData?.plan || "").includes("Listed Property Plus")
                      || checkoutData?.upgrades?.upgradeToPlus
                      || checkoutData?.upgrades?.banner
                      || checkoutData?.upgrades?.premium
                      || checkoutData?.upgrades?.pin;

        if (upgraded && !isFSBOPlan(checkoutData.plan)) {
          updateData.plan = "Listed Property Plus";
        }

        // Update Firestore
        await updateDoc(listingRef, updateData);
        
        // Mark as processed
        localStorage.setItem(processingKey, "true");
        
        console.log("[paid-upgrades] ✅ Updated:", paidUpgrades);
        if (updateData.plan) console.log("[paid-upgrades] ✅ Plan:", updateData.plan);

      } catch (e) {
        console.error("[paid-upgrades] Error:", e);
      }
    })();
  </script>

</body>
</html>
