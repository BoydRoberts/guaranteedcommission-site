<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication — Review & Sign</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.font-cursive{font-family:'Brush Script MT',cursive}</style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-center mb-6">Irrevocable Seller Communication</h1>

    <!-- Friendly invalid message -->
    <div id="invalidBox" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-yellow-900 mb-4">
      <p class="font-semibold">Listing not available</p>
      <p class="text-sm mt-1">This page requires a valid listing (id not found).</p>
      <div class="mt-3">
        <a href="/index.html" class="inline-block px-4 py-2 rounded bg-blue-600 text-white">Go back to Home</a>
      </div>
    </div>

    <!-- Agent (or non-seller) blocked -->
    <div id="roleBlocked" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-800 mb-4">
      <p class="font-semibold">Only the seller may sign</p>
      <p class="text-sm mt-1">Please have the seller log in to sign the Irrevocable Seller Communication.</p>
      <div class="mt-3 flex gap-2">
        <a id="goAgentDetail" href="#" class="px-4 py-2 rounded bg-gray-700 text-white">Go to Agent Page</a>
        <a href="/login.html?tab=signin" class="px-4 py-2 rounded border">Seller Sign In</a>
      </div>
    </div>

    <!-- Already signed -->
    <div id="alreadySigned" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 text-green-800 mb-4">
      <p class="font-semibold">This listing has already been signed.</p>
      <p class="text-sm mt-1">You can view/print the signed document below.</p>
    </div>

    <!-- Sign UI -->
    <div id="signWrap" class="hidden">
      <div id="iscText" class="text-sm leading-relaxed whitespace-pre-line">
        Loading ISC...
      </div>

      <div class="mt-6">
        <label class="block mb-2 text-sm font-semibold">Electronic Signature (seller):</label>
        <input
          type="text"
          id="signature"
          placeholder="Type your full legal name here"
          class="font-cursive w-full border p-2 rounded"
          required
          aria-describedby="sigHelp"
        >
        <p id="sigHelp" class="text-xs mt-2 text-gray-600 hidden"></p>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-semibold">Signing Date:</label>
        <p id="date" class="text-sm"></p>
      </div>

      <div class="flex justify-between mt-6">
        <a id="viewPrintable" href="#" class="bg-gray-600 text-white px-4 py-2 rounded" target="_blank" rel="noopener">
          View Printable
        </a>
        <button id="btnContinue" class="bg-green-600 text-white px-6 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          Sign / Continue
        </button>
      </div>

      <p id="sigSaved" class="hidden text-green-700 font-semibold mt-3">Signature saved.</p>
    </div>
  </div>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);

    // Resolve listing id
    const params = new URLSearchParams(location.search);
    let listingId = (params.get('id') || localStorage.getItem('lastListingId') || "").trim();
    if (!listingId) {
      $("invalidBox").classList.remove("hidden");
      throw new Error("Missing listing id");
    }

    // Wire links
    $("goAgentDetail").href = "/agent-detail.html?id=" + encodeURIComponent(listingId);
    $("viewPrintable").href = "/printable-isc.html?id=" + encodeURIComponent(listingId);

    // Helpers
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    $("date").textContent = todayISO();

    // Only the SELLER can sign:
    // - Role must be "seller" OR (no role set) BUT loggedInEmail must match ownerEmail once loaded.
    function canSellerSign(docData) {
      const role = (localStorage.getItem('userRole') || '').trim();
      const who  = (localStorage.getItem('loggedInEmail') || '').trim().toLowerCase();
      const ownerEmail = (docData.ownerEmail || '').trim().toLowerCase();
      if (role === 'listing_agent' || role === 'buyers_agent') return false;
      if (!who) return false;
      // If ownerEmail recorded, it must match current user
      if (ownerEmail) return who === ownerEmail;
      // If not recorded yet, allow and we will set it on sign
      return true;
    }

    function buildIscTextFromDoc(d) {
      const addressFull = (d.address || "").trim();
      const short = addressFull.split(",")[0] || "[short address]";
      const apn = (d.apn || "");
      const name = (d.ownerName || "[name]");
      const plan = (d.plan || "");
      const isFSBO = plan.includes("FSBO");

      const commissionType = d.commissionType || "%";
      const cVal = (d.commission || "");
      const commissionDisplay = commissionType === "$"
        ? (cVal ? ("$" + Number(cVal).toLocaleString()) : "[commission]")
        : (cVal ? (cVal + "%") : "[commission]");
      const suffix = commissionType === "%" ? " of the total purchase price" : "";

      if (isFSBO) {
        const phone = d.agentPhone || "[owner/seller phone]";
        const email = d.ownerEmail || "[owner/seller email]";
        return `To the escrow holder/closing agent,

I, ${name}, am the owner/seller of ${addressFull}${apn?`, # ${apn}`:""}. ${short} is listed for sale by owner (Me). My phone number is ${phone}. My email address is ${email}.

Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      } else {
        const brokerage  = d.brokerage  || "[listing brokerage]";
        const agentName  = d.agentName  || "[listing agent]";
        const phone      = d.agentPhone || "[agent phone]";
        const email      = d.agentEmail || "[agent email]";
        return `To the escrow holder/closing agent,

I, ${name}, am the owner/seller of ${addressFull}${apn?`, # ${apn}`:""}. ${short} is listed for sale by ${brokerage}, ${agentName}, listing agent, ${phone}, ${email}.

Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      }
    }

    (async function boot(){
      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) { $("invalidBox").classList.remove("hidden"); return; }
        const d = snap.data() || {};

        // If already signed, show the notice + printable link and stop
        if (d.signedISC && d.signedISC.name && d.signedISC.date) {
          $("alreadySigned").classList.remove("hidden");
          $("signWrap").classList.remove("hidden");
          $("iscText").textContent = buildIscTextFromDoc(d);
          // Lock inputs
          $("signature").value = d.signedISC.name;
          $("signature").setAttribute("disabled","disabled");
          $("date").textContent = d.signedISC.date;
          $("btnContinue").classList.add("hidden");
          return;
        }

        // Role check for seller-only signing
        if (!canSellerSign(d)) {
          $("roleBlocked").classList.remove("hidden");
          return;
        }

        // Pre-fill seller name
        const expected = (d.ownerName || "").trim();
        const sigInput = $("signature");
        const btn = $("btnContinue");
        const help = $("sigHelp");
        if (expected) sigInput.value = expected;

        function check() {
          const typed = (sigInput.value || "").trim();
          const ok = !!typed;
          btn.disabled = !ok;
          help.textContent = ok ? "Signature looks good." : "Please type your full legal name.";
          help.className = ok ? "text-xs mt-2 text-green-600" : "text-xs mt-2 text-red-600";
          help.classList.remove('hidden');
        }
        sigInput.addEventListener('input', check);
        sigInput.addEventListener('blur', check);
        check();

        // Build ISC preview text
        $("iscText").textContent = buildIscTextFromDoc({ ...d, ownerName: (sigInput.value || d.ownerName || "[name]") });

        // Save signature to Firestore & ensure ownerEmail is set for listed flows
        $("btnContinue").addEventListener("click", async () => {
          const typed = (sigInput.value || "").trim();
          if (!typed) return;

          const isFSBO = (d.plan || "").includes("FSBO");
          const loggedIn = (localStorage.getItem("loggedInEmail") || "").trim().toLowerCase();

          try {
            const updates = {
              ownerName: d.ownerName || typed, // ensure ownerName present
              signedISC: { name: typed, date: todayISO(), ts: serverTimestamp() },
              updatedAt: serverTimestamp()
            };
            // For listed flows, tie the listing to the seller email so Welcome can find it
            if (!isFSBO && loggedIn && !d.ownerEmail) {
              updates.ownerEmail = loggedIn;
            }

            await updateDoc(doc(db, "listings", listingId), updates);
            $("sigSaved").classList.remove('hidden');
          } catch (e) {
            console.warn("[signature] save failed", e);
            alert("Could not save signature. Please try again.");
            return;
          }

          // Continue to intake / invite path
          window.location.href = isFSBO ? "/seller-detail.html?id="+encodeURIComponent(listingId)
                                        : "/agent-invite.html?id="+encodeURIComponent(listingId);
        });
      } catch (e) {
        console.warn(e);
        $("invalidBox").classList.remove("hidden");
      }
    })();
  </script>
</body>
</html>
