<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication — Review & Sign</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.font-cursive{font-family:'Brush Script MT',cursive}</style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-center mb-6">Irrevocable Seller Communication</h1>

    <div id="iscText" class="text-sm leading-relaxed whitespace-pre-line">
      Loading ISC...
    </div>

    <div class="mt-6">
      <label class="block mb-2 text-sm font-semibold">Electronic Signature:</label>
      <input
        type="text"
        id="signature"
        placeholder="Type your full name here"
        class="font-cursive w-full border p-2 rounded"
        required
        aria-describedby="sigHelp"
      >
      <p id="sigHelp" class="text-xs mt-2 text-gray-600 hidden"></p>
    </div>

    <div class="mt-4">
      <label class="block text-sm font-semibold">Date:</label>
      <p id="date" class="text-sm"></p>
    </div>

    <div class="flex justify-between mt-6">
      <a id="viewPrintable" href="/printable-isc.html" class="bg-gray-600 text-white px-4 py-2 rounded">
        Sign / View
      </a>

      <button id="btnContinue" class="bg-green-600 text-white px-6 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        Sign / Continue
      </button>
    </div>
  </div>

  <script>
    // OPTIONAL guard: if a listing agent somehow lands here, bounce them
    if ((localStorage.getItem('userRole') || '') === 'listing_agent') {
      location.replace('/agent-detail.html');
    }

    function getJSON(k, fb){ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } }

    const url = new URL(location.href);
    const listingId = url.searchParams.get('id') || localStorage.getItem('lastListingId') || '';
    const FD_KEY = listingId ? `formData:${listingId}` : 'formData';
    const SIG_KEY = listingId ? `signedISC:${listingId}` : 'signedISC';

    document.getElementById("date").textContent = new Date().toLocaleDateString();

    const formData = getJSON(FD_KEY, getJSON('formData', {}));
    const planType = ((localStorage.getItem("postSignatureOptions") || (localStorage.getItem("selectedPlan")||"")).toLowerCase().includes("fsbo")) ? "fsbo" : "listed";

    // Link printable with same id
    (function linkPrintable(){
      const a = document.getElementById('viewPrintable');
      a.href = listingId ? `/printable-isc.html?id=${encodeURIComponent(listingId)}` : `/printable-isc.html`;
    })();

    (function fillISC() {
      const commissionType = formData.commissionType || "%";
      const commission = formData.commission || "";
      const fullAddress = formData.address || "";
      const shortAddress = fullAddress.split(",")[0] || "[short address]";
      const apn = formData.apn || "[APN]";
      const name = formData.name || "[name]";
      const agentPhone = formData.agentPhone || formData.phone || "[agent phone]";
      const brokerage = formData.brokerage || "[listing brokerage]";
      const agent = formData.agent || "[listing agent]";
      const agentEmail = formData.agentEmail || "[agent email]";
      const suffix = commissionType === "%" ? " of the total purchase price" : "";
      const commissionDisplay = commissionType === "$" ? `$${commission}` : `${commission}%`;

      let text = `To the escrow holder/closing agent,\n\n`;

      if (planType === "fsbo") {
        text += `I, ${name}, am the owner/seller of ${fullAddress}, #${apn}. ${shortAddress} is listed for sale by owner (Me). My phone number is ${agentPhone}. My email address is ${formData.fsboEmail || "[owner/seller email]"}.\n\n`;
        text += `Let it be known: if a buyer’s agent/broker facilitates the sale of ${shortAddress}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commissionDisplay}${suffix}.`;
      } else {
        text += `I, ${name}, am the owner/seller of ${fullAddress}, #${apn}. ${shortAddress} is listed for sale by ${brokerage}, ${agent}, listing agent, ${agentPhone}, ${agentEmail}.\n\n`;
        text += `Let it be known: if a buyer’s agent/broker facilitates the sale of ${shortAddress}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${suffix}.`;
      }

      document.getElementById("iscText").textContent = text;
    })();

    (function enforceSignatureMatch(){
      const sigInput = document.getElementById('signature');
      const btn = document.getElementById('btnContinue');
      const help = document.getElementById('sigHelp');

      const formData = getJSON(FD_KEY, getJSON('formData', {}));
      const expected = (formData && typeof formData.name === 'string') ? formData.name.trim() : '';

      function check() {
        const typed = (sigInput.value || '').trim();
        const ok = expected && typed && typed.toLowerCase() === expected.toLowerCase();

        btn.disabled = !ok;
        if (!expected) {
          help.textContent = "We couldn't find your Box-2 name. Please go back and enter your name in the communication form.";
          help.className = "text-xs mt-2 text-red-600";
          help.classList.remove('hidden');
          return;
        }

        if (!typed) {
          help.textContent = `Please type your full name exactly as entered: “${expected}”.`;
          help.className = "text-xs mt-2 text-gray-600";
        } else if (!ok) {
          help.textContent = `Signature must match Box-2 seller name exactly: “${expected}”.`;
          help.className = "text-xs mt-2 text-red-600";
        } else {
          help.textContent = "Signature looks good.";
          help.className = "text-xs mt-2 text-green-600";
        }
        help.classList.remove('hidden');
      }

      sigInput.addEventListener('input', check);
      sigInput.addEventListener('blur', check);
      check();

      btn.addEventListener('click', () => {
        const signature = (sigInput.value || '').trim();
        if (!signature) return;
        const payload = { name: signature, date: new Date().toISOString().slice(0,10) };
        localStorage.setItem(SIG_KEY, JSON.stringify(payload));   // per-listing signature

        const isFSBO = (localStorage.getItem("selectedPlan")||"").includes("FSBO");
        window.location.href = isFSBO ? "/seller-detail.html" : "/agent-invite.html";
      });
    })();
  </script>
</body>
</html>
