<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication — Review & Sign</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.font-cursive{font-family:'Brush Script MT',cursive}</style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-center mb-6">Irrevocable Seller Communication</h1>

    <div id="iscText" class="text-sm leading-relaxed whitespace-pre-line">
      Loading ISC...
    </div>

    <div class="mt-6">
      <label class="block mb-2 text-sm font-semibold">Electronic Signature:</label>
      <input type="text" id="signature" placeholder="Type your full name here" class="font-cursive w-full border p-2 rounded" required>
    </div>

    <div class="mt-4">
      <label class="block text-sm font-semibold">Date:</label>
      <p id="date" class="text-sm"></p>
    </div>

    <div class="flex justify-between mt-6">
      <!-- Renamed: View / Print ISC -> Sign / View -->
      <button onclick="window.location.href='/printable-isc.html'" class="bg-gray-600 text-white px-4 py-2 rounded">
        Sign / View
      </button>
      <!-- Removed Download PDF button per request -->
      <!-- Renamed: Continue -> Sign / Continue -->
      <button onclick="continueFlow()" class="bg-green-600 text-white px-6 py-2 rounded">
        Sign / Continue
      </button>
    </div>
  </div>

  <script>
    function fillISC() {
      const planType = (localStorage.getItem("postSignatureOptions") || (localStorage.getItem("selectedPlan")||"")).toLowerCase().includes("fsbo") ? "fsbo" : "listed";
      const data = JSON.parse(localStorage.getItem("formData") || "{}");
      const commissionType = data.commissionType || "%";
      const commission = data.commission || "";
      const fullAddress = data.address || "";
      const shortAddress = fullAddress.split(",")[0] || "[short address]";
      const apn = data.apn || "[Parcel # / Pin # / Tax ID # / Folio # / APN #]";
      const name = data.name || "[name]";
      const agentPhone = data.agentPhone || data.phone || "[agent phone]";
      const brokerage = data.brokerage || "[listing brokerage]";
      const agent = data.agent || "[listing agent]";
      const suffix = commissionType === "%" ? " of the total purchase price" : "";
      const commissionDisplay = commissionType === "$" ? `$${commission}` : `${commission}%`;

      let text = `To the escrow holder/closing agent,\n\n`;

      if (planType === "fsbo") {
        // FSBO text remains unchanged per your instructions (still includes parcel line as previously implemented)
        text += `I, ${name}, am the owner/seller of ${fullAddress}, #${apn}. ${shortAddress} is listed for sale by owner (Me). My phone number is ${agentPhone}. My email address is ${data.fsboEmail || "[owner/seller email]"}.\n\n`;
        text += `Let it be known: if a buyer’s agent/broker facilitates the sale of ${shortAddress}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commissionDisplay}${suffix}.`;
      } else {
        // BASIC/PLUS: remove the parcel/APN from the first sentence
        text += `I, ${name}, am the owner/seller of ${fullAddress}. ${shortAddress} is listed for sale by ${brochureSafe(brokerage)}, ${agent}, listing agent, ${agentPhone}.\n\n`;
        text += `Let it be known: if a buyer’s agent/broker facilitates the sale of ${shortAddress}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${suffix}.`;
      }

      document.getElementById("iscText").textContent = text;
    }

    // Ensure brokerage placeholder doesn’t print as [listing brokerage] with commas spacing weirdly
    function brochureSafe(str){ return str || "[listing brokerage]"; }

    function continueFlow() {
      const signature = document.getElementById("signature").value.trim();
      if (!signature) {
        alert("Please type your full name to sign the ISC.");
        return;
      }
      localStorage.setItem("signature", signature);
      window.location.href = (localStorage.getItem("selectedPlan")||"").includes("FSBO") ? "/seller-detail.html" : "/agent-invite.html";
    }

    document.getElementById("date").textContent = new Date().toLocaleDateString();
    window.addEventListener("DOMContentLoaded", fillISC);
  </script>
</body>
</html>
