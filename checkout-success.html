<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Successful | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 py-16">
    <div class="bg-white rounded-xl shadow-lg p-8 text-center">
      
      <!-- Success Icon -->
      <div id="iconContainer" class="mx-auto w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-6">
        <svg id="successIcon" class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <!-- Spinner (hidden by default) -->
        <svg id="spinnerIcon" class="hidden w-10 h-10 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>

      <!-- Status Text -->
      <h2 id="statusTitle" class="text-2xl font-bold text-gray-900 mb-2">Payment Successful!</h2>
      <p id="statusMessage" class="text-gray-600 mb-6">Activating your advertisement...</p>

      <!-- Details (shown after activation) -->
      <div id="activationDetails" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6 text-sm text-green-800">
        <p class="font-semibold">Your ad is now live!</p>
        <p class="mt-1">It will appear on listing pages in your selected ZIP codes.</p>
      </div>

      <!-- Error Details (shown on failure) -->
      <div id="errorDetails" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6 text-sm text-red-800">
        <p class="font-semibold">There was an issue activating your ad.</p>
        <p class="mt-1">Please contact support if this persists.</p>
      </div>

      <!-- Buttons -->
      <div class="space-y-3">
        <a href="/index.html" class="block w-full py-3 px-4 rounded-lg text-white font-semibold hover:opacity-90 transition" style="background-color:#4DA6FF;">
          Return to Home
        </a>
        <a href="/advertise.html" class="block w-full py-3 px-4 rounded-lg border border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition">
          View Advertising Options
        </a>
      </div>

    </div>
  </main>

  <!-- Firebase Script -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    // UI state helpers
    function showProcessing() {
      $("iconContainer").className = "mx-auto w-20 h-20 rounded-full bg-blue-100 flex items-center justify-center mb-6";
      $("successIcon").classList.add("hidden");
      $("spinnerIcon").classList.remove("hidden");
      $("statusTitle").textContent = "Processing...";
      $("statusMessage").textContent = "Activating your advertisement...";
    }

    function showSuccess(type) {
      $("iconContainer").className = "mx-auto w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-6";
      $("spinnerIcon").classList.add("hidden");
      $("successIcon").classList.remove("hidden");
      $("statusTitle").textContent = "Activation Successful!";
      $("statusMessage").textContent = `Your ${type} ad is now live.`;
      $("activationDetails").classList.remove("hidden");
      $("errorDetails").classList.add("hidden");
    }

    function showError(message) {
      $("iconContainer").className = "mx-auto w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mb-6";
      $("spinnerIcon").classList.add("hidden");
      $("successIcon").innerHTML = `
        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      `;
      $("statusTitle").textContent = "Activation Issue";
      $("statusMessage").textContent = message;
      $("errorDetails").classList.remove("hidden");
      $("activationDetails").classList.add("hidden");
    }

    function showAlreadyActive() {
      $("statusTitle").textContent = "Payment Successful!";
      $("statusMessage").textContent = "Thank you for your purchase.";
      $("activationDetails").classList.remove("hidden");
    }

    // Main activation logic
    async function activatePendingAds() {
      // Check for pending IDs in localStorage
      const pendingLocalProId = localStorage.getItem("pendingLocalProId");
      const pendingBrokerId = localStorage.getItem("pendingBrokerId");
      const pendingServiceProviderId = localStorage.getItem("pendingServiceProviderId");

      // If no pending IDs, show generic success
      if (!pendingLocalProId && !pendingBrokerId && !pendingServiceProviderId) {
        console.log("[checkout-success] No pending ads to activate");
        showAlreadyActive();
        return;
      }

      showProcessing();

      let activated = false;
      let adType = "";

      try {
        // Activate Local Professional
        if (pendingLocalProId) {
          console.log("[checkout-success] Activating Local Pro:", pendingLocalProId);
          await updateDoc(doc(db, "localPros", pendingLocalProId), {
            status: "active",
            activatedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          localStorage.removeItem("pendingLocalProId");
          localStorage.removeItem("pendingLocalProEmail");
          activated = true;
          adType = "Local Professional";
        }

        // Activate Broker
        if (pendingBrokerId) {
          console.log("[checkout-success] Activating Broker:", pendingBrokerId);
          await updateDoc(doc(db, "localBrokers", pendingBrokerId), {
            status: "active",
            activatedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          localStorage.removeItem("pendingBrokerId");
          localStorage.removeItem("pendingBrokerEmail");
          activated = true;
          adType = adType ? adType + " & Broker" : "Broker";
        }

        // Activate Service Provider
        if (pendingServiceProviderId) {
          console.log("[checkout-success] Activating Service Provider:", pendingServiceProviderId);
          await updateDoc(doc(db, "localServiceProviders", pendingServiceProviderId), {
            status: "active",
            activatedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          localStorage.removeItem("pendingServiceProviderId");
          localStorage.removeItem("pendingServiceProviderEmail");
          activated = true;
          adType = adType ? adType + " & Service Provider" : "Service Provider";
        }

        if (activated) {
          showSuccess(adType);
        } else {
          showAlreadyActive();
        }

      } catch (err) {
        console.error("[checkout-success] Activation failed:", err);
        showError("Could not activate your ad. Please contact support.");
      }
    }

    // Run on page load
    activatePendingAds();
  </script>
</body>
</html>
