<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment Successful | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 text-center">
      <div class="flex items-end justify-center gap-0">
        <img src="/Logo.png" alt="Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
      </div>
    </div>
  </header>

  <main class="flex-grow flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 text-center max-w-lg w-full">
      
      <div id="iconContainer" class="mx-auto w-20 h-20 rounded-full bg-blue-50 flex items-center justify-center mb-6">
        <svg id="spinnerIcon" class="w-10 h-10 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <svg id="successIcon" class="hidden w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <svg id="errorIcon" class="hidden w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </div>

      <h2 id="statusTitle" class="text-2xl font-bold text-gray-900 mb-2">Processing Payment...</h2>
      <p id="statusMessage" class="text-gray-600 mb-6">Please wait while we finalize your purchase.</p>

      <div id="actionButtons" class="hidden space-y-3">
        <a href="/index.html" class="block w-full py-3 px-4 rounded-lg text-white font-semibold hover:opacity-90 transition" style="background-color:#4DA6FF;">
          Return to Home
        </a>
      </div>

    </div>
  </main>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // Import the existing handler for Listing Upgrades
    import { updatePaidUpgradesAfterPayment } from "/scripts/paid-upgrades-handler.js";

    const $ = (id) => document.getElementById(id);

    // UI Helpers
    function setSuccess(title, msg) {
      $("spinnerIcon").classList.add("hidden");
      $("errorIcon").classList.add("hidden");
      $("successIcon").classList.remove("hidden");
      $("iconContainer").classList.replace("bg-blue-50", "bg-green-100");
      $("iconContainer").classList.replace("bg-red-100", "bg-green-100");
      
      $("statusTitle").textContent = title;
      $("statusMessage").textContent = msg;
      $("actionButtons").classList.remove("hidden");
    }

    function setError(msg) {
      $("spinnerIcon").classList.add("hidden");
      $("successIcon").classList.add("hidden");
      $("errorIcon").classList.remove("hidden");
      $("iconContainer").classList.replace("bg-blue-50", "bg-red-100");
      
      $("statusTitle").textContent = "Activation Issue";
      $("statusMessage").textContent = msg;
      $("actionButtons").classList.remove("hidden");
    }

    async function processCheckout() {
      // 1. Check for LISTING UPGRADES (Banner, Premium, Plus, etc.)
      // These are identified by having a 'session_id' in the URL (from Stripe Checkout)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('session_id')) {
        console.log("[checkout-success] Detected Listing Upgrade Session");
        try {
          const result = await updatePaidUpgradesAfterPayment();
          
          if (result.processed) {
            setSuccess("Upgrade Successful!", "Your listing has been upgraded. Changes are now live.");
          } else if (result.alreadyProcessed) {
            setSuccess("Already Processed", "This payment has already been applied.");
          } else {
            // If it returned false but no error, maybe it was just a page refresh without params
            setError("Could not verify payment details. Please contact support.");
          }
        } catch (e) {
          console.error(e);
          setError("Error processing listing upgrade.");
        }
        return; 
      }

      // 2. Check for ADVERTISING SUBSCRIPTIONS (Pros, Brokers, Service Providers)
      // These are identified by localStorage keys set during signup
      const pendingProId = localStorage.getItem("pendingLocalProId");
      const pendingBrokerId = localStorage.getItem("pendingBrokerId");
      const pendingProviderId = localStorage.getItem("pendingServiceProviderId");

      if (pendingProId || pendingBrokerId || pendingProviderId) {
        console.log("[checkout-success] Detected Advertising Subscription");
        try {
          let activated = false;
          let label = "Ad";

          // Local Pro
          if (pendingProId) {
            await updateDoc(doc(db, "localPros", pendingProId), { 
              status: "active", activatedAt: serverTimestamp(), updatedAt: serverTimestamp() 
            });
            localStorage.removeItem("pendingLocalProId");
            localStorage.removeItem("pendingLocalProEmail");
            label = "Local Professional";
            activated = true;
          }

          // Broker
          if (pendingBrokerId) {
            await updateDoc(doc(db, "localBrokers", pendingBrokerId), { 
              status: "active", activatedAt: serverTimestamp(), updatedAt: serverTimestamp() 
            });
            localStorage.removeItem("pendingBrokerId");
            localStorage.removeItem("pendingBrokerEmail");
            label = "Broker Slot";
            activated = true;
          }

          // Service Provider
          if (pendingProviderId) {
            await updateDoc(doc(db, "localServiceProviders", pendingProviderId), { 
              status: "active", activatedAt: serverTimestamp(), updatedAt: serverTimestamp() 
            });
            localStorage.removeItem("pendingServiceProviderId");
            localStorage.removeItem("pendingServiceProviderEmail");
            localStorage.removeItem("pendingServiceProviderPhoto");
            label = "Service Provider";
            activated = true;
          }

          if (activated) {
            setSuccess("Activation Successful!", `Your ${label} ad is now live on the site.`);
          } else {
            setError("No pending ad found to activate.");
          }

        } catch (e) {
          console.error(e);
          setError("Database update failed. Please contact support.");
        }
        return;
      }

      // 3. Fallback (Page accessed directly with no context)
      setSuccess("Payment Successful", "Thank you for your payment.");
    }

    // Run on load
    processCheckout();

  </script>
</body>
</html>
