<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }
    @media print {
      body { background: white !important; }
      .no-print { display:none !important; }
    }
    /* Embed mode tweaks (no borders, no outer margins) */
    body.gc-embed {
      background: transparent !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    .gc-embed .gc-card {
      border: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      padding: 0 !important;
    }
    .gc-embed .gc-wrap {
      padding: 0 !important;
      margin: 0 !important;
      max-width: none !important;
    }
  </style>
</head>
<body class="bg-white text-black p-6 sm:p-8">
  <div id="wrap" class="gc-wrap max-w-3xl mx-auto bg-white">

    <!-- Local preview notice -->
    <div id="localNotice" class="hidden mb-4 p-3 rounded border border-yellow-200 bg-yellow-50 text-yellow-900 text-sm">
      Showing a local preview from your browser. Once the listing is saved to the server, this page will display the server copy.
    </div>

    <!-- Content card -->
    <div id="card" class="gc-card border p-6 rounded shadow bg-white">
      <h1 class="text-xl font-bold text-center mb-4">Irrevocable Seller Communication</h1>

      <div id="iscContent" class="text-sm space-y-4 leading-relaxed">
        <p>To the escrow holder/closing agent,</p>

        <p id="p1">Loading…</p>
        <p id="p2"></p>

        <p class="mt-6 text-center">
          <span id="sigName" class="font-cursive">[Name]</span>
          <span class="ml-2">Electronic Signature</span>
          <span class="ml-4" id="sigDate">[date]</span>
        </p>

        <p class="text-xs text-gray-500 mt-8 text-center" id="counters"></p>
        <p class="text-[10px] text-gray-400 mt-6 text-center">GuaranteedCommission.com</p>
      </div>

      <div class="no-print mt-6 flex items-center justify-end gap-2">
        <button onclick="window.print()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">Print</button>
      </div>
    </div>
  </div>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      getDoc, doc, getDocs, collection, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Safe JSON
    function getJSON(key, fb) { try { return JSON.parse(localStorage.getItem(key)) ?? fb; } catch { return fb; } }

    const $ = (id)=>document.getElementById(id);

    // Detect embed mode (?embed=1)
    const u0 = new URL(location.href);
    const isEmbed = (u0.searchParams.get('embed') === '1');
    if (isEmbed) {
      document.body.classList.add('gc-embed');
      // remove default body padding when embedded
      try {
        document.body.style.background = 'transparent';
      } catch {}
    }

    // Build body text from a server doc
    function buildFromDoc(d) {
      const addressFull = (d.address || "").trim();
      const short = addressFull.split(",")[0] || "[short address]";
      const apn = (d.apn || "").trim();
      const name = (d.ownerName || (d.signedISC?.name) || "[name]");
      const plan = (d.plan || "");
      const isFSBO = plan.includes("FSBO");

      const commissionType = d.commissionType || "%";
      const cVal = (d.commission || "");
      const commissionDisplay = commissionType === "$"
        ? (cVal ? ("$" + Number(cVal).toLocaleString()) : "[commission]")
        : (cVal ? (cVal + "%") : "[commission]");
      const suffix = commissionType === "%" ? " of the total purchase price" : "";

      let p1 = "", p2 = "";
      if (isFSBO) {
        const phone = d.agentPhone || d.ownerPhone || "[owner/seller phone]";
        const email = d.ownerEmail || "[owner/seller email]";
        p1 = `I, ${name}, am the owner/seller of ${addressFull}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by owner (Me). My phone number is ${phone}. My email address is ${email}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      } else {
        const brokerage  = d.brokerage  || "[listing brokerage]";
        const agentName  = d.agentName  || "[listing agent]";
        const phone      = d.agentPhone || "[agent phone]";
        const email      = d.agentEmail || "[agent email]";
        p1 = `I, ${name}, am the owner/seller of ${addressFull}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by ${brokerage}, ${agentName}, listing agent, ${phone}, ${email}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      }

      const sigName = (d.signedISC?.name) || (d.ownerName) || "";
      const sigDate = (d.signedISC?.date) || new Date().toISOString().slice(0,10);

      return { p1, p2, sigName, sigDate };
    }

    // Build body text from localStorage (preview)
    function buildFromLocal() {
      const fd   = getJSON("formData", {});
      const signed = getJSON("signedISC", {});
      const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
      const isFSBO   = plan.includes("FSBO");
      const addressFull = (fd.address || "").trim() || "[full address]";
      const short    = addressFull.split(",")[0] || "[short address]";
      const apn      = (fd.apn || "").trim();
      const name     = (fd.name || signed.name || "[name]");
      const phone    = fd.agentPhone || (isFSBO ? "[owner/seller phone]" : "[agent phone]");
      const emailFSBO= fd.fsboEmail || "[owner/seller email]";
      const brokerage= fd.brokerage || "[listing brokerage]";
      const agent    = fd.agent || "[listing agent]";
      const agentEmail = fd.agentEmail || "[agent email]";
      const cType = fd.commissionType || "%";
      const cVal  = (fd.commission || "").trim();
      const commissionDisplay = cType === "$"
        ? (cVal ? ("$" + Number(cVal).toLocaleString()) : "[commission]")
        : (cVal ? (cVal + "%") : "[commission]");
      const suffix  = (cType === "%") ? " of the total purchase price" : "";

      let p1 = "", p2 = "";
      if (isFSBO) {
        p1 = `I, ${name}, am the owner/seller of ${addressFull}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by owner (Me). My phone number is ${phone}. My email address is ${emailFSBO}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      } else {
        p1 = `I, ${name}, am the owner/seller of ${addressFull}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by ${brokerage}, ${agent}, listing agent, ${phone}, ${agentEmail}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commissionDisplay}${commissionDisplay ? suffix : ""}.`;
      }

      const sigName = signed.name || name || "";
      const sigDate = signed.date || new Date().toISOString().slice(0,10);

      return { p1, p2, sigName, sigDate };
    }

    function postSize() {
      try {
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        window.parent?.postMessage({ type: "gc-isc-embed-size", height: h }, "*");
      } catch {}
    }

    (async function boot(){
      const u = new URL(location.href);
      const isEmbed = (u.searchParams.get('embed') === '1');
      let idParam   = (u.searchParams.get('id')   || '').trim();
      let addrParam = (u.searchParams.get('addr') || '').trim();

      // In embed mode, strip body/card padding/borders
      if (isEmbed) {
        document.body.classList.add('gc-embed');
        document.getElementById('wrap')?.classList.add('gc-embed');
        document.getElementById('card')?.classList.add('gc-embed');
      }

      // Try server by id
      let data = null;
      if (idParam && db) {
        try {
          const snap = await getDoc(doc(db,"listings", idParam));
          if (snap.exists()) data = snap.data();
        } catch (e) { console.warn("[isc] by id failed:", e); }
      }

      // Try server by exact address
      if (!data && addrParam && db) {
        try {
          const snap = await getDocs(query(collection(db,"listings"), where("address","==", addrParam), limit(1)));
          if (!snap.empty) data = snap.docs[0].data();
        } catch (e) { console.warn("[isc] by address failed:", e); }
      }

      // Render
      let t;
      if (data) {
        t = buildFromDoc(data);
      } else {
        // Fallback to local preview
        t = buildFromLocal();
        document.getElementById("localNotice")?.classList.remove("hidden");
      }

      document.getElementById("p1").textContent = t.p1;
      document.getElementById("p2").textContent = t.p2;
      document.getElementById("sigName").textContent = t.sigName || "[Name]";
      document.getElementById("sigDate").textContent = t.sigDate;

      // View counter (based on address if we can infer)
      (function counters(){
        const addr = (data?.address || getJSON("formData", {}).address || "").toLowerCase();
        const key = addr ? ("iscViews:" + addr) : "iscViews:generic";
        let n = Number(localStorage.getItem(key) || 0); n += 1;
        localStorage.setItem(key, String(n));
        document.getElementById("counters").textContent = `This Irrevocable Seller Communication has been viewed ${n} time(s).`;
      })();

      // Post height to parent (so parent resizes and no scrollbars appear)
      postSize();
      // Re-post after fonts/layout settle
      setTimeout(postSize, 150);
      setTimeout(postSize, 400);
      setTimeout(postSize, 1200);
    })();
  </script>
</body>
</html>
