<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication (ISC)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }
    @media print {
      body { background: white !important; }
      .no-print { display:none !important; }
    }
  </style>
</head>
<body class="bg-white text-black p-8">
  <div class="max-w-3xl mx-auto border p-6 rounded shadow bg-white">
    <div class="flex items-center justify-between no-print mb-4">
      <h1 class="text-xl font-bold">Irrevocable Seller Communication (ISC)</h1>
      <div class="text-xs text-gray-600">GuaranteedCommission.com</div>
    </div>

    <div id="iscContent" class="text-sm space-y-4 leading-relaxed">
      <h2 class="text-lg font-semibold text-center">Irrevocable Seller Communication</h2>

      <p>To the escrow holder/closing agent,</p>

      <p id="p1">Loading…</p>
      <p id="p2"></p>

      <p class="mt-6">
        <span id="sigName" class="font-cursive">[Name]</span>
        <span class="ml-2">Electronic Signature</span>
        <span class="ml-4" id="sigDate">[date]</span>
      </p>

      <p class="text-xs text-gray-500 mt-8" id="counters"></p>
    </div>

    <div class="no-print mt-6 flex items-center justify-end gap-2">
      <button onclick="window.print()" class="bg-gray-700 text-white px-3 py-2 rounded text-sm">Print</button>
    </div>
  </div>

  <script>
    function getJSON(k, fb) { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } }

    const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const fd   = getJSON("formData", {});
    const signed = getJSON("signedISC", {}); // { name, date }

    const isFSBO   = plan.includes("FSBO");
    const fullAddr = (fd.address || "").trim() || "[full address]";
    const short    = fullAddr.split(",")[0] || "[short address]";
    const apn      = (fd.apn || "").trim();
    const name     = (fd.name || signed.name || "[name]");
    const phone    = fd.agentPhone || (isFSBO ? "[owner/seller phone]" : "[agent phone]");
    const email    = fd.fsboEmail || "[owner/seller email]";
    const brokerage= fd.brokerage || (isFSBO ? "" : "[listing brokerage]");
    const agent    = fd.agent || (isFSBO ? "" : "[listing agent]");

    const cType = fd.commissionType || "%";
    const cVal  = (fd.commission || "").trim();
    const commDisplay = cType === "$"
      ? (cVal ? ("$" + Number(cVal).toLocaleString()) : "[commission]")
      : (cVal ? (cVal + "%") : "[commission]");
    const commSuffix  = (cType === "%") ? " of the total purchase price" : "";

    let p1 = "", p2 = "";
    if (isFSBO) {
      p1 = `I, ${name}, am the owner/seller of ${fullAddr}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by owner (Me). ` +
           `My phone number is ${phone}. My email address is ${email}.`;
      p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) ` +
           `are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commDisplay}${commDisplay ? commSuffix : ""}.`;
    } else {
      p1 = `I, ${name}, am the owner/seller of ${fullAddr}. ${short} is listed for sale by ${brokerage}, ${agent}, listing agent, ${phone}.`;
      p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) ` +
           `are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for ` +
           `broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commDisplay}${commDisplay ? commSuffix : ""}.`;
    }

    document.getElementById("p1").textContent = p1;
    document.getElementById("p2").textContent = p2;

    const sigName = signed.name || name || "[Name]";
    const sigDate = signed.date || new Date().toISOString().slice(0,10);
    document.getElementById("sigName").textContent = sigName;
    document.getElementById("sigDate").textContent = sigDate;

    // Unified ISC view counter (fires here regardless of where viewed from)
    (function counters(){
      const key = "iscViews:" + (fullAddr||"").toLowerCase();
      let n = Number(localStorage.getItem(key) || 0); n += 1;
      localStorage.setItem(key, String(n));
      document.getElementById("counters").textContent = `This Irrevocable Seller Communication has been viewed ${n} time(s).`;
    })();
  </script>
</body>
</html>
