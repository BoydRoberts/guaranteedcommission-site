<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication — Printable</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF for PDF export (text-based, crisp) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }
    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      .page { box-shadow: none !important; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Top bar (hidden when printing) -->
  <header class="bg-white border-b no-print">
    <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/signature.html" class="text-sm text-blue-600 hover:underline">&larr; Back</a>
      <div class="flex items-center gap-3">
        <span class="text-[11px] px-2 py-1 rounded bg-gray-100 text-gray-600">printable-isc build 2025-08-14c</span>
        <button id="btnPdf" class="px-3 py-1 rounded bg-blue-600 text-white">Download PDF</button>
        <button onclick="window.print()" class="px-3 py-1 rounded bg-gray-800 text-white">Print</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <section class="page bg-white rounded-2xl shadow p-6">
      <h1 class="text-xl font-bold text-center mb-1">Irrevocable Seller Communication</h1>
      <p class="text-xs text-gray-500 text-center mb-6">For escrow/closing agent use.</p>

      <!-- ISC body -->
      <div class="text-sm leading-6 text-gray-800" id="iscBody">
        <p>To the escrow holder/closing agent,</p>

        <!-- Listed -->
        <div id="iscListed" class="hidden">
          <p class="mt-3" id="listedP1">
            I, <span id="L_name">[name]</span>, am the owner/seller of
            <span id="L_addrFull">[full address]</span><span id="L_parcelBlock">, # <span id="L_apn">[APN]</span></span>.
            <span id="L_addrShort1">[short address]</span> is listed for sale by
            <span id="L_brokerage">[listing brokerage]</span>,
            <span id="L_agent">[listing agent]</span>, listing agent,
            <span id="L_agentPhone">[agent phone]</span>.
          </p>
          <p class="mt-3" id="listedP2">
            Let it be known: if a buyer’s agent/broker facilitates the sale of
            <span id="L_addrShort2">[short address]</span>, you (the escrow holder/closing agent)
            are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the
            listing brokerage (if there is an agreement for broker-to-broker compensation) and second by
            debiting me, the seller – a commission not to exceed
            <span id="L_commDisplay">[commission]</span>
            <span id="L_commSuffix"></span>.
          </p>
        </div>

        <!-- FSBO -->
        <div id="iscFSBO" class="hidden">
          <p class="mt-3" id="fsboP1">
            I, <span id="F_name">[name]</span>, am the owner/seller of
            <span id="F_addrFull">[full address]</span><span id="F_parcelBlock">, # <span id="F_apn">[APN]</span></span>.
            <span id="F_addrShort1">[short address]</span> is listed for sale by owner (Me).
            My phone number is <span id="F_phone">[owner/seller phone]</span>. My email address is <span id="F_email">[owner/seller email]</span>.
          </p>
          <p class="mt-3" id="fsboP2">
            Let it be known: if a buyer’s agent/broker facilitates the sale of
            <span id="F_addrShort2">[short address]</span>, you (the escrow holder/closing agent)
            are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed
            <span id="F_commDisplay">[commission]</span>
            <span id="F_commSuffix"></span>.
          </p>
        </div>

        <!-- Signature row -->
        <div class="mt-8" id="sigRow">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-base">
                <span id="sigRender" class="font-cursive">[Name]</span>
              </div>
              <div class="text-xs text-gray-600">Electronic Signature</div>
            </div>
            <div class="text-sm"><span id="sigDate">[YYYY-MM-DD]</span></div>
          </div>
        </div>
      </div>

      <!-- Footer line -->
      <div class="mt-8 pt-4 border-t text-[11px] text-gray-500 flex items-center justify-between">
        <span>GuaranteedCommission.com &middot; Document for escrow/closing agent</span>
        <span id="viewCounter">Viewed 0 times</span>
      </div>
    </section>
  </main>

  <script>
    console.log("[printable-isc] build 2025-08-14c");

    // Helpers
    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // Load context
    const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const fd = getJSON("formData", {});
    const sig = getJSON("signedISC", null);

    // Address bits
    const fullAddr = (fd.address || "").trim();
    const shortAddr = fullAddr.split(",")[0] || "";

    // APN handling
    const apn = (fd.apn || "").trim();
    const apnMode = (fd.apnMode || "").trim(); // listed only ("agent" means omit parcel bit)

    // Commission text
    const comm = (fd.commission || "").trim();
    const cType = fd.commissionType || "%";
    const commDisplay = cType === "$" ? (comm ? ("$" + Number(comm).toLocaleString()) : "") : (comm ? (comm + "%") : "");
    const commSuffix = (cType === "%") ? "of the total purchase price" : "";

    // Which variant
    const isFSBO = plan === "FSBO Plus";

    if (isFSBO) {
      $("iscFSBO").classList.remove("hidden");
      $("F_name").textContent = fd.name || "[name]";
      $("F_addrFull").textContent = fullAddr || "[full address]";
      $("F_apn").textContent = apn || "[APN]";
      $("F_parcelBlock").style.display = apn ? "inline" : "none";
      $("F_addrShort1").textContent = shortAddr || "[short address]";
      $("F_addrShort2").textContent = shortAddr || "[short address]";
      $("F_phone").textContent = fd.agentPhone || "[owner/seller phone]";
      $("F_email").textContent = fd.brokerage || "[owner/seller email]";
      $("F_commDisplay").textContent = commDisplay || "[commission]";
      $("F_commSuffix").textContent = commDisplay ? (" " + commSuffix) : "";
    } else {
      $("iscListed").classList.remove("hidden");
      $("L_name").textContent = fd.name || "[name]";
      $("L_addrFull").textContent = fullAddr || "[full address]";
      $("L_apn").textContent = apn || "[APN]";
      const showParcel = !!apn && apnMode !== "agent";
      $("L_parcelBlock").style.display = showParcel ? "inline" : "none";
      $("L_addrShort1").textContent = shortAddr || "[short address]";
      $("L_addrShort2").textContent = shortAddr || "[short address]";
      $("L_brokerage").textContent = fd.brokerage || "[listing brokerage]";
      $("L_agent").textContent = fd.agent || "[listing agent]";
      $("L_agentPhone").textContent = fd.agentPhone || "[agent phone]";
      $("L_commDisplay").textContent = commDisplay || "[commission]";
      $("L_commSuffix").textContent = commDisplay ? (" " + commSuffix) : "";
    }

    // Signature render
    const signerName = (sig && sig.name) ? sig.name : (fd.name || "");
    const sigDate = (sig && sig.date) ? sig.date : new Date().toISOString().slice(0,10);
    $("sigRender").textContent = signerName || "[Name]";
    $("sigDate").textContent = sigDate;

    // --------- Per-ISC view counter ----------
    function counterKey() {
      const addrKey = (fullAddr || "").toLowerCase().trim();
      const signerKey = (signerName || "").toLowerCase().trim();
      return `iscCounter::${plan}::${addrKey}::${signerKey}`;
    }
    function incrementCounter() {
      const key = counterKey();
      const all = getJSON("iscCounters", {});
      all[key] = (all[key] || 0) + 1;
      setJSON("iscCounters", all);
      return all[key];
    }
    const count = incrementCounter();
    $("viewCounter").textContent = `Viewed ${count} ${count === 1 ? "time" : "times"}`;

    // --------- PDF Export (jsPDF) ----------
    document.getElementById("btnPdf").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "letter" }); // 612x792

      const marginL = 54;  // 0.75"
      const marginR = 54;
      let y = 64;

      const pageW = doc.internal.pageSize.getWidth();

      function line(txt, opts={}) {
        const maxW = pageW - marginL - marginR;
        const lines = doc.splitTextToSize(txt, maxW);
        lines.forEach((ln) => { doc.text(ln, marginL, y); y += (opts.leading || 16); });
      }
      function sectionGap(px=10) { y += px; }
      function h1(txt) { doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.text(txt, pageW/2, y, { align:"center" }); y += 18; }
      function smallCenter(txt) { doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.text(txt, pageW/2, y, { align:"center" }); y += 14; }
      function setBody() { doc.setFont("helvetica","normal"); doc.setFontSize(11); }

      // Header
      h1("Irrevocable Seller Communication");
      smallCenter("For escrow/closing agent use.");
      sectionGap(8);
      setBody();

      line("To the escrow holder/closing agent,");
      sectionGap(8);

      if (isFSBO) {
        const p1 = document.getElementById("fsboP1").innerText;
        const p2 = document.getElementById("fsboP2").innerText;
        line(p1);
        sectionGap(6);
        line(p2);
      } else {
        const p1 = document.getElementById("listedP1").innerText;
        const p2 = document.getElementById("listedP2").innerText;
        line(p1);
        sectionGap(6);
        line(p2);
      }

      // Signature block
      sectionGap(18);
      doc.setFont("helvetica","normal");
      doc.setFontSize(12);
      doc.text((signerName || "[Name]"), marginL, y);
      doc.setFontSize(9);
      doc.text("Electronic Signature", marginL, y + 12);
      doc.setFontSize(11);
      doc.text(sigDate || "[YYYY-MM-DD]", pageW - marginR, y, { align:"right" });
      y += 24;

      // Footer
      const footerY = 792 - 40;
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("GuaranteedCommission.com · Document for escrow/closing agent", marginL, footerY);
      doc.text(`Viewed ${count} ${count === 1 ? "time" : "times"}`, pageW - marginR, footerY, { align: "right" });

      // File name: short-address + date
      const short = (fd.address || "listing").split(",")[0].trim().replace(/\s+/g,"_");
      const fname = `ISC_${short}_${sigDate || "signed"}.pdf`;
      doc.save(fname);
    });
  </script>
</body>
</html>
