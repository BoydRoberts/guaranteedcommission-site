<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --tile-pad: 1rem;   /* match listing tile side padding */
      --top-pad: 0.5rem;  /* slightly smaller top margin as requested */
    }

    html, body { background: transparent; }
    body {
      color: #111827;        /* gray-900 */
      line-height: 1.5;
      padding: var(--top-pad) var(--tile-pad) var(--tile-pad) var(--tile-pad);
    }

    /* Single outer card when standalone; no inner border in embed */
    .isc-card {
      background: #ffffff;
      border-radius: 0.75rem;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
      border: 1px solid #e5e7eb; /* gray-200 */
      padding: var(--tile-pad);
    }

    /* In embed, parent column already provides a card; remove inner border,
       keep equal inner padding so content aligns with tile/map. */
    .embed .isc-card {
      box-shadow: none;
      border: 0;
      border-radius: 0;
      padding: 0;
    }
    .embed .isc-wrap {
      padding: var(--tile-pad);  /* equal side margins like the tile */
    }

    .h1 {
      font-size: 1.125rem;   /* text-lg */
      font-weight: 700;      /* font-bold */
      text-align: center;    /* centered per request */
      margin: 0 0 0.5rem 0;  /* reduce top margin */
    }

    .p { font-size: 0.95rem; margin-top: 0.5rem; }

    .sig-row {
      margin-top: 1rem;      /* slightly tighter */
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.95rem;
    }
    /* Indent signature ~5 characters from the left */
    .sig-left { padding-left: 5ch; }
    .sig-name { font-family: "Brush Script MT", cursive; font-size: 1.1rem; }
    .fine { font-size: 0.75rem; color: #6b7280; }   /* gray-500 */
    /* Indent date ~5 characters in from the right edge */
    .sig-right { padding-right: 5ch; }

    /* No print button per your request */
    .no-print { display: none !important; }
  </style>
</head>
<body>
  <div id="root" class="max-w-3xl mx-auto">
    <div id="card" class="isc-card">
      <div id="wrap" class="">
        <h1 class="h1">Irrevocable Seller Communication</h1>

        <!-- UNSIGNED NOTICE (shown if no saved signature) -->
        <div id="unsignedBox" class="fine mt-2 text-center hidden" style="color:#9a3412;">
          Not signed yet. This document must be signed by the seller before use.
        </div>

        <!-- BODY (hidden when not signed) -->
        <div id="bodyBox">
          <p class="p">To the escrow holder/closing agent,</p>
          <p id="p1" class="p">Loading…</p>
          <p id="p2" class="p"></p>

          <div class="sig-row">
            <div class="sig-left">
              <div id="sigName" class="sig-name">[Name]</div>
              <div class="fine">Electronic Signature</div>
            </div>
            <div id="sigDate" class="sig-right">[date]</div>
          </div>

          <!-- View counter (restored) -->
          <div id="counter" class="fine mt-4 text-center"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (module) for Firestore reads when id= is provided -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const getJSON = (k, fb)=>{ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };

    // Are we embedded inside listing.html? (We’ll auto-size so the whole doc is visible.)
    function isEmbed() {
      try { return (new URL(location.href)).searchParams.get("embed") === "1"; }
      catch { return false; }
    }

    function postHeight() {
      try {
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        window.parent?.postMessage?.({ type:"gc-isc-embed-size", height: h }, "*");
      } catch {}
    }

    function fmtCommission(commission, type) {
      const t = type === "$" ? "$" : "%";
      if (!commission) return "[commission]";
      if (t === "$") {
        const n = Number(commission);
        return isFinite(n) ? "$" + Math.round(n).toLocaleString() : String(commission);
      }
      return String(commission) + "%";
    }

    function showUnsigned() {
      $("unsignedBox")?.classList.remove("hidden");
      $("bodyBox")?.classList.add("hidden");
    }
    function showBody() {
      $("unsignedBox")?.classList.add("hidden");
      $("bodyBox")?.classList.remove("hidden");
    }

    function buildFromData(d) {
      const plan = String(d.plan || "");
      const isFSBO = plan.includes("FSBO");

      const fullAddr = String(d.address || "").trim() || "[full address]";
      const short    = fullAddr.split(",")[0] || "[short address]";
      const apn      = (d.apn || "").trim();
      const name     = (d.ownerName || d.name || "[name]");
      const brokerage= d.brokerage || "[listing brokerage]";
      const agent    = d.agentName || d.agent || "[listing agent]";
      const phone    = d.agentPhone || d.phone || (isFSBO ? "[owner/seller phone]" : "[agent phone]");
      const email    = isFSBO ? (d.ownerEmail || "[owner/seller email]") : (d.agentEmail || "[agent email]");

      const cType    = (d.commissionType === "$" || d.commissionType === "%") ? d.commissionType : "%";
      const cVal     = (d.commission ?? "").toString().trim();
      const commDisp = fmtCommission(cVal, cType);
      const commSfx  = (cVal && cType === "%") ? " of the total purchase price" : "";

      // Signature block — MUST be present (no "today" fallback)
      const signed = (d.signedISC && typeof d.signedISC === "object") ? d.signedISC : {};
      if (!signed.name || !signed.date) {
        showUnsigned();
        return;
      }

      let p1 = "", p2 = "";
      if (isFSBO) {
        p1 = `I, ${name}, am the owner/seller of ${fullAddr}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by owner (Me). My phone number is ${phone}. My email address is ${email}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker a commission not to exceed ${commDisp}${commDisp !== "[commission]" ? commSfx : ""}.`;
      } else {
        const showParcel = !!apn;
        p1 = `I, ${name}, am the owner/seller of ${fullAddr}${showParcel ? `, # ${apn}` : ""}. ${short} is listed for sale by ${brokerage}, ${agent}, listing agent, ${phone}${email ? `, ${email}` : ""}.`;
        p2 = `Let it be known: if a buyer’s agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer’s broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission not to exceed ${commDisp}${commDisp !== "[commission]" ? commSfx : ""}.`;
      }

      $("p1").textContent = p1;
      $("p2").textContent = p2;
      $("sigName").textContent = signed.name;
      $("sigDate").textContent = signed.date;

      showBody();

      // View counter (by id if present; else by address) — count only when signed is present
      const key = "iscViews:" + (d.__id || fullAddr.toLowerCase());
      let n = Number(localStorage.getItem(key) || 0);
      n += 1;
      localStorage.setItem(key, String(n));
      $("counter").textContent = `Viewed ${n} time${n===1 ? "" : "s"}.`;
    }

    (async function boot(){
      // Embed-class styling: no inner border, equal margins like tile
      if (isEmbed()) {
        document.body.classList.add("embed");
        $("wrap")?.classList.add("isc-wrap");
      }

      let loaded = false;

      try {
        const u = new URL(location.href);
        const id   = (u.searchParams.get("id") || "").trim();

        if (id && db) {
          try {
            const snap = await getDoc(doc(db, "listings", id));
            if (snap.exists()) {
              const data = snap.data() || {};
              data.__id = id; // annotate for counter keying
              buildFromData(data);
              loaded = true;
            }
          } catch {}
        }

        if (!loaded) {
          // Fallback to local preview (useful without id) — will show "unsigned" until signedISC exists
          const fd = getJSON("formData", {});
          const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
          const d = {
            plan,
            address: fd.address,
            apn: fd.apn,
            ownerName: fd.name,
            ownerEmail: fd.fsboEmail,
            agentName: fd.agent,
            agentPhone: fd.agentPhone || fd.phone,
            agentEmail: fd.agentEmail,
            brokerage: fd.brokerage,
            commission: fd.commission,
            commissionType: fd.commissionType
          };
          buildFromData(d);
        }
      } catch {
        // Keep defaults on any error
        showUnsigned();
      }

      // Auto-size so the full document is visible without clicks
      if (isEmbed()) {
        requestAnimationFrame(postHeight);
        setTimeout(postHeight, 120);
        window.addEventListener("load", postHeight);
      }
    })();
  </script>
</body>
</html>
