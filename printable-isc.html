<!DOCTYPE html>
<!-- Build: 2026-02-07 (Added Price History + Status History sections) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Irrevocable Seller Communication</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --tile-pad: 1rem;  
      --top-pad: 0.5rem;
    }

    html, body { background: transparent; }
    body {
      color: #111827;
      line-height: 1.5;
      padding: var(--top-pad) var(--tile-pad) var(--tile-pad) var(--tile-pad);
    }

    .isc-card {
      background: #ffffff;
      border-radius: 0.75rem;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
      border: 1px solid #e5e7eb;
      padding: var(--tile-pad);
      position: relative;
    }

    .embed .isc-card {
      box-shadow: none;
      border: 0;
      border-radius: 0;
      padding: 0;
    }
    .embed .isc-wrap {
      padding: var(--tile-pad);
    }

    .h1 {
      font-size: 1.125rem;
      font-weight: 700;
      text-align: center;
      margin: 0 0 0.5rem 0;
    }

    .p {
      font-size: 0.95rem;
      margin-top: 0.5rem;
      text-align: left;
      hyphens: none;
    }

    /* FSBO text wrapping fix - prevents commission from bleeding out of container */
    .p.fsbo-wrap {
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }

    .sig-row {
      margin-top: 1rem;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.95rem;
    }
    .sig-left { padding-left: 5ch; }
    .sig-name { font-family: "Brush Script MT", cursive; font-size: 1.1rem; color:#1d4ed8; }
    .fine { font-size: 0.75rem; color: #6b7280; }
    .sig-right { padding-right: 5ch; }

    /* History section styling */
    .history-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #d1d5db;
    }
    .history-title {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }
    .history-list {
      font-size: 0.75rem;
      color: #374151;
    }
    .history-list > div {
      margin-bottom: 0.25rem;
    }

    @media print { .print-hidden { display: none !important; } }
  </style>
</head>
<body>

  <div id="root" class="max-w-3xl mx-auto">
    <div id="card" class="isc-card">
      <div id="printRow" class="flex justify-end mb-2">
        <button id="printBtn" class="print-hidden px-3 py-1 border rounded text-sm bg-gray-50 hover:bg-gray-100">Print</button>
      </div>

      <div id="wrap">
        <h1 class="h1">Irrevocable Seller Communication</h1>

        <p class="p">To the escrow holder/closing agent,</p>
        <p id="p1" class="p">Loading…</p>
        <p id="p2" class="p"></p>

        <div class="sig-row">
          <div class="sig-left">
            <div id="sigName" class="sig-name">[Name]</div>
            <div id="sigLabel" class="fine">Electronic Signature</div>
          </div>
          <div id="sigDate" class="sig-right">[date]</div>
        </div>

        <div id="sigCounterBelow" class="fine text-center mt-1"></div>

        <!-- ✅ Commission History Section -->
        <div id="commissionHistorySection" class="history-section hidden">
          <h3 class="history-title">Commission History</h3>
          <div id="commissionHistoryList" class="history-list"></div>
        </div>

        <!-- ✅ Price History Section -->
        <div id="priceHistorySection" class="history-section hidden">
          <h3 class="history-title">Price History</h3>
          <div id="priceHistoryList" class="history-list"></div>
        </div>

        <!-- ✅ Status History Section -->
        <div id="statusHistorySection" class="history-section hidden">
          <h3 class="history-title">Status History</h3>
          <div id="statusHistoryList" class="history-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, getDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const getJSON = (k, fb)=>{ try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };

    function isEmbed() {
      try { return (new URL(location.href)).searchParams.get("embed") === "1"; }
      catch { return false; }
    }

    function postHeight() {
      try {
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        window.parent?.postMessage?.({ type:"gc-isc-embed-size", height: h }, "*");
      } catch {}
    }

    function fmtCommission(commission, type) {
      const t = type === "$" ? "$" : "%";
      if (!commission) return "[commission]";
      if (t === "$") {
        const n = Number(commission);
        return isFinite(n) ? "$" + Math.round(n).toLocaleString() : String(commission);
      }
      return String(commission) + "%";
    }

    // =========================================================================
    // COMMISSION HISTORY
    // Format: "12/18/2025 10:46 AM — Original — 3.0%"
    // Hide in embed mode to prevent text overflow
    // =========================================================================
    function renderCommissionHistory(history) {
      const section = $("commissionHistorySection");
      const list = $("commissionHistoryList");

      if (!section || !list) return;

      // Hide history in embed mode (small card view on listing detail page)
      if (isEmbed()) {
        section.classList.add("hidden");
        return;
      }

      if (!Array.isArray(history) || history.length < 1) {
        section.classList.add("hidden");
        return;
      }

      section.classList.remove("hidden");
      list.innerHTML = "";

      history.forEach((entry) => {
        const commDisplay = entry.commissionType === "%"
          ? `${entry.commission}%`
          : `$${Number(entry.commission).toLocaleString()}`;

        const when = entry.time ? `${entry.date} ${entry.time}` : `${entry.date}`;
        const item = document.createElement("div");
        item.textContent = `${when} — ${entry.label || "Entry"} — ${commDisplay}`;
        list.appendChild(item);
      });
    }

    // =========================================================================
    // PRICE HISTORY
    // Format: "2026-01-20 10:46 AM — Original — $9,000,000"
    // Hide in embed mode
    // =========================================================================
    function renderPriceHistory(history) {
      const section = $("priceHistorySection");
      const list = $("priceHistoryList");

      if (!section || !list) return;

      // Hide history in embed mode
      if (isEmbed()) {
        section.classList.add("hidden");
        return;
      }

      if (!Array.isArray(history) || history.length < 1) {
        section.classList.add("hidden");
        return;
      }

      section.classList.remove("hidden");
      list.innerHTML = "";

      history.forEach((entry) => {
        // Format price with commas
        let priceDisplay = "—";
        if (entry.price !== undefined && entry.price !== null) {
          const priceNum = Number(entry.price);
          if (isFinite(priceNum) && priceNum > 0) {
            priceDisplay = "$" + priceNum.toLocaleString();
          } else if (typeof entry.price === "string" && entry.price.trim()) {
            priceDisplay = entry.price;
          }
        }

        const when = entry.time ? `${entry.date} ${entry.time}` : `${entry.date}`;
        const label = entry.label || "Entry";
        
        const item = document.createElement("div");
        item.textContent = `${when} — ${label} — ${priceDisplay}`;
        list.appendChild(item);
      });
    }

    // =========================================================================
    // STATUS HISTORY
    // Format: "2026-01-20 11:02 AM — Changed — Pending"
    // Hide in embed mode
    // =========================================================================
    function renderStatusHistory(history) {
      const section = $("statusHistorySection");
      const list = $("statusHistoryList");

      if (!section || !list) return;

      // Hide history in embed mode
      if (isEmbed()) {
        section.classList.add("hidden");
        return;
      }

      if (!Array.isArray(history) || history.length < 1) {
        section.classList.add("hidden");
        return;
      }

      section.classList.remove("hidden");
      list.innerHTML = "";

      history.forEach((entry) => {
        const statusDisplay = entry.status || "—";
        const when = entry.time ? `${entry.date} ${entry.time}` : `${entry.date}`;
        const label = entry.label || "Entry";
        
        const item = document.createElement("div");
        item.textContent = `${when} — ${label} — ${statusDisplay}`;
        list.appendChild(item);
      });
    }

    // =========================================================================
    // BUILD FROM DATA
    // =========================================================================
    function buildFromData(d, id) {
      const plan = String(d.plan || "");
      const isFSBO = plan.includes("FSBO");

      const fullAddr = String(d.address || "").trim() || "[full address]";
      const short    = fullAddr.split(",")[0] || "[short address]";
      const apn      = (d.apn || "").trim();

      const name     = (d.ownerName || d.name || "[name]");
      const brokerage= d.brokerage || "[listing brokerage]";
      const agent    = d.agentName || d.agent || "[listing agent]";

      const phone = isFSBO
        ? (d.ownerPhone || d.phone || d.agentPhone || "[owner/seller phone number]")
        : (d.agentPhone || d.phone || "[agent phone]");

      const email = isFSBO
        ? (d.ownerEmail || "[owner/seller email]")
        : (d.agentEmail || "[agent email]");

      const cType    = (d.commissionType === "$" || d.commissionType === "%") ? d.commissionType : "%";
      const cVal     = (d.commission ?? "").toString().trim();
      const commDisp = fmtCommission(cVal, cType);
      const commSfx  = (cVal && cType === "%") ? " of the total purchase price" : "";

      let p1 = "", p2 = "";

      if (isFSBO) {
        p1 = `I, ${name}, am the owner/seller of ${fullAddr}${apn ? `, # ${apn}` : ""}. ${short} is listed for sale by owner (Me): ${phone}, ${email}.`;
        p2 = `Let it be known: if a buyer's agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer's broker a commission equal to ${commDisp}${commDisp !== "[commission]" ? commSfx : ""}.`;
      } else {
        p1 = `I, ${name}, am the owner/seller of ${fullAddr}. ${short} is listed for sale. ${agent} with ${brokerage} is the listing agent: ${phone}, ${email}.`;
        p2 = `Let it be known: if a buyer's agent/broker facilitates the sale of ${short}, you (the escrow holder/closing agent) are irrevocably instructed to credit/compensate the buyer's broker – first, by debiting the listing brokerage (if there is an agreement for broker-to-broker compensation) and second by debiting me, the seller – a commission equal to ${commDisp}${commDisp !== "[commission]" ? commSfx : ""}.`;
      }

      const signed = (d.signedISC && typeof d.signedISC === "object") ? d.signedISC : getJSON("signedISC", {});
      const sigName = (signed.name || name || "[Name]");
      const sigDate = (signed.date || "[date]");

      $("p1").textContent = p1;
      $("p2").textContent = p2;
      $("sigName").textContent = sigName;
      $("sigDate").textContent = sigDate;

      // ✅ FSBO text wrapping fix: Add class to prevent commission bleeding
      const p1El = $("p1");
      const p2El = $("p2");
      if (isFSBO) {
        if (p1El) p1El.classList.add("fsbo-wrap");
        if (p2El) p2El.classList.add("fsbo-wrap");
      } else {
        if (p1El) p1El.classList.remove("fsbo-wrap");
        if (p2El) p2El.classList.remove("fsbo-wrap");
      }

      const embedded = isEmbed();

      const sigLabel = $("sigLabel");
      if (sigLabel && embedded) sigLabel.style.display = "none";

      const below = $("sigCounterBelow");
      if (embedded) {
        const n = Number(d.iscViews || 0);
        if (below) below.textContent = `Viewed ${n} time${n===1 ? "" : "s"}`;
      } else {
        if (below) below.style.display = "none";
        if (id) {
          updateDoc(doc(db, "listings", id), { iscViews: increment(1), updatedAt: serverTimestamp() }).catch(()=>{});
        }
      }

      // =========================================================================
      // RENDER ALL HISTORY SECTIONS
      // =========================================================================
      
      // ✅ Render Commission History
      if (d.commissionHistory) {
        renderCommissionHistory(d.commissionHistory);
      }

      // ✅ Render Price History
      if (d.priceHistory) {
        renderPriceHistory(d.priceHistory);
      }

      // ✅ Render Status History
      if (d.statusHistory) {
        renderStatusHistory(d.statusHistory);
      }
    }

    // =========================================================================
    // BOOT
    // =========================================================================
    (async function boot(){
      const embedded = isEmbed();
      const printRow = document.getElementById('printRow');
      const printBtn = document.getElementById('printBtn');

      if (embedded) {
        if (printRow) printRow.style.display = 'none';
      } else {
        if (printBtn) printBtn.addEventListener('click', () => window.print());
      }

      if (embedded) {
        document.body.classList.add("embed");
        document.getElementById("wrap")?.classList.add("isc-wrap");
      }

      let loaded = false;

      try {
        const u = new URL(location.href);
        let id = (u.searchParams.get("id") || "").trim();

        if (id && db) {
          try {
            const snap = await getDoc(doc(db, "listings", id));
            if (snap.exists()) {
              const data = snap.data() || {};
              buildFromData(data, id);
              loaded = true;
            }
          } catch {}
        }

        if (!loaded) {
          const fd = getJSON("formData", {});
          const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
          const d = {
            plan,
            address: fd.address,
            apn: fd.apn,
            ownerName: fd.name,
            ownerEmail: fd.fsboEmail,
            agentName: fd.agent,
            agentPhone: fd.agentPhone || fd.phone,
            agentEmail: fd.agentEmail,
            brokerage: fd.brokerage,
            commission: fd.commission,
            commissionType: fd.commissionType,
            iscViews: 0
          };
          buildFromData(d, "");
        }
      } catch {}

      if (embedded) {
        requestAnimationFrame(postHeight);
        setTimeout(postHeight, 120);
        window.addEventListener("load", postHeight);
      }
    })();
  </script>
</body>
</html>
