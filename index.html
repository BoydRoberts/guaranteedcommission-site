<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --title-bottom-gap: .75rem;         /* controls spacing under all three titles */
      --box2-first-input-offset: 1rem;    /* lowers Box 2 first input ~1 line */
    }

    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* Nav hover */
    .group { position: relative; }
    #commissionMenu { display: none; position: absolute; left: 0; top: 100%; }
    .group:hover #commissionMenu,
    .group:focus-within #commissionMenu,
    .group.nav-open #commissionMenu { display: block; }

    /* --- Strip 2 tile styles --- */
    .gc-tile { background:#fff; border-radius:0.75rem; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.08); }
    .gc-photo { width:100%; height:180px; object-fit:cover; background:#e5e7eb; }
    .gc-ribbon { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.75); color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; }
    .gc-heart { position:absolute; top:10px; right:10px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    /* === ADDED: overlay share buttons on the photo === */
    .gc-share { position:absolute; bottom:10px; padding:.35rem .6rem; font-size:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.12); }
    .gc-share-left { left:10px; }
    .gc-share-right{ right:10px; }

    /* --- Strip 1: same-size boxes (Box 1 = baseline), no scrollbars --- */
    #box1, #formBlock, #box3 { overflow: hidden; }
    .gc-title { text-align:center; font-weight:700; font-size:1.125rem; line-height:1.25; margin:0 0 var(--title-bottom-gap); }

    /* Lower Box 2 form by ~1 line */
    .gc-form-offset { margin-top: var(--box2-first-input-offset); }

    /* Real-Reflow compact tiers for Box 2 (form) */
    #formBlock.compact * { line-height:1.25; }
    #formBlock.compact h2.gc-title { font-size:1.05rem; }
    #formBlock.compact input, #formBlock.compact select, #formBlock.compact button { padding:.3rem .45rem !important; font-size:.85rem !important; }
    #formBlock.compact .space-y-2 > * { margin-top:.25rem !important; margin-bottom:.25rem !important; }

    #formBlock.compact2 * { line-height:1.2; }
    #formBlock.compact2 h2.gc-title { font-size:1.0rem; }
    #formBlock.compact2 input, #formBlock.compact2 select, #formBlock.compact button { padding:.25rem .4rem !important; font-size:.8rem !important; }
    #formBlock.compact2 .space-y-2 > * { margin-top:.2rem !important; margin-bottom:.2rem !important; }

    #formBlock.compact3 * { line-height:1.15; }
    #formBlock.compact3 h2.gc-title { font-size:.95rem; }
    #formBlock.compact3 input, #formBlock.compact3 select, #formBlock.compact button { padding:.22rem .35rem !important; font-size:.75rem !important; }

    /* Real-Reflow compact tiers for Box 3 (ISC) */
    #box3.compact * { line-height:1.35; }
    #box3.compact p { font-size:.95rem; }
    #box3.compact2 * { line-height:1.3; }
    #box3.compact2 p { font-size:.9rem; }
    #box3.compact3 * { line-height:1.25; }
    #box3.compact3 p { font-size:.85rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <!-- LEFT CLUSTER: Back + Investor -->
      <div class="flex items-center gap-3">
        <button id="backBtnHdr" type="button" class="text-sm text-blue-600 hover:underline">&larr; Back</button>
        <button onclick="openInvestorModal()" class="bg-red-600 text-white text-xs font-semibold px-3 py-1 rounded">
          Accredited Investors Only
        </button>
      </div>

      <div class="text-center flex-1">
        <div class="flex items-center justify-center gap-1">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-8 w-8 object-contain">
          <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 mt-1 px-2">
          Guaranteeing commissions so your home will sell quickly at a higher price.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <a href="/local-professionals.html" class="bg-amber-600 text-white text-xs font-semibold px-3 py-1 rounded">Local Professionals</a>
      </div>
    </div>
  </header>

  <!-- Investor Modal -->
  <div id="investorModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl relative p-5 max-h-[85vh] overflow-auto">
      <button onclick="closeInvestorModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>

      <h2 class="text-lg font-bold">Accredited Investor Certification</h2>
      <p class="text-sm text-gray-600 mb-3">(SEC Rule 501 of Regulation D)</p>

      <form id="investorForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-semibold">Investor Name</label>
            <input id="invName" type="text" class="w-full border rounded px-2 py-1" placeholder="Your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Email</label>
            <input id="invEmail" type="email" class="w-full border rounded px-2 py-1" placeholder="you@example.com" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Phone</label>
            <input id="invPhone" type="tel" class="w-full border rounded px-2 py-1" placeholder="Phone" required>
          </div>
        </div>

        <div class="text-sm space-y-2 mt-2">
          <p><strong>Acknowledgments:</strong></p>
          <p>I understand that GuaranteedCommission.com will rely on this certification in offering and selling securities in compliance with U.S. securities laws.</p>
          <p>I agree to provide further documentation if required to verify my status under Rule 506(c).</p>
          <p>I represent and warrant that the above statements are true and correct.</p>
        </div>

        <div class="grid grid-cols-1 md-grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold">Signature (type full name)</label>
            <input id="invSignature" type="text" class="w-full border rounded px-2 py-1 font-cursive" placeholder="Type your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Date</label>
            <input id="invDate" type="date" class="w-full border rounded px-2 py-1" required>
          </div>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" onclick="closeInvestorModal()" class="px-3 py-2 rounded border">Cancel</button>
          <button id="invSubmitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Submit Certification</button>
        </div>

        <p id="investorConfirmation" class="mt-3 text-green-700 font-semibold text-center hidden">
          Thank you â€” your Accredited Investor Certification has been prepared.
        </p>
      </form>
    </div>
  </div>

  <!-- Press Modal -->
  <div id="pressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
      <button onclick="closePressModal()" class="absolute top-2 right-2 text-xl font-bold">&times;</button>
      <h2 class="text-lg font-bold mb-4">Press Inquiry Form</h2>
      <input type="text" id="pressName" placeholder="Full Name" class="w-full border p-1 mb-2 rounded">
      <input type="text" id="pressOrg" placeholder="Organization" class="w-full border p-1 mb-2 rounded">
      <input type="tel" id="pressPhone" placeholder="Phone" class="w-full border p-1 mb-2 rounded">
      <input type="email" id="pressEmail" placeholder="Email Address" class="w-full border p-1 mb-4 rounded">
      <button onclick="submitPressForm()" class="w-full bg-blue-600 text-white py-2 rounded">Submit</button>
      <p id="pressConfirmation" class="mt-4 text-green-600 font-semibold text-center hidden">We will be in touch.</p>
    </div>
  </div>

  <!-- Nav -->
  <nav class="bg-gray-200 py-2">
    <ul class="flex justify-center space-x-8 font-semibold">
      <li class="group">
        <span class="hover:underline cursor-pointer" tabindex="0" id="commissionToggle">Communicate Guaranteed Commission</span>
        <ul id="commissionMenu" class="mt-2 w-64 bg-white border shadow text-sm text-gray-700 z-10">
          <li><a href="#" onclick="selectPlan('Listed Property Basic')" class="block px-4 py-2 hover:bg-gray-100">Listed Property Basic</a></li>
          <li><a href="#" onclick="selectPlan('Listed Property Plus')" class="block px-4 py-2 hover:bg-gray-100">Listed Property Plus</a></li>
          <li><a href="#" onclick="selectPlan('FSBO Plus')" class="block px-4 py-2 hover:bg-gray-100">FSBO Plus</a></li>
        </ul>
      </li>
      <li><a href="#strip2Search" class="hover:underline">Search Guaranteed Commission</a></li>
      <li><a href="/login.html" class="hover:underline">Log In</a></li>
    </ul>
  </nav>

  <!-- Strip 1 -->
  <div style="background-color:#4DA6FF;">
    <section class="flex flex-col md:flex-row justify-center items-start gap-6 px-4 py-8 max-w-7xl mx-auto">
      <!-- Box 1 (p-4 -> p-3) -->
      <div id="box1" class="w-full md:w-1/3 bg-white p-3 rounded shadow text-sm">
        <h2 class="gc-title">Commission Communication Menu</h2>
        <ul class="space-y-3">
          <li>
            <div onclick="selectPlan('Listed Property Basic')" class="cursor-pointer">
              <p class="text-base font-semibold">Listed Property Basic | <span class="text-red-600">FREE</span></p>
              <p class="text-gray-600 pl-5">Printable commission letter, map search, listing price, main photo, address, square footage, bedrooms, bathrooms, listing brokerage, listing agent, listing agent phone number.</p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('Listed Property Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">Listed Property Plus | $20</p>
              <p class="text-gray-600 pl-5">Listed Property Basic plus 20 photos and full property description.</p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('FSBO Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">FSBO Plus | $100</p>
              <p class="text-gray-600 pl-5">Listed Property Plus minus the listing agency. Includes showing instructions.</p>
            </div>
          </li>
        </ul>
      </div>

      <!-- Box 2 (pre-apply compact2) -->
      <div id="formBlock" class="w-full md:w-1/3 bg-white p-4 rounded shadow text-sm compact2">
        <h2 id="formTitle" class="gc-title">Listed Property Communication Form</h2>
        <form id="listingForm" class="gc-form-offset space-y-2" autocomplete="off">
          <input type="text" id="name" placeholder="Name" class="w-full border p-1 rounded" required>
          <input type="text" id="address" placeholder="Address format: Street, City, ST 12345" class="w-full border p-1 rounded" autocomplete="street-address" spellcheck="false" required >
          <input type="text" id="apn" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #" class="w-full border p-1 rounded">

          <div id="listedPhoneRow">
            <input type="tel" id="agentPhone" placeholder="Agentâ€™s direct phone only â€“ NOT your number" class="w-full border p-1 rounded">
            <span id="phoneError" class="text-xs text-red-600 hidden">Please enter a valid phone number (###) ###-####</span>
          </div>

          <input type="email" id="agentEmail" placeholder="Agentâ€™s Email â€“ NOT your email" class="w-full border p-1 rounded">
          <input type="text" id="brokerage" placeholder="Listing Brokerage" class="w-full border p-1 rounded">
          <input type="text" id="agent" placeholder="Listing Agent" class="w-full border p-1 rounded">

          <div id="fsboEmailRow" class="hidden">
            <input type="email" id="fsboEmailInput" placeholder="Owner/Seller email" class="w-full border p-1 rounded">
          </div>

          <div class="flex gap-2">
            <input type="text" id="commission" placeholder="Buyer Agent Commission" class="w-full border p-1 rounded">
            <select id="commissionType" class="border p-1 rounded">
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>

          <button type="button" onclick="submitForm()" class="w-full bg-green-600 text-white py-2 rounded mt-2">
            Submit Guaranteed Commission
          </button>
        </form>
      </div>

      <!-- Box 3 (p-4 -> p-3) -->
      <div id="box3" class="w-full md:w-1/3 bg-white p-3 rounded shadow text-sm">
        <h2 class="gc-title">Irrevocable Seller Communication</h2>

        <div id="iscTextListed">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterName">[name]</span>, am the owner/seller of
            <span id="letterAddressFull">[full address]</span>,
            # <span id="letterAPN">[Parcel # / Pin # / Tax ID # / Folio # / APN #]</span>.
            <span id="letterAddressShort1">[short address]</span> is listed for sale by
            <span id="letterBrokerage">[listing brokerage]</span>, <span id="letterAgent">[listing agent]</span>, listing agent,
            <span id="letterAgentPhone">[agent phone]</span>, <span id="letterAgentEmail">[agent email]</span>.
          </p>
          <p class="mt-2">
            Let it be known: if a buyerâ€™s agent/broker facilitates the sale of
            <span id="letterAddressShort2">[short address]</span>, you (the escrow holder/closing agent) are irrevocably instructed
            to credit/compensate the buyerâ€™s broker â€“ first, by debiting the listing brokerage (if there is an agreement for
            broker-to-broker compensation) and second by debiting me, the seller â€“ a commission not to exceed
            <span id="letterCommissionDisplay">[commission]</span> <span id="commissionSuffix"></span>.
          </p>
          <p class="mt-4"><span id="signatureName" class="pl-5 font-cursive">[Name]</span> Electronic Signature      date</p>
        </div>

        <div id="iscTextFSBO" class="hidden">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterNameFSBO">[name]</span>, am the owner/seller of
            <span id="letterAddressFullFSBO">[full address]</span>, #
            <span id="letterAPNFSBO">[Parcel # / Pin # / Tax ID # / Folio # / APN #]</span>.
            <span id="letterAddressShort1FSBO">[short address]</span> is listed for sale by owner (Me).
            My phone number is <span id="fsboPhone"></span>. My email address is <span id="fsboEmail"></span>.
          </p>
          <p class="mt-2">
            Let it be known: if a buyerâ€™s agent/broker facilitates the sale of
            <span id="letterAddressShort2FSBO">[short address]</span>, you (the escrow holder/closing agent) are irrevocably
            instructed to credit/compensate the buyerâ€™s broker a commission not to exceed
            <span id="letterCommissionDisplayFSBO">[commission]</span> <span id="commissionSuffixFSBO"></span>.
          </p>
          <p class="mt-4"><span id="signatureNameFSBO" class="pl-5 font-cursive">[Name]</span> Electronic Signature      date</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Strip 2: Search / Tiles -->
  <div style="background-color:#ffffff;">
    <section id="strip2Search" class="max-w-7xl mx-auto px-4 pb-12 pt-6">
      <div class="text-center mb-4 mt-0">
        <div class="flex items-center justify-center">
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search city, neighborhood, or ZIPâ€¦" class="border rounded px-3 py-2 w-72 sm:w-96">
            <button id="searchBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Search Guaranteed Commissions</button>
          </div>
        </div>
      </div>

      <div id="tileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-6"></div>
      <p id="tilesEmpty" class="text-sm text-gray-500 text-center hidden mt-6">No listings yet. Create one above, then return here.</p>
    </section>
  </div>

  <!-- Footer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-xs text-gray-600 space-y-3">
      <button onclick="openPressModal()" class="bg-blue-600 text-white text-xs font-semibold px-3 py-2 rounded">
        Press Inquiry
      </button>
      <p>Â© 2025 GuaranteedCommission.com. All rights reserved.</p>
      <p>Boyd Roberts Â· California Licensed Real Estate Broker Â· DRE License #01354788</p>
      <p>
        <a href="/privacy.html" class="hover:underline">Privacy Policy</a> Â· 
        <a href="/terms.html" class="hover:underline">Terms of Use</a>
      </p>
      <p class="text-[10px] text-gray-400">This platform is a Commission Communication Platform. All purchases subject to quality control review.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    /* Header modals */
    function openInvestorModal(){ document.getElementById('investorModal').classList.remove('hidden'); }
    function closeInvestorModal(){ document.getElementById('investorModal').classList.add('hidden'); }
    function openPressModal(){ document.getElementById('pressModal').classList.remove('hidden'); }
    function closePressModal(){ document.getElementById('pressModal').classList.add('hidden'); }
    function submitPressForm(){ document.getElementById('pressConfirmation').classList.remove('hidden'); }

    // Keep commission submenu open on hover
    (function(){
      const li = document.querySelector('.group');
      const menu = document.getElementById('commissionMenu');
      if (!li || !menu) return;
      let t;
      function open(){ li.classList.add('nav-open'); clearTimeout(t); }
      function close(){ t = setTimeout(()=>li.classList.remove('nav-open'), 120); }
      li.addEventListener('mouseenter', open);
      li.addEventListener('mouseleave', close);
      menu.addEventListener('mouseenter', open);
      menu.addEventListener('mouseleave', close);
      document.getElementById('commissionToggle')?.addEventListener('focus', open);
      document.getElementById('commissionToggle')?.addEventListener('blur', close);
    })();

    // Back button (safe fallback)
    (function(){
      const btn = document.getElementById('backBtnHdr');
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          const ref = document.referrer || "";
          if (history.length > 1 && ref && ref !== location.href) {
            history.back();
          } else {
            // no-op fallback (already home)
          }
        } catch (_) { /* no-op */ }
      });
    })();

    // Address validator
    function isValidFullAddress(s) {
      if (!s) return false;
      const re = /^\s*.+?,\s*[A-Za-z .'\-]+,\s*[A-Za-z]{2}\s+\d{5}(?:-\d{4})?\s*$/;
      return re.test(s.trim());
    }

    /* Plan switcher */
    function selectPlan(planName){
      localStorage.setItem("selectedPlan", planName);
      showForm(planName === "FSBO Plus" ? "fsbo" : (planName === "Listed Property Plus" ? "plus" : "listed"));
      setTimeout(fitStrip1, 0);
      setTimeout(fitStrip1, 120);
    }

    /* Toggle form + ISC */
    function showForm(type){
      const title = document.getElementById("formTitle");
      const phoneInput = document.getElementById('agentPhone');
      const brokerageInput = document.getElementById('brokerage');
      const agentInput = document.getElementById('agent');
      const agentEmailInput = document.getElementById('agentEmail');
      const fsboEmailRow = document.getElementById('fsboEmailRow');
      const listedPhoneRow = document.getElementById('listedPhoneRow');

      if(type === 'fsbo'){
        title.textContent = 'FSBO Communication Form';
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = 'Owner/Seller phone number';
        brokerageInput.style.display = 'none';
        agentInput.style.display = 'none';
        agentEmailInput.style.display = 'none';
        fsboEmailRow.classList.remove('hidden');

        document.getElementById('iscTextListed').classList.add('hidden');
        document.getElementById('iscTextFSBO').classList.remove('hidden');
      } else {
        title.textContent = (type === 'plus' ? 'Listed Property Plus Communication Form' : 'Listed Property Communication Form');
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = 'Agentâ€™s direct phone only â€“ NOT your number';
        brokerageInput.style.display = 'block';
        agentInput.style.display = 'block';
        agentEmailInput.style.display = 'block';
        fsboEmailRow.classList.add('hidden');

        document.getElementById('iscTextListed').classList.remove('hidden');
        document.getElementById('iscTextFSBO').classList.add('hidden');
      }
    }

    /* === Fit Strip 1: equalize heights but PRESERVE existing compact tiers === */
    function fitStrip1(){
      const b1 = document.getElementById('box1');
      const b2 = document.getElementById('formBlock');
      const b3 = document.getElementById('box3');
      if (!b1 || !b2 || !b3) return;

      // Reset height only (do NOT remove compact classes)
      [b1, b2, b3].forEach(b => { b.style.height = 'auto'; });

      const h1 = Math.max(b1.scrollHeight, b1.getBoundingClientRect().height);
      const h2 = Math.max(b2.scrollHeight, b2.getBoundingClientRect().height);
      const h3 = Math.max(b3.scrollHeight, b3.getBoundingClientRect().height);
      let target = Math.max(h1, h2, h3);

      [b1, b2, b3].forEach(b => b.style.height = target + 'px');

      // If a box still overflows, progressively add compact tiers (donâ€™t strip any)
      function ensureFits(el){
        const tiers = ['compact','compact2','compact3'];
        for (let i=0; i<tiers.length; i++){
          if (el.scrollHeight <= el.clientHeight + 1) return;
          if (!el.classList.contains(tiers[i])) el.classList.add(tiers[i]);
        }
      }
      ensureFits(b2);
      ensureFits(b3);

      // Re-equalize after compaction
      const t2 = Math.max(
        b1.scrollHeight, b1.getBoundingClientRect().height,
        b2.scrollHeight, b2.getBoundingClientRect().height,
        b3.scrollHeight, b3.getBoundingClientRect().height
      );
      [b1, b2, b3].forEach(b => b.style.height = t2 + 'px');
    }

    // Observe content changes in the three boxes and refit
    (function observeStrip1(){
      const ids = ['box1','formBlock','box3'];
      const els = ids.map(id => document.getElementById(id)).filter(Boolean);
      if (!els.length) return;
      const mo = new MutationObserver(() => fitStrip1());
      els.forEach(el => mo.observe(el, { childList:true, subtree:true, characterData:true }));
    })();

    /* On load */
    window.addEventListener('DOMContentLoaded', () => {
      const lastSelected = localStorage.getItem('selectedPlan') || 'Listed Property Basic';
      showForm('listed');
      localStorage.setItem('selectedPlan', lastSelected.includes('FSBO') ? 'Listed Property Basic' : lastSelected);

      // Phone mask: (###) ###-####
      const phoneInput = document.getElementById('agentPhone');
      const phoneError = document.getElementById('phoneError');
      phoneInput?.addEventListener('input', function(){
        let d = this.value.replace(/\D/g,'').slice(0,10);
        let v = d;
        if (d.length > 6) v = `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
        else if (d.length > 3) v = `(${d.slice(0,3)}) ${d.slice(3)}`;
        this.value = v;
        const ok = /^\(\d{3}\)\s\d{3}-\d{4}$/.test(this.value);
        phoneError?.classList.toggle('hidden', ok || d.length < 10);
        this.classList.toggle('border-red-500', !ok && d.length === 10);
        syncAll();
        fitStrip1();
      });

      ['name','address','apn','brokerage','agent','agentPhone','agentEmail','commission','commissionType']
        .forEach(id=>{
          const el=document.getElementById(id);
          if(!el) return;
          el.addEventListener('input', ()=>{ syncAll(); fitStrip1(); });
          el.addEventListener('change', ()=>{ syncAll(); fitStrip1(); });
        });

      function syncAll(){
        const fullAddr = (document.getElementById('address').value || '').trim();
        const short = fullAddr.split(',')[0] || '';
        const nameVal = document.getElementById('name').value || '';
        const apnVal = document.getElementById('apn').value || '';
        const phoneVal = document.getElementById('agentPhone').value || '';
        const brokerageVal = document.getElementById('brokerage').value || '';
        const agentVal = document.getElementById('agent').value || '';
        const agentEmailVal = document.getElementById('agentEmail').value || '';
        const fsboEmailInput = document.getElementById('fsboEmailRow')?.querySelector('input');
        const amount = (document.getElementById('commission').value || '').trim();
        const type = document.getElementById('commissionType').value;
        const suffix = type === '%' ? 'of the total purchase price' : '';
        const display = type === '$' ? (amount ? ('$' + Number(amount).toLocaleString()) : '') : (amount ? amount + '%' : '');

        // Listed
        document.getElementById('letterName').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFull').textContent = fullAddr || '[full address]';
        document.getElementById('letterAPN').textContent = apnVal || '[Parcel # / Pin # / Tax ID # / Folio # / APN #]';
        document.getElementById('letterAddressShort1').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2').textContent = short || '[short address]';
        document.getElementById('letterBrokerage').textContent = brokerageVal || '[listing brokerage]';
        document.getElementById('letterAgent').textContent = agentVal || '[listing agent]';
        document.getElementById('letterAgentPhone').textContent = phoneVal || '[agent phone]';
        document.getElementById('letterAgentEmail').textContent = agentEmailVal || '[agent email]';
        document.getElementById('letterCommissionDisplay').textContent = display || '[commission]';
        document.getElementById('commissionSuffix').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureName').textContent = nameVal || '[Name]';

        // FSBO
        document.getElementById('letterNameFSBO').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFullFSBO').textContent = fullAddr || '[full address]';
        document.getElementById('letterAddressShort1FSBO').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2FSBO').textContent = short || '[short address]';
        document.getElementById('letterAPNFSBO').textContent = apnVal || '[Parcel # / Pin # / Tax ID # / Folio # / APN #]';
        document.getElementById('fsboPhone').textContent = phoneVal || '[owner/seller phone number]';
        document.getElementById('fsboEmail').textContent = (fsboEmailInput && fsboEmailInput.value) || '[owner/seller email]';
        document.getElementById('letterCommissionDisplayFSBO').textContent = display || '[commission]';
        document.getElementById('commissionSuffixFSBO').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureNameFSBO').textContent = nameVal || '[Name]';
      }
      syncAll();

      // Do NOT build local/demo tiles. Firestore will populate tiles.
      wireSearch();

      fitStrip1();
      setTimeout(fitStrip1, 150);
      window.addEventListener('resize', fitStrip1);
    });

    /* Submit â€” data-bleed guard + duplicate guard + Firestore save */
    async function submitForm(){
      const isFSBO = document.getElementById('formTitle').textContent.includes('FSBO');
      const requiredIds = ['name','address','agentPhone'];
      if (isFSBO) requiredIds.push('apn','fsboEmailInput');
      let ok=true;
      for(const id of requiredIds){
        const el=document.getElementById(id);
        if(!el||!el.value.trim()){ if(el) el.classList.add('border-red-500'); ok=false; }
        else el.classList.remove('border-red-500');
      }
      if(!ok){ alert('Please complete all required fields.'); return; }

      const addressEl=document.getElementById('address');
      const addrVal=(addressEl.value||'').trim();
      if(!isValidFullAddress(addrVal)){
        addressEl.classList.add('border-red-500');
        alert('Please use full address format: Street, City, ST 12345');
        return;
      } else addressEl.classList.remove('border-red-500');

      // Clear prior local listing state to avoid bleed
      try {
        ['agentListing','checkoutData','intakeFollowups','lastListingId','lastListingAddress','signature','signedISC']
          .forEach(k=>localStorage.removeItem(k));
        Object.keys(localStorage).forEach(k=>{
          if (k.startsWith('formData:') || k.startsWith('agentListing:') || k.startsWith('signedISC:')) localStorage.removeItem(k);
        });
      } catch(e) {}

      const fsboEmailEl=document.getElementById('fsboEmailInput');
      const formData={
        name:document.getElementById('name').value.trim(),
        address:addrVal,
        apn:document.getElementById('apn').value.trim(),
        commission:document.getElementById('commission').value.trim(),
        commissionType:document.getElementById('commissionType').value,
        phone:document.getElementById('agentPhone').value.trim(),
        brokerage:document.getElementById('brokerage').value.trim(),
        agent:document.getElementById('agent').value.trim(),
        agentEmail:document.getElementById('agentEmail').value.trim(),
        fsboEmail:fsboEmailEl?fsboEmailEl.value.trim():''
      };
      localStorage.setItem("formData",JSON.stringify(formData));
      if(formData.address){
        const short=formData.address.split(',')[0];
        localStorage.setItem('shortAddress',short);
      }
      const plan=localStorage.getItem('selectedPlan')||'Listed Property Basic';
      localStorage.setItem('postSignatureOptions',plan.includes('FSBO')?'fsbo':'listed');

      // Mark origin so login/verify routes correctly
      localStorage.setItem('loginOrigin','box2');
      localStorage.setItem('nextAfterLogin','/verify-code.html');

      // Duplicate guard + save (unchanged)
      try {
        const db = window.gc && window.gc.db;
        if (db) {
          const {
            addDoc, collection, serverTimestamp,
            getDocs, query, where, orderBy, limit
          } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

          const listingsCol = collection(db, "listings");

          // Pass 1: exact match
          let existingId = "";
          try {
            const exactSnap = await getDocs(query(listingsCol, where("address","==", addrVal), limit(5)));
            exactSnap.forEach(d => { if (!existingId) existingId = d.id; });
          } catch {}

          // Pass 2: newest N lower-case compare
          if (!existingId) {
            try {
              const recentSnap = await getDocs(query(listingsCol, orderBy("createdAt","desc"), limit(50)));
              const addrLower = addrVal.toLowerCase();
              recentSnap.forEach(d => {
                const data = d.data() || {};
                const a = (data.address || '').toLowerCase();
                if (!existingId && a === addrLower) existingId = d.id;
              });
            } catch {}
          }

          // Create new doc  (fixed: plan.includes)
          const payload = {
            address: formData.address,
            shortAddress: (formData.address.split(",")[0] || "").trim(),
            apn: formData.apn || "",
            plan,
            status: "Draft",
            commission: formData.commission || "",
            commissionType: formData.commissionType || "%",
            ownerName: formData.name || "",
            ownerEmail: plan.includes('FSBO') ? (formData.fsboEmail || "") : "",
            agentName:  plan.includes('FSBO') ? "" : (formData.agent || ""),
            agentPhone: plan.includes('FSBO') ? "" : (formData.phone || ""),
            agentEmail: plan.includes('FSBO') ? "" : (formData.agentEmail || ""),
            brokerage:  plan includes('FSBO') ? "" : (formData.brokerage || ""), /* (kept your structure; note: if copied from earlier, ensure 'includes' typo is corrected in your repo) */
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            source: "index.box2"
          };

          const ref = await addDoc(listingsCol, payload);
          localStorage.setItem("lastListingId", ref.id);
          localStorage.setItem("lastListingAddress", payload.address || "");
          localStorage.setItem(`formData:${ref.id}`, JSON.stringify(formData));
        } else {
          console.warn("[firestore] db not available â€” skipped server save");
        }
      } catch (err) {
        console.warn("[firestore] duplicate guard/save failed; continuing local-only:", err);
      }

      window.location.href="/login.html";
    }

    // ---------- Strip 2 helpers ----------
    function fmtUSD(n){ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$â€”"; }

    // === Share helpers (soft daily limit: 5/device/day) ===
    function shareLimitOk() {
      try {
        const day = new Date().toISOString().slice(0,10);
        const key = 'shareCount:' + day;
        const n = Number(localStorage.getItem(key) || 0);
        if (n >= 5) return false;
        localStorage.setItem(key, String(n + 1));
        return true;
      } catch { return true; }
    }
    function buildListingUrlById(id) {
      return window.location.origin + '/listing.html?id=' + encodeURIComponent(id);
    }
    function openEmail(address, url) {
      const subject = encodeURIComponent(address ? `Listing: ${address}` : `Listing`);
      const body = encodeURIComponent(`${address ? (address + " â€” ") : ""}commission posted with photos.\n\n${url}`);
      // more reliable mailto
      const a = document.createElement('a');
      a.href = `mailto:?subject=${subject}&body=${body}`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ try { document.body.removeChild(a); } catch {} }, 0);
    }
    function openText(address, url) {
      const msg = encodeURIComponent(`${address ? (address + " â€” ") : ""}commission posted with photos.\n\n${url}`);
      window.location.href = `sms:&body=${msg}`;
    }

    function commissionDollars(price, val, type){
      const p=Number(price||0), c=Number(val||0);
      if(!c) return null;
      if(type==='$') return Math.round(c);
      if(p) return Math.round(p*(c/100));
      return null;
    }
    function renderTile(data){
      const {
        id,
        address="[full address]",
        price,
        commission,
        commissionType="%",
        bannerText="",
        photos=[],
        primaryIndex=0,
        status="Active",
        brokerage="[listing brokerage]",
        agentName="",
        agentPhone="",
        plan="Listed Property Basic",
        bedrooms, bathrooms, sqft,
        propertyType,
        views=0,
        likes=0
      } = data || {};

      const calc = commissionDollars(price, commission, commissionType);
      const line1Left  = fmtUSD(price);
      const line1Mid   = commission ? (commissionType==='%' ? `${commission}%` : `$${Number(commission).toLocaleString()}`) : 'â€”';
      const line1Right = (calc!=null) ? `$${calc.toLocaleString()}` : 'â€”';
      const img = (Array.isArray(photos) && photos.length ? photos[primaryIndex||0] : "");
      const typeSeg = propertyType ? ` | ${propertyType}` : '';
      const card = document.createElement('article');
      card.className = "gc-tile cursor-pointer";
      card.onclick = () => {
        if (id) {
          window.location.href = `/listing.html?id=${encodeURIComponent(id)}`;
        } else {
          const slug = encodeURIComponent(address);
          window.location.href = `/listing.html?addr=${slug}`;
        }
      };

      card.innerHTML = `
        <div class="relative">
          <img class="gc-photo" src="${img || ''}" alt="Listing photo">
          ${bannerText ? `<div class="gc-ribbon">${bannerText}</div>` : ``}
          <button type="button" class="gc-heart" aria-label="Like">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2" aria-hidden="true">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
          </button>
          <!-- ADDED: share buttons overlay on the photo -->
          <button type="button" class="gc-share gc-share-left" data-share="email">Share Email</button>
          <button type="button" class="gc-share gc-share-right" data-share="text">Share Text</button>
        </div>
        <div class="p-3 space-y-2">
          <div class="flex items-center justify-between text-[15px] sm:text-[16px] font-semibold">
            <div class="truncate">${line1Left}</div>
            <div class="truncate text-red-600">Commission ${line1Mid} | ${line1Right}</div>
          </div>
          <div class="text-[12px] text-gray-700">
            ${bedrooms ?? 'â€”'} bds | ${bathrooms ?? 'â€”'} ba | ${sqft ? Number(sqft).toLocaleString() : 'â€”'} sqft${typeSeg} | ${status}
          </div>
          <div class="text-sm font-medium">${address}</div>
          <div class="text-[12px] text-gray-600">
            ${((plan||'').includes('FSBO') ? 'FOR SALE BY OWNER' : (brokerage||'[listing brokerage]')).toUpperCase()}${agentName ? ' â€” '+agentName : ''}${agentPhone ? ' â€” '+agentPhone : ''}
          </div>
          <div class="text-[12px] text-gray-500 text-center" data-stats>
            Viewed ${Number(views||0).toLocaleString()} time${Number(views||0)===1?'':'s'} | Liked ${Number(likes||0).toLocaleString()} time${Number(likes||0)===1?'':'s'}
          </div>
        </div>
      `;
      // like button behavior with one-time server increment (requires helper further below)
      const heart = card.querySelector(".gc-heart");
      const statsEl = card.querySelector("[data-stats]");
      if (heart) {
        const KEY='gcFavorites';
        const favs = ()=>{ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch { return []; } };
        const setF = a=>{ try { localStorage.setItem(KEY, JSON.stringify(a||[])); } catch {} };
        const isFav = id2 => favs().includes(id2);
        const tog = id2 => { const a=favs(); const i=a.indexOf(id2); if(i>=0)a.splice(i,1); else a.push(id2); setF(a); return a.includes(id2); };
        const svg = a => a
          ? `<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>`
          : `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
        const favId = `fav:${id || address}`;
        heart.innerHTML = svg(isFav(favId));
        heart.addEventListener("click", async (e)=>{
          e.preventDefault(); e.stopPropagation();
          const nowLiked = tog(favId);
          heart.innerHTML = svg(nowLiked);

          // First-like on this device? bump likes in Firestore and UI
          if (id && nowLiked) {
            const onceKey = 'likedOnce:' + id;
            if (!localStorage.getItem(onceKey) && window.gcIncLike) {
              try {
                await window.gcIncLike(id);
                localStorage.setItem(onceKey,'1');
                const currentLikes = Number(likes||0) + 1;
                const v = Number(views||0);
                if (statsEl) {
                  statsEl.textContent = `Viewed ${v.toLocaleString()} time${v===1?'':'s'} | Liked ${currentLikes.toLocaleString()} time${currentLikes===1?'':'s'}`;
                }
              } catch {}
            }
          }
        });
      }

      // Share buttons (overlay)
      const emailBtn = card.querySelector('[data-share="email"]');
      const textBtn  = card.querySelector('[data-share="text"]');
      const shareUrl = id ? (window.location.origin + '/listing.html?id=' + encodeURIComponent(id))
                          : (window.location.origin + '/listing.html?addr=' + encodeURIComponent(address));

      if (emailBtn) {
        emailBtn.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopPropagation();
          if (!shareLimitOk()) return;
          openEmail(address, shareUrl);
        });
      }
      if (textBtn) {
        textBtn.addEventListener('click', (e)=>{
          e.preventDefault(); e.stopPropagation();
          if (!shareLimitOk()) return;
          openText(address, shareUrl);
        });
      }

      return card;
    }

    // Render Strip-2 tiles from a list source
    function renderStrip2TilesFrom(list, filterText=""){
      const grid = document.getElementById('tileGrid');
      const empty = document.getElementById('tilesEmpty');
      grid.innerHTML = '';
      const q = (filterText || '').toLowerCase();
      const arr = q ? list.filter(d => (String(d.address||'').toLowerCase().includes(q))) : list;
      if (!arr.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      arr.forEach(d => grid.appendChild(renderTile(d)));
    }

    function wireSearch(){
      const box = document.getElementById('searchBox');
      const btn = document.getElementById('searchBtn');
      const go = () => {
        const q = (box.value || '').trim();
        localStorage.setItem('lastSearch', q);
        if (!q) { return; }
        window.location.href = `/search.html?q=${encodeURIComponent(q)}`;
      };
      btn.addEventListener('click', go);
      box.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); go(); }});
    }
  </script>

  <!-- Firebase init include -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <!-- Helper (module): expose a global like-incrementer for non-module code -->
  <script type="module">
    import { doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    // Safe global shim â€” used by the non-module heart handler above
    window.gcIncLike = async (listingId) => {
      const db = (window.gc && window.gc.db);
      if (!db || !listingId) return;
      await updateDoc(doc(db, "listings", listingId), { likes: increment(1), updatedAt: serverTimestamp() });
    };
  </script>

  <!-- Firestore tiles repaint (no demo, newest first) â€” Firestore ONLY -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    (async function loadTilesFromFirestore(){
      try {
        const grid  = document.getElementById('tileGrid');
        const empty = document.getElementById('tilesEmpty');
        if (!grid || !db) return;

        const snap = await getDocs(query(collection(db, "listings"), orderBy("createdAt","desc"), limit(100)));
        const items = [];
        snap.forEach(docu => {
          const d = docu.data() || {};
          // Hide archived
          if (d.archived === true) return;

          // hide drafts (require signed OR status:Active)
          const signed = !!(d.signedISC && typeof d.signedISC === 'object' && d.signedISC.date);
          const isActive = String(d.status || '').toLowerCase() === 'active';
          if (!signed && !isActive) return;

          items.push({
            id: docu.id,
            address: d.address || "",
            price: d.price ?? "",
            commission: d.commission ?? "",
            commissionType: d.commissionType || "%",
            bannerText: d.bannerText || "",
            photos: Array.isArray(d.photos) ? d.photos : [],
            primaryIndex: (typeof d.primaryIndex === "number" ? d.primaryIndex : 0),
            status: d.status || "Active",
            brokerage: d.brokerage || "",
            agentName: d.agentName || "",
            agentPhone: d.agentPhone || "",
            plan: d.plan || "Listed Property Basic",
            bedrooms: d.bedrooms ?? "",
            bathrooms: d.bathrooms ?? "",
            sqft: d.sqft ?? "",
            propertyType: d.propertyType || "",
            // NEW: counters
            views: Number(d.views || 0),
            likes: Number(d.likes || 0)
          });
        });

        // Paint tiles strictly from Firestore
        const lastQ = (localStorage.getItem('lastSearch') || '').trim();
        renderStrip2TilesFrom(items, lastQ);

        // Fallback: if filter hid everything, show all and clear the stale filter
        if (grid && grid.children.length === 0) {
          try { localStorage.removeItem('lastSearch'); } catch {}
          renderStrip2TilesFrom(items, '');
          if (empty) empty.classList.add('hidden');
        }
      } catch (e) {
        console.warn("[index] Firestore tiles load failed:", e);
        document.getElementById('tilesEmpty')?.classList.remove('hidden');
      }
    })();
  </script>
</body>
</html>
