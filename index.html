<!DOCTYPE html> 
<!-- index.html - Build 2025-11-28 (fix Basic plan default) -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --title-bottom-gap: .75rem;
      --box2-first-input-offset: 0.75rem;
    }

    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* Nav hover */
    .group { position: relative; }
    #commissionMenu { display: none; position: absolute; left: 0; top: 100%; }
    .group:hover #commissionMenu,
    .group:focus-within #commissionMenu,
    .group.nav-open #commissionMenu { display: block; }

    /* --- Strip 2 tile styles --- */
    .gc-tile { background:#fff; border-radius:0.75rem; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.08); }
    .gc-photo { width:100%; height:180px; object-fit:cover; background:#e5e7eb; }
    .gc-ribbon { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.75); color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; }
    .gc-heart { position:absolute; top:10px; right:10px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    .gc-share { position:absolute; bottom:10px; padding:.35rem .6rem; font-size:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.12); }
    .gc-share-left { left:10px; }
    .gc-share-right{ right:10px; }

    #box1, #formBlock, #box3 { overflow: hidden; padding-top: 1rem; }
    .gc-title { text-align:center; font-weight:700; font-size:1.125rem; line-height:1.25; margin-top:0; margin-bottom:var(--title-bottom-gap); }
    .gc-body-top { margin-top: 0.75rem; }

    .gc-form-offset { margin-top: var(--box2-first-input-offset); }

    /* Box 1 FSBO compact mode */
    #box1.fsbo-compact { font-size: 0.75rem; }
    #box1.fsbo-compact .gc-title { font-size: 1rem; }
    #box1.fsbo-compact ul { --tw-space-y-reverse: 0; margin-top: calc(0.5rem * calc(1 - var(--tw-space-y-reverse))); margin-bottom: calc(0.5rem * var(--tw-space-y-reverse)); }
    #box1.fsbo-compact ul > * + * { margin-top: 0.5rem; }
    #box1.fsbo-compact p.text-base { font-size: 0.875rem; }

    #formBlock.compact * { line-height:1.25; }
    #formBlock.compact input, #formBlock.compact select, #formBlock.compact button { padding:.4rem .5rem !important; font-size:.85rem !important; }
    #formBlock.compact .space-y-2 > * { margin-top:.25rem !important; margin-bottom:.25rem !important; }

    #formBlock.compact2 * { line-height:1.2; }
    #formBlock.compact2 input, #formBlock.compact2 select, #formBlock.compact2 button { padding:.35rem .45rem !important; font-size:.8rem !important; }
    #formBlock.compact2 .space-y-2 > * { margin-top:.2rem !important; margin-bottom:.2rem !important; }

    #formBlock.compact3 * { line-height:1.15; }
    #formBlock.compact3 input, #formBlock.compact3 select, #formBlock.compact3 button { padding:.3rem .4rem !important; font-size:.75rem !important; }

    #box3.compact * { line-height:1.35; }
    #box3.compact p { font-size:.95rem; }
    #box3.compact2 * { line-height:1.3; }
    #box3.compact2 p { font-size:.9rem; }
    #box3.compact3 * { line-height:1.25; }
    #box3.compact3 p { font-size:.85rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center gap-3">
        <a href="/local-brokers.html" class="bg-amber-600 hover:bg-amber-700 text-white text-xs font-semibold px-3 py-1 rounded">
          Local Brokers
        </a>
      </div>

      <div class="text-center flex-1">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
        </div>
        <p class="text-base text-red-600 font-semibold mt-1 px-2">
          Guaranteeing commissions so your home will sell quickly at a higher price.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <a href="/local-professionals.html" class="bg-amber-600 text-white text-xs font-semibold px-3 py-1 rounded">Local Professionals</a>
      </div>
    </div>
  </header>

  <div id="investorModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl relative p-5 max-h-[85vh] overflow-auto">
      <button onclick="closeInvestorModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>

      <h2 class="text-lg font-bold">Accredited Investor Certification</h2>
      <p class="text-sm text-gray-600 mb-3">(SEC Rule 501 of Regulation D)</p>

      <form id="investorForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-semibold">Investor Name</label>
            <input id="invName" type="text" class="w-full border rounded px-2 py-1" placeholder="Your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Email</label>
            <input id="invEmail" type="email" class="w-full border rounded px-2 py-1" placeholder="you@example.com" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Phone</label>
            <input id="invPhone" type="tel" class="w-full border rounded px-2 py-1" placeholder="Phone" required>
          </div>
        </div>

        <div class="text-sm space-y-2 mt-2">
          <p><strong>Acknowledgments:</strong></p>
          <p>I understand that GuaranteedCommission.com will rely on this certification in offering and selling securities in compliance with U.S. securities laws.</p>
          <p>I agree to provide further documentation if required to verify my status under Rule 506(c).</p>
          <p>I represent and warrant that the above statements are true and correct.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold">Signature (type full name)</label>
            <input id="invSignature" type="text" class="w-full border rounded px-2 py-1 font-cursive" placeholder="Type your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Date</label>
            <input id="invDate" type="date" class="w-full border rounded px-2 py-1" required>
          </div>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" onclick="closeInvestorModal()" class="px-3 py-2 rounded border">Cancel</button>
          <button id="invSubmitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Submit Certification</button>
        </div>

        <p id="investorConfirmation" class="mt-3 text-green-700 font-semibold text-center hidden">
          Thank you - your Accredited Investor Certification has been prepared.
        </p>
      </form>
    </div>
  </div>

  <div id="pressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
      <button onclick="closePressModal()" class="absolute top-2 right-2 text-xl font-bold">&times;</button>
      <h2 class="text-lg font-bold mb-4">Press Inquiry Form</h2>
      <input type="text" id="pressName" placeholder="Full Name" class="w-full border p-1 mb-2 rounded">
      <input type="text" id="pressOrg" placeholder="Organization" class="w-full border p-1 mb-2 rounded">
      <input type="tel" id="pressPhone" placeholder="Phone" class="w-full border p-1 mb-2 rounded">
      <input type="email" id="pressEmail" placeholder="Email Address" class="w-full border p-1 mb-4 rounded">
      <button onclick="submitPressForm()" class="w-full bg-blue-600 text-white py-2 rounded">Submit</button>
      <p id="pressConfirmation" class="mt-4 text-green-600 font-semibold text-center hidden">We will be in touch.</p>
    </div>
  </div>

  <nav class="bg-gray-200 py-2">
    <ul class="flex justify-center space-x-8 font-semibold">
      <li class="group">
        <span class="hover:underline cursor-pointer" tabindex="0" id="commissionToggle">Communicate Guaranteed Commission</span>
        <ul id="commissionMenu" class="mt-2 w-64 bg-white border shadow text-sm text-gray-700 z-10">
          <li><a href="#" onclick="selectPlan('Listed Property Basic')" class="block px-4 py-2 hover:bg-gray-100">Listed Property Basic</a></li>
          <li><a href="#" onclick="selectPlan('Listed Property Plus')" class="block px-4 py-2 hover:bg-gray-100">Listed Property Plus</a></li>
          <li><a href="#" onclick="selectPlan('FSBO Plus')" class="block px-4 py-2 hover:bg-gray-100">FSBO Plus</a></li>
        </ul>
      </li>
      <li><a href="#strip2Search" class="hover:underline">Search Guaranteed Commission</a></li>
      <li><a href="/login.html" class="hover:underline">Log In</a></li>
    </ul>
  </nav>

  <div style="background-color:#4DA6FF;">
    <section class="flex flex-col md:flex-row justify-center items-start gap-6 px-4 py-8 max-w-7xl mx-auto">
      <div id="box1" class="w-full md:w-1/3 bg-white p-3 rounded shadow text-sm">
        <h2 class="gc-title">Commission Communication Menu</h2>
        <ul class="gc-body-top space-y-3">
          <li>
            <div onclick="selectPlan('Listed Property Basic')" class="cursor-pointer">
              <p class="text-base font-semibold">Listed Property Basic | <span class="text-red-600">FREE</span></p>
              <p class="text-gray-600 pl-5">Printable commission letter, map search, listing price, main photo, address, square footage, bedrooms, bathrooms, listing brokerage, listing agent, listing agent phone number. <span class="text-red-600">(We never sell your information.)</span></p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('Listed Property Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">Listed Property Plus | $20</p>
              <p class="text-gray-600 pl-5">Listed Property Basic plus 20 photos and full property description. <span class="text-red-600">(We never sell your information.)</span></p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('FSBO Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">FSBO Plus | $100</p>
              <p class="text-gray-600 pl-5">Listed Property Plus minus the listing agency. Includes showing instructions. <span class="text-red-600">(Confidential FSBO upgrade available at checkout.)</span></p>
            </div>
          </li>
        </ul>
      </div>

      <div id="formBlock" class="w-full md:w-1/3 bg-white p-4 rounded shadow text-sm compact2">
        <h2 id="formTitle" class="gc-title tracking-tight">Listed Property Communication Form</h2>
        <form id="listingForm" class="space-y-2" autocomplete="off">
          <input type="text" id="name" placeholder="Name" class="w-full border py-1.5 px-2 rounded gc-form-offset" required>
          <input type="text" id="address" placeholder="Address format: Street, City, ST 12345" class="w-full border py-1.5 px-2 rounded" autocomplete="street-address" spellcheck="false" required >
          <input type="text" id="apn" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #" class="w-full border py-1.5 px-2 rounded">

          <div id="listedPhoneRow">
            <input type="tel" id="agentPhone" placeholder="Agent's direct phone only - NOT your number" class="w-full border py-1.5 px-2 rounded">
            <span id="phoneError" class="text-xs text-red-600 hidden">Please enter a valid phone number (###) ###-####</span>
          </div>

          <input type="email" id="agentEmail" placeholder="Agent's Email - NOT your email" class="w-full border py-1.5 px-2 rounded">
          <input type="text" id="brokerage" placeholder="Listing Brokerage" class="w-full border py-1.5 px-2 rounded">
          <input type="text" id="agent" placeholder="Listing Agent" class="w-full border py-1.5 px-2 rounded">

          <div id="fsboEmailRow" class="hidden">
            <input type="email" id="fsboEmailInput" placeholder="Owner/Seller email" class="w-full border py-1.5 px-2 rounded">
          </div>

          <div class="flex gap-2">
            <input type="text" id="commission" placeholder="Buyer Agent Commission" class="w-full border py-1.5 px-2 rounded">
            <select id="commissionType" class="border py-1.5 px-2 rounded">
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>

          <div class="text-center">
            <button type="button" onclick="submitForm()" class="bg-[#4DA6FF] hover:bg-blue-500 text-white px-3 py-2 rounded mt-2 text-sm font-semibold" style="padding: 0.5rem 0.75rem !important; font-size: 0.875rem !important;">
              Submit Guaranteed Commission
            </button>
          </div>
        </form>
      </div>

      <div id="box3" class="w-full md:w-1/3 bg-white p-3 rounded shadow text-sm">
        <h2 class="gc-title">Irrevocable Seller Communication</h2>

        <div id="iscTextListed" class="gc-body-top">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterName">[name]</span>, am the owner/seller of
            <span id="letterAddressFull">[full address]</span>,
            # <span id="letterAPN">[Parcel # / Pin # / Tax ID # / Folio # / APN #]</span>.
            <span id="letterAddressShort1">[short address]</span> is listed for sale by
            <span id="letterBrokerage">[listing brokerage]</span>, <span id="letterAgent">[listing agent]</span>, listing agent,
            <span id="letterAgentPhone">[agent phone]</span>, <span id="letterAgentEmail">[agent email]</span>.
          </p>
          <p class="mt-2">
            Let it be known: if a buyer's agent/broker facilitates the sale of
            <span id="letterAddressShort2">[short address]</span>, you (the escrow holder/closing agent) are irrevocably instructed
            to credit/compensate the buyer's broker - first, by debiting the listing brokerage (if there is an agreement for
            broker-to-broker compensation) and second by debiting me, the seller - a commission not to exceed
            <span id="letterCommissionDisplay">[commission]</span> <span id="commissionSuffix"></span>.
          </p>
          <div class="mt-6 flex items-baseline">
            <span id="signatureName" class="ml-16 font-cursive text-[1.5rem] font-semibold" style="color:#4DA6FF;">[Name]</span>
            <span class="text-[1.5rem] font-semibold ml-auto mr-16" style="color:#4DA6FF;">Date</span>
          </div>
        </div>

        <div id="iscTextFSBO" class="gc-body-top hidden">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterNameFSBO">[name]</span>, am the owner/seller of
            <span id="letterAddressFullFSBO">[full address]</span>, #
            <span id="letterAPNFSBO">[Parcel # / Pin # / Tax ID # / Folio # / APN #]</span>.
            <span id="letterAddressShort1FSBO">[short address]</span> is listed for sale by owner (Me).
            My phone number is <span id="fsboPhone"></span>. My email address is <span id="fsboEmail"></span>.
          </p>
          <p class="mt-2">
            Let it be known: if a buyer's agent/broker facilitates the sale of
            <span id="letterAddressShort2FSBO">[short address]</span>, you (the escrow holder/closing agent) are irrevocably
            instructed to credit/compensate the buyer's broker a commission not to exceed
            <span id="letterCommissionDisplayFSBO">[commission]</span> <span id="commissionSuffixFSBO"></span>.
          </p>
          <div class="mt-6 flex items-baseline">
            <span id="signatureNameFSBO" class="ml-16 font-cursive text-[1.5rem] font-semibold" style="color:#4DA6FF;">[Name]</span>
            <span class="text-[1.5rem] font-semibold ml-auto mr-16" style="color:#4DA6FF;">Date</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div style="background-color:#ffffff;">
    <section id="strip2Search" class="max-w-7xl mx-auto px-4 pb-12 pt-6">
      <div class="text-center mb-4 mt-0">
        <div class="flex items-center justify-center">
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search city, neighborhood, or ZIP..." class="border rounded px-3 py-2 w-72 sm:w-96">
            <button id="searchBtn" class="bg-[#4DA6FF] hover:bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold">Search Guaranteed Commissions</button>
          </div>
        </div>
      </div>

      <div id="tileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-6"></div>
      <p id="tilesEmpty" class="text-sm text-gray-500 text-center hidden mt-6">No listings yet. Create one above, then return here.</p>
    </section>
  </div>

  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-xs text-gray-600 space-y-3">
      <div class="flex justify-center gap-3">
        <button onclick="openPressModal()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-2 rounded">
          Press Inquiry
        </button>
        <button onclick="openInvestorModal()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-2 rounded">
          Accredited Investors Only
        </button>
      </div>
      <p>Â© 2025 GuaranteedCommission.com. All rights reserved.</p>
      <p>Boyd Roberts - California Licensed Real Estate Broker - DRE License #01354788</p>
      <p>
        <a href="/privacy.html" class="hover:underline">Privacy Policy</a> - 
        <a href="/terms.html" class="hover:underline">Terms of Use</a>
      </p>
      <p class="text-[10px] text-gray-400">This platform is a Commission Communication Platform. All purchases subject to quality control review.</p>
    </div>
  </footer>

  <script>
    // Track which plan user explicitly selected this session
    var userSelectedPlanThisSession = null;

    function openInvestorModal(){ document.getElementById('investorModal').classList.remove('hidden'); }
    function closeInvestorModal(){ document.getElementById('investorModal').classList.add('hidden'); }
    function openPressModal(){ document.getElementById('pressModal').classList.remove('hidden'); }
    function closePressModal(){ document.getElementById('pressModal').classList.add('hidden'); }
    function submitPressForm(){ document.getElementById('pressConfirmation').classList.remove('hidden'); }

    (function(){
      var li = document.querySelector('.group');
      var menu = document.getElementById('commissionMenu');
      if (!li || !menu) return;
      var t;
      function open(){ li.classList.add('nav-open'); clearTimeout(t); }
      function close(){ t = setTimeout(function(){li.classList.remove('nav-open');}, 120); }
      li.addEventListener('mouseenter', open);
      li.addEventListener('mouseleave', close);
      menu.addEventListener('mouseenter', open);
      menu.addEventListener('mouseleave', close);
      var toggle = document.getElementById('commissionToggle');
      if(toggle){ toggle.addEventListener('focus', open); toggle.addEventListener('blur', close); }
    })();

    function isValidFullAddress(s) {
      if (!s) return false;
      var re = /^\s*.+?,\s*[A-Za-z .'\-]+,\s*[A-Za-z]{2}\s+\d{5}(?:-\d{4})?\s*$/;
      return re.test(s.trim());
    }

    function selectPlan(planName){
      userSelectedPlanThisSession = planName; // Track explicit selection
      localStorage.setItem("selectedPlan", planName);
      showForm(planName === "FSBO Plus" ? "fsbo" : (planName === "Listed Property Plus" ? "plus" : "listed"));
      setTimeout(fitStrip1, 0);
      setTimeout(fitStrip1, 120);
    }

    function showForm(type){
      var title = document.getElementById("formTitle");
      var phoneInput = document.getElementById('agentPhone');
      var brokerageInput = document.getElementById('brokerage');
      var agentInput = document.getElementById('agent');
      var agentEmailInput = document.getElementById('agentEmail');
      var fsboEmailRow = document.getElementById('fsboEmailRow');
      var listedPhoneRow = document.getElementById('listedPhoneRow');
      var box1 = document.getElementById('box1');

      if(type === 'fsbo'){
        title.textContent = 'FSBO Communication Form';
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = 'Owner/Seller phone number';
        brokerageInput.style.display = 'none';
        agentInput.style.display = 'none';
        agentEmailInput.style.display = 'none';
        fsboEmailRow.classList.remove('hidden');

        document.getElementById('iscTextListed').classList.add('hidden');
        document.getElementById('iscTextFSBO').classList.remove('hidden');
        
        // Make Box 1 smaller in FSBO mode
        box1.classList.add('fsbo-compact');
      } else {
        title.textContent = (type === 'plus' ? 'Listed Property Plus Communication Form' : 'Listed Property Communication Form');
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = "Agent's direct phone only - NOT your number";
        brokerageInput.style.display = 'block';
        agentInput.style.display = 'block';
        agentEmailInput.style.display = 'block';
        fsboEmailRow.classList.add('hidden');

        document.getElementById('iscTextListed').classList.remove('hidden');
        document.getElementById('iscTextFSBO').classList.add('hidden');
        
        // Remove compact styling from Box 1 when not FSBO
        box1.classList.remove('fsbo-compact');
      }
    }

    function fitStrip1(){
      var b1 = document.getElementById('box1');
      var b2 = document.getElementById('formBlock');
      var b3 = document.getElementById('box3');
      if (!b1 || !b2 || !b3) return;

      [b1, b2, b3].forEach(function(b){ b.style.height = 'auto'; });

      var h1 = Math.max(b1.scrollHeight, b1.getBoundingClientRect().height);
      var h2 = Math.max(b2.scrollHeight, b2.getBoundingClientRect().height);
      var h3 = Math.max(b3.scrollHeight, b3.getBoundingClientRect().height);
      var target = Math.max(h1, h2, h3);

      [b1, b2, b3].forEach(function(b){ b.style.height = target + 'px'; });

      function ensureFits(el){
        var tiers = ['compact','compact2','compact3'];
        for (var i=0; i<tiers.length; i++){
          if (el.scrollHeight <= el.clientHeight + 1) return;
          if (!el.classList.contains(tiers[i])) el.classList.add(tiers[i]);
        }
      }
      ensureFits(b2);
      ensureFits(b3);

      var t2 = Math.max(
        b1.scrollHeight, b1.getBoundingClientRect().height,
        b2.scrollHeight, b2.getBoundingClientRect().height,
        b3.scrollHeight, b3.getBoundingClientRect().height
      );
      [b1, b2, b3].forEach(function(b){ b.style.height = t2 + 'px'; });
    }

    (function observeStrip1(){
      var ids = ['box1','formBlock','box3'];
      var els = [];
      for(var i=0;i<ids.length;i++){
        var el = document.getElementById(ids[i]);
        if(el) els.push(el);
      }
      if (!els.length) return;
      var mo = new MutationObserver(function(){ fitStrip1(); });
      for(var j=0;j<els.length;j++){
        mo.observe(els[j], { childList:true, subtree:true, characterData:true });
      }
    })();

    window.addEventListener('DOMContentLoaded', function() {
      // CRITICAL FIX: Always default to Basic on page load
      // This prevents stale "Listed Property Plus" from polluting new listings
      showForm('listed');
      localStorage.setItem('selectedPlan', 'Listed Property Basic');
      console.log('[index] Page load: Reset selectedPlan to Listed Property Basic');

      var phoneInput = document.getElementById('agentPhone');
      var phoneError = document.getElementById('phoneError');
      if(phoneInput){
        phoneInput.addEventListener('input', function(){
          var d = this.value.replace(/\D/g,'').slice(0,10);
          var v = d;
          if (d.length > 6) v = '(' + d.slice(0,3) + ') ' + d.slice(3,6) + '-' + d.slice(6);
          else if (d.length > 3) v = '(' + d.slice(0,3) + ') ' + d.slice(3);
          this.value = v;
          var ok = /^\(\d{3}\)\s\d{3}-\d{4}$/.test(this.value);
          if(phoneError){
            phoneError.classList.toggle('hidden', ok || d.length < 10);
          }
          this.classList.toggle('border-red-500', !ok && d.length === 10);
          syncAll();
          fitStrip1();
        });
      }

      var syncFields = ['name','address','apn','brokerage','agent','agentPhone','agentEmail','commission','commissionType'];
      for(var i=0;i<syncFields.length;i++){
        var el = document.getElementById(syncFields[i]);
        if(el){
          el.addEventListener('input', function(){ syncAll(); fitStrip1(); });
          el.addEventListener('change', function(){ syncAll(); fitStrip1(); });
        }
      }

      function syncAll(){
        var fullAddr = (document.getElementById('address').value || '').trim();
        var short = fullAddr.split(',')[0] || '';
        var nameVal = document.getElementById('name').value || '';
        var apnVal = document.getElementById('apn').value || '';
        var phoneVal = document.getElementById('agentPhone').value || '';
        var brokerageVal = document.getElementById('brokerage').value || '';
        var agentVal = document.getElementById('agent').value || '';
        var agentEmailVal = document.getElementById('agentEmail').value || '';
        var fsboEmailInput = document.getElementById('fsboEmailInput');
        var amount = (document.getElementById('commission').value || '').trim();
        var type = document.getElementById('commissionType').value;
        var suffix = type === '%' ? 'of the total purchase price' : '';
        var display = type === '$' ? (amount ? ('$' + Number(amount).toLocaleString()) : '') : (amount ? amount + '%' : '');

        document.getElementById('letterName').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFull').textContent = fullAddr || '[full address]';
        document.getElementById('letterAPN').textContent = apnVal || '[Parcel # / Pin # / Tax ID # / Folio # / APN #]';
        document.getElementById('letterAddressShort1').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2').textContent = short || '[short address]';
        document.getElementById('letterBrokerage').textContent = brokerageVal || '[listing brokerage]';
        document.getElementById('letterAgent').textContent = agentVal || '[listing agent]';
        document.getElementById('letterAgentPhone').textContent = phoneVal || '[agent phone]';
        document.getElementById('letterAgentEmail').textContent = agentEmailVal || '[agent email]';
        document.getElementById('letterCommissionDisplay').textContent = display || '[commission]';
        document.getElementById('commissionSuffix').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureName').textContent = nameVal || '[Name]';

        document.getElementById('letterNameFSBO').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFullFSBO').textContent = fullAddr || '[full address]';
        document.getElementById('letterAddressShort1FSBO').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2FSBO').textContent = short || '[short address]';
        document.getElementById('letterAPNFSBO').textContent = apnVal || '[Parcel # / Pin # / Tax ID # / Folio # / APN #]';
        document.getElementById('fsboPhone').textContent = phoneVal || '[owner/seller phone number]';
        document.getElementById('fsboEmail').textContent = (fsboEmailInput && fsboEmailInput.value) || '[owner/seller email]';
        document.getElementById('letterCommissionDisplayFSBO').textContent = display || '[commission]';
        document.getElementById('commissionSuffixFSBO').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureNameFSBO').textContent = nameVal || '[Name]';
      }
      syncAll();

      wireSearch();

      fitStrip1();
      setTimeout(fitStrip1, 150);
      window.addEventListener('resize', fitStrip1);
    });

    async function submitForm(){
      var isFSBO = document.getElementById('formTitle').textContent.includes('FSBO');
      var requiredIds = ['name','address','agentPhone'];
      if (isFSBO) { requiredIds.push('apn'); requiredIds.push('fsboEmailInput'); }
      var ok = true;
      for(var i=0;i<requiredIds.length;i++){
        var id = requiredIds[i];
        var el = document.getElementById(id);
        if(!el || !el.value.trim()){ 
          if(el) el.classList.add('border-red-500'); 
          ok = false; 
        } else {
          el.classList.remove('border-red-500');
        }
      }
      if(!ok){ alert('Please complete all required fields.'); return; }

      var addressEl = document.getElementById('address');
      var addrVal = (addressEl.value || '').trim();
      if(!isValidFullAddress(addrVal)){
        addressEl.classList.add('border-red-500');
        alert('Please use full address format: Street, City, ST 12345');
        return;
      } else {
        addressEl.classList.remove('border-red-500');
      }

      // Clear stale session data for new listing
      try {
        var keysToRemove = ['agentListing','checkoutData','intakeFollowups','lastListingAddress','signature','signedISC'];
        for(var k=0;k<keysToRemove.length;k++){
          localStorage.removeItem(keysToRemove[k]);
        }
        var allKeys = Object.keys(localStorage);
        for(var m=0;m<allKeys.length;m++){
          var key = allKeys[m];
          if (key.indexOf('formData:') === 0 || key.indexOf('agentListing:') === 0 || key.indexOf('signedISC:') === 0) {
            localStorage.removeItem(key);
          }
        }
      } catch(e) {}

      var fsboEmailEl = document.getElementById('fsboEmailInput');
      var formData = {
        name: document.getElementById('name').value.trim(),
        address: addrVal,
        apn: document.getElementById('apn').value.trim(),
        commission: document.getElementById('commission').value.trim(),
        commissionType: document.getElementById('commissionType').value,
        phone: document.getElementById('agentPhone').value.trim(),
        brokerage: document.getElementById('brokerage').value.trim(),
        agent: document.getElementById('agent').value.trim(),
        agentEmail: document.getElementById('agentEmail').value.trim(),
        fsboEmail: fsboEmailEl ? fsboEmailEl.value.trim() : ''
      };
      localStorage.setItem("formData", JSON.stringify(formData));
      if(formData.address){
        var short = formData.address.split(',')[0];
        localStorage.setItem('shortAddress', short);
      }
      
      // CRITICAL FIX: Determine plan based on what user explicitly selected THIS SESSION
      // If user didn't click a plan option, default to Basic (for Listed) or FSBO
      var plan;
      if (isFSBO) {
        plan = 'FSBO Plus';
      } else if (userSelectedPlanThisSession === 'Listed Property Plus') {
        plan = 'Listed Property Plus';
      } else {
        // Default to Basic - user either selected Basic or didn't select anything
        plan = 'Listed Property Basic';
      }
      
      // Save the correct plan
      localStorage.setItem('selectedPlan', plan);
      console.log('[index] submitForm: plan =', plan, '(userSelectedPlanThisSession:', userSelectedPlanThisSession, ')');
      
      localStorage.setItem('postSignatureOptions', plan.indexOf('FSBO') >= 0 ? 'fsbo' : 'listed');

      localStorage.setItem('loginOrigin', 'box2');
      localStorage.setItem('nextAfterLogin', '/verify-code.html');

      try {
        var db = window.gc && window.gc.db;
        if (db) {
          var firestore = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          var addDoc = firestore.addDoc;
          var collection = firestore.collection;
          var serverTimestamp = firestore.serverTimestamp;
          var getDocs = firestore.getDocs;
          var query = firestore.query;
          var where = firestore.where;
          var orderBy = firestore.orderBy;
          var limit = firestore.limit;

          var listingsCol = collection(db, "listings");

          var existingId = "";
          try {
            var exactSnap = await getDocs(query(listingsCol, where("address","==", addrVal), limit(5)));
            exactSnap.forEach(function(d){ if (!existingId) existingId = d.id; });
          } catch(e) {}

          if (!existingId) {
            try {
              var recentSnap = await getDocs(query(listingsCol, orderBy("createdAt","desc"), limit(50)));
              var addrLower = addrVal.toLowerCase();
              recentSnap.forEach(function(d){
                var data = d.data() || {};
                var a = (data.address || '').toLowerCase();
                if (!existingId && a === addrLower) existingId = d.id;
              });
            } catch(e) {}
          }

          // Save listing with correct plan
          var payload = {
            address: formData.address,
            shortAddress: (formData.address.split(",")[0] || "").trim(),
            apn: formData.apn || "",
            plan: plan,
            status: "Draft",
            commission: formData.commission || "",
            commissionType: formData.commissionType || "%",
            ownerName: formData.name || "",
            ownerEmail: plan.indexOf('FSBO') >= 0 ? (formData.fsboEmail || "") : "",
            ownerPhone: plan.indexOf('FSBO') >= 0 ? (formData.phone || "") : "",
            agentName:  plan.indexOf('FSBO') >= 0 ? "" : (formData.agent || ""),
            agentPhone: plan.indexOf('FSBO') >= 0 ? "" : (formData.phone || ""),
            agentEmail: plan.indexOf('FSBO') >= 0 ? "" : (formData.agentEmail || ""),
            brokerage:  plan.indexOf('FSBO') >= 0 ? "" : (formData.brokerage || ""),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            source: "index.box2"
          };

          console.log("[index] Saving listing to Firestore with plan:", plan);
          var ref = await addDoc(listingsCol, payload);
          console.log("[index] Listing saved! ID:", ref.id);
          
          localStorage.setItem("lastListingId", ref.id);
          localStorage.setItem("lastListingAddress", payload.address || "");
          localStorage.setItem('formData:' + ref.id, JSON.stringify(formData));
        } else {
          console.warn("[firestore] db not available - skipped server save");
        }
      } catch (err) {
        console.error("[firestore] Save failed:", err);
        alert("Error saving listing. Please try again.");
        return;
      }

      window.location.href = "/login.html";
    }

    function fmtUSD(n){ var v = Number(n||0); return v ? ("$"+v.toLocaleString()) : "$-"; }

    function shareLimitOk() {
      try {
        var day = new Date().toISOString().slice(0,10);
        var key = 'shareCount:' + day;
        var n = Number(localStorage.getItem(key) || 0);
        if (n >= 5) return false;
        localStorage.setItem(key, String(n + 1));
        return true;
      } catch(e) { return true; }
    }
    function buildListingUrlById(id) {
      return window.location.origin + '/listing.html?id=' + encodeURIComponent(id);
    }
    function openEmail(address, url) {
      var subject = encodeURIComponent(address ? 'Listing: ' + address : 'Listing');
      var body = encodeURIComponent((address ? (address + " - ") : "") + 'commission posted with photos.\n\n' + url);
      var a = document.createElement('a');
      a.href = 'mailto:?subject=' + subject + '&body=' + body;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ try { document.body.removeChild(a); } catch(e){} }, 0);
    }
    function openText(address, url) {
      var msg = encodeURIComponent((address ? (address + " - ") : "") + 'commission posted with photos.\n\n' + url);
      window.location.href = 'sms:&body=' + msg;
    }

    function commissionDollars(price, val, type){
      var p = Number(price||0), c = Number(val||0);
      if(!c) return null;
      if(type === '$') return Math.round(c);
      if(p) return Math.round(p*(c/100));
      return null;
    }
    
    function renderTile(data){
      var id = data.id || "";
      var address = data.address || "[full address]";
      var price = data.price;
      var commission = data.commission;
      var commissionType = data.commissionType || "%";
      var bannerText = data.bannerText || "";
      var photos = data.photos || [];
      var primaryIndex = data.primaryIndex || 0;
      var status = data.status || "Active";
      var brokerage = data.brokerage || "[listing brokerage]";
      var agentName = data.agentName || "";
      var agentPhone = data.agentPhone || "";
      var plan = data.plan || "Listed Property Basic";
      var bedrooms = data.bedrooms;
      var bathrooms = data.bathrooms;
      var sqft = data.sqft;
      var propertyType = data.propertyType || "";
      var views = data.views || 0;
      var likes = data.likes || 0;

      var calc = commissionDollars(price, commission, commissionType);
      var line1Left  = fmtUSD(price);
      var line1Mid   = commission ? (commissionType === '%' ? commission + '%' : '$' + Number(commission).toLocaleString()) : '-';
      var line1Right = (calc != null) ? '$' + calc.toLocaleString() : '-';
      var img = (Array.isArray(photos) && photos.length ? photos[primaryIndex||0] : "");
      var typeSeg = propertyType ? ' | ' + propertyType : '';
      var card = document.createElement('article');
      card.className = "gc-tile cursor-pointer";
      card.onclick = function() {
        if (id) {
          window.location.href = '/listing.html?id=' + encodeURIComponent(id);
        } else {
          var slug = encodeURIComponent(address);
          window.location.href = '/listing.html?addr=' + slug;
        }
      };

      var brokerageDisplay = (plan||'').indexOf('FSBO') >= 0 ? 'FOR SALE BY OWNER' : (brokerage||'[listing brokerage]').toUpperCase();
      
      card.innerHTML = 
        '<div class="relative">' +
          '<img class="gc-photo" src="' + (img || '') + '" alt="Listing photo">' +
          (bannerText ? '<div class="gc-ribbon">' + bannerText + '</div>' : '') +
          '<button type="button" class="gc-heart" aria-label="Like">' +
            '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2" aria-hidden="true">' +
              '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>' +
            '</svg>' +
          '</button>' +
          '<button type="button" class="gc-share gc-share-left" data-share="email">Share Email</button>' +
          '<button type="button" class="gc-share gc-share-right" data-share="text">Share Text</button>' +
        '</div>' +
        '<div class="p-3 space-y-2">' +
          '<div class="flex items-center justify-between text-[15px] sm:text-[16px] font-semibold">' +
            '<div class="truncate">' + line1Left + '</div>' +
            '<div class="truncate text-red-600">Commission ' + line1Mid + ' | ' + line1Right + '</div>' +
          '</div>' +
          '<div class="text-[12px] text-gray-700">' +
            (bedrooms != null ? bedrooms : '-') + ' bds | ' + (bathrooms != null ? bathrooms : '-') + ' ba | ' + (sqft ? Number(sqft).toLocaleString() : '-') + ' sqft' + typeSeg + ' | ' + status +
          '</div>' +
          '<div class="text-sm font-medium">' + address + '</div>' +
          '<div class="text-[12px] text-gray-600">' +
            brokerageDisplay + (agentName ? ' - ' + agentName : '') + (agentPhone ? ' - ' + agentPhone : '') +
          '</div>' +
          '<div class="text-[12px] text-gray-500 text-center" data-stats>' +
            'Viewed ' + Number(views||0).toLocaleString() + ' time' + (Number(views||0)===1?'':'s') + ' | Liked ' + Number(likes||0).toLocaleString() + ' time' + (Number(likes||0)===1?'':'s') +
          '</div>' +
        '</div>';

      var heart = card.querySelector(".gc-heart");
      var statsEl = card.querySelector("[data-stats]");
      if (heart) {
        var KEY = 'gcFavorites';
        var favs = function(){ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch(e) { return []; } };
        var setF = function(a){ try { localStorage.setItem(KEY, JSON.stringify(a||[])); } catch(e) {} };
        var isFav = function(id2){ return favs().indexOf(id2) >= 0; };
        var tog = function(id2){ var a=favs(); var i=a.indexOf(id2); if(i>=0)a.splice(i,1); else a.push(id2); setF(a); return a.indexOf(id2)>=0; };
        var svg = function(a){ return a
          ? '<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>'
          : '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>';
        };
        var favId = 'fav:' + (id || address);
        heart.innerHTML = svg(isFav(favId));
        heart.addEventListener("click", async function(e){
          e.preventDefault(); e.stopPropagation();
          var nowLiked = tog(favId);
          heart.innerHTML = svg(nowLiked);

          if (id && nowLiked) {
            var onceKey = 'likedOnce:' + id;
            if (!localStorage.getItem(onceKey) && window.gcIncLike) {
              try {
                await window.gcIncLike(id);
                localStorage.setItem(onceKey,'1');
                var currentLikes = Number(likes||0) + 1;
                var v = Number(views||0);
                if (statsEl) {
                  statsEl.textContent = 'Viewed ' + v.toLocaleString() + ' time' + (v===1?'':'s') + ' | Liked ' + currentLikes.toLocaleString() + ' time' + (currentLikes===1?'':'s');
                }
              } catch(err) {}
            }
          }
        });
      }

      var emailBtn = card.querySelector('[data-share="email"]');
      var textBtn  = card.querySelector('[data-share="text"]');
      var shareUrl = id ? (window.location.origin + '/listing.html?id=' + encodeURIComponent(id))
                        : (window.location.origin + '/listing.html?addr=' + encodeURIComponent(address));

      if (emailBtn) {
        emailBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          if (!shareLimitOk()) return;
          openEmail(address, shareUrl);
        });
      }
      if (textBtn) {
        textBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          if (!shareLimitOk()) return;
          openText(address, shareUrl);
        });
      }

      return card;
    }

    function renderStrip2TilesFrom(list, filterText){
      filterText = filterText || "";
      var grid = document.getElementById('tileGrid');
      var empty = document.getElementById('tilesEmpty');
      grid.innerHTML = '';
      var q = (filterText || '').toLowerCase();
      var arr = q ? list.filter(function(d){ return (String(d.address||'').toLowerCase().indexOf(q) >= 0); }) : list;
      if (!arr.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      for(var i=0;i<arr.length;i++){
        grid.appendChild(renderTile(arr[i]));
      }
    }

    function wireSearch(){
      var box = document.getElementById('searchBox');
      var btn = document.getElementById('searchBtn');
      var go = function() {
        var q = (box.value || '').trim();
        localStorage.setItem('lastSearch', q);
        if (!q) { return; }
        window.location.href = '/search.html?q=' + encodeURIComponent(q);
      };
      btn.addEventListener('click', go);
      box.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); go(); }});
    }
  </script>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.gcIncLike = async function(listingId) {
      var db = (window.gc && window.gc.db);
      if (!db || !listingId) return;
      await updateDoc(doc(db, "listings", listingId), { likes: increment(1), updatedAt: serverTimestamp() });
    };
  </script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    (async function loadTilesFromFirestore(){
      try {
        var grid  = document.getElementById('tileGrid');
        var empty = document.getElementById('tilesEmpty');
        if (!grid || !db) return;

        var snap = await getDocs(query(collection(db, "listings"), orderBy("createdAt","desc"), limit(100)));
        var items = [];
        snap.forEach(function(docu) {
          var d = docu.data() || {};
          if (d.archived === true) return;

          var signed = !!(d.signedISC && typeof d.signedISC === 'object' && d.signedISC.date);
          var isActive = String(d.status || '').toLowerCase() === 'active';
          if (!signed && !isActive) return;

          items.push({
            id: docu.id,
            address: d.address || "",
            price: d.price != null ? d.price : "",
            commission: d.commission != null ? d.commission : "",
            commissionType: d.commissionType || "%",
            bannerText: d.bannerText || "",
            photos: Array.isArray(d.photos) ? d.photos : [],
            primaryIndex: (typeof d.primaryIndex === "number" ? d.primaryIndex : 0),
            status: d.status || "Active",
            brokerage: d.brokerage || "",
            agentName: d.agentName || "",
            agentPhone: d.agentPhone || "",
            plan: d.plan || "Listed Property Basic",
            bedrooms: d.bedrooms != null ? d.bedrooms : "",
            bathrooms: d.bathrooms != null ? d.bathrooms : "",
            sqft: d.sqft != null ? d.sqft : "",
            propertyType: d.propertyType || "",
            views: Number(d.views || 0),
            likes: Number(d.likes || 0)
          });
        });

        var lastQ = (localStorage.getItem('lastSearch') || '').trim();
        renderStrip2TilesFrom(items, lastQ);

        if (grid && grid.children.length === 0) {
          try { localStorage.removeItem('lastSearch'); } catch(e) {}
          renderStrip2TilesFrom(items, '');
          if (empty) empty.classList.add('hidden');
        }
      } catch (e) {
        console.warn("[index] Firestore tiles load failed:", e);
        var emptyEl = document.getElementById('tilesEmpty');
        if(emptyEl) emptyEl.classList.remove('hidden');
      }
    })();
  </script>
</body>
</html>
