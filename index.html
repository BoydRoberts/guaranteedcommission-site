<!DOCTYPE html>
<!-- index.html - Build 2026-01-02 (Task A: Shared tile renderer) -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --title-bottom-gap: .75rem;
      --box2-first-input-offset: 0.75rem;
    }

    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* --- Strip 2 tile styles (shared with tile-renderer.js) --- */
    .gc-tile { background:#fff; border-radius:0.75rem; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.08); }
    .gc-photo { width:100%; height:180px; object-fit:cover; background:#e5e7eb; }
    .gc-ribbon { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.75); color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; }
    .gc-heart { position:absolute; top:10px; right:10px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); border:none; cursor:pointer; }

    .gc-share { position:absolute; bottom:10px; padding:.35rem .6rem; font-size:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.12); cursor:pointer; }
    .gc-share-left { left:10px; }
    .gc-share-right{ right:10px; }

    #box1, #formBlock, #box3 { overflow: hidden; padding-top: 1rem; }
    .gc-title { text-align:center; font-weight:700; font-size:1.125rem; line-height:1.25; margin-top:0; margin-bottom:var(--title-bottom-gap); }
    .gc-body-top-box1 { margin-top: calc(var(--box2-first-input-offset) - 12px); }
    .gc-body-top-box3 { margin-top: calc(var(--box2-first-input-offset) - 12px); }

    .gc-form-offset { margin-top: var(--box2-first-input-offset); }

    /* Box 1 FSBO compact mode */
    #box1.fsbo-compact { font-size: 0.75rem; }
    #box1.fsbo-compact .gc-title { font-size: 1.125rem; }
    #box1.fsbo-compact ul { --tw-space-y-reverse: 0; margin-bottom: calc(0.5rem * var(--tw-space-y-reverse)); }
    #box1.fsbo-compact ul > * + * { margin-top: 0.5rem; }
    #box1.fsbo-compact p.text-base { font-size: 0.875rem; }

    /* Box 1: justified text with minimal spacing */
    #box1 p { text-align: justify; hyphens: auto; }

    /* Box 3: justified ISC text by default */
    #box3 p { text-align: justify; hyphens: auto; }

    /* Box 3: switch to left-aligned when user starts typing */
    #box3.typing p { text-align: left; hyphens: none; }

    /* Only break overly long emails when necessary to prevent overflow */
    #fsboEmail { overflow-wrap: break-word; }

    #formBlock.compact * { line-height:1.25; }
    #formBlock.compact input, #formBlock.compact select, #formBlock.compact button { padding:.4rem .5rem !important; font-size:.85rem !important; }
    #formBlock.compact .space-y-2 > * { margin-top:.25rem !important; margin-bottom:.25rem !important; }

    #formBlock.compact2 * { line-height:1.2; }
    #formBlock.compact2 input, #formBlock.compact2 select, #formBlock.compact2 button { padding:.35rem .45rem !important; font-size:.8rem !important; }
    #formBlock.compact2 .space-y-2 > * { margin-top:.2rem !important; margin-bottom:.2rem !important; }

    #formBlock.compact3 * { line-height:1.15; }
    #formBlock.compact3 input, #formBlock.compact3 select, #formBlock.compact3 button { padding:.3rem .4rem !important; font-size:.75rem !important; }

    #box3.compact * { line-height:1.35; }
    #box3.compact p { font-size:.95rem; }
    #box3.compact2 * { line-height:1.3; }
    #box3.compact2 p { font-size:.9rem; }
    #box3.compact3 * { line-height:1.25; }
    #box3.compact3 p { font-size:.85rem; }

    /* --- Header YouTube video styling --- */
    #headerVideoFrame {
      border: 0;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,.12);
      background: #000;
    }

    /* Mobile: full-width 16:9 video, centered */
    @media (max-width: 767px) {
      #headerVideoWrap { display:flex; justify-content:center; }
      #headerVideoFrame {
        width: 100% !important;
        height: auto !important;
        aspect-ratio: 16 / 9;
        max-width: 100%;
      }
    }

    /* --- Header Counter Box (mirrors video/listing tile styling) --- */
    #headerCounterBox {
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 1px 6px rgba(0,0,0,.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Allow label to overflow container width */
    #headerCounterWrap > div {
      overflow: visible;
    }

    /* Rolling number animation container */
    .gc-counter-digit {
      display: inline-block;
      overflow: hidden;
      height: 1.5em;
      line-height: 1.5em;
      vertical-align: bottom;
    }

    .gc-counter-digit-inner {
      display: inline-block;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gc-counter-digit-inner.rolling {
      animation: rollUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes rollUp {
      0% {
        transform: translateY(100%);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Mobile: counter stacks below, centered */
    @media (max-width: 767px) {
      #headerCounterWrap {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
      }
      #headerCounterWrap > div {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: auto !important;
      }
      #headerCounterBox {
        padding: 0.75rem 1.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- HEADER: Title truly centered; video left, counter right (absolute positioned) -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 md:relative">

      <!-- TITLE BLOCK: Always truly centered (determines header height) -->
      <div class="text-center" id="headerTitleBlock">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>

      <!-- VIDEO: Below title on mobile; absolute left on desktop (aligns with Box 1) -->
      <div id="headerVideoWrap"
           class="mt-4 md:mt-0 md:absolute md:left-4 md:top-1/2 md:-translate-y-1/2"
           aria-label="Header video">
        <div>
          <iframe
            id="headerVideoFrame"
            title="GuaranteedCommission.com video"
            src="https://www.youtube.com/embed/3PtTT17ILXY?rel=0&modestbranding=1"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          ></iframe>
          <div class="mt-1 text-[8px] font-semibold tracking-widest leading-none text-center" style="color:#4DA6FF;">
            FOUNDER'S MESSAGE
          </div>
        </div>
      </div>

      <!-- COUNTER: Below video on mobile; absolute right on desktop (aligns with Box 3) -->
      <div id="headerCounterWrap"
           class="md:absolute md:right-4 md:top-1/2 md:-translate-y-1/2"
           aria-label="Guaranteed commissions counter">
        <div class="flex flex-col items-center">
          <div id="headerCounterBox">
            <span id="counterDisplay" class="text-2xl font-bold text-gray-800">0</span>
          </div>
          <div class="mt-1 text-[8px] font-semibold tracking-widest leading-none whitespace-nowrap" style="color:#4DA6FF;">
            GUARANTEED COMMISSIONS
          </div>
        </div>
      </div>

    </div>
  </header>

  <div id="investorModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl relative p-5 max-h-[85vh] overflow-auto">
      <button onclick="closeInvestorModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>
      <h2 class="text-lg font-bold">Accredited Investor Certification</h2>
      <p class="text-sm text-gray-600 mb-3">(SEC Rule 501 of Regulation D)</p>
      <form id="investorForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-semibold">Investor Name</label>
            <input id="invName" type="text" class="w-full border rounded px-2 py-1" placeholder="Your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Email</label>
            <input id="invEmail" type="email" class="w-full border rounded px-2 py-1" placeholder="you@example.com" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Phone</label>
            <input id="invPhone" type="tel" class="w-full border rounded px-2 py-1" placeholder="Phone" required>
          </div>
        </div>
        <div class="text-sm space-y-2 mt-2">
          <p><strong>Acknowledgments:</strong></p>
          <p>I understand that GuaranteedCommission.com will rely on this certification in offering and selling securities in compliance with U.S. securities laws.</p>
          <p>I agree to provide further documentation if required to verify my status under Rule 506(c).</p>
          <p>I represent and warrant that the above statements are true and correct.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold">Signature (type full name)</label>
            <input id="invSignature" type="text" class="w-full border rounded px-2 py-1 font-cursive" placeholder="Type your full name" required>
          </div>
          <div>
            <label class="block text-sm font-semibold">Date</label>
            <input id="invDate" type="date" class="w-full border rounded px-2 py-1" required>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2">
          <button type="button" onclick="closeInvestorModal()" class="px-3 py-2 rounded border">Cancel</button>
          <button id="invSubmitBtn" type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Submit Certification</button>
        </div>
        <p id="investorConfirmation" class="mt-3 text-green-700 font-semibold text-center hidden">
          Thank you - your Accredited Investor Certification has been prepared.
        </p>
      </form>
    </div>
  </div>

  <div id="pressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
      <button onclick="closePressModal()" class="absolute top-2 right-2 text-xl font-bold">&times;</button>
      <h2 class="text-lg font-bold mb-4">Press Inquiry Form</h2>
      <input type="text" id="pressName" placeholder="Full Name" class="w-full border p-1 mb-2 rounded">
      <input type="text" id="pressOrg" placeholder="Organization" class="w-full border p-1 mb-2 rounded">
      <input type="tel" id="pressPhone" placeholder="Phone" class="w-full border p-1 mb-2 rounded">
      <input type="email" id="pressEmail" placeholder="Email Address" class="w-full border p-1 mb-4 rounded">
      <button onclick="submitPressForm()" class="w-full bg-blue-600 text-white py-2 rounded">Submit</button>
      <p id="pressConfirmation" class="mt-4 text-green-600 font-semibold text-center hidden">We will be in touch.</p>
    </div>
  </div>

  <nav class="bg-gray-200 py-2">
    <ul class="flex justify-center space-x-8 font-semibold">
      <li><a href="/advertise.html" class="hover:underline" style="color:#4DA6FF;">Advertise</a></li>
      <li><a href="/login.html" class="hover:underline" style="color:#4DA6FF;">Log In</a></li>
    </ul>
  </nav>

  <div style="background-color:#4DA6FF;">
    <section class="flex flex-col md:flex-row justify-center items-start gap-6 px-4 py-8 max-w-7xl mx-auto">
      <!-- BOX 1 -->
      <div id="box1" class="w-full md:w-1/3 bg-white p-4 rounded shadow text-sm flex flex-col">
        <h2 class="gc-title">Commission Communication Menu</h2>
        <ul class="gc-body-top-box1 space-y-3 flex-1">
          <li>
            <div onclick="selectPlan('Listed Property Basic')" class="cursor-pointer">
              <p class="text-base font-semibold">
                Listed Property Basic | <span class="text-red-600">FREE</span>
              </p>
              <p class="text-gray-600 pl-5">
                Printable commission letter, map search, listing price, main photo, address, square footage, bedrooms, bathrooms, listing brokerage, listing agent, listing agent phone number.
                <span class="text-red-600">(We never sell your information.)</span>
              </p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('Listed Property Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">Listed Property Plus | $20</p>
              <p class="text-gray-600 pl-5">
                Listed Property Basic plus 20 photos and full property description.
                <span class="text-red-600">(We never sell your information.)</span>
              </p>
            </div>
          </li>
          <li>
            <div onclick="selectPlan('FSBO Plus')" class="cursor-pointer">
              <p class="text-base font-semibold">FSBO Plus | $100</p>
              <p class="text-gray-600 pl-5">
                Listed Property Plus minus the listing agency. Can include showing instructions.
                <span class="text-red-600">(Confidential FSBO upgrade available at checkout.)</span>
              </p>
            </div>
          </li>
        </ul>
      </div>

      <!-- BOX 2 -->
      <div id="formBlock" class="w-full md:w-1/3 bg-white p-4 rounded shadow text-sm compact2 flex flex-col">
        <h2 id="formTitle" class="gc-title tracking-tight">Listed Property Communication Form</h2>
        <form id="listingForm" class="space-y-2 flex flex-col flex-1" autocomplete="off">
          <input type="text" id="name" placeholder="Owner/Seller Name" class="w-full border py-1.5 px-2 rounded gc-form-offset" required>
          <input type="text" id="address" placeholder="Full Property Address (Street, City, ST 12345)" class="w-full border py-1.5 px-2 rounded" autocomplete="street-address" spellcheck="false" required>

          <div id="apnRow" class="hidden">
            <input type="text" id="apn" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #" class="w-full border py-1.5 px-2 rounded">
          </div>

          <input type="text" id="agent" placeholder="Listing Agent" class="w-full border py-1.5 px-2 rounded">
          <input type="text" id="brokerage" placeholder="Listing Brokerage" class="w-full border py-1.5 px-2 rounded">

          <div id="listedPhoneRow">
            <input type="tel" id="agentPhone" placeholder="Agent Phone - NOT Your Phone" class="w-full border py-1.5 px-2 rounded">
            <span id="phoneError" class="text-xs text-red-600 hidden">
              Please enter a valid phone number (###) ###-####</span>
          </div>

          <input type="email" id="agentEmail" placeholder="Agent Email - NOT Your Email" class="w-full border py-1.5 px-2 rounded">

          <div id="fsboEmailRow" class="hidden">
            <input type="email" id="fsboEmailInput" placeholder="Owner/Seller email" class="w-full border py-1.5 px-2 rounded">
          </div>

          <div class="flex gap-2">
            <input type="text" id="commission" placeholder="Buyer Agent Commission" class="w-full border py-1.5 px-2 rounded">
            <select id="commissionType" class="border py-1.5 px-2 rounded">
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>

          <div class="text-center mt-auto">
            <button type="button" onclick="submitForm()"
                    class="bg-[#4DA6FF] hover:bg-blue-500 text-white px-3 py-2 rounded mt-2 text-sm font-semibold"
                    style="padding: 0.5rem 0.75rem !important; font-size: 0.875rem !important;">
              Submit Guaranteed Commission
            </button>
          </div>
        </form>
      </div>

      <!-- BOX 3 -->
      <div id="box3" class="w-full md:w-1/3 bg-white p-4 rounded shadow text-sm flex flex-col">
        <h2 class="gc-title">Irrevocable Seller Communication</h2>

        <div id="iscTextListed" class="gc-body-top-box3 flex flex-col flex-1">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterName">[name]</span>, am the owner/seller of
            <span id="letterAddressFull">[full address]</span>.
            <span id="letterAddressShort1">[short address]</span> is listed for sale.
            <span id="letterAgent">[listing agent]</span> with <span id="letterBrokerage">[listing brokerage]</span> is the listing agent.
          </p>
          <p class="mt-2">
            Let it be known: if a buyer's agent/broker facilitates the sale of
            <span id="letterAddressShort2">[short address]</span>, you (the escrow holder/closing agent) are irrevocably instructed
            to credit/compensate the buyer's broker - first, by debiting the listing brokerage (if there is an agreement for
            broker-to-broker compensation) and second by debiting me, the seller - a commission equal to
            <span id="letterCommissionDisplay">[commission]</span><span id="commissionSuffix"></span>.
          </p>
          <div class="mt-auto flex items-baseline justify-center gap-8">
            <span id="signatureName"
                  class="font-cursive text-[1.5rem] font-semibold"
                  style="color:#4DA6FF; transform: translateY(-8px); display: inline-block; margin-left: -2rem;">[Name]</span>
            <span id="signatureDate" class="text-[1.5rem] font-semibold"
                  style="color:#4DA6FF; font-size: 1.2rem; transform: translateY(-6px); display: inline-block; margin-right: -2rem;">Date</span>
          </div>
        </div>

        <div id="iscTextFSBO" class="gc-body-top-box3 hidden flex flex-col flex-1">
          <p>To the escrow holder/closing agent,</p>
          <p class="mt-2">
            I, <span id="letterNameFSBO">[name]</span>, am the owner/seller of
            <span id="letterAddressFullFSBO">[full address]</span>, #
            <span id="letterAPNFSBO">[Parcel # / Pin # / Tax ID # / Folio # / APN #]</span>.
            <span id="letterAddressShort1FSBO">[short address]</span> is listed for sale by owner (Me):
            <span id="fsboPhone">[owner/seller phone number]</span>, <span id="fsboEmail">[owner/seller email]</span>.
          </p>
          <p class="mt-2">
            Let it be known: if a buyer's agent/broker facilitates the sale of
            <span id="letterAddressShort2FSBO">[short address]</span>, you (the escrow holder/closing agent) are irrevocably
            instructed to credit/compensate the buyer's broker a commission equal to
            <span id="letterCommissionDisplayFSBO">[commission]</span><span id="commissionSuffixFSBO"></span>.
          </p>
          <div class="mt-auto flex items-baseline justify-center gap-8">
            <span id="signatureNameFSBO"
                  class="font-cursive text-[1.5rem] font-semibold"
                  style="color:#4DA6FF; transform: translateY(-8px); display: inline-block; margin-left: -2rem;">[Name]</span>
            <span id="signatureDateFSBO" class="text-[1.5rem] font-semibold"
                  style="color:#4DA6FF; font-size: 1.2rem; transform: translateY(-6px); display: inline-block; margin-right: -2rem;">Date</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div style="background-color:#ffffff;">
    <section id="strip2Search" class="max-w-7xl mx-auto px-4 pb-12 pt-6">
      <div class="text-center mb-4 mt-0">
        <div class="flex items-center justify-center">
          <div class="flex items-center gap-2">
            <input id="searchBox" type="text" placeholder="Search city, neighborhood, or ZIP..." class="border rounded px-3 py-2 w-72 sm:w-96">
            <button id="searchBtn" class="bg-[#4DA6FF] hover:bg-blue-500 text-white px-3 py-2 rounded text-sm font-semibold">Search Guaranteed Commissions</button>
          </div>
        </div>
      </div>
      <div id="tileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mt-6"></div>
      <p id="tilesEmpty" class="text-sm text-gray-500 text-center hidden mt-6">No listings yet. Create one above, then return here.</p>
    </section>
  </div>

  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-xs text-gray-600 space-y-3">
      <div class="flex justify-center gap-3">
        <button onclick="openPressModal()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-2 rounded">
          Press Inquiry
        </button>
        <button onclick="openInvestorModal()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-2 rounded">
          Accredited Investors Only
        </button>
      </div>
      <p>© 2025 GuaranteedCommission.com. All rights reserved.</p>
      <p>Boyd Roberts - California Licensed Real Estate Broker - DRE License #01354788</p>
      <p>
        <a href="/privacy.html" class="hover:underline">Privacy Policy</a> -
        <a href="/terms.html" class="hover:underline">Terms of Use</a>
      </p>
      <p class="text-[10px] text-gray-400">This platform is a Commission Communication Platform. All purchases subject to quality control review.</p>
    </div>
  </footer>

  <!-- ====================================================================
       INLINE SCRIPT: Form logic, plan selection, ISC sync, modals, layout
       NOTE: Tile rendering moved to /scripts/tile-renderer.js
       ==================================================================== -->
  <script>
    // Track which plan user explicitly selected this session
    var userSelectedPlanThisSession = null;

    function tabInitialized() {
      try { return sessionStorage.getItem("gc_home_initialized") === "1"; }
      catch(e) { return false; }
    }
    function markTabInitialized() {
      try { sessionStorage.setItem("gc_home_initialized", "1"); } catch(e) {}
    }

    function cameFromFlow() {
      try {
        const ref = document.referrer || "";
        return /\/(login|verify|verify-code|checkout|upsell|signature|seller-detail|agent-detail|agent-invite|listing|search)\.html/i.test(ref);
      } catch(e) {
        return false;
      }
    }

    function hasActiveFlowState() {
      try {
        if (localStorage.getItem("lastListingId")) return true;

        const raw = localStorage.getItem("checkoutData");
        if (raw) {
          try {
            const obj = JSON.parse(raw);
            const hasUpgrades = obj && obj.upgrades && Object.values(obj.upgrades).some(Boolean);
            if (hasUpgrades) return true;
          } catch(e) {}
        }

        if (localStorage.getItem("nextAfterLogin")) return true;
        if (localStorage.getItem("loginOrigin")) return true;

        return false;
      } catch(e) { return false; }
    }

    function planToFormMode(plan) {
      if (plan === "FSBO Plus") return "fsbo";
      if (plan === "Listed Property Plus") return "plus";
      return "listed";
    }

    function getStoredPlan() {
      const p = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
      return (p === "FSBO Plus" || p === "Listed Property Plus" || p === "Listed Property Basic") ? p : "Listed Property Basic";
    }

    function setPlan(planName, isUserAction) {
      localStorage.setItem("selectedPlan", planName);
      if (isUserAction === true) {
        userSelectedPlanThisSession = planName;
        try { sessionStorage.setItem("gc_user_selected_plan", planName); } catch(e) {}
      }
    }

    function openInvestorModal(){ document.getElementById('investorModal').classList.remove('hidden'); }
    function closeInvestorModal(){ document.getElementById('investorModal').classList.add('hidden'); }

    function openPressModal(){ document.getElementById('pressModal').classList.remove('hidden'); }
    function closePressModal(){ document.getElementById('pressModal').classList.add('hidden'); }
    function submitPressForm(){ document.getElementById('pressConfirmation').classList.remove('hidden'); }

    function isValidFullAddress(s) {
      if (!s) return false;
      var re = /^\s*.+?,\s*[A-Za-z .'\-]+,\s*[A-Za-z]{2}\s+\d{5}(?:-\d{4})?\s*$/;
      return re.test(s.trim());
    }

    function getDeviceKey() {
      try {
        var k = localStorage.getItem("gcDeviceKey");
        if (!k) {
          var c = (typeof window !== "undefined") ? window.crypto : null;
          if (c && typeof c.randomUUID === "function") k = c.randomUUID();
          else k = "dk_" + Math.random().toString(16).slice(2) + Date.now();
          localStorage.setItem("gcDeviceKey", k);
        }
        return k;
      } catch(e) { return "dk_fallback"; }
    }

    function selectPlan(planName){
      setPlan(planName, true);
      showForm(planToFormMode(planName));
      setTimeout(fitStrip1, 0);
      setTimeout(fitStrip1, 120);
    }

    function showForm(type){
      var title = document.getElementById("formTitle");
      var phoneInput = document.getElementById('agentPhone');
      var brokerageInput = document.getElementById('brokerage');
      var agentInput = document.getElementById('agent');
      var agentEmailInput = document.getElementById('agentEmail');
      var fsboEmailRow = document.getElementById('fsboEmailRow');
      var listedPhoneRow = document.getElementById('listedPhoneRow');
      var box1 = document.getElementById('box1');
      var apnRow = document.getElementById('apnRow');

      if(type === 'fsbo'){
        title.textContent = 'FSBO Communication Form';
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = 'Owner/Seller phone number';
        brokerageInput.style.display = 'none';
        agentInput.style.display = 'none';
        agentEmailInput.style.display = 'none';
        fsboEmailRow.classList.remove('hidden');
        if (apnRow) apnRow.classList.remove('hidden');

        document.getElementById('iscTextListed').classList.add('hidden');
        document.getElementById('iscTextFSBO').classList.remove('hidden');

        box1.classList.add('fsbo-compact');
      } else {
        title.textContent = (type === 'plus' ? 'Listed Property Plus Communication Form' : 'Listed Property Communication Form');
        listedPhoneRow.classList.remove('hidden');
        phoneInput.placeholder = "Agent Phone - NOT Your Phone";
        brokerageInput.style.display = 'block';
        agentInput.style.display = 'block';
        agentEmailInput.style.display = 'block';
        fsboEmailRow.classList.add('hidden');
        if (apnRow) apnRow.classList.add('hidden');

        document.getElementById('iscTextListed').classList.remove('hidden');
        document.getElementById('iscTextFSBO').classList.add('hidden');

        box1.classList.remove('fsbo-compact');
      }
    }

    function fitStrip1(){
      var b1 = document.getElementById('box1');
      var b2 = document.getElementById('formBlock');
      var b3 = document.getElementById('box3');
      if (!b1 || !b2 || !b3) return;

      [b1, b2, b3].forEach(function(b){ b.style.height = 'auto'; });

      var h1 = Math.max(b1.scrollHeight, b1.getBoundingClientRect().height);
      var h2 = Math.max(b2.scrollHeight, b2.getBoundingClientRect().height);
      var h3 = Math.max(b3.scrollHeight, b3.getBoundingClientRect().height);
      var target = Math.max(h1, h2, h3);

      [b1, b2, b3].forEach(function(b){ b.style.height = target + 'px'; });

      function ensureFits(el){
        var tiers = ['compact','compact2','compact3'];
        for (var i=0; i<tiers.length; i++){
          if (el.scrollHeight <= el.clientHeight + 1) return;
          if (!el.classList.contains(tiers[i])) el.classList.add(tiers[i]);
        }
      }
      ensureFits(b2);
      ensureFits(b3);

      var t2 = Math.max(
        b1.scrollHeight, b1.getBoundingClientRect().height,
        b2.scrollHeight, b2.getBoundingClientRect().height,
        b3.scrollHeight, b3.getBoundingClientRect().height
      );
      [b1, b2, b3].forEach(function(b){ b.style.height = t2 + 'px'; });
    }

    (function observeStrip1(){
      var ids = ['box1','formBlock','box3'];
      var els = [];
      for(var i=0;i<ids.length;i++){
        var el = document.getElementById(ids[i]);
        if(el) els.push(el);
      }
      if (!els.length) return;

      var mo = new MutationObserver(function(){ fitStrip1(); });
      for(var j=0;j<els.length;j++){
        mo.observe(els[j], { childList:true, subtree:true, characterData:true });
      }
    })();

    function sizeHeaderVideo(){
      try {
        var frame = document.getElementById('headerVideoFrame');
        var counterBox = document.getElementById('headerCounterBox');
        var titleBlock = document.getElementById('headerTitleBlock');
        
        if (!frame || !titleBlock) return;

        if (window.innerWidth < 768) {
          frame.style.width = '';
          frame.style.height = '';
          if (counterBox) {
            counterBox.style.width = '';
            counterBox.style.height = '';
          }
          return;
        }

        var h = Math.round(titleBlock.getBoundingClientRect().height);
        if (!h || h < 40) return;

        var w = Math.round(h * (16 / 9));

        frame.style.height = h + 'px';
        frame.style.width = w + 'px';

        // Size counter box to exactly match video
        if (counterBox) {
          counterBox.style.height = h + 'px';
          counterBox.style.width = w + 'px';
        }
      } catch(e) { console.warn('[sizeHeaderVideo]', e); }
    }

    window.addEventListener('DOMContentLoaded', function() {
      const returning = cameFromFlow() || hasActiveFlowState();
      const alreadyInit = tabInitialized();

      if (!alreadyInit && !returning) {
        setPlan("Listed Property Basic", false);
        showForm("listed");
        console.log("[index] Fresh start → selectedPlan=Listed Property Basic (no explicit selection)");
      } else {
        let explicit = "";
        try { explicit = (sessionStorage.getItem("gc_user_selected_plan") || "").trim(); } catch(e) {}

        const validPlans = ["Listed Property Basic", "Listed Property Plus", "FSBO Plus"];
        const isValid = validPlans.indexOf(explicit) >= 0;

        if (isValid) {
          setPlan(explicit, true);
          showForm(planToFormMode(explicit));
          console.log("[index] Return → restored explicit selection from sessionStorage:", explicit);
        } else {
          showForm("listed");
          console.log("[index] Return → no explicit selection, defaulting UI to Basic");
        }
      }

      markTabInitialized();

      sizeHeaderVideo();
      setTimeout(sizeHeaderVideo, 80);

      var phoneInput = document.getElementById('agentPhone');
      var phoneError = document.getElementById('phoneError');
      if(phoneInput){
        phoneInput.addEventListener('input', function(){
          var d = this.value.replace(/\D/g,'').slice(0,10);
          var v = d;
          if (d.length > 6) v = '(' + d.slice(0,3) + ') ' + d.slice(3,6) + '-' + d.slice(6);
          else if (d.length > 3) v = '(' + d.slice(0,3) + ') ' + d.slice(3);
          this.value = v;

          var ok = /^\(\d{3}\)\s\d{3}-\d{4}$/.test(this.value);
          if(phoneError){
            phoneError.classList.toggle('hidden', ok || d.length < 10);
          }
          this.classList.toggle('border-red-500', !ok && d.length === 10);

          syncAll();
          fitStrip1();
        });
      }

      var syncFields = ['name','address','apn','brokerage','agent','agentPhone','agentEmail','commission','commissionType','fsboEmailInput'];
      for(var i=0;i<syncFields.length;i++){
        var el = document.getElementById(syncFields[i]);
        if(el){
          el.addEventListener('input', function(){
            syncAll();
            fitStrip1();
          });
          el.addEventListener('change', function(){
            syncAll();
            fitStrip1();
          });
        }
      }

      function syncAll(){
        var box3 = document.getElementById('box3');
        var fsboEmailInput = document.getElementById('fsboEmailInput');
        var hasTyped = !!(
          document.getElementById('name').value.trim() ||
          document.getElementById('address').value.trim() ||
          document.getElementById('apn').value.trim() ||
          document.getElementById('brokerage').value.trim() ||
          document.getElementById('agent').value.trim() ||
          document.getElementById('agentPhone').value.trim() ||
          document.getElementById('agentEmail').value.trim() ||
          document.getElementById('commission').value.trim() ||
          (fsboEmailInput && fsboEmailInput.value.trim())
        );
        if (box3 && hasTyped) box3.classList.add('typing');
        else if (box3) box3.classList.remove('typing');

        var fullAddr = (document.getElementById('address').value || '').trim();
        var short = fullAddr.split(',')[0] || '';
        var nameVal = document.getElementById('name').value || '';
        var apnVal = document.getElementById('apn').value || '';
        var phoneVal = document.getElementById('agentPhone').value || '';
        var brokerageVal = document.getElementById('brokerage').value || '';
        var agentVal = document.getElementById('agent').value || '';
        var amount = (document.getElementById('commission').value || '').trim();
        var type = document.getElementById('commissionType').value;

        var suffix = type === '%' ? 'of the total purchase price' : '';
        var display = type === '$' ? (amount ? ('$' + Number(amount).toLocaleString()) : '') : (amount ? amount + '%' : '');

        document.getElementById('letterName').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFull').textContent = fullAddr || '[full address]';
        document.getElementById('letterAddressShort1').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2').textContent = short || '[short address]';
        document.getElementById('letterBrokerage').textContent = brokerageVal || '[listing brokerage]';
        document.getElementById('letterAgent').textContent = agentVal || '[listing agent]';
        document.getElementById('letterCommissionDisplay').textContent = display || '[commission]';
        document.getElementById('commissionSuffix').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureName').textContent = nameVal || '[Name]';

        document.getElementById('letterNameFSBO').textContent = nameVal || '[name]';
        document.getElementById('letterAddressFullFSBO').textContent = fullAddr || '[full address]';
        document.getElementById('letterAddressShort1FSBO').textContent = short || '[short address]';
        document.getElementById('letterAddressShort2FSBO').textContent = short || '[short address]';
        document.getElementById('letterAPNFSBO').textContent = apnVal || '[Parcel # / Pin # / Tax ID # / Folio # / APN #]';
        document.getElementById('fsboPhone').textContent = phoneVal || '[owner/seller phone number]';
        document.getElementById('fsboEmail').textContent = (fsboEmailInput && fsboEmailInput.value) || '[owner/seller email]';
        document.getElementById('letterCommissionDisplayFSBO').textContent = display || '[commission]';
        document.getElementById('commissionSuffixFSBO').textContent = display ? (' ' + suffix) : '';
        document.getElementById('signatureNameFSBO').textContent = nameVal || '[Name]';
      }

      syncAll();

      var today = new Date();
      var month = today.getMonth() + 1;
      var day = today.getDate();
      var year = today.getFullYear();
      var dateStr = month + '/' + day + '/' + year;

      document.getElementById('signatureDate').textContent = dateStr;
      document.getElementById('signatureDateFSBO').textContent = dateStr;

      wireSearch();
      fitStrip1();
      setTimeout(fitStrip1, 150);
      window.addEventListener('resize', fitStrip1);
      window.addEventListener('resize', sizeHeaderVideo);
    });

    async function submitForm(){
      var isFSBO = document.getElementById('formTitle').textContent.includes('FSBO');

      var requiredIds = ['name','address','agentPhone'];
      if (isFSBO) {
        requiredIds.push('apn');
        requiredIds.push('fsboEmailInput');
      }

      var ok = true;
      for(var i=0;i<requiredIds.length;i++){
        var id = requiredIds[i];
        var el = document.getElementById(id);
        if(!el || !el.value.trim()){
          if(el) el.classList.add('border-red-500');
          ok = false;
        } else {
          el.classList.remove('border-red-500');
        }
      }

      if(!ok){
        alert('Please complete all required fields.');
        return;
      }

      var addressEl = document.getElementById('address');
      var addrVal = (addressEl.value || '').trim();
      if(!isValidFullAddress(addrVal)){
        addressEl.classList.add('border-red-500');
        alert('Please use full address format: Street, City, ST 12345');
        return;
      } else {
        addressEl.classList.remove('border-red-500');
      }

      try {
        var keysToRemove = ['agentListing','checkoutData','intakeFollowups','lastListingAddress','signature','signedISC'];
        for(var k=0;k<keysToRemove.length;k++){
          localStorage.removeItem(keysToRemove[k]);
        }
        var allKeys = Object.keys(localStorage);
        for(var m=0;m<allKeys.length;m++){
          var key = allKeys[m];
          if (key.indexOf('formData:') === 0 || key.indexOf('agentListing:') === 0 || key.indexOf('signedISC:') === 0) {
            localStorage.removeItem(key);
          }
        }
      } catch(e) {}

      var fsboEmailEl = document.getElementById('fsboEmailInput');
      var formData = {
        name: document.getElementById('name').value.trim(),
        address: addrVal,
        apn: document.getElementById('apn').value.trim(),
        commission: document.getElementById('commission').value.trim(),
        commissionType: document.getElementById('commissionType').value,
        phone: document.getElementById('agentPhone').value.trim(),
        brokerage: document.getElementById('brokerage').value.trim(),
        agent: document.getElementById('agent').value.trim(),
        agentEmail: document.getElementById('agentEmail').value.trim(),
        fsboEmail: fsboEmailEl ? fsboEmailEl.value.trim() : ''
      };

      localStorage.setItem("formData", JSON.stringify(formData));
      if(formData.address){
        var short = formData.address.split(',')[0];
        localStorage.setItem('shortAddress', short);
      }

      var plan;
      if (isFSBO) plan = 'FSBO Plus';
      else if (userSelectedPlanThisSession === 'Listed Property Plus') plan = 'Listed Property Plus';
      else plan = 'Listed Property Basic';

      localStorage.setItem('selectedPlan', plan);

      localStorage.setItem('postSignatureOptions', plan.indexOf('FSBO') >= 0 ? 'fsbo' : 'listed');
      localStorage.setItem('loginOrigin', 'box2');
      localStorage.setItem('nextAfterLogin', '/verify-code.html');

      // ✅ Email normalization (used for Firestore fields)
      function normEmail(v){
        return String(v || '').trim().toLowerCase();
      }

      try {
        var db = window.gc && window.gc.db;
        if (db) {
          var firestore = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          var addDoc = firestore.addDoc;
          var collection = firestore.collection;
          var serverTimestamp = firestore.serverTimestamp;

          var listingsCol = collection(db, "listings");

          var agentEmailRaw = plan.indexOf('FSBO') >= 0 ? "" : (formData.agentEmail || "");
          var ownerEmailRaw = plan.indexOf('FSBO') >= 0 ? (formData.fsboEmail || "") : "";

          var payload = {
            address: formData.address,
            shortAddress: (formData.address.split(",")[0] || "").trim(),
            apn: formData.apn || "",
            plan: plan,
            status: "Draft",
            commission: formData.commission || "",
            commissionType: formData.commissionType || "%",

            ownerName: formData.name || "",
            ownerEmail: ownerEmailRaw,
            ownerEmailLower: normEmail(ownerEmailRaw),

            ownerPhone: plan.indexOf('FSBO') >= 0 ? (formData.phone || "") : "",

            agentName: plan.indexOf('FSBO') >= 0 ? "" : (formData.agent || ""),
            agentPhone: plan.indexOf('FSBO') >= 0 ? "" : (formData.phone || ""),

            agentEmail: agentEmailRaw,
            agentEmailLower: normEmail(agentEmailRaw),

            brokerage: plan.indexOf('FSBO') >= 0 ? "" : (formData.brokerage || ""),
            deviceKey: getDeviceKey(),

            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            source: "index.box2"
          };

          var ref = await addDoc(listingsCol, payload);

          localStorage.setItem("lastListingId", ref.id);
          localStorage.setItem("lastListingAddress", payload.address || "");
          localStorage.setItem('formData:' + ref.id, JSON.stringify(formData));
        } else {
          console.warn("[firestore] db not available - skipped server save");
        }
      } catch (err) {
        console.error("[firestore] Save failed:", err);
        alert("Error saving listing. Please try again.");
        return;
      }

      window.location.href = "/login.html";
    }

    /* ========================================
       Strip 2 Tiles: Uses shared tile-renderer.js
       Placeholder set here, actual renderer loaded via module
       ======================================== */
    window.gcRenderTile = null;

    function renderStrip2TilesFrom(list, filterText){
      filterText = filterText || "";
      var grid = document.getElementById('tileGrid');
      var empty = document.getElementById('tilesEmpty');
      grid.innerHTML = '';

      var q = (filterText || '').toLowerCase();
      var arr = q ? list.filter(function(d){
        return (String(d.address||'').toLowerCase().indexOf(q) >= 0);
      }) : list;

      if (!arr.length) {
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      for(var i=0;i<arr.length;i++){
        if (window.gcRenderTile) {
          grid.appendChild(window.gcRenderTile(arr[i]));
        }
      }
    }

    function wireSearch(){
      var box = document.getElementById('searchBox');
      var btn = document.getElementById('searchBtn');

      var go = function() {
        var q = (box.value || '').trim();
        localStorage.setItem('lastSearch', q);
        if (!q) return;
        window.location.href = '/search.html?q=' + encodeURIComponent(q);
      };

      btn.addEventListener('click', go);
      box.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          e.preventDefault();
          go();
        }
      });
    }
  </script>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <!-- Like increment function: SINGLE SOURCE OF TRUTH for all tile likes -->
  <script type="module">
    import { doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    window.gcIncLike = async function(listingId) {
      var db = (window.gc && window.gc.db);
      if (!db || !listingId) return;
      await updateDoc(doc(db, "listings", listingId), {
        likes: increment(1),
        updatedAt: serverTimestamp()
      });
    };
  </script>

  <!-- Strip 2 Tiles: Load from Firestore using shared tile-renderer.js -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { renderTile } from "/scripts/tile-renderer.js";

    // Wire shared renderer to use gcIncLike for like increments
    window.gcRenderTile = function(data) {
      return renderTile(data, {
        onLikeIncrement: window.gcIncLike
      });
    };

    (async function loadTilesFromFirestore(){
      try {
        var grid = document.getElementById('tileGrid');
        var empty = document.getElementById('tilesEmpty');
        if (!grid || !db) return;

        var snap = await getDocs(query(collection(db, "listings"), orderBy("createdAt","desc"), limit(100)));
        var items = [];

        snap.forEach(function(docu) {
          var d = docu.data() || {};
          if (d.archived === true) return;

          var signed = !!(d.signedISC && typeof d.signedISC === 'object' && d.signedISC.date);
          var isActive = String(d.status || '').toLowerCase() === 'active';

          if (!signed && !isActive) return;

          items.push({
            id: docu.id,
            address: d.address || "",
            price: d.price != null ? d.price : "",
            commission: d.commission != null ? d.commission : "",
            commissionType: d.commissionType || "%",
            bannerText: d.bannerText || "",
            photos: Array.isArray(d.photos) ? d.photos : [],
            primaryIndex: (typeof d.primaryIndex === "number" ? d.primaryIndex : 0),
            status: d.status || "Active",
            brokerage: d.brokerage || "",
            agentName: d.agentName || "",
            agentPhone: d.agentPhone || "",
            plan: d.plan || "Listed Property Basic",
            bedrooms: d.bedrooms != null ? d.bedrooms : "",
            bathrooms: d.bathrooms != null ? d.bathrooms : "",
            sqft: d.sqft != null ? d.sqft : "",
            propertyType: d.propertyType || "",
            views: Number(d.views || 0),
            likes: Number(d.likes || 0)
          });
        });

        var lastQ = (localStorage.getItem('lastSearch') || '').trim();
        renderStrip2TilesFrom(items, lastQ);

        if (grid && grid.children.length === 0) {
          try { localStorage.removeItem('lastSearch'); } catch(e) {}
          renderStrip2TilesFrom(items, '');
          if (empty) empty.classList.add('hidden');
        }

      } catch (e) {
        console.warn("[index] Firestore tiles load failed:", e);
        var emptyEl = document.getElementById('tilesEmpty');
        if(emptyEl) emptyEl.classList.remove('hidden');
      }
    })();
  </script>

  <!-- Real-time Guaranteed Commissions Counter (scalable: listens to single stats doc) -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    (function initCounter() {
      const counterDisplay = document.getElementById('counterDisplay');
      if (!counterDisplay || !db) return;

      let currentCount = 0;

      // Rolling animation function
      function animateCountChange(newCount) {
        if (newCount === currentCount) return;

        const oldStr = String(currentCount);
        const newStr = String(newCount);

        // Build HTML with rolling digits
        let html = '';
        for (let i = 0; i < newStr.length; i++) {
          const newDigit = newStr[i];
          const oldDigit = i < oldStr.length ? oldStr[i] : '';
          const needsAnimation = newDigit !== oldDigit || newStr.length !== oldStr.length;

          if (needsAnimation) {
            html += `<span class="gc-counter-digit"><span class="gc-counter-digit-inner rolling">${newDigit}</span></span>`;
          } else {
            html += `<span class="gc-counter-digit"><span class="gc-counter-digit-inner">${newDigit}</span></span>`;
          }
        }

        counterDisplay.innerHTML = html;
        currentCount = newCount;

        // Remove animation class after animation completes
        setTimeout(() => {
          const rollingEls = counterDisplay.querySelectorAll('.rolling');
          rollingEls.forEach(el => el.classList.remove('rolling'));
        }, 450);
      }

      // Listen to single stats document (scalable: 1 doc read per visitor)
      // Document: stats/publicCounts → { guaranteedCommissionsCount: N }
      const statsDocRef = doc(db, "stats", "publicCounts");

      const unsubscribe = onSnapshot(statsDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          const count = Number(data.guaranteedCommissionsCount) || 0;
          animateCountChange(count);
        } else {
          // Doc doesn't exist yet - show 0
          animateCountChange(0);
        }
      }, (error) => {
        console.warn("[counter] Firestore listener error:", error);
      });

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        if (unsubscribe) unsubscribe();
      });
    })();
  </script>

</body>
</html>
