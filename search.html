<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .mapboxgl-canvas { outline: none; }
    .pill { display:inline-flex; align-items:center; gap:4px; background:#f3f4f6; border-radius:9999px; padding:2px 10px; font-size:13px; margin:2px; }
    .pill button { background:none; border:none; color:#555; font-size:14px; cursor:pointer; line-height:1; }
    details[open] summary svg { transform: rotate(180deg); }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">&larr; Home</a>
      <div class="text-center">
        <h1 class="text-xl font-bold">Search Results</h1>
        <p id="qLabel" class="text-xs text-gray-600"></p>
      </div>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <!-- Query & Controls -->
  <section class="bg-white border-y">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col items-center gap-3">
        <!-- Main query (centered) + Saved Searches dropdown -->
        <div class="w-full md:w-3/4 lg:w-2/3 flex items-center gap-2">
          <input id="qBox" class="border rounded px-3 py-2 w-full" placeholder="City, neighborhood, or ZIP">
          <button id="applyBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
          <select id="savedSearchesDropdown" class="border rounded px-2 py-2 text-sm">
            <option value="">Saved Searches</option>
          </select>
        </div>

        <!-- Active filter pills -->
        <div id="activePills" class="flex flex-wrap mt-1"></div>

        <!-- Advanced filters -->
        <details id="filtersPanel" class="w-full md:w-3/4 lg:w-2/3">
          <summary class="flex items-center justify-between cursor-pointer select-none px-2 py-2 text-sm text-gray-700">
            <span class="font-semibold">Advanced filters</span>
            <svg width="16" height="16" viewBox="0 0 24 24" class="transition"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
          </summary>
          <div class="mt-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 text-sm">
            <div>
              <label class="block text-gray-600 mb-1">Min Price ($)</label>
              <input id="priceMin" type="number" min="0" step="1000" class="w-full border rounded px-2 py-1" placeholder="500000">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Max Price ($)</label>
              <input id="priceMax" type="number" min="0" step="1000" class="w-full border rounded px-2 py-1" placeholder="2500000">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Beds</label>
              <input id="bedsMin" type="number" min="0" step="1" class="w-full border rounded px-2 py-1" placeholder="3">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Baths</label>
              <input id="bathsMin" type="number" min="0" step="0.5" class="w-full border rounded px-2 py-1" placeholder="2">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Status</label>
              <select id="status" class="w-full border rounded px-2 py-1">
                <option value="">Any</option>
                <option>Active</option>
                <option>In Contract</option>
                <option>Sold</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Property Type</label>
              <select id="propType" class="w-full border rounded px-2 py-1">
                <option value="">Any</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Commission %</label>
              <input id="commPctMin" type="number" min="0" step="0.25" class="w-full border rounded px-2 py-1" placeholder="2.5">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Commission $</label>
              <input id="commUsdMin" type="number" min="0" step="5000" class="w-full border rounded px-2 py-1" placeholder="20000">
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="applyFiltersBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Apply filters</button>
            <button id="clearFiltersBtn" class="px-3 py-2 rounded border">Clear</button>
            <span class="text-xs text-gray-500 ml-2">Filters and last search are remembered.</span>
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- Body: Map left, Tiles right -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="grid grid-cols-1 lg:grid-cols-5 gap-5">
      <aside class="lg:col-span-2 bg-white rounded-2xl shadow overflow-hidden">
        <div id="mapCanvas" class="h-[26rem] bg-gray-100"></div>
      </aside>
      <section class="lg:col-span-3">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>
    </section>
  </main>

  <script src="/scripts/tiles.js"></script>

  <script>
    // Mapbox token
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtZXJvbjduajA5MW8yanBvMTgxcWx2a2IifQ.dMBWViogHJkh0SgeVX5N_Q";
    if (MAPBOX_TOKEN && mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const getParam = (k) => new URL(location.href).searchParams.get(k);
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };

    // Read filters
    function readFiltersFromUI() {
      const val = (id) => (document.getElementById(id)?.value || '').trim();
      const num = (id) => {
        const v = (document.getElementById(id)?.value || '').trim();
        const n = Number(v); return isFinite(n) && v!=='' ? n : null;
      };
      return {
        priceMin: num('priceMin'),
        priceMax: num('priceMax'),
        bedsMin:  num('bedsMin'),
        bathsMin: num('bathsMin'),
        status:   val('status'),
        propType: val('propType'),
        commPctMin: num('commPctMin'),
        commUsdMin: num('commUsdMin'),
      };
    }

    // Active pills
    function renderPills(filters){
      const pillsBox = $("activePills");
      pillsBox.innerHTML = '';
      function pill(label, key){
        const el = document.createElement('div');
        el.className='pill';
        el.innerHTML = `<span>${label}</span><button>&times;</button>`;
        el.querySelector('button').onclick = ()=>{ 
          document.getElementById(key).value='';
          document.getElementById("applyFiltersBtn").click();
        };
        pillsBox.appendChild(el);
      }
      if (filters.priceMin) pill(`$${filters.priceMin}+`,'priceMin');
      if (filters.priceMax) pill(`Up to $${filters.priceMax}`,'priceMax');
      if (filters.bedsMin) pill(`${filters.bedsMin}+ bds`,'bedsMin');
      if (filters.bathsMin) pill(`${filters.bathsMin}+ ba`,'bathsMin');
      if (filters.status) pill(filters.status,'status');
      if (filters.propType) pill(filters.propType,'propType');
      if (filters.commPctMin) pill(`${filters.commPctMin}%+`,'commPctMin');
      if (filters.commUsdMin) pill(`$${filters.commUsdMin}+ comm`,'commUsdMin');
    }

    // Saved searches
    function getSavedSearches(){ return getJSON('savedSearches', []); }
    function setSavedSearches(arr){ setJSON('savedSearches', arr); }
    function refreshSavedDropdown(){
      const dd = $("savedSearchesDropdown");
      dd.innerHTML = `<option value="">Saved Searches</option>`;
      getSavedSearches().forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.name || s.q || 'Search';
        dd.appendChild(opt);
      });
    }

    // Init
    (async function boot(){
      const qParam = getParam('q') || localStorage.getItem('lastSearch') || '';
      $("qBox").value = qParam;
      $("qLabel").textContent = qParam ? `Showing results for “${qParam}”` : 'Showing all listings';
      localStorage.setItem('lastSearch', qParam);

      const filters = getJSON('lastFilters', {});
      Object.entries(filters).forEach(([k,v])=>{ if($(k)) $(k).value=v; });
      renderPills(filters);

      // dataset
      const dataset = [ /* demo, reuse your buildDataset() in real */ ];

      $("applyFiltersBtn").onclick = ()=>{ 
        const f=readFiltersFromUI(); 
        setJSON('lastFilters', f); 
        renderPills(f); 
      };
      $("clearFiltersBtn").onclick = ()=>{ 
        setJSON('lastFilters',{}); 
        renderPills({}); 
        document.querySelectorAll('#filtersPanel input, #filtersPanel select').forEach(el=>el.value=''); 
      };

      refreshSavedDropdown();
      $("savedSearchesDropdown").onchange = (e)=>{
        const sel = getSavedSearches().find(s=>s.id===e.target.value);
        if (!sel) return;
        $("qBox").value=sel.q; 
        Object.entries(sel.filters||{}).forEach(([k,v])=>{ if($(k)) $(k).value=v; });
        renderPills(sel.filters||{});
      };
    })();
  </script>
</body>
</html>
