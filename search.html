<!DOCTYPE html>
<!-- search.html - Build 2026-02-14 (Sold: centered badge, soldPrice display, dark red, clean markers) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body { height: 100%; }
    .mapboxgl-canvas { outline: none; }

    /* Tile styles */
    .gc-tile { background:#fff; border-radius:0.75rem; overflow:hidden; box-shadow:0 1px 6px rgba(0,0,0,.08); cursor:pointer; }
    .gc-photo { width:100%; height:180px; object-fit:cover; background:#e5e7eb; }
    .gc-ribbon { position:absolute; top:10px; left:10px; background:rgba(0,0,0,.75); color:#fff; font-size:12px; padding:4px 8px; border-radius:6px; }
    .gc-heart { position:absolute; top:10px; right:10px; width:32px; height:32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); border:none; cursor:pointer; }
    .gc-share { position:absolute; bottom:10px; padding:.35rem .6rem; font-size:12px; background:#fff; border:1px solid #e5e7eb; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.12); cursor:pointer; }
    .gc-share-left { left:10px; }
    .gc-share-right { right:10px; }

    /* 50/50 layout */
    .search-layout { display:flex; flex-direction:column; height:100vh; }
    .search-header { flex-shrink:0; }
    .search-body { flex:1; display:flex; overflow:hidden; }
    .search-map { width:50%; height:100%; flex-shrink:0; background:#fff; }
    .search-map #mapCanvas { width:100%; height:100%; }
    .search-results { width:50%; height:100%; overflow-y:auto; background:#f3f4f6; padding:1rem; }
    .search-results #grid { display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem; }

    @media (max-width: 1023px) {
      .search-body { flex-direction:column; }
      .search-map { width:100%; height:300px; }
      .search-results { width:100%; height:auto; flex:1; }
      .search-results #grid { grid-template-columns:1fr; }
    }

    /* ===== MARKER STYLES ===== */
    /* Default: ACTIVE listings = BLUE (#4DA6FF) */
    .gc-marker-wrap { position:relative; width:0; height:0; }
    .gc-marker-dot {
      position:absolute;
      width:10px; height:10px;
      background:#4DA6FF;
      border:2px solid #fff;
      border-radius:9999px;
      box-shadow:0 1px 2px rgba(0,0,0,.3);
      left:0; top:0;
      transform:translate(-50%, -50%);
      cursor:pointer;
    }
    .gc-marker-label {
      position:absolute;
      left:10px; top:0;
      transform:translate(0, -50%);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      border:2px solid #4DA6FF;
      border-radius:9999px;
      padding:2px 8px;
      font-size:12px;
      font-weight:700;
      color:#4DA6FF;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
    }
    .gc-marker-wrap.highlighted .gc-marker-label { background:#4DA6FF; color:#fff; }
    .gc-marker-wrap.highlighted .gc-marker-dot { box-shadow:0 3px 10px rgba(77,166,255,.45); }
    .gc-tile.highlighted { outline:3px solid #4DA6FF; outline-offset:2px; box-shadow:0 4px 12px rgba(77,166,255,.3); }

    /* ===== PENDING / IN CONTRACT = BLACK (#1f2937) ===== */
    .gc-marker-wrap.pending .gc-marker-dot {
      background:#1f2937;
    }
    .gc-marker-wrap.pending .gc-marker-label {
      background:#fff;
      border-color:#1f2937;
      color:#1f2937;
    }
    .gc-marker-wrap.pending.highlighted .gc-marker-label {
      background:#1f2937;
      color:#fff;
    }
    .gc-marker-wrap.pending.highlighted .gc-marker-dot {
      box-shadow:0 3px 10px rgba(31,41,55,.45);
    }

    /* ===== SOLD = RED (#dc2626) ===== */
    .gc-marker-wrap.sold .gc-marker-dot {
      background:#dc2626;
    }
    .gc-marker-wrap.sold .gc-marker-label {
      background:#fff;
      border-color:#dc2626;
      color:#dc2626;
    }
    .gc-marker-wrap.sold.highlighted .gc-marker-label {
      background:#dc2626;
      color:#fff;
    }
    .gc-marker-wrap.sold.highlighted .gc-marker-dot {
      box-shadow:0 3px 10px rgba(220,38,38,.45);
    }

    /* Filter bar dropdown styling */
    .filter-dropdown { position:relative; display:inline-block; }
    .filter-btn {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:8px 12px;
      font-size:14px;
      font-weight:500;
      background:#4DA6FF;
      color:#fff;
      border:1px solid #4DA6FF;
      border-radius:8px;
      cursor:pointer;
      white-space:nowrap;
    }
    .filter-btn:hover { opacity:0.9; }
    .filter-btn:focus { outline:none; }
    .filter-btn.active { background:#4DA6FF; border-color:#4DA6FF; }
    .filter-btn svg { width:12px; height:12px; transition:transform 0.15s; fill:#fff; }
    .filter-dropdown.open .filter-btn svg { transform:rotate(180deg); }

    .filter-panel {
      position:absolute;
      top:calc(100% + 4px);
      left:0;
      min-width:200px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:8px;
      box-shadow:0 4px 16px rgba(0,0,0,.12);
      padding:12px;
      z-index:100;
      display:none;
    }
    .filter-dropdown.open .filter-panel { display:block; }
    .filter-panel.right { left:auto; right:0; }

    .filter-panel label { display:block; font-size:12px; color:#6b7280; margin-bottom:4px; }
    .filter-panel input, .filter-panel select {
      width:100%;
      padding:6px 8px;
      font-size:14px;
      border:1px solid #d1d5db;
      border-radius:6px;
      margin-bottom:8px;
    }
    .filter-panel input:focus, .filter-panel select:focus {
      outline:none;
      border-color:#4DA6FF;
    }
    .filter-apply-btn {
      width:100%;
      padding:8px;
      font-size:14px;
      font-weight:500;
      color:#fff;
      background:#4DA6FF;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .filter-apply-btn:hover { opacity:0.9; }

    /* Saved search autocomplete dropdown */
    .search-autocomplete {
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:#fff;
      border:1px solid #e5e7eb;
      border-top:none;
      border-radius:0 0 8px 8px;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      max-height:200px;
      overflow-y:auto;
      z-index:200;
      display:none;
    }
    .search-autocomplete.show { display:block; }
    .search-autocomplete-item {
      padding:10px 12px;
      cursor:pointer;
      font-size:14px;
      border-bottom:1px solid #f3f4f6;
    }
    .search-autocomplete-item:last-child { border-bottom:none; }
    .search-autocomplete-item:hover { background:#f3f4f6; }
    .search-autocomplete-item .saved-label {
      font-size:11px;
      color:#4DA6FF;
      margin-left:8px;
    }
    
    /* SOLD STATUS DISPLAY - High visibility styling */
    .sold-details-text {
      color: #b91c1c; /* red-700 for visibility */
      font-weight: 700;
      font-size: 11px;
    }
  </style>
</head>

<body class="search-layout text-gray-900">

  <!-- ========== STRIP 1: BRANDED HEADER ========== -->
  <div class="search-header">
    <header class="bg-white border-b">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
          <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

          <div class="text-center">
            <div class="flex items-end justify-center gap-0">
              <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
              <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
            <a href="/login.html" id="authLink" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Log In</a>
          </div>
        </div>
      </div>
    </header>

    <!-- ========== STRIP 2: ZILLOW-STYLE FILTER BAR ========== -->
    <section class="bg-white border-b">
      <div class="px-2 py-2">
        <div class="flex flex-wrap items-center gap-2">

          <!-- Search Input -->
          <div class="w-[320px] relative">
            <input id="qBox" type="text" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-base focus:outline-none focus:border-[#4DA6FF]" placeholder="City, ZIP, or Saved Search" autocomplete="off">
            <div id="searchAutocomplete" class="search-autocomplete"></div>
          </div>

          <!-- For Sale Dropdown -->
          <div class="filter-dropdown" data-filter="status">
            <button class="filter-btn" type="button">
              <span>For Sale</span>
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel">
              <select id="status" class="w-full">
                <option value="">Any Status</option>
                <option value="Active">Active</option>
                <option value="In Contract">In Contract</option>
                <option value="Sold">Sold</option>
              </select>
              <button class="filter-apply-btn" data-apply="status">Apply</button>
            </div>
          </div>

          <!-- Price Dropdown -->
          <div class="filter-dropdown" data-filter="price">
            <button class="filter-btn" type="button">
              <span>Price</span>
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel">
              <label>Min Price</label>
              <input id="priceMin" type="number" min="0" step="50000" placeholder="No Min">
              <label>Max Price</label>
              <input id="priceMax" type="number" min="0" step="50000" placeholder="No Max">
              <button class="filter-apply-btn" data-apply="price">Apply</button>
            </div>
          </div>

          <!-- Beds Dropdown -->
          <div class="filter-dropdown" data-filter="beds">
            <button class="filter-btn" type="button">
              <span>Beds</span>
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel">
              <label>Min Bedrooms</label>
              <select id="bedsMin">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="2">2+</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
                <option value="5">5+</option>
              </select>
              <button class="filter-apply-btn" data-apply="beds">Apply</button>
            </div>
          </div>

          <!-- Baths Dropdown -->
          <div class="filter-dropdown" data-filter="baths">
            <button class="filter-btn" type="button">
              <span>Baths</span>
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel">
              <label>Min Bathrooms</label>
              <select id="bathsMin">
                <option value="">Any</option>
                <option value="1">1+</option>
                <option value="1.5">1.5+</option>
                <option value="2">2+</option>
                <option value="2.5">2.5+</option>
                <option value="3">3+</option>
                <option value="4">4+</option>
              </select>
              <button class="filter-apply-btn" data-apply="baths">Apply</button>
            </div>
          </div>

          <!-- Type Dropdown -->
          <div class="filter-dropdown" data-filter="propType">
            <button class="filter-btn" type="button">
              <span>Type</span>
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel">
              <select id="propType">
                <option value="">Any Type</option>
                <option value="Single Family">Single Family</option>
                <option value="Condo">Condo</option>
                <option value="Townhouse">Townhouse</option>
                <option value="Multi-Family">Multi-Family</option>
                <option value="Land">Land</option>
                <option value="Other">Other</option>
              </select>
              <button class="filter-apply-btn" data-apply="propType">Apply</button>
            </div>
          </div>

          <div class="flex-1"></div>

          <!-- Share / Save -->
          <div class="filter-dropdown" data-filter="share-save">
            <button class="px-4 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;" type="button">
              Share / Save
              <svg class="inline-block ml-1 w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel right" style="min-width:280px;">
              <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Save Current Search</label>
                <input id="searchNameInput" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm mb-2" placeholder="Name this search...">
                <button id="saveSearchBtn" class="w-full px-3 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;">
                  Save Search
                </button>
              </div>

              <hr class="my-3 border-gray-200">

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Share Results Now</label>
                <div class="grid grid-cols-2 gap-2">
                  <button id="emailSearchBtn" class="px-3 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;">
                    Email Results
                  </button>
                  <button id="textSearchBtn" class="px-3 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;">
                    Text Results
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Clear -->
          <button id="clearFiltersBtn" class="px-3 py-2 text-sm text-white rounded-lg" style="background:#4DA6FF;">
            Clear
          </button>

          <!-- Auto-Notify -->
          <div class="filter-dropdown" data-filter="auto-notify">
            <button class="px-4 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;" type="button">
              Auto-Notify
              <svg class="inline-block ml-1 w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
            </button>
            <div class="filter-panel right" style="min-width:280px;">
              <label class="block text-sm font-semibold text-gray-700 mb-2">Auto-Notify on New Listings</label>
              <p class="text-xs text-gray-500 mb-3">Get notified when new listings match this search</p>
              <div class="grid grid-cols-2 gap-2">
                <button id="autoEmailBtn" class="px-3 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;">
                  Auto-Email
                </button>
                <button id="autoTextBtn" class="px-3 py-2 text-sm font-medium text-white rounded-lg" style="background:#4DA6FF;">
                  Auto-Text
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- MAP + RESULTS -->
  <div class="search-body">
    <div class="search-map"><div id="mapCanvas"></div></div>
    <div class="search-results"><div id="grid"></div></div>
  </div>

  <!-- Firebase init (Firestore only, no Auth) -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { 
      collection, query, orderBy, getDocs, limit, doc as fdoc, updateDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Mapbox token
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtaW1idDMwbjFjMWUzZHE3ZzY4ZjBob3IifQ.lF5BvHIsT_SVe0f6mT5nRw";
    if (MAPBOX_TOKEN && window.mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const getParam = (k) => new URL(location.href).searchParams.get(k);
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const CAN_HOVER = window.matchMedia && window.matchMedia('(hover: hover)').matches;

    // ===== localStorage Auth Check =====
    function isLoggedIn() {
      return !!(localStorage.getItem('loggedInEmail') || '').trim();
    }
    function getLoggedInEmail() {
      return (localStorage.getItem('loggedInEmail') || '').trim();
    }

    // ===== Update Auth UI =====
    function updateAuthUI() {
      const authLink = $('authLink');
      const email = getLoggedInEmail();
      if (email) {
        authLink.textContent = 'Log Out';
        authLink.href = '#';
        authLink.onclick = (e) => {
          e.preventDefault();
          ['isLoggedIn','loggedInEmail','userRole','verificationCode','verifyTarget','nextAfterLogin','nextAfterVerify','lastListingId','lastListingAddress']
            .forEach(k=>localStorage.removeItem(k));
          window.location.reload();
        };
      } else {
        authLink.textContent = 'Log In';
        authLink.href = '/login.html';
        authLink.onclick = null;
      }
    }

    // ===== Auth Gating =====
    function requireAuth(callback) {
      if (isLoggedIn()) {
        callback();
      } else {
        alert('Please log in to use this feature.');
        window.location.href = '/login.html';
      }
    }

    // ===== Filter Dropdown UI =====
    (function wireFilterDropdowns() {
      const dropdowns = document.querySelectorAll('.filter-dropdown');

      dropdowns.forEach(dd => {
        const btn = dd.querySelector(':scope > button');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wasOpen = dd.classList.contains('open');
          dropdowns.forEach(d => d.classList.remove('open'));
          if (!wasOpen) dd.classList.add('open');
        });
      });

      document.addEventListener('click', () => {
        dropdowns.forEach(d => d.classList.remove('open'));
        $('searchAutocomplete').classList.remove('show');
      });

      document.querySelectorAll('.filter-panel').forEach(panel => {
        panel.addEventListener('click', e => e.stopPropagation());
      });

      document.querySelectorAll('.filter-apply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          applyAllFilters();
          dropdowns.forEach(d => d.classList.remove('open'));
        });
      });
    })();

    // ===== Likes =====
    async function incrementLikeOnce(listingId) {
      try {
        const onceKey = 'likedOnce:' + listingId;
        if (localStorage.getItem(onceKey)) return false;
        await updateDoc(fdoc(db, "listings", listingId), { likes: increment(1), updatedAt: serverTimestamp() });
        localStorage.setItem(onceKey, '1');
        return true;
      } catch (e) {
        console.warn('[likes] increment failed', e);
        return false;
      }
    }

    // ===== Filters =====
    function readFiltersFromUI() {
      const val = (id) => (document.getElementById(id)?.value || '').trim();
      const num = (id) => {
        const v = (document.getElementById(id)?.value || '').trim();
        const n = Number(v);
        return isFinite(n) && v !== '' ? n : null;
      };
      return {
        priceMin: num('priceMin'),
        priceMax: num('priceMax'),
        bedsMin: num('bedsMin'),
        bathsMin: num('bathsMin'),
        status: val('status'),
        propType: val('propType'),
      };
    }

    function writeFiltersToUI(f) {
      const set = (id, v) => { const el = $(id); if (el) el.value = (v ?? ''); };
      set('priceMin', f.priceMin ?? '');
      set('priceMax', f.priceMax ?? '');
      set('bedsMin', f.bedsMin ?? '');
      set('bathsMin', f.bathsMin ?? '');
      set('status', f.status ?? '');
      set('propType', f.propType ?? '');
    }

    function updateDropdownLabels(f) {
      const statusBtn = document.querySelector('[data-filter="status"] .filter-btn span');
      if (statusBtn) statusBtn.textContent = f.status || 'For Sale';

      const priceBtn = document.querySelector('[data-filter="price"] .filter-btn span');
      if (priceBtn) {
        if (f.priceMin && f.priceMax) priceBtn.textContent = `$${(f.priceMin/1000)}K-$${(f.priceMax/1000)}K`;
        else if (f.priceMin) priceBtn.textContent = `$${(f.priceMin/1000)}K+`;
        else if (f.priceMax) priceBtn.textContent = `Up to $${(f.priceMax/1000)}K`;
        else priceBtn.textContent = 'Price';
      }

      const bedsBtn = document.querySelector('[data-filter="beds"] .filter-btn span');
      if (bedsBtn) bedsBtn.textContent = f.bedsMin ? `${f.bedsMin}+ Beds` : 'Beds';

      const bathsBtn = document.querySelector('[data-filter="baths"] .filter-btn span');
      if (bathsBtn) bathsBtn.textContent = f.bathsMin ? `${f.bathsMin}+ Baths` : 'Baths';

      const propBtn = document.querySelector('[data-filter="propType"] .filter-btn span');
      if (propBtn) propBtn.textContent = f.propType || 'Type';

      document.querySelectorAll('.filter-dropdown').forEach(dd => {
        const filter = dd.dataset.filter;
        let isActive = false;
        if (filter === 'status' && f.status) isActive = true;
        if (filter === 'price' && (f.priceMin || f.priceMax)) isActive = true;
        if (filter === 'beds' && f.bedsMin) isActive = true;
        if (filter === 'baths' && f.bathsMin) isActive = true;
        if (filter === 'propType' && f.propType) isActive = true;
        const btn = dd.querySelector('.filter-btn');
        if (btn) btn.classList.toggle('active', isActive);
      });
    }

    function matchesFilters(docu, qtext, f) {
      const address = (docu.address || '').toLowerCase();
      if (qtext && !address.includes(qtext.toLowerCase().trim())) return false;

      const price = Number(docu.price || 0);
      if (f.priceMin && price && price < f.priceMin) return false;
      if (f.priceMax && price && price > f.priceMax) return false;

      const beds = Number(docu.bedrooms || 0);
      const baths = Number(docu.bathrooms || 0);
      if (f.bedsMin && beds < f.bedsMin) return false;
      if (f.bathsMin && baths < f.bathsMin) return false;

      if (f.status) {
        const normalized = (String(docu.status || '').toLowerCase() === 'in_contract') ? 'In Contract' : (docu.status || '');
        if (normalized !== f.status) return false;
      }

      if (f.propType) {
        const type = String(docu.propertyType || '').toLowerCase();
        if (!type || type !== f.propType.toLowerCase()) return false;
      }

      return true;
    }

    // ===== SENIORITY PRIORITY SORTING =====
    // Business Rules:
    // 0. Status Group: Active first, In Contract second, Sold last
    // 1. Pin Placement: Top tier within status group, sorted by createdAt ASCENDING (oldest first = seniority)
    // 2. Premium Placement: Second tier within status group, sorted by createdAt ASCENDING (oldest first = seniority)
    // 3. Standard Listings: Third tier within status group, sorted by createdAt DESCENDING (newest first)
    function sortListings(items) {
      function getCreatedAtMs(doc) {
        const ca = doc.createdAt;
        if (!ca) return 0;
        if (typeof ca.toMillis === 'function') return ca.toMillis();
        if (typeof ca.toDate === 'function') return ca.toDate().getTime();
        if (typeof ca === 'number') return ca;
        if (typeof ca === 'string') return new Date(ca).getTime() || 0;
        return 0;
      }

      function statusRank(doc) {
        const s = String(doc.status || '').trim().toLowerCase();
        if (s === 'sold') return 2;
        if (s === 'in contract' || s === 'in_contract' || s === 'pending') return 1;
        return 0; // Active and everything else
      }

      return [...items].sort((a, b) => {
        // Status group first: Active (0) < In Contract (1) < Sold (2)
        const aStatus = statusRank(a);
        const bStatus = statusRank(b);
        if (aStatus !== bStatus) return aStatus - bStatus;

        // Within same status group: pin > premium > standard
        const aPin = !!(a.paidUpgrades && a.paidUpgrades.pin);
        const bPin = !!(b.paidUpgrades && b.paidUpgrades.pin);
        const aPremium = !!(a.paidUpgrades && a.paidUpgrades.premium);
        const bPremium = !!(b.paidUpgrades && b.paidUpgrades.premium);
        
        if (aPin && !bPin) return -1;
        if (!aPin && bPin) return 1;
        if (aPin && bPin) return getCreatedAtMs(a) - getCreatedAtMs(b);
        
        if (aPremium && !bPremium) return -1;
        if (!aPremium && bPremium) return 1;
        if (aPremium && bPremium) return getCreatedAtMs(a) - getCreatedAtMs(b);
        
        return getCreatedAtMs(b) - getCreatedAtMs(a);
      });
    }

    // ===== Saved Searches (localStorage) =====
    function getSavedSearches() { return getJSON('savedSearches', []); }
    function setSavedSearches(arr) { setJSON('savedSearches', arr); }

    function saveSearchToLocal(name, q, filters) {
      const arr = getSavedSearches();
      const record = {
        id: 'ss_' + Date.now(),
        name: name || q || 'My Search',
        q,
        filters,
        createdAt: Date.now()
      };
      arr.unshift(record);
      setSavedSearches(arr);
      return record;
    }

    // ===== Saved Search Autocomplete =====
    function showSavedSearchAutocomplete(input) {
      const autocomplete = $('searchAutocomplete');
      const val = input.toLowerCase().trim();
      const searches = getSavedSearches();

      if (!isLoggedIn() || val.length < 2 || searches.length === 0) {
        autocomplete.classList.remove('show');
        return;
      }

      const matches = searches.filter(s =>
        s.name.toLowerCase().includes(val) ||
        (s.q && s.q.toLowerCase().includes(val))
      );

      if (matches.length === 0) {
        autocomplete.classList.remove('show');
        return;
      }

      autocomplete.innerHTML = matches.slice(0, 5).map(s => `
        <div class="search-autocomplete-item" data-search-id="${s.id}">
          ${s.name}
          <span class="saved-label">Saved Search</span>
        </div>
      `).join('');

      autocomplete.querySelectorAll('.search-autocomplete-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const searchId = item.dataset.searchId;
          const saved = searches.find(s => s.id === searchId);
          if (saved) {
            loadSavedSearch(saved);
          }
          autocomplete.classList.remove('show');
        });
      });

      autocomplete.classList.add('show');
    }

    function loadSavedSearch(saved) {
      $('qBox').value = saved.q || '';
      if (saved.filters) {
        writeFiltersToUI(saved.filters);
        updateDropdownLabels(saved.filters);
      }
      applyAllFilters();
    }

    // ===== URL SYNC =====
    function syncFiltersToURL() {
      try {
        const f = readFiltersFromUI();
        const q = ($("qBox")?.value || "").trim();

        const params = new URLSearchParams();

        if (q) params.set("q", q);
        if (f.priceMin != null) params.set("priceMin", String(f.priceMin));
        if (f.priceMax != null) params.set("priceMax", String(f.priceMax));
        if (f.bedsMin != null) params.set("bedsMin", String(f.bedsMin));
        if (f.bathsMin != null) params.set("bathsMin", String(f.bathsMin));
        if (f.status) params.set("status", f.status);
        if (f.propType) params.set("propType", f.propType);

        const newUrl = window.location.pathname + (params.toString() ? ("?" + params.toString()) : "");
        window.history.replaceState({}, "", newUrl);
      } catch (e) {
        console.warn("[url] syncFiltersToURL failed:", e);
      }
    }

    function readFiltersFromURL() {
      try {
        const sp = new URLSearchParams(window.location.search);
        const out = {
          q: (sp.get("q") || "").trim(),
          priceMin: sp.get("priceMin"),
          priceMax: sp.get("priceMax"),
          bedsMin: sp.get("bedsMin"),
          bathsMin: sp.get("bathsMin"),
          status: (sp.get("status") || "").trim(),
          propType: (sp.get("propType") || "").trim()
        };

        function toNumOrNull(v) {
          if (v === null || v === undefined) return null;
          const s = String(v).trim();
          if (s === "") return null;
          const n = Number(s);
          return isFinite(n) ? n : null;
        }

        return {
          q: out.q,
          filters: {
            priceMin: toNumOrNull(out.priceMin),
            priceMax: toNumOrNull(out.priceMax),
            bedsMin: toNumOrNull(out.bedsMin),
            bathsMin: toNumOrNull(out.bathsMin),
            status: out.status || "",
            propType: out.propType || ""
          },
          hasAny: !!(out.q || out.priceMin || out.priceMax || out.bedsMin || out.bathsMin || out.status || out.propType)
        };
      } catch (e) {
        return { q: "", filters: {}, hasAny: false };
      }
    }

    // ===== Map + markers + viewport sync =====
    let map;
    let markers = [];
    let markerMap = {};
    let allListingsWithCoords = [];
    let allDocs = [];

    const geocodeCache = new Map();

    function formatPriceShort(price) {
      const p = Number(price || 0);
      if (!p) return '$-';
      if (p >= 1000000) return '$' + (p / 1000000).toFixed(p % 1000000 === 0 ? 0 : 1) + 'M';
      if (p >= 1000) return '$' + Math.round(p / 1000) + 'K';
      return '$' + p.toLocaleString();
    }

    function getListingKey(it) {
      return it?.id ? String(it.id) : String(it?.address || '').trim().toLowerCase();
    }

    function isValidLatLng(lat, lng) {
      const latNum = Number(lat);
      const lngNum = Number(lng);
      return !isNaN(latNum) && !isNaN(lngNum)
        && latNum >= -90 && latNum <= 90
        && lngNum >= -180 && lngNum <= 180
        && (latNum !== 0 || lngNum !== 0);
    }

    async function geocodeWithBounds(q) {
      if (!MAPBOX_TOKEN || !q) return null;
      try {
        const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
        const data = await resp.json();
        const f = data?.features?.[0];
        if (!f) return null;
        return { center: f.center || null, bbox: f.bbox || null };
      } catch {
        return null;
      }
    }

    function clearMarkers() {
      markers.forEach(m => m.remove());
      markers = [];
      markerMap = {};
      allListingsWithCoords = [];
    }

    async function geocodeExactAddress(addr) {
      const a = String(addr || '').trim();
      if (!a) return null;
      if (geocodeCache.has(a)) return geocodeCache.get(a);

      try {
        const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(a)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
        const data = await resp.json();
        const c = data?.features?.[0]?.center || null;
        if (c && Array.isArray(c) && c.length === 2) {
          geocodeCache.set(a, c);
          return c;
        }
      } catch {}
      geocodeCache.set(a, null);
      return null;
    }

    function highlightMarker(listingKey, on) {
      const wrap = markerMap[listingKey];
      if (wrap) wrap.classList.toggle('highlighted', !!on);
    }

    function highlightTile(listingKey, on) {
      const tile = document.querySelector(`[data-listing-id="${listingKey}"]`);
      if (tile) tile.classList.toggle('highlighted', !!on);
    }

    async function initMap(q) {
      const DEFAULT_CENTER = [-98.5795, 39.8283];
      const DEFAULT_ZOOM = 4.2;

      let center = DEFAULT_CENTER;
      let bbox = null;

      const qTrim = String(q || '').trim();
      if (qTrim) {
        const geo = await geocodeWithBounds(qTrim);
        if (geo?.center) center = geo.center;
        if (geo?.bbox && Array.isArray(geo.bbox) && geo.bbox.length === 4) bbox = geo.bbox;
      }

      map = new mapboxgl.Map({
        container: 'mapCanvas',
        style: 'mapbox://styles/mapbox/streets-v12',
        center,
        zoom: qTrim ? 11.5 : DEFAULT_ZOOM
      });
      map.addControl(new mapboxgl.NavigationControl());

      if (bbox) {
        map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {
          padding: 70,
          maxZoom: 12.8,
          duration: 0
        });
      }

      setTimeout(() => { try { map.resize(); } catch (e) {} }, 140);
      return center;
    }

    // =========================================================================
    // CURRENCY FORMATTER - Used for price and commission
    // =========================================================================
    function money(n) { 
      const v = Number(n || 0); 
      return v ? ("$" + v.toLocaleString()) : "$—"; 
    }

    function commissionAmount(price, commission, type) {
      const p = Number(price || 0), c = Number(commission || 0);
      if (!c) return 0;
      return type === '$' ? Math.round(c) : (p ? Math.round(p * (c / 100)) : 0);
    }

    function wireHeart(btn, keyId, onFirstLike) {
      const KEY = 'gcFavorites';
      const favs = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } };
      const setF = a => { try { localStorage.setItem(KEY, JSON.stringify(a || [])); } catch {} };
      const isFav = id => favs().includes(id);
      const tog = id => { const a = favs(); const i = a.indexOf(id); if (i >= 0) a.splice(i, 1); else a.push(id); setF(a); return a.includes(id); };
      const svg = a => a
        ? `<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>`
        : `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
      btn.innerHTML = svg(isFav(keyId));
      btn.onclick = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const nowLiked = tog(keyId);
        btn.innerHTML = svg(nowLiked);
        if (nowLiked && typeof onFirstLike === 'function') onFirstLike();
      };
    }

    function buildContactLine(doc) {
      const plan = String(doc.plan || "Listed Property Basic");
      const isFSBO = plan.includes("FSBO");

      if (isFSBO) {
        let line = 'FOR SALE BY OWNER';
        if (doc.ownerName) line += ' - ' + doc.ownerName;
        if (doc.ownerPhone) line += ' - ' + doc.ownerPhone;
        return line;
      } else {
        let line = (doc.brokerage || '[listing brokerage]').toUpperCase();
        if (doc.agentName) line += ' - ' + doc.agentName;
        if (doc.agentPhone) line += ' - ' + doc.agentPhone;
        return line;
      }
    }

    // =========================================================================
    // TILE RENDERER - FIXED INLINE SOLD DATE/PRICE LOGIC
    // =========================================================================
    function renderTile(doc) {
      const id = doc.id;
      const address = String(doc.address || "").trim();
      const banner = String(doc.bannerText || "");
      const pType = String(doc.propertyType || "");
      const bds = doc.bedrooms ?? "—";
      const ba = doc.bathrooms ?? "—";
      const sqft = doc.sqft ? Number(doc.sqft).toLocaleString() : "—";
      const price = (typeof doc.price === "number") ? doc.price : (Number(doc.price) || 0);
      const cType = (doc.commissionType === "%" || doc.commissionType === "$") ? doc.commissionType : "%";
      const cRaw = doc.commission ?? "";

      // Determine sold status early so we can use soldPrice
      const statusStr = String(doc.status || "Active").trim();
      const statusLower = statusStr.toLowerCase();
      const isSold = (statusLower === "sold");

      // For sold listings, use soldPrice for display and commission math
      const finalPrice = (isSold && doc.soldPrice) ? Number(doc.soldPrice) : price;

      const cAmt = commissionAmount(finalPrice, cRaw, cType);
      const cPctLbl = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw) + '%')) : "—";

      const photos = Array.isArray(doc.photos) ? doc.photos.filter(u => typeof u === "string" && u) : [];
      let pIdx = (typeof doc.primaryIndex === "number") ? doc.primaryIndex : 0;
      if (pIdx < 0 || pIdx >= photos.length) pIdx = 0;
      const primaryPhoto = photos[pIdx] || "";

      const views = Number(doc.views || 0);
      const likes = Number(doc.likes || 0);

      const contactLine = buildContactLine(doc);
      
      // =====================================================
      // INLINE SOLD DATE/PRICE LOGIC - ROBUST IMPLEMENTATION
      // =====================================================
      // (isSold already determined above for price/commission logic)
      
      // Debug log to verify data
      console.log('[renderTile] Listing:', id, '| Status:', statusStr, '| soldDate:', doc.soldDate, '| soldPrice:', doc.soldPrice);
      
      // Build status display text with sold details
      let statusDisplayText = statusStr; // Default: use status as-is
      let statusDisplayClass = ""; // CSS class for styling
      
      if (isSold) {
        // Extract sold details directly from doc
        const soldDateRaw = doc.soldDate; // Expected: "YYYY-MM-DD" string
        const soldPriceRaw = doc.soldPrice; // Expected: number
        
        // Check if we have BOTH fields
        if (soldDateRaw && soldPriceRaw) {
          // Format date: YYYY-MM-DD -> M/D/YYYY
          let formattedDate = null;
          try {
            const dateStr = String(soldDateRaw);
            if (dateStr.includes('-')) {
              const parts = dateStr.split('-');
              if (parts.length === 3) {
                const year = parts[0];
                const month = parseInt(parts[1], 10); // Remove leading zero
                const day = parseInt(parts[2], 10);   // Remove leading zero
                if (year && month && day) {
                  formattedDate = `${month}/${day}/${year}`;
                }
              }
            }
          } catch (e) {
            console.warn('[renderTile] Date parsing failed:', e);
          }
          
          // Format price: number -> $X,XXX,XXX
          let formattedPrice = null;
          try {
            const priceNum = Number(soldPriceRaw);
            if (priceNum > 0) {
              formattedPrice = "$" + priceNum.toLocaleString();
            }
          } catch (e) {
            console.warn('[renderTile] Price parsing failed:', e);
          }
          
          // Build the full sold string
          if (formattedDate && formattedPrice) {
            statusDisplayText = `Sold ${formattedDate} for ${formattedPrice}`;
            statusDisplayClass = "sold-details-text"; // Visual debug class
            console.log('[renderTile] SUCCESS - Built sold string:', statusDisplayText);
          } else {
            // Partial data - show what we can
            if (formattedDate) {
              statusDisplayText = `Sold ${formattedDate}`;
            } else if (formattedPrice) {
              statusDisplayText = `Sold for ${formattedPrice}`;
            } else {
              statusDisplayText = "Sold";
            }
            statusDisplayClass = "sold-details-text";
          }
        } else {
          // Legacy: No sold details, just show "Sold"
          statusDisplayText = "Sold";
          statusDisplayClass = "sold-details-text";
          console.log('[renderTile] Legacy sold listing - no date/price data');
        }
      }
      // =====================================================
      // END INLINE SOLD LOGIC
      // =====================================================

      const card = document.createElement("article");
      card.className = "gc-tile relative";
      card.onclick = () => { window.location.href = `/listing.html?id=${encodeURIComponent(id)}`; };

      // Build the status span with optional class
      const statusSpan = statusDisplayClass 
        ? `<span class="${statusDisplayClass}">${statusDisplayText}</span>`
        : statusDisplayText;

      card.innerHTML = `
        <div class="relative">
          <img class="gc-photo" alt="Listing photo" src="${primaryPhoto}">
          ${banner ? `<div class="gc-ribbon">${banner}</div>` : ''}
          ${isSold ? `<div class="absolute top-2 left-1/2 -translate-x-1/2 bg-red-600 text-white font-bold text-[11px] px-2 py-1 rounded shadow">SOLD</div>` : ''}
          <button type="button" class="gc-heart" aria-label="Like"></button>
          <button type="button" class="gc-share gc-share-left" data-share="email">Email</button>
          <button type="button" class="gc-share gc-share-right" data-share="text">Text</button>
        </div>
        <div class="p-3 space-y-1">
          <div class="flex items-center justify-between text-[15px] font-semibold">
            <div class="truncate ${isSold ? 'text-red-700' : ''}">${finalPrice ? money(finalPrice) : "$—"}</div>
            <div class="truncate text-red-600">Commission ${cPctLbl} | ${cAmt ? money(cAmt) : "$—"}</div>
          </div>
          <div class="text-[12px] text-gray-700">
            ${bds} bd | ${ba} ba | ${sqft} sqft${pType ? " | " + pType : ""} | ${statusSpan}
          </div>
          <div class="text-sm font-medium truncate">${address || "[address]"}</div>
          <div class="text-[11px] text-gray-600 truncate">
            ${contactLine}
          </div>
          <div class="text-[11px] text-gray-500 text-center tile-stats">
            ${views.toLocaleString()} views | ${likes.toLocaleString()} likes
          </div>
        </div>
      `;

      const heart = card.querySelector(".gc-heart");
      const statsEl = card.querySelector(".tile-stats");
      if (heart) {
        wireHeart(heart, `fav:${id}`, async () => {
          const did = await incrementLikeOnce(id);
          if (did && statsEl) {
            const newLikes = likes + 1;
            statsEl.textContent = `${views.toLocaleString()} views | ${newLikes.toLocaleString()} likes`;
          }
        });
      }

      const shareUrl = window.location.origin + '/listing.html?id=' + encodeURIComponent(id);
      card.querySelectorAll("[data-share]").forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const kind = btn.getAttribute("data-share");
          const subject = encodeURIComponent(address ? `Listing: ${address}` : 'Listing');
          const body = encodeURIComponent(`${address ? (address + " — ") : ""}commission posted with photos.\n\n${shareUrl}`);
          if (kind === "email") window.location.href = `mailto:?subject=${subject}&body=${body}`;
          else window.location.href = `sms:&body=${body}`;
        });
      });

      return card;
    }

    // =========================================================================
    // Map Marker Logic
    // Color scheme: Active=Blue, Pending/InContract=Black, Sold=Red
    // NO visual distinction for Pin placement (sorting only)
    // =========================================================================
    async function addDotPriceMarkers(items) {
      if (!map) return;
      clearMarkers();

      const subset = items.slice(0, 100);

      for (const it of subset) {
        const addr = (it?.address || '').trim();
        if (!addr) continue;

        let coords = null;
        if (isValidLatLng(it.lat, it.lng)) {
          coords = [Number(it.lng), Number(it.lat)];
        } else {
          coords = await geocodeExactAddress(addr);
        }
        if (!coords) continue;

        const listingKey = getListingKey(it);
        allListingsWithCoords.push({ ...it, _lng: coords[0], _lat: coords[1] });

        const wrap = document.createElement('div');
        wrap.className = 'gc-marker-wrap';
        wrap.dataset.listingId = listingKey;
        wrap.title = addr;

        // ===== STATUS-BASED MARKER COLORS =====
        const statusLower = String(it.status || '').trim().toLowerCase();
        const isSold = statusLower === 'sold';
        const isPending = statusLower === 'in contract' || statusLower === 'in_contract' || statusLower === 'pending';

        if (isSold) {
          wrap.classList.add('sold');       // Red markers
        } else if (isPending) {
          wrap.classList.add('pending');    // Black markers
        }
        // else: default Blue markers (no class needed)

        const dot = document.createElement('div');
        dot.className = 'gc-marker-dot';

        const label = document.createElement('div');
        label.className = 'gc-marker-label';

        // Price label — color coding is sufficient, no text suffix needed
        // For sold listings, show soldPrice if available
        const markerPrice = (isSold && it.soldPrice) ? it.soldPrice : it.price;
        label.textContent = formatPriceShort(markerPrice);

        const goListing = (e) => {
          e.stopPropagation();
          if (it.id) window.location.href = `/listing.html?id=${encodeURIComponent(it.id)}`;
          else window.location.href = `/listing.html?addr=${encodeURIComponent(addr)}`;
        };
        dot.addEventListener('click', goListing);
        label.addEventListener('click', goListing);

        if (CAN_HOVER) {
          wrap.addEventListener('mouseenter', () => highlightTile(listingKey, true));
          wrap.addEventListener('mouseleave', () => highlightTile(listingKey, false));
        }

        wrap.appendChild(dot);
        wrap.appendChild(label);

        const marker = new mapboxgl.Marker({ element: wrap, anchor: 'center' })
          .setLngLat(coords)
          .addTo(map);

        markers.push(marker);
        markerMap[listingKey] = wrap;
      }

      syncTilesToViewport();
    }

    function renderTilesWithHover(grid, items) {
      grid.innerHTML = '';
      if (!items.length) {
        grid.innerHTML = `<div class="text-sm text-gray-500">No listings in this map area. Pan or zoom out to see more.</div>`;
        return;
      }
      
      // Apply seniority sorting to viewport items
      const sortedItems = sortListings(items);
      
      sortedItems.forEach(it => {
        const tile = renderTile(it);
        const listingKey = getListingKey(it);
        tile.dataset.listingId = listingKey;

        if (CAN_HOVER) {
          tile.addEventListener('mouseenter', () => highlightMarker(listingKey, true));
          tile.addEventListener('mouseleave', () => highlightMarker(listingKey, false));
        }
        grid.appendChild(tile);
      });
    }

    function syncTilesToViewport() {
      if (!map) return;
      const bounds = map.getBounds();
      const visible = allListingsWithCoords.filter(it => bounds.contains([it._lng, it._lat]));
      renderTilesWithHover($('grid'), visible);
    }

    function wireMapSync() {
      if (!map) return;
      map.on('moveend', syncTilesToViewport);
      map.on('zoomend', syncTilesToViewport);
    }

    async function applyAllFilters() {
      const f = readFiltersFromUI();
      setJSON('lastFilters', f);
      updateDropdownLabels(f);

      const q = $("qBox").value.trim();
      const filtered = allDocs.filter(d => matchesFilters(d, q, f));
      
      // Apply seniority priority sorting
      const sorted = sortListings(filtered);
      
      await addDotPriceMarkers(sorted);

      // GEOCODE + MAP MOVE: fly to the searched city/location
      // This ensures the map camera moves when the user searches a new city
      // (e.g., typing "Newport" while viewing Laguna results)
      if (q && map) {
        const geo = await geocodeWithBounds(q);
        if (geo?.center) {
          if (geo.bbox && Array.isArray(geo.bbox) && geo.bbox.length === 4) {
            map.fitBounds(
              [[geo.bbox[0], geo.bbox[1]], [geo.bbox[2], geo.bbox[3]]],
              { padding: 70, maxZoom: 14, duration: 1000 }
            );
          } else {
            map.flyTo({ center: geo.center, zoom: 12, duration: 1000 });
          }
        }
      }

      // URL sync
      syncFiltersToURL();
    }

    (async function boot() {
      updateAuthUI();

      // ===== URL params take priority =====
      const fromUrl = readFiltersFromURL();

      const qParam = (fromUrl.hasAny ? fromUrl.q : (getParam('q') || localStorage.getItem('lastSearch') || '')).trim();
      $("qBox").value = qParam;
      localStorage.setItem('lastSearch', qParam);

      const lastFilters = fromUrl.hasAny ? fromUrl.filters : getJSON('lastFilters', {});
      writeFiltersToUI(lastFilters);
      updateDropdownLabels(lastFilters);

      setJSON('lastFilters', lastFilters);

      await initMap(qParam);
      wireMapSync();

      try {
        const snap = await getDocs(query(collection(db, "listings"), orderBy("createdAt", "desc"), limit(200)));
        snap.forEach(d => {
          const data = d.data() || {};
          const signed = !!(data.signedISC && typeof data.signedISC === 'object' && data.signedISC.date);
          const isActive = String(data.status || '').toLowerCase() === 'active';
          if (!signed && !isActive) return;
          
          // DEBUG: Log sold listings to verify data
          if (String(data.status || '').toLowerCase() === 'sold') {
            console.log('[boot] Found SOLD listing:', d.id, '| soldDate:', data.soldDate, '| soldPrice:', data.soldPrice);
          }
          
          allDocs.push({ id: d.id, ...data });
        });
      } catch (e) {
        console.warn("[search] Firestore fetch failed:", e);
      }

      // Apply seniority priority sorting to allDocs
      allDocs = sortListings(allDocs);

      const filtered = allDocs.filter(d => matchesFilters(d, qParam, lastFilters));
      const sorted = sortListings(filtered);
      
      await addDotPriceMarkers(sorted);

      syncFiltersToURL();

      console.log('[search] Boot complete, listings loaded:', allDocs.length);

      // Enter key in search box
      $("qBox").addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyAllFilters();
          $('searchAutocomplete').classList.remove('show');
        }
      });

      // Autocomplete on input
      $("qBox").addEventListener('input', (e) => {
        showSavedSearchAutocomplete(e.target.value);
      });

      // Clear all filters
      $("clearFiltersBtn").onclick = async () => {
        setJSON('lastFilters', {});
        document.querySelectorAll('#priceMin, #priceMax, #bedsMin, #bathsMin, #status, #propType').forEach(el => el.value = '');
        updateDropdownLabels({});
        const q = $("qBox").value.trim();
        const refiltered = allDocs.filter(d => matchesFilters(d, q, {}));
        const resorted = sortListings(refiltered);
        await addDotPriceMarkers(resorted);

        syncFiltersToURL();
      };

      // ===== GATED ACTIONS =====

      $("saveSearchBtn").onclick = () => {
        requireAuth(() => {
          const q = $("qBox").value.trim();
          const filters = readFiltersFromUI();
          const nameInput = $("searchNameInput");
          const name = (nameInput?.value || '').trim() || q || "My Search";
          saveSearchToLocal(name, q, filters);
          if (nameInput) nameInput.value = '';
          alert("Search saved as: " + name);
        });
      };

      $("emailSearchBtn").onclick = () => {
        requireAuth(() => {
          const q = $("qBox").value.trim();
          const subject = encodeURIComponent(`Search Results: ${q || 'All Listings'}`);
          const body = encodeURIComponent(`View my search results:\n\n${window.location.href}`);
          window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });
      };

      $("textSearchBtn").onclick = () => {
        requireAuth(() => {
          const body = encodeURIComponent(`Check out these listings:\n\n${window.location.href}`);
          window.location.href = `sms:&body=${body}`;
        });
      };

      $("autoEmailBtn").onclick = () => {
        requireAuth(() => {
          const q = $("qBox").value.trim();
          const filters = readFiltersFromUI();
          saveSearchToLocal("Auto-Email: " + (q || "Search"), q, filters);
          alert("Auto-Email saved for this search (delivery wiring is post-MVP).");
        });
      };

      $("autoTextBtn").onclick = () => {
        requireAuth(() => {
          const q = $("qBox").value.trim();
          const filters = readFiltersFromUI();
          saveSearchToLocal("Auto-Text: " + (q || "Search"), q, filters);
          alert("Auto-Text saved for this search (delivery wiring is post-MVP).");
        });
      };

    })();
  </script>
</body>
</html>
