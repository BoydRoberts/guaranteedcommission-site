<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .mapboxgl-canvas { outline: none; }
    .pill { display:inline-flex; align-items:center; gap:4px; background:#f3f4f6; border-radius:9999px; padding:2px 10px; font-size:13px; margin:2px; }
    .pill button { background:none; border:none; color:#555; font-size:14px; cursor:pointer; line-height:1; }
    details[open] summary svg { transform: rotate(180deg); }

    /* Email/alerts banner */
    #saveBanner { display:none; }
    .banner { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; border-radius:8px; }
    .banner .btn { border-radius:8px; padding:.5rem .75rem; font-size:.875rem; }

    /* === Unified tile look (matches listing.html) === */
    .tile-photo { width:100%; height: 16rem; object-fit: cover; background:#e5e7eb; }
    .tile-banner { position:absolute; top:12px; left:12px; background:rgba(0,0,0,.8); color:#fff; font-size:12px; font-weight:600; border-radius:9999px; padding:4px 8px; }
    .heart-btn { position:absolute; top:12px; right:12px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(0,0,0,.08); overflow:hidden; }
    .tile-body { padding:1rem; } /* equal padding on all sides */
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">&larr; Home</a>
      <div class="text-center">
        <h1 class="text-xl font-bold">Search Results</h1>
        <p id="qLabel" class="text-xs text-gray-600"></p>
      </div>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <!-- Query & Controls -->
  <section class="bg-white border-y">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col items-center gap-3">

        <!-- Query + Saved dropdown -->
        <div class="w-full md:w-3/4 lg:w-2/3 flex items-center gap-2">
          <input id="qBox" class="border rounded px-3 py-2 w-full" placeholder="City, neighborhood, or ZIP">
          <button id="applyBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
          <select id="savedSearchesDropdown" class="border rounded px-2 py-2 text-sm">
            <option value="">Saved Searches</option>
          </select>
          <button id="saveSearchBtn" class="px-3 py-2 border rounded text-sm">Save Search</button>
        </div>

        <!-- Active filter pills -->
        <div id="activePills" class="flex flex-wrap mt-1"></div>

        <!-- Advanced filters -->
        <details id="filtersPanel" class="w-full md:w-3/4 lg:w-2/3">
          <summary class="flex items-center justify-between cursor-pointer select-none px-2 py-2 text-sm text-gray-700">
            <span class="font-semibold">Advanced filters</span>
            <svg width="16" height="16" viewBox="0 0 24 24" class="transition"><path fill="currentColor" d="M12 15.5L5 8.5l1.4-1.4L12 12.7l5.6-5.6L19 8.5z"/></svg>
          </summary>

          <div class="mt-3 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 text-sm">
            <div>
              <label class="block text-gray-600 mb-1">Min Price ($)</label>
              <input id="priceMin" type="number" min="0" step="1000" class="w-full border rounded px-2 py-1" placeholder="500000">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Max Price ($)</label>
              <input id="priceMax" type="number" min="0" step="1000" class="w-full border rounded px-2 py-1" placeholder="2500000">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Beds</label>
              <input id="bedsMin" type="number" min="0" step="1" class="w-full border rounded px-2 py-1" placeholder="3">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Baths</label>
              <input id="bathsMin" type="number" min="0" step="0.5" class="w-full border rounded px-2 py-1" placeholder="2">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Status</label>
              <select id="status" class="w-full border rounded px-2 py-1">
                <option value="">Any</option>
                <option>Active</option>
                <option>In Contract</option>
                <option>Sold</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Property Type</label>
              <select id="propType" class="w-full border rounded px-2 py-1">
                <option value="">Any</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Commission %</label>
              <input id="commPctMin" type="number" min="0" step="0.25" class="w-full border rounded px-2 py-1" placeholder="2.5">
            </div>
            <div>
              <label class="block text-gray-600 mb-1">Min Commission $</label>
              <input id="commUsdMin" type="number" min="0" step="5000" class="w-full border rounded px-2 py-1" placeholder="20000">
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="applyFiltersBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Apply filters</button>
            <button id="clearFiltersBtn" class="px-3 py-2 rounded border">Clear</button>
            <span class="text-xs text-gray-500 ml-2">Filters and last search are remembered.</span>
          </div>
        </details>

        <!-- Email/alerts banner -->
        <div id="saveBanner" class="w-full md:w-3/4 lg:w-2/3 banner p-3 mt-2">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div class="text-sm">
              <strong>Email these results?</strong> We’ll send today’s matches now and alert you when new listings appear.
            </div>
            <div class="flex gap-2">
              <button id="saveYesBtn" class="btn bg-indigo-600 text-white">Yes, email & alert me</button>
              <button id="saveNoBtn" class="btn border">Not now</button>
            </div>
          </div>

          <div id="saveLoginNeeded" class="hidden mt-2 text-sm text-amber-800">
            Please <a href="/login.html" class="underline">log in</a> to save searches and get alerts.
          </div>
          <div id="saveConfirmed" class="hidden mt-2 text-sm text-green-800">
            Saved. We’ll email these results now and alert you when new ones appear.
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Body: Map left, Tiles right -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="grid grid-cols-1 lg:grid-cols-5 gap-5">
      <aside class="lg:col-span-2 bg-white rounded-2xl shadow overflow-hidden">
        <div id="mapCanvas" class="h-[26rem] bg-gray-100"></div>
      </aside>
      <section class="lg:col-span-3">
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>
    </section>
  </main>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script>
    // Mapbox token
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtZXJvbjduajA5MW8yanBvMTgxcWx2a2IifQ.dMBWViogHJkh0SgeVX5N_Q";
    if (MAPBOX_TOKEN && window.mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const getParam = (k) => new URL(location.href).searchParams.get(k);
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };

    // Filters & pills
    function readFiltersFromUI() {
      const val = (id) => (document.getElementById(id)?.value || '').trim();
      const num = (id) => {
        const v = (document.getElementById(id)?.value || '').trim();
        const n = Number(v); return isFinite(n) && v!=='' ? n : null;
      };
      return {
        priceMin: num('priceMin'),
        priceMax: num('priceMax'),
        bedsMin:  num('bedsMin'),
        bathsMin: num('bathsMin'),
        status:   val('status'),
        propType: val('propType'),
        commPctMin: num('commPctMin'),
        commUsdMin: num('commUsdMin'),
      };
    }

    function writeFiltersToUI(f){
      const set = (id, v)=>{ const el=$(id); if (!el) return; el.value = (v ?? ''); };
      set('priceMin', f.priceMin ?? '');
      set('priceMax', f.priceMax ?? '');
      set('bedsMin',  f.bedsMin ?? '');
      set('bathsMin', f.bathsMin ?? '');
      set('status',   f.status ?? '');
      set('propType', f.propType ?? '');
      set('commPctMin', f.commPctMin ?? '');
      set('commUsdMin', f.commUsdMin ?? '');
    }

    function renderPills(filters){
      const pillsBox = $("activePills");
      pillsBox.innerHTML = '';
      function pill(label, key){
        const el = document.createElement('div');
        el.className='pill';
        el.innerHTML = `<span>${label}</span><button aria-label="Clear">&times;</button>`;
        el.querySelector('button').onclick = ()=>{ const input=document.getElementById(key); if(input){ input.value=''; } document.getElementById("applyFiltersBtn").click(); };
        pillsBox.appendChild(el);
      }
      if (filters.priceMin) pill(`$${Number(filters.priceMin).toLocaleString()}+`,'priceMin');
      if (filters.priceMax) pill(`Up to $${Number(filters.priceMax).toLocaleString()}`,'priceMax');
      if (filters.bedsMin) pill(`${filters.bedsMin}+ bds`,'bedsMin');
      if (filters.bathsMin) pill(`${filters.bathsMin}+ ba`,'bathsMin');
      if (filters.status) pill(filters.status,'status');
      if (filters.propType) pill(filters.propType,'propType');
      if (filters.commPctMin) pill(`${filters.commPctMin}%+`,'commPctMin');
      if (filters.commUsdMin) pill(`$${Number(filters.commUsdMin).toLocaleString()}+ comm`,'commUsdMin');
    }

    // Map helpers
    let map;
    async function geocodeCenter(q){
      if (!MAPBOX_TOKEN) return null;
      try {
        const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
        const data = await resp.json();
        return data?.features?.[0]?.center || null;
      } catch { return null; }
    }
    async function initMap(q){
      const center = (q && await geocodeCenter(q)) || [-117.7854, 33.5427];
      map = new mapboxgl.Map({ container: 'mapCanvas', style: 'mapbox://styles/mapbox/streets-v12', center, zoom: 12.5 });
      map.addControl(new mapboxgl.NavigationControl());
      return center;
    }
    async function addMarkers(items){
      if (!map) return;
      for (const it of items.slice(0, 50)) {
        const addr = (it?.address || '').trim();
        if (!addr) continue;
        try {
          const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(addr)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
          const data = await resp.json();
          const c = data?.features?.[0]?.center;
          if (!c) continue;
          const el = document.createElement("div");
          el.style.width = "10px"; el.style.height = "10px";
          el.style.background = "#dc2626"; el.style.border = "2px solid #fff";
          el.style.borderRadius = "50%"; el.style.boxShadow = "0 1px 2px rgba(0,0,0,.3)";
          el.title = (addr||'');
          new mapboxgl.Marker(el).setLngLat(c).addTo(map);
          el.addEventListener("click", () => {
            if (it.id) {
              window.location.href = `/listing.html?id=${encodeURIComponent(it.id)}`;
            } else {
              const slug = encodeURIComponent(addr);
              window.location.href = `/listing.html?addr=${slug}`;
            }
          });
        } catch {}
      }
    }

    // Saved searches
    function getSavedSearches(){ return getJSON('savedSearches', []); }
    function setSavedSearches(arr){ setJSON('savedSearches', arr); }
    function refreshSavedDropdown(){
      const dd = $("savedSearchesDropdown");
      dd.innerHTML = `<option value="">Saved Searches</option>`;
      getSavedSearches().forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.name || s.q || 'Search';
        dd.appendChild(opt);
      });
    }
    function saveCurrentSearch(name, q, filters, opts={}){
      const email = (localStorage.getItem('loggedInEmail') || '').trim();
      if (!email && opts.alerts) {
        $('saveLoginNeeded').classList.remove('hidden');
        return null;
      }
      const arr = getSavedSearches();
      const record = {
        id: 'ss_' + Date.now(),
        name: name || (q || 'Search') + ' #' + (arr.length+1),
        q, filters,
        email: email || '',
        alerts: !!opts.alerts,
        lastSent: opts.lastSent || null,
        lastChecked: Date.now()
      };
      arr.unshift(record);
      setSavedSearches(arr);
      refreshSavedDropdown();
      $("savedSearchesDropdown").value = record.id;
      return record;
    }

    function showSaveBanner(show) {
      const b = $('saveBanner');
      b.style.display = show ? 'block' : 'none';
      if (!show) {
        $('saveLoginNeeded').classList.add('hidden');
        $('saveConfirmed').classList.add('hidden');
      }
    }

    // Unified tile renderer (same as listing page)
    function money(n){ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$—"; }
    function commissionAmount(price, commission, type) {
      const p = Number(price||0), c = Number(commission||0);
      if (!c) return 0;
      return type === '$' ? Math.round(c) : (p ? Math.round(p * (c/100)) : 0);
    }
    function wireHeart(btn, keyId) {
      const KEY='gcFavorites';
      const favs = ()=>{ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch { return []; } };
      const setF = a=>{ try { localStorage.setItem(KEY, JSON.stringify(a||[])); } catch {} };
      const isFav = id => favs().includes(id);
      const tog = id => { const a=favs(); const i=a.indexOf(id); if(i>=0)a.splice(i,1); else a.push(id); setF(a); return a.includes(id); };
      const svg = a => a
        ? `<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>`
        : `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
      btn.innerHTML = svg(isFav(keyId));
      btn.onclick = (e)=>{ e.preventDefault(); btn.innerHTML = svg(tog(keyId)); };
    }
    function renderTileDoc(doc){
      const id = doc.id;
      const address = String(doc.address || "").trim();
      const banner  = String(doc.bannerText || "");
      const plan    = String(doc.plan || "Listed Property Basic");
      const status  = String(doc.status || "Active");
      const pType   = String(doc.propertyType || "");
      const bds     = doc.bedrooms ?? "—";
      const ba      = doc.bathrooms ?? "—";
      const sqft    = doc.sqft ? Number(doc.sqft).toLocaleString() : "—";
      const price   = (typeof doc.price === "number") ? doc.price : (Number(doc.price)||0);
      const cType   = (doc.commissionType === "%" || doc.commissionType === "$") ? doc.commissionType : "%";
      const cRaw    = doc.commission ?? "";
      const cAmt    = commissionAmount(price, cRaw, cType);
      const cPctLbl = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw)+'%')) : "—";
      const brokerage = doc.brokerage || (plan.includes("FSBO") ? "FOR SALE BY OWNER" : "[listing brokerage]");
      const agentName = doc.agentName || "";
      const agentPhone= doc.agentPhone || "";

      const photos = Array.isArray(doc.photos) ? doc.photos.filter(u=>typeof u==="string"&&u) : [];
      let pIdx = (typeof doc.primaryIndex === "number") ? doc.primaryIndex : 0;
      if (pIdx<0 || pIdx>=photos.length) pIdx = 0;
      const primaryPhoto = photos[pIdx] || "";

      const card = document.createElement("article");
      card.className = "card relative cursor-pointer";
      card.onclick = () => { window.location.href = `/listing.html?id=${encodeURIComponent(id)}`; };

      card.innerHTML = `
        <div class="relative">
          <img class="tile-photo" alt="Listing photo" src="${primaryPhoto}">
          ${banner ? `<div class="tile-banner">${banner}</div>` : ``}
          <button type="button" class="heart-btn" aria-label="Like"></button>
        </div>
        <div class="tile-body space-y-1">
          <div class="flex items-center justify-between text-[16px] sm:text-[18px] font-semibold">
            <div class="truncate">${price ? money(price) : "$—"}</div>
            <div class="truncate text-red-600">Commission ${cPctLbl} | ${cAmt ? money(cAmt) : "$—"}</div>
          </div>
          <div class="text-[12px] text-gray-700">
            ${bds} bds | ${ba} ba | ${sqft} sqft${pType ? " | " + pType : ""} | ${status}
          </div>
          <div class="text-sm font-medium">${address || "[full address]"}</div>
          <div class="text-[12px] text-gray-600">
            ${(plan.includes("FSBO") ? "FOR SALE BY OWNER" : (brokerage||"[listing brokerage]")).toUpperCase()}${agentName ? ' — '+agentName : ''}${agentPhone ? ' — '+agentPhone : ''}
          </div>
        </div>
      `;

      // Like button
      const heart = card.querySelector(".heart-btn");
      if (heart) wireHeart(heart, `fav:${id}`);

      return card;
    }

    // Main boot
    (async function boot(){
      const grid = $("grid");
      const qParam = getParam('q') || localStorage.getItem('lastSearch') || '';
      $("qBox").value = qParam;
      $("qLabel").textContent = qParam ? `Showing results for “${qParam}”` : 'Showing all listings';
      localStorage.setItem('lastSearch', qParam);

      const lastFilters = getJSON('lastFilters', {});
      writeFiltersToUI(lastFilters);
      renderPills(lastFilters);

      await initMap(qParam);

      // Firestore fetch (ONLY real data)
      let docs = [];
      try {
        const { db } = await import("/scripts/firebase-init.js");
        const { collection, query, orderBy, getDocs, limit } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
        const snap = await getDocs(query(collection(db, "listings"), orderBy("createdAt","desc"), limit(200)));
        snap.forEach(d => {
          const data = d.data() || {};
          // === CHANGE: hide drafts (require signed OR status:Active)
          const signed = !!(data.signedISC && typeof data.signedISC === 'object' && data.signedISC.date);
          const isActive = String(data.status || '').toLowerCase() === 'active';
          if (!signed && !isActive) return;
          docs.push({ id: d.id, ...data });
        });
      } catch (e) {
        console.warn("[search] Firestore fetch failed:", e);
      }

      // Apply filters + query
      const filtered = docs.filter(d => matchesFilters(d, qParam, lastFilters));

      // Render tiles
      grid.innerHTML = '';
      if (!filtered.length) {
        grid.innerHTML = `<div class="text-sm text-gray-500">No results. Try a different search.</div>`;
      } else {
        filtered.forEach(doc => grid.appendChild(renderTileDoc(doc)));
      }

      addMarkers(filtered);

      // Email banner
      showSaveBanner(true);

      // Search button
      $("applyBtn").onclick = () => {
        const q = $("qBox").value.trim();
        localStorage.setItem('lastSearch', q);
        location.href = `/search.html?q=${encodeURIComponent(q)}`;
      };

      // Filters
      $("applyFiltersBtn").onclick = () => {
        const f = readFiltersFromUI();
        setJSON('lastFilters', f);
        renderPills(f);
        const q = $("qBox").value.trim();
        const refiltered = docs.filter(d => matchesFilters(d, q, f));
        $("qLabel").textContent = q ? `Showing results for “${q}”` : 'Showing all listings';
        grid.innerHTML = '';
        if (!refiltered.length) grid.innerHTML = `<div class="text-sm text-gray-500">No results. Try a different search.</div>`;
        else refiltered.forEach(doc => grid.appendChild(renderTileDoc(doc)));
        addMarkers(refiltered);
        showSaveBanner(true);
      };

      $("clearFiltersBtn").onclick = () => {
        setJSON('lastFilters', {});
        document.querySelectorAll('#filtersPanel input, #filtersPanel select').forEach(el => el.value = '');
        renderPills({});
        const q = $("qBox").value.trim();
        const refiltered = docs.filter(d => matchesFilters(d, q, {}));
        grid.innerHTML = '';
        if (!refiltered.length) grid.innerHTML = `<div class="text-sm text-gray-500">No results. Try a different search.</div>`;
        else refiltered.forEach(doc => grid.appendChild(renderTileDoc(doc)));
        addMarkers(refiltered);
        showSaveBanner(true);
      };

      // Saved searches dropdown
      const dd = $("savedSearchesDropdown");
      dd.onchange = () => {
        const id = dd.value;
        if (!id) return;
        const arr = getSavedSearches();
        const sel = arr.find(s => s.id === id);
        if (!sel) return;
        $("qBox").value = sel.q || '';
        writeFiltersToUI(sel.filters || {});
        renderPills(sel.filters || {});
        const refiltered = docs.filter(d => matchesFilters(d, sel.q || '', sel.filters || {}));
        $("qLabel").textContent = sel.q ? `Showing results for “${sel.q}”` : 'Showing all listings';
        grid.innerHTML = '';
        if (!refiltered.length) grid.innerHTML = `<div class="text-sm text-gray-500">No results. Try a different search.</div>`;
        else refiltered.forEach(doc => grid.appendChild(renderTileDoc(doc)));
        addMarkers(refiltered);
        showSaveBanner(true);
      };

      // Open filters/prompt via query params
      (function(){
        const u = new URL(location.href);
        if (u.searchParams.get('open') === 'filters') {
          document.getElementById('filtersPanel')?.setAttribute('open','');
        }
        if (u.searchParams.get('prompt') === 'save') {
          showSaveBanner(true);
        }
      })();

      refreshSavedDropdown();

      // Save banner buttons
      $('saveYesBtn').addEventListener('click', () => {
        const q = $("qBox").value.trim();
        const filters = readFiltersFromUI();
        const rec = saveCurrentSearch('', q, filters, { alerts: true, lastSent: Date.now() });
        if (rec) $('saveConfirmed').classList.remove('hidden');
      });
      $('saveNoBtn').addEventListener('click', () => { showSaveBanner(false); });
    })();

    // Apply filters against a Firestore doc
    function matchesFilters(doc, qtext, f){
      const address = (doc.address || '').toLowerCase();
      if (qtext && !address.includes(qtext.toLowerCase().trim())) return false;

      const price = Number(doc.price || 0);
      if (f.priceMin && price && price < f.priceMin) return false;
      if (f.priceMax && price && price > f.priceMax) return false;

      const beds = Number(doc.bedrooms || 0);
      const baths = Number(doc.bathrooms || 0);
      if (f.bedsMin && beds < f.bedsMin) return false;
      if (f.bathsMin && baths < f.bathsMin) return false;

      if (f.status) {
        const normalized = (String(doc.status||'').toLowerCase()==='in_contract') ? 'In Contract' : (doc.status||'');
        if (normalized !== f.status) return false;
      }

      if (f.propType) {
        const type = String(doc.propertyType || '').toLowerCase();
        if (!type || type !== f.propType.toLowerCase()) return false;
      }

      const commType = doc.commissionType || '%';
      const commVal = Number(doc.commission || 0);
      if (f.commPctMin) {
        if (commType === '%' && commVal < f.commPctMin) return false;
        if (commType === '$') {
          const p = Number(doc.price || 0);
          if (p && (commVal / p * 100) < f.commPctMin) return false;
        }
      }
      if (f.commUsdMin) {
        if (commType === '$' && commVal < f.commUsdMin) return false;
        if (commType === '%') {
          const p = Number(doc.price || 0);
          if (p && Math.round(p * (commVal/100)) < f.commUsdMin) return false;
        }
      }

      return true;
    }
  </script>
</body>
</html>
