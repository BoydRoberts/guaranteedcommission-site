<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <a href="/" class="text-blue-700 underline text-sm">&larr; Back to Home</a>
      <div class="text-center flex-1">
        <h1 class="text-2xl font-bold">Search Guaranteed Commissions</h1>
        <p class="text-xs text-gray-600">Find listings where the buyer’s agent commission is communicated up front.</p>
      </div>
      <a href="/login.html" class="text-blue-700 underline text-sm">Log In</a>
    </div>
  </header>

  <!-- Search Bar & Filters -->
  <section class="max-w-7xl mx-auto px-4 py-4">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
        <div class="lg:col-span-2">
          <label class="text-sm font-semibold block mb-1">Search</label>
          <input id="q" type="text"
                 placeholder="Search by address, city, brokerage, or agent..."
                 class="w-full border p-2 rounded" />
        </div>
        <div>
          <label class="text-sm font-semibold block mb-1">Min Price</label>
          <input id="minPrice" type="number" min="0" step="1000" placeholder="e.g., 500000"
                 class="w-full border p-2 rounded" />
        </div>
        <div>
          <label class="text-sm font-semibold block mb-1">Max Price</label>
          <input id="maxPrice" type="number" min="0" step="1000" placeholder="e.g., 1500000"
                 class="w-full border p-2 rounded" />
        </div>

        <div>
          <label class="text-sm font-semibold block mb-1">Beds (min)</label>
          <input id="bedsMin" type="number" min="0" step="1" placeholder="e.g., 2"
                 class="w-full border p-2 rounded" />
        </div>
        <div>
          <label class="text-sm font-semibold block mb-1">Baths (min)</label>
          <input id="bathsMin" type="number" min="0" step="1" placeholder="e.g., 2"
                 class="w-full border p-2 rounded" />
        </div>

        <div class="lg:col-span-2 flex gap-2">
          <button id="applyBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-full lg:w-auto">Apply Filters</button>
          <button id="clearBtn" class="bg-gray-300 text-gray-900 px-4 py-2 rounded w-full lg:w-auto">Clear</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section class="max-w-7xl mx-auto px-4 pb-12">
    <div id="tilesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    <p id="noResults" class="hidden text-center text-sm text-gray-600 mt-6">No listings match your filters.</p>
  </section>

  <script>
    function getAllListings() {
      const listings = JSON.parse(localStorage.getItem('listings') || '[]');

      // Include stub listing if present (from agent invite path)
      const status = localStorage.getItem('listingStatus');
      const stub = JSON.parse(localStorage.getItem('listingStub') || 'null');
      if (status === 'stub-live' && stub) {
        listings.unshift({
          id: 'stub',
          address: stub.address || localStorage.getItem('shortAddress') || 'Coming Soon',
          shortAddress: (stub.shortAddress || (stub.address || '').split(',')[0] || 'Coming Soon'),
          plan: stub.plan || 'Listed Property Basic',
          price: '', // Coming soon
          beds: '', baths: '',
          commissionDisplay: stub.commissionDisplay || '',
          commissionType: stub.commissionType || '%',
          brokerage: stub.brokerage || '',
          agent: stub.agent || '',
          agentPhone: stub.agentPhone || '',
          photoUrl: 'coming-soon',
          createdAt: Date.now()
        });
      }
      return listings;
    }

    function money(n){
      if(n === '' || n === null || n === undefined) return '';
      const num = Number(n);
      if (isNaN(num)) return '';
      return num.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    }

    function tileHtml(l){
      const imgSrc = (l.photoUrl === 'coming-soon' || !l.photoUrl)
        ? 'https://via.placeholder.com/600x400?text=Coming+Soon'
        : l.photoUrl;

      const price = l.price ? money(l.price) : 'Price coming soon';
      const beds = l.beds ? `${l.beds} bd` : '';
      const baths = l.baths ? `${l.baths} ba` : '';
      const meta = [beds, baths].filter(Boolean).join(' • ');

      const commissionBadge = l.commissionDisplay
        ? `<span class="text-xs px-2 py-1 rounded bg-green-100 text-green-700 ring-1 ring-green-300">${l.commissionDisplay}</span>`
        : '';

      const agentLine = (l.brokerage || l.agent || l.agentPhone)
        ? `<p class="mt-1 text-xs text-gray-600">${[l.brokerage, l.agent, l.agentPhone].filter(Boolean).join(' • ')}</p>`
        : '';

      const href = `/listing.html?id=${encodeURIComponent(l.id || 'stub')}`;

      return `
        <a href="${href}" class="block bg-white rounded-lg shadow hover:shadow-md transition overflow-hidden">
          <div class="relative">
            <img src="${imgSrc}" alt="${l.shortAddress || l.address || ''}" class="w-full h-44 object-cover">
            ${commissionBadge ? `<div class="absolute top-2 left-2">${commissionBadge}</div>` : ''}
          </div>
          <div class="p-3">
            <div class="flex items-baseline justify-between">
              <h3 class="font-semibold text-base truncate mr-2">${l.shortAddress || l.address || ''}</h3>
              <span class="text-sm font-bold">${price}</span>
            </div>
            ${meta ? `<p class="text-sm text-gray-700 mt-1">${meta}</p>` : ''}
            ${agentLine}
          </div>
        </a>
      `;
    }

    function passesFilters(l, f){
      // Text search
      const hay = [
        l.address || '', l.shortAddress || '', l.brokerage || '', l.agent || ''
      ].join(' ').toLowerCase();
      if (f.q && !hay.includes(f.q)) return false;

      // Price
      const price = Number(l.price || 0);
      if (f.minPrice && (!price || price < f.minPrice)) return false;
      if (f.maxPrice && price && price > f.maxPrice) return false;

      // Beds / Baths (treat missing as 0)
      const beds = Number(l.beds || 0);
      const baths = Number(l.baths || 0);
      if (f.bedsMin && beds < f.bedsMin) return false;
      if (f.bathsMin && baths < f.bathsMin) return false;

      return true;
    }

    function render(){
      const grid = document.getElementById('tilesGrid');
      const noRes = document.getElementById('noResults');

      const f = {
        q: (document.getElementById('q').value || '').toLowerCase().trim(),
        minPrice: Number(document.getElementById('minPrice').value || 0),
        maxPrice: Number(document.getElementById('maxPrice').value || 0),
        bedsMin: Number(document.getElementById('bedsMin').value || 0),
        bathsMin: Number(document.getElementById('bathsMin').value || 0),
      };

      const all = getAllListings();
      const filtered = all.filter(l => passesFilters(l, f));

      if (filtered.length === 0){
        grid.innerHTML = '';
        noRes.classList.remove('hidden');
        return;
      }
      noRes.classList.add('hidden');

      grid.innerHTML = filtered.map(tileHtml).join('');
    }

    window.addEventListener('DOMContentLoaded', () => {
      // Wire buttons
      document.getElementById('applyBtn').addEventListener('click', render);
      document.getElementById('clearBtn').addEventListener('click', () => {
        ['q','minPrice','maxPrice','bedsMin','bathsMin'].forEach(id => document.getElementById(id).value = '');
        render();
      });

      // Live typing on main query
      document.getElementById('q').addEventListener('input', render);

      // Initial paint
      render();
    });
  </script>
</body>
</html>
