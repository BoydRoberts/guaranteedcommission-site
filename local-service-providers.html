<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Service Providers | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="relative flex items-center justify-center max-w-7xl mx-auto px-4 py-4">
      <a href="/advertise.html" class="absolute left-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">← Back to Advertise</a>

      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <h2 class="text-2xl font-bold text-center mb-2" style="color:#4DA6FF;">Local Service Providers</h2>
    <p class="text-center text-gray-600 mb-6">
      Display your business card on every listing detail page and on every listed property intake page (seller and agent) in a specified ZIP code.
    </p>

    <!-- Pricing Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm text-blue-900">
      <p class="font-semibold">$5 per month per ZIP code</p>
      <p class="text-blue-700 mt-1">Maximum 3 ZIP codes | Eight service providers per ZIP | First come first served</p>
    </div>

    <!-- Status -->
    <div id="status" class="hidden mb-4 text-sm rounded-lg p-3" role="alert"></div>

    <!-- Signup Form -->
    <form id="serviceProviderForm" class="bg-white rounded-xl shadow p-6 space-y-5" autocomplete="off">
      <div>
        <label for="role" class="block text-sm font-semibold mb-1">Service Type <span class="text-red-600">*</span></label>
        <input id="role" type="text" required placeholder="e.g., Title, Escrow, Architect, Builder, Planner" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <p class="text-xs text-gray-500 mt-1">Enter your service category (Title, Escrow, Architect, Builder, etc.)</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="name" class="block text-sm font-semibold mb-1">Your Name <span class="text-red-600">*</span></label>
          <input id="name" type="text" required placeholder="First Last" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="company" class="block text-sm font-semibold mb-1">Company Name <span class="text-red-600">*</span></label>
          <input id="company" type="text" required placeholder="Your Company LLC" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="email" class="block text-sm font-semibold mb-1">Email <span class="text-red-600">*</span></label>
          <input id="email" type="email" required placeholder="you@example.com" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="phone" class="block text-sm font-semibold mb-1">Phone <span class="text-red-600">*</span></label>
          <input id="phone" type="tel" required placeholder="123-456-7890" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div>
        <label for="license" class="block text-sm font-semibold mb-1">License # <span class="text-gray-400">(Optional)</span></label>
        <input id="license" type="text" placeholder="License or certification number" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- ZIP Codes -->
      <div>
        <label class="block text-sm font-semibold mb-1">ZIP Codes <span class="text-red-600">*</span></label>
        <p class="text-xs text-gray-500 mb-2">Enter up to 3 ZIP codes where you want to display your business card. At least one required.</p>
        <div class="grid grid-cols-3 gap-3">
          <input id="zip1" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 1" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input id="zip2" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 2" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input id="zip3" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 3" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <!-- Business Card Upload -->
      <div>
        <label for="photoInput" class="block text-sm font-semibold mb-1">Business Card Image <span class="text-gray-400">(Optional)</span></label>
        <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" class="block w-full text-sm">
        <p class="text-xs text-gray-500 mt-1">PNG or JPG. This will be displayed on listing pages in your ZIP codes.</p>
        <div id="photoPreview" class="mt-3 hidden">
          <img id="previewImg" class="thumb" alt="Preview">
        </div>
      </div>

      <div class="pt-4">
        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
          Continue to Payment ($5/month per ZIP)
        </button>
      </div>
    </form>

    <!-- Search Section -->
    <section class="mt-10 bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-4" style="color:#4DA6FF;">Search Local Service Providers by ZIP</h3>
      <div class="flex gap-2 mb-4">
        <input id="searchZip" type="text" maxlength="5" placeholder="Enter ZIP code" class="flex-1 border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="searchBtn" type="button" class="px-4 py-2 rounded text-white font-semibold hover:opacity-90" style="background-color:#4DA6FF;">Search</button>
      </div>
      <div id="searchResults" class="space-y-3"></div>
      <p id="searchEmpty" class="hidden text-sm text-gray-500">No service providers found for this ZIP code.</p>
    </section>
  </main>

  <!-- Firebase init -->
  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import {
      collection, addDoc, query, where, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const $ = (id) => document.getElementById(id);
    const COLLECTION = "localServiceProviders";
    const MAX_PER_ZIP = 8;
    const STRIPE_LINK = "https://buy.stripe.com/test_SERVICE_PROVIDER_PLACEHOLDER";

    function setStatus(msg, ok = false) {
      const box = $("status");
      box.classList.remove("hidden");
      box.textContent = msg;
      box.className = ok
        ? "mb-4 text-sm rounded-lg p-3 bg-green-50 text-green-700"
        : "mb-4 text-sm rounded-lg p-3 bg-red-50 text-red-700";
    }

    function formatPhone(s) {
      const d = (s || "").replace(/\D/g, "").slice(0, 10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0, 3) + "-" + d.slice(3);
      return d.slice(0, 3) + "-" + d.slice(3, 6) + "-" + d.slice(6);
    }

    // Phone formatting
    $("phone")?.addEventListener("input", (e) => {
      const cur = e.target.selectionStart;
      const before = e.target.value;
      e.target.value = formatPhone(before);
      e.target.selectionStart = e.target.selectionEnd = Math.min(cur + (e.target.value.length - before.length), e.target.value.length);
    });

    // ZIP inputs - digits only
    ["zip1", "zip2", "zip3", "searchZip"].forEach((id) => {
      $(id)?.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0, 5);
      });
    });

    // Photo preview
    $("photoInput")?.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          $("previewImg").src = ev.target.result;
          $("photoPreview").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      } else {
        $("photoPreview").classList.add("hidden");
      }
    });

    // Check ZIP availability (max 8 providers per ZIP)
    async function checkZipAvailability(zips) {
      const soldOut = [];
      for (const zip of zips) {
        if (!zip) continue;
        try {
          const q = query(
            collection(db, COLLECTION),
            where("status", "==", "active"),
            where("zips", "array-contains", zip)
          );
          const snap = await getDocs(q);
          if (snap.size >= MAX_PER_ZIP) {
            soldOut.push(zip);
          }
        } catch (e) {
          console.warn("[checkZip] error for", zip, e);
        }
      }
      return soldOut;
    }

    // Upload photo to Storage
    async function uploadPhoto(file, docId) {
      const storage = getStorage(undefined, STORAGE_BUCKET_GS);
      const safeName = String(file.name || "card").replace(/[^\w\-.]+/g, "_");
      const path = `localServiceProviders/${docId}/${Date.now()}_${safeName}`;
      const r = ref(storage, path);
      await uploadBytes(r, file);
      return await getDownloadURL(r);
    }

    // Form submission
    $("serviceProviderForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const role = ($("role")?.value || "").trim();
      const name = ($("name")?.value || "").trim();
      const company = ($("company")?.value || "").trim();
      const email = ($("email")?.value || "").trim().toLowerCase();
      const phone = ($("phone")?.value || "").trim();
      const license = ($("license")?.value || "").trim();
      const zip1 = ($("zip1")?.value || "").trim();
      const zip2 = ($("zip2")?.value || "").trim();
      const zip3 = ($("zip3")?.value || "").trim();
      const photoFile = $("photoInput")?.files?.[0] || null;

      // Validation
      if (!role || !name || !company || !email || !phone) {
        setStatus("Please complete all required fields.");
        return;
      }

      const zips = [zip1, zip2, zip3].filter((z) => z && z.length === 5);
      if (zips.length === 0) {
        setStatus("Please enter at least one valid 5-digit ZIP code.");
        return;
      }

      // Check ZIP availability
      setStatus("Checking ZIP availability...", true);
      const soldOut = await checkZipAvailability(zips);
      if (soldOut.length > 0) {
        setStatus(`ZIP ${soldOut.join(", ")} is sold out (limit ${MAX_PER_ZIP}). Please choose different ZIP codes.`);
        return;
      }

      setStatus("Saving your information...", true);

      try {
        // Create Firestore document
        const docData = {
          role: role,
          name: name,
          company: company,
          email: email,
          emailLower: email.toLowerCase(),
          phone: phone,
          license: license || null,
          zips: zips,
          status: "pending", // Will be set to "active" after payment
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, COLLECTION), docData);
        console.log("[service-provider] Created doc:", docRef.id);

        // Upload photo if provided
        if (photoFile) {
          try {
            const photoUrl = await uploadPhoto(photoFile, docRef.id);
            // Note: In production, you'd update the doc with the photoUrl
            // For now, we'll store it in localStorage for the Stripe return
            localStorage.setItem("pendingServiceProviderPhoto", photoUrl);
          } catch (uploadErr) {
            console.warn("[service-provider] Photo upload failed:", uploadErr);
          }
        }

        // Store pending info for Stripe return
        localStorage.setItem("pendingServiceProviderId", docRef.id);
        localStorage.setItem("pendingServiceProviderEmail", email);

        setStatus("Redirecting to payment...", true);

        // Calculate total based on number of ZIPs
        const total = zips.length * 5;

        // Redirect to Stripe (placeholder link)
        setTimeout(() => {
          window.location.href = `${STRIPE_LINK}?prefilled_email=${encodeURIComponent(email)}&client_reference_id=${docRef.id}`;
        }, 800);

      } catch (err) {
        console.error("[service-provider] Save failed:", err);
        setStatus("Could not save your information. Please try again.");
      }
    });

    // Search functionality
    $("searchBtn")?.addEventListener("click", async () => {
      const zip = ($("searchZip")?.value || "").trim();
      if (!zip || zip.length !== 5) {
        setStatus("Please enter a valid 5-digit ZIP code.");
        return;
      }

      const resultsDiv = $("searchResults");
      const emptyMsg = $("searchEmpty");
      resultsDiv.innerHTML = "<p class='text-sm text-gray-500'>Searching...</p>";
      emptyMsg.classList.add("hidden");

      try {
        const q = query(
          collection(db, COLLECTION),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          resultsDiv.innerHTML = "";
          emptyMsg.classList.remove("hidden");
          return;
        }

        resultsDiv.innerHTML = "";
        snap.forEach((doc) => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "flex items-center gap-4 p-3 border rounded-lg bg-gray-50";

          const photoSrc = d.photoUrl || d.photo || "";
          if (photoSrc) {
            const img = document.createElement("img");
            img.src = photoSrc;
            img.alt = d.company || "Service Provider";
            img.className = "thumb";
            img.onerror = () => {
              img.style.display = "none";
            };
            card.appendChild(img);
          } else {
            const placeholder = document.createElement("div");
            placeholder.className = "thumb bg-gray-200 flex items-center justify-center text-xs text-gray-500";
            placeholder.textContent = "No Image";
            card.appendChild(placeholder);
          }

          const info = document.createElement("div");
          info.className = "flex-1";
          info.innerHTML = `
            <p class="font-semibold">${d.company || d.name || "Service Provider"}</p>
            <p class="text-sm text-gray-600">${d.role || "Service Provider"}</p>
            <p class="text-xs text-gray-500">${d.name || ""} ${d.phone ? "• " + d.phone : ""}</p>
          `;
          card.appendChild(info);

          resultsDiv.appendChild(card);
        });

      } catch (err) {
        console.error("[search] failed:", err);
        resultsDiv.innerHTML = "<p class='text-sm text-red-600'>Search failed. Please try again.</p>";
      }
    });

    // Allow Enter key to trigger search
    $("searchZip")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        $("searchBtn")?.click();
      }
    });
  </script>
</body>
</html>
