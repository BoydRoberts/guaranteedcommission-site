<!DOCTYPE html>
<!-- Build: 2026-02-28 (Frankenstein fix: removed seller-detail.html | Auth gate fix | Success UI: hide form) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Service Providers | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Full business card preview - shows complete rectangle */
    .card-preview { width: auto; max-width: 100%; height: auto; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb; }
    /* Search result thumbnails */
    .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="relative flex items-center justify-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="absolute left-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">Home</a>

      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>

      <div class="absolute right-4 flex items-center gap-4">
        <a href="/advertise.html" class="text-xs font-semibold hover:underline" style="color:#4DA6FF;">Advertise</a>
        <a href="/login.html" id="authLink" class="text-xs font-semibold hover:underline" style="color:#4DA6FF;">Log In</a>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <h2 class="text-2xl font-bold text-center mb-2" style="color:#4DA6FF;">Local Service Providers</h2>
    <p class="text-center text-gray-600 mb-6">
      Display your business card on every listing detail page and on every listed property intake page (seller and agent) in a specified ZIP code.
    </p>

    <!-- Pricing Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm text-blue-900">
      <p class="font-semibold">$5 per month per ZIP code</p>
      <p class="text-blue-700 mt-1">Maximum 3 ZIP codes | Eight service providers per ZIP | First come first served</p>
    </div>

    <!-- Status -->
    <div id="status" class="hidden mb-4 text-sm rounded-lg p-3" role="alert"></div>

    <!-- Success Message (shown after payment) -->
    <section id="thanks" class="hidden bg-emerald-50 rounded-2xl border border-emerald-200 p-5 mb-6 text-emerald-800">
      <h3 class="text-lg font-semibold">Thank you!</h3>
      <p class="text-sm mt-1">Your Local Service Provider subscription checkout completed successfully.</p>
    </section>

    <!-- Signup Form -->
    <form id="serviceProviderForm" class="bg-white rounded-xl shadow p-6 space-y-5" autocomplete="off">
      <div>
        <label for="role" class="block text-sm font-semibold mb-1">Service Type <span class="text-red-600">*</span></label>
        <input id="role" type="text" required placeholder="e.g., Title, Escrow, Architect, Builder, Planner" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <p class="text-xs text-gray-500 mt-1">Enter your service category (Title, Escrow, Architect, Builder, etc.)</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="name" class="block text-sm font-semibold mb-1">Your Name <span class="text-red-600">*</span></label>
          <input id="name" type="text" required placeholder="First Last" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="company" class="block text-sm font-semibold mb-1">Company Name <span class="text-gray-400">(Optional)</span></label>
          <input id="company" type="text" placeholder="Your Company LLC" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="email" class="block text-sm font-semibold mb-1">Email <span class="text-red-600">*</span></label>
          <input id="email" type="email" required placeholder="you@example.com" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label for="phone" class="block text-sm font-semibold mb-1">Phone <span class="text-red-600">*</span></label>
          <input id="phone" type="tel" required placeholder="123-456-7890" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div>
        <label for="license" class="block text-sm font-semibold mb-1">License # <span class="text-gray-400">(Optional)</span></label>
        <input id="license" type="text" placeholder="License or certification number" class="w-full border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <!-- ZIP Codes -->
      <div>
        <label class="block text-sm font-semibold mb-1">ZIP Codes <span class="text-red-600">*</span></label>
        <p class="text-xs text-gray-500 mb-2">Enter up to 3 ZIP codes where you want to display your business card. At least one required.</p>
        <div class="grid grid-cols-3 gap-3">
          <input id="zip1" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 1" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input id="zip2" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 2" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
          <input id="zip3" type="text" maxlength="5" pattern="\d{5}" placeholder="ZIP 3" class="border p-2 rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <!-- Business Card Upload -->
      <div>
        <label for="photoInput" class="block text-sm font-semibold mb-1">Business Card Image <span class="text-red-600">*</span></label>
        <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" required class="block w-full text-sm">
        <p class="text-xs text-gray-500 mt-1">PNG or JPG. This will be displayed on listing pages in your ZIP codes.</p>
        <div id="photoPreview" class="mt-3 hidden">
          <img id="previewImg" class="card-preview" alt="Business Card Preview">
        </div>
      </div>

      <div class="pt-4">
        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
          Continue to Payment ($5/month per ZIP)
        </button>
      </div>
    </form>

    <!-- Search Section -->
    <section class="mt-10 bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-4" style="color:#4DA6FF;">Search Local Service Providers by ZIP</h3>
      <div class="flex gap-2 mb-4">
        <input id="searchZip" type="text" maxlength="5" placeholder="Enter ZIP code" class="flex-1 border p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="searchBtn" type="button" class="px-4 py-2 rounded text-white font-semibold hover:opacity-90" style="background-color:#4DA6FF;">Search</button>
      </div>
      <div id="searchResults" class="space-y-3"></div>
      <p id="searchEmpty" class="hidden text-sm text-gray-500">No service providers found for this ZIP code.</p>
    </section>
  </main>

  <!-- Firebase init -->
  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import {
      collection, addDoc, query, where, getDocs, serverTimestamp, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const $ = (id) => document.getElementById(id);
    const COLLECTION = "localServiceProviders";
    const MAX_PER_ZIP = 8;
    const MAX_ZIPS = 3;
    const PRICE_PER_ZIP = 5;
    // Stripe checkout is handled via /api/create-subscription-session (dynamic quantity)
    const PRICE_ID_LOCAL_SERVICE = "price_1Stz0hPTiT2zuxx0S4zezAW4"; // $5/mo per ZIP

    // Waitlist state
    let isWaitlistMode = false;
    let soldOutZips = [];

    function setStatus(msg, ok = false) {
      const box = $("status");
      box.classList.remove("hidden");
      box.textContent = msg;
      box.className = ok
        ? "mb-4 text-sm rounded-lg p-3 bg-green-50 text-green-700"
        : "mb-4 text-sm rounded-lg p-3 bg-red-50 text-red-700";
    }

    function fmtMoney(n) { return '$' + Number(n || 0).toLocaleString(); }

    function formatPhone(s) {
      const d = (s || "").replace(/\D/g, "").slice(0, 10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0, 3) + "-" + d.slice(3);
      return d.slice(0, 3) + "-" + d.slice(3, 6) + "-" + d.slice(6);
    }

    // Phone formatting
    $("phone")?.addEventListener("input", (e) => {
      const cur = e.target.selectionStart;
      const before = e.target.value;
      e.target.value = formatPhone(before);
      e.target.selectionStart = e.target.selectionEnd = Math.min(cur + (e.target.value.length - before.length), e.target.value.length);
    });

    // ZIP inputs - digits only + trigger availability check
    ["zip1", "zip2", "zip3"].forEach((id) => {
      $(id)?.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/\D/g, "").slice(0, 5);
        debouncedAvailabilityCheck();
      });
    });
    
    // Search ZIP - digits only (no availability check)
    $("searchZip")?.addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, "").slice(0, 5);
    });

    // Photo preview with full card-preview class
    $("photoInput")?.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          $("previewImg").src = ev.target.result;
          $("previewImg").className = "card-preview";
          $("photoPreview").classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      } else {
        $("photoPreview").classList.add("hidden");
      }
    });

    // Check ZIP availability (max 8 providers per ZIP)
    async function checkZipAvailability(zips) {
      const soldOut = [];
      for (const zip of zips) {
        if (!zip) continue;
        try {
          const q = query(
            collection(db, COLLECTION),
            where("status", "==", "active"),
            where("zips", "array-contains", zip)
          );
          const snap = await getDocs(q);
          if (snap.size >= MAX_PER_ZIP) {
            soldOut.push(zip);
          }
        } catch (e) {
          console.warn("[checkZip] error for", zip, e);
        }
      }
      return soldOut;
    }

    // Update button state based on availability
    function updateButtonState(soldOut, zips) {
      const btn = $("serviceProviderForm")?.querySelector('button[type="submit"]');
      if (!btn) return;
      
      soldOutZips = soldOut;
      
      if (soldOut.length > 0 && zips.length > 0) {
        // Some ZIPs are sold out - switch to waitlist mode
        isWaitlistMode = true;
        btn.textContent = 'Join Waitlist';
        btn.className = 'w-full py-3 rounded-lg text-white font-semibold transition';
        btn.style.backgroundColor = '#4DA6FF';
        
        // Show which ZIPs are sold out
        setStatus(`ZIP ${soldOut.join(', ')} is currently full (limit ${MAX_PER_ZIP}). You can join the waitlist to be notified when a spot opens.`, true);
      } else {
        // All ZIPs available - normal checkout mode
        isWaitlistMode = false;
        btn.textContent = `Continue to Payment (${fmtMoney(PRICE_PER_ZIP)}/month per ZIP)`;
        btn.className = 'w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition';
        btn.style.backgroundColor = '';
        $("status").classList.add("hidden");
      }
    }

    // Get current ZIPs from inputs
    function getCurrentZips() {
      const zip1 = ($("zip1")?.value || "").trim();
      const zip2 = ($("zip2")?.value || "").trim();
      const zip3 = ($("zip3")?.value || "").trim();
      return [zip1, zip2, zip3].filter((z) => z && z.length === 5);
    }

    // Debounced availability check
    let checkTimeout = null;
    async function debouncedAvailabilityCheck() {
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(async () => {
        const zips = getCurrentZips();
        
        if (zips.length > 0) {
          const soldOut = await checkZipAvailability(zips);
          updateButtonState(soldOut, zips);
        } else {
          updateButtonState([], zips);
        }
      }, 500);
    }

    // ========== AUTH GATE HELPERS ==========
    // Helper to check if user is logged in
    function isLoggedIn() {
      const email = (localStorage.getItem('loggedInEmail') || '').trim();
      return email.length > 0;
    }

    // Helper to save form draft for auth gate
    function saveFormDraft() {
      const draft = {
        role: $('role')?.value || '',
        name: $('name')?.value || '',
        company: $('company')?.value || '',
        email: $('email')?.value || '',
        phone: $('phone')?.value || '',
        license: $('license')?.value || '',
        zip1: $('zip1')?.value || '',
        zip2: $('zip2')?.value || '',
        zip3: $('zip3')?.value || '',
        savedAt: Date.now()
      };
      localStorage.setItem('localServiceFormDraft', JSON.stringify(draft));
      console.log('[service-providers] Form draft saved for auth gate');
    }

    // ========== DRAFT RESTORATION (Auth Gate Support) ==========
    // If user was redirected to login and came back, restore their form data
    (function restoreDraft() {
      try {
        const draftJson = localStorage.getItem('localServiceFormDraft');
        if (!draftJson) return;
        
        const draft = JSON.parse(draftJson);
        console.log('[service-providers] Restoring form draft:', draft);
        
        // Restore form fields
        if (draft.role && $('role')) $('role').value = draft.role;
        if (draft.name && $('name')) $('name').value = draft.name;
        if (draft.company && $('company')) $('company').value = draft.company;
        if (draft.email && $('email')) $('email').value = draft.email;
        if (draft.phone && $('phone')) $('phone').value = formatPhone(draft.phone);
        if (draft.license && $('license')) $('license').value = draft.license;
        if (draft.zip1 && $('zip1')) $('zip1').value = draft.zip1;
        if (draft.zip2 && $('zip2')) $('zip2').value = draft.zip2;
        if (draft.zip3 && $('zip3')) $('zip3').value = draft.zip3;
        
        // Trigger availability check to update button state
        debouncedAvailabilityCheck();
        
        // Clear the draft (one-time restore)
        localStorage.removeItem('localServiceFormDraft');
        
        // Clear the return path and auto-submit to Stripe
        if (localStorage.getItem('nextAfterLogin') === window.location.href) {
          localStorage.removeItem('nextAfterLogin');
          setStatus('Welcome back! For security, please re-attach your business card image, then click Continue.', true);
          // We intentionally do not auto-submit here because the browser clears file inputs during redirects.
        }
      } catch (e) {
        console.warn('[service-providers] Draft restore failed:', e);
        localStorage.removeItem('localServiceFormDraft');
      }
    })();

    // Upload photo to Storage
    async function uploadPhoto(file, docId) {
      const storage = getStorage(undefined, STORAGE_BUCKET_GS);
      const safeName = String(file.name || "card").replace(/[^\w\-.]+/g, "_");
      const path = `localServiceProviders/${docId}/${Date.now()}_${safeName}`;
      const r = ref(storage, path);
      await uploadBytes(r, file);
      return await getDownloadURL(r);
    }

    // ========== SUCCESS HANDLING WITH FALLBACK ACTIVATION ==========
    // FIX: Hide #serviceProviderForm on success return so user only sees the thank-you message
    (async function(){
      const u = new URL(location.href);
      if (u.searchParams.get('status') === 'success') {
        $('thanks')?.classList.remove('hidden');
        $('serviceProviderForm')?.classList.add('hidden');  // ← FIX: hide blank form on success
        
        // Fallback activation: If pendingServiceProviderId exists, activate immediately
        const pendingId = localStorage.getItem("pendingServiceProviderId");
        if (pendingId) {
          try {
            await updateDoc(doc(db, COLLECTION, pendingId), {
              status: "active",
              activatedAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            console.log("[service-providers] Fallback activation successful:", pendingId);
            
            // Clean up localStorage
            localStorage.removeItem("pendingServiceProviderId");
            localStorage.removeItem("pendingServiceProviderEmail");
            localStorage.removeItem("pendingServiceProviderPhoto");
            
            // Update success message
            const thanksEl = $('thanks');
            if (thanksEl) {
              thanksEl.innerHTML = `
                <h3 class="text-lg font-semibold">Thank you!</h3>
                <p class="text-sm mt-1">Your Local Service Provider subscription checkout completed successfully. Your business card is now live in the requested ZIP code.</p>
              `;
            }
          } catch (e) {
            console.warn("[service-providers] Fallback activation failed:", e);
          }
        }
      }
    })();

    // Form submission
    $("serviceProviderForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = e.target.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = isWaitlistMode ? 'Joining waitlist…' : 'Processing…';

        const role = ($("role")?.value || "").trim();
        const name = ($("name")?.value || "").trim();
        const company = ($("company")?.value || "").trim();
        const email = ($("email")?.value || "").trim().toLowerCase();
        const phone = ($("phone")?.value || "").trim();
        const license = ($("license")?.value || "").trim();
        const zips = getCurrentZips();
        const photoFile = $("photoInput")?.files?.[0] || null;

        // ========== STEP 1: VALIDATION ==========
        if (!role || !name || !email || !phone) {
          setStatus("Please complete all required fields.");
          return;
        }

        if (!photoFile) {
          setStatus("Please attach your business card image.");
          return;
        }

        if (zips.length === 0) {
          setStatus("Please enter at least one valid 5-digit ZIP code.");
          return;
        }

        // ========== STEP 2: AUTH GATE ==========
        // FIX: Redirect to /login.html (not /login.html?tab=create) with email prefill
        if (!isLoggedIn()) {
          setStatus('Please log in or create an account to continue. Redirecting...', true);
          
          // Save form data for restoration after login
          saveFormDraft();
          
          // Set return path so login redirects back here
          localStorage.setItem('nextAfterLogin', window.location.href);
          
          // Redirect to login page with email prefill (no tab= param)
          setTimeout(() => {
            window.location.href = '/login.html?email=' + encodeURIComponent(email);
          }, 1000);
          
          return;
        }

        // ========== STEP 3: WAITLIST MODE ==========
        if (isWaitlistMode) {
          const waitlistData = {
            roleType: 'local_service', // Required for waitlist processing
            role, // Service type (Title, Escrow, etc.)
            name,
            company,
            email,
            emailLower: email.toLowerCase(),
            phone,
            license: license || null,
            waitlistZips: soldOutZips,
            allRequestedZips: zips,
            status: "waiting",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          // Upload photo if provided
          if (photoFile) {
            try {
              const storage = getStorage(undefined, STORAGE_BUCKET_GS);
              const safeName = String(photoFile.name || "waitlist_card").replace(/[^\w\-.]+/g, "_");
              const path = `waitlist_localServiceProviders/${email.replace(/[^a-z0-9]/g,'_')}/${Date.now()}_${safeName}`;
              const r = ref(storage, path);
              await uploadBytes(r, photoFile);
              waitlistData.photoUrl = await getDownloadURL(r);
            } catch (uploadErr) {
              console.warn("[waitlist] photo upload failed:", uploadErr);
            }
          }

          await addDoc(collection(db, "waitlist_localServiceProviders"), waitlistData);
          console.log("[service-providers] Added to waitlist");

          // Show success message
          const thanksEl = $('thanks');
          if (thanksEl) {
            thanksEl.innerHTML = `
              <h3 class="text-lg font-semibold">You're on the Waitlist!</h3>
              <p class="text-sm mt-1">ZIP ${soldOutZips.join(', ')} is currently full (limit ${MAX_PER_ZIP}). You have been added to the priority waitlist. We will notify you at <strong>${email}</strong> when a spot opens.</p>
            `;
            thanksEl.classList.remove('hidden');
          }
          $("status").classList.add("hidden");
          $("serviceProviderForm").classList.add("hidden");
          return;
        }

        // ========== STEP 4: NORMAL CHECKOUT MODE ==========
        // Re-check availability before proceeding
        setStatus("Checking ZIP availability...", true);
        const soldOut = await checkZipAvailability(zips);
        if (soldOut.length > 0) {
          updateButtonState(soldOut, zips);
          return;
        }

        setStatus("Saving your information...", true);

        // Create Firestore document
        const docData = {
          role: role,
          name: name,
          company: company,
          email: email,
          emailLower: email.toLowerCase(),
          phone: phone,
          license: license || null,
          zips: zips,
          status: "pending", // Will be set to "active" after payment
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, COLLECTION), docData);
        console.log("[service-provider] Created doc:", docRef.id);

        // Upload photo if provided
        let photoUrl = "";
        if (photoFile) {
          try {
            photoUrl = await uploadPhoto(photoFile, docRef.id);
            // Update the document with the photo URL
            await updateDoc(doc(db, COLLECTION, docRef.id), { photoUrl: photoUrl });
            console.log("[service-provider] Photo URL saved:", photoUrl);
          } catch (uploadErr) {
            console.warn("[service-provider] Photo upload failed:", uploadErr);
          }
        }

        // Store pending info for activation on checkout-success.html
        localStorage.setItem("pendingServiceProviderId", docRef.id);
        localStorage.setItem("pendingServiceProviderEmail", email);
        if (photoUrl) {
          localStorage.setItem("pendingServiceProviderPhoto", photoUrl);
        }

        setStatus("Redirecting to payment...", true);

        // Create dynamic Stripe checkout session via backend API
        const payload = {
          roleType: "local_service",
          zipCodes: zips,
          priceId: PRICE_ID_LOCAL_SERVICE,
          successUrl: window.location.origin + "/local-service-providers.html?status=success",
          cancelUrl:  window.location.origin + "/local-service-providers.html?status=cancel",
          metadata: {
            email: email,
            name: name,
            company: company,
            draftId: docRef.id
          }
        };

        const resp = await fetch("/api/create-subscription-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await resp.json();
        if (!resp.ok) throw new Error(out.error || "Subscription session failed.");
        if (out.url) {
          window.location.href = out.url;
          return;
        }
        throw new Error("Server did not return checkout url.");

      } catch (err) {
        console.error("[service-provider] Error:", err);
        setStatus("Could not process your request. Please try again.");
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });

    // Search functionality
    $("searchBtn")?.addEventListener("click", async () => {
      const zip = ($("searchZip")?.value || "").trim();
      if (!zip || zip.length !== 5) {
        setStatus("Please enter a valid 5-digit ZIP code.");
        return;
      }

      const resultsDiv = $("searchResults");
      const emptyMsg = $("searchEmpty");
      resultsDiv.innerHTML = "<p class='text-sm text-gray-500'>Searching...</p>";
      emptyMsg.classList.add("hidden");

      try {
        const q = query(
          collection(db, COLLECTION),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          resultsDiv.innerHTML = "";
          emptyMsg.classList.remove("hidden");
          return;
        }

        resultsDiv.innerHTML = "";
        snap.forEach((doc) => {
          const d = doc.data();
          const card = document.createElement("div");
          card.className = "flex items-center gap-4 p-3 border rounded-lg bg-gray-50";

          const photoSrc = d.photoUrl || d.photo || "";
          if (photoSrc) {
            const img = document.createElement("img");
            img.src = photoSrc;
            img.alt = d.company || "Service Provider";
            img.className = "thumb";
            img.onerror = () => {
              img.style.display = "none";
            };
            card.appendChild(img);
          } else {
            const placeholder = document.createElement("div");
            placeholder.className = "thumb bg-gray-200 flex items-center justify-center text-xs text-gray-500";
            placeholder.textContent = "No Image";
            card.appendChild(placeholder);
          }

          const info = document.createElement("div");
          info.className = "flex-1";
          info.innerHTML = `
            <p class="font-semibold">${d.company || d.name || "Service Provider"}</p>
            <p class="text-sm text-gray-600">${d.role || "Service Provider"}</p>
            <p class="text-xs text-gray-500">${d.name || ""} ${d.phone ? "• " + d.phone : ""}</p>
          `;
          card.appendChild(info);

          resultsDiv.appendChild(card);
        });

      } catch (err) {
        console.error("[search] failed:", err);
        resultsDiv.innerHTML = "<p class='text-sm text-red-600'>Search failed. Please try again.</p>";
      }
    });

    // Allow Enter key to trigger search
    $("searchZip")?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        $("searchBtn")?.click();
      }
    });
  </script>

  <!-- Global Nav Sync: smart login/logout/dashboard -->
  <script src="/scripts/global-nav.js"></script>
</body>
</html>
