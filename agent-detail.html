<!DOCTYPE html>
<!-- agent-detail.html - Build 2026-02-13 (Added Price + Status History Tracking) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail Intake (Agent)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 6px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
    .note { font-size: 12px; }
    .chip { font-size: 11px; padding:2px 6px; border-radius:9999px; background:#f3f4f6; color:#374151; }
    .badge { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#ecfccb; color:#166534; border:1px solid #bbf7d0; }
    .badge-paid { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#d1fae5; color:#065f46; border:1px solid #6ee7b7; }
    .badge-free { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#fef3c7; color:#92400e; border:1px solid #fbbf24; }

    /* ===== Soft Autosave indicator ===== */
    #autosaveIndicator {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 9999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    #autosaveDot {
      width: 9px;
      height: 9px;
      border-radius: 9999px;
      background: #9ca3af;
      box-shadow: 0 0 0 2px rgba(156,163,175,0.15);
    }
    #autosaveText { color: #374151; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Soft Autosave status indicator -->
  <div id="autosaveIndicator" aria-live="polite">
    <span id="autosaveDot"></span>
    <span id="autosaveText">Waiting…</span>
  </div>

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="relative flex items-center justify-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="absolute left-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">Home</a>

      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>

      <a href="/advertise.html" class="absolute right-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">Advertise</a>
    </div>
  </header>

  <!-- Status bar -->
  <div class="max-w-6xl mx-auto mt-4 px-3">
    <p id="statusBar" class="text-sm text-gray-600"></p>
  </div>

  <!-- SOLD LOCK BANNER -->
  <div id="soldLockBanner" class="hidden max-w-6xl mx-auto px-3 mt-4">
    <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-3 text-sm font-semibold">
      Locked: This listing is closed and can no longer be edited.
    </div>
  </div>

  <div class="max-w-6xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6 px-3">
    <!-- LEFT: Intake form -->
    <section class="lg:col-span-2 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm">
          Plan:
          <span id="planPill" class="pill">—</span>
        </p>
        <p id="payerBadge" class="text-xs text-gray-600"></p>
      </div>

      <hr class="my-4"/>

      <form id="agentForm" class="space-y-5" autocomplete="off">
        <!-- Address (read-only) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Address</label>
          <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
        </div>

        <!-- Status (required) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
          <select id="status" class="w-full border p-2 rounded" required>
            <option value="">Select…</option>
            <option>Active</option>
            <option>In Contract</option>
            <option>Sold</option>
          </select>
        </div>

        <!-- Price & Commission (commission locked) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
            <input id="price" type="number" min="0" step="1000" placeholder="e.g., 2050000" class="w-full border p-2 rounded">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
            <div class="flex gap-2">
              <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
              <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50 text-center" readonly>
            </div>
            <p class="text-xs text-gray-500 mt-1">Commission is locked. Seller must pay to change.</p>
          </div>
        </div>

        <!-- Property Facts -->
        <div>
          <label class="block text-sm font-semibold mb-1">Property Facts</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
              <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
              <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
              <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 1860" class="w-full border p-2 rounded">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Year Built</span>
              <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1976" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
              <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 5000" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-sm font-semibold mb-1">Property Type</span>
              <select id="propertyType" class="w-full border p-2 rounded">
                <option value="">Select…</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- APN / Parcel -->
        <div>
          <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
          <input id="apn" class="w-full border p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
        </div>

        <!-- Photos (Storage uploads) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Photos</label>
          <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>

          <div class="flex items-center gap-2">
            <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" multiple class="block">
            <span id="photoNote" class="note text-gray-500">JPG/PNG are best. Uploads save automatically.</span>
          </div>

          <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
        </div>

        <!-- Description (Plus only) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Description</label>
          <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full border p-2 rounded"></textarea>
          <p id="descGateNote" class="lock-note mt-1 hidden">Upgrade to Listed Property Plus to enable Description.</p>
        </div>

        <!-- Banner / Preferred Area / Pin Area -->
        <div>
          <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
          <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1–4)" class="w-full border p-2 rounded">
          <p id="bannerGateNote" class="lock-note mt-1 hidden">Purchase Banner to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
          <input id="preferredArea" placeholder="e.g., Newport Beach, Harbor View" class="w-full border p-2 rounded">
          <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
          <input id="pinArea" placeholder="e.g., Newport Beach, Eastbluff" class="w-full border p-2 rounded">
          <p id="pinGateNote" class="lock-note mt-1 hidden">Purchase Pin Placement to enable this field.</p>
        </div>

        <!-- Agent confirms -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
            <input id="brokerage" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
            <input id="agentName" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
            <input id="agentEmail" type="email" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
            <input id="agentPhone" class="w-full border p-2 rounded">
          </div>
        </div>

        <div class="pt-2 mt-6">
          <a id="goPreviewBtn" href="#" target="_blank" class="block w-full text-center py-2 rounded text-white hover:opacity-90" style="background-color:#4DA6FF;">Preview Full Listing Detail</a>
        </div>
      </form>
    </section>

    <!-- RIGHT: Monthly Promo -->
    <aside class="space-y-4">
      <!-- Monthly Free Promo -->
      <section class="bg-white rounded shadow p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold"><span id="promoMonth">January</span> Free Promo</h2>
          <span id="promoBadge" class="hidden text-xs px-2 py-1 rounded text-white" style="background-color:#4DA6FF;">Active</span>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          Listing agents can upgrade to <strong>Listed Property Plus</strong>, add <strong>Banner</strong>, <strong>Premium</strong>, and <strong>Pin Placement</strong> for <strong>FREE</strong> during <span id="promoMonth2">January</span> <span id="promoYear">2026</span>.
        </p>
        <button id="applyPromoBtn" type="button" class="mt-3 w-full text-white px-3 py-2 rounded disabled:opacity-50" style="background-color:#4DA6FF;">
          Apply <span id="promoMonth3">January</span> Free Upgrades
        </button>
        <p id="promoNote" class="text-xs text-gray-500 mt-2"></p>
      </section>
    </aside>
  </div>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <!-- Firestore + Storage logic -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, getDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // =========================================================================
    // FIX: Force agent role on the agent page (prevents stale seller role breaking promo)
    // =========================================================================
    try { localStorage.setItem("userRole", "listing_agent"); } catch(e) {}

    // =========================================================================
    // TASK E: Mapbox geocoding for lat/lng (matches index.html pattern)
    // =========================================================================
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtaW1idDMwbjFjMWUzZHE3ZzY4ZjBob3IifQ.lF5BvHIsT_SVe0f6mT5nRw";
    const GEO_TIMEOUT_MS = 3000;

    async function geocodeAddress(address) {
      const failResult = { lat:null, lng:null, placeName:null, status:"failed", provider:"mapbox" };
      if (!address || !MAPBOX_TOKEN) { failResult.status = "skipped"; return failResult; }

      try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?limit=1&access_token=${MAPBOX_TOKEN}`;
        const fetchPromise = fetch(url);
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), GEO_TIMEOUT_MS));

        const resp = await Promise.race([fetchPromise, timeoutPromise]);
        if (!resp.ok) { failResult.status = "http_error"; return failResult; }

        const data = await resp.json();
        const feature = data?.features?.[0];
        if (!feature?.center) { failResult.status = "no_results"; return failResult; }

        return {
          lng: feature.center[0],
          lat: feature.center[1],
          placeName: feature.place_name || null,
          status: "ok",
          provider: "mapbox"
        };
      } catch (e) {
        console.warn("[geocodeAddress] failed:", e.message || e);
        failResult.status = (e.message === "timeout") ? "timeout" : "error";
        return failResult;
      }
    }

    async function ensureLatLng(listingId, address) {
      if (!listingId || !address) return false;
      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) return false;
        const d = snap.data() || {};

        const hasLat = typeof d.lat === "number" && !isNaN(d.lat);
        const hasLng = typeof d.lng === "number" && !isNaN(d.lng);
        if (hasLat && hasLng && d.geoStatus === "ok") return false;

        const geo = await geocodeAddress(address);

        const geoUpdate = {
          lat: geo.lat,
          lng: geo.lng,
          geoStatus: geo.status,
          geoProvider: geo.provider,
          updatedAt: serverTimestamp()
        };
        if (geo.placeName) geoUpdate.geoPlaceName = geo.placeName;
        if (geo.status === "ok") geoUpdate.geoUpdatedAt = serverTimestamp();

        await updateDoc(doc(db, "listings", listingId), geoUpdate);
        return geo.status === "ok";
      } catch (e) {
        console.warn("[Task E] ensureLatLng failed:", e);
        return false;
      }
    }

    // ----- helpers -----
    const $ = (id) => document.getElementById(id);
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const plural = (n, a, b) => (n===1 ? a : b);

    function setStatus(msg, ok=true) {
      const el = $("statusBar");
      el.textContent = msg || '';
      el.className = ok ? "text-sm text-gray-600" : "text-sm text-red-700";
    }

    // ===== Soft Autosave indicator helpers =====
    function setAutosaveUI(state) {
      var dot = document.getElementById("autosaveDot");
      var txt = document.getElementById("autosaveText");
      if (!dot || !txt) return;

      if (state === "saving") {
        dot.style.background = "#f59e0b";
        txt.textContent = "Saving…";
      } else if (state === "saved") {
        dot.style.background = "#10b981";
        txt.textContent = "All changes saved";
      } else if (state === "error") {
        dot.style.background = "#ef4444";
        txt.textContent = "Save failed";
      } else if (state === "locked") {
        dot.style.background = "#ef4444";
        txt.textContent = "Locked";
      } else {
        dot.style.background = "#9ca3af";
        txt.textContent = "Waiting…";
      }
    }

    function debounce(fn, waitMs) {
      var t = null;
      return function() {
        var ctx = this, args = arguments;
        if (t) clearTimeout(t);
        t = setTimeout(function() { fn.apply(ctx, args); }, waitMs);
      };
    }

    // Clean the listing id
    function cleanId(raw) {
      const m = String(raw || '').trim().match(/^[A-Za-z0-9_-]+/);
      return m ? m[0] : '';
    }
    (function ensureCleanId(){
      const u = new URL(location.href);
      let raw = u.searchParams.get('id') || localStorage.getItem('lastListingId') || '';
      const cleaned = cleanId(raw);
      if (cleaned) {
        localStorage.setItem('lastListingId', cleaned);
        if (raw !== cleaned) {
          u.searchParams.set('id', cleaned);
          history.replaceState({}, "", u.toString());
        }
      }
    })();

    const listingId = localStorage.getItem('lastListingId') || '';
    if ($("goPreviewBtn") && listingId) $("goPreviewBtn").href = "/listing.html?id=" + encodeURIComponent(listingId);

    // ---- Working state ----
    let plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    let isPlus = (plan === "Listed Property Plus");
    let maxPhotos = isPlus ? 20 : 1;
    let photos = [];
    let primaryIndex = 0;
    let paidUpgrades = {};
    let commissionChangeUsed = false;
    let currentZipOnDoc = "";
    let autosaveEnabled = true;

    // ===== SOLD LOCK (Agent) =====
    let soldLocked = false;

    function checkSoldLock(statusValue) {
      const isSold = String(statusValue || "").trim().toLowerCase() === "sold";
      soldLocked = !!isSold;

      const banner = document.getElementById("soldLockBanner");
      if (banner) banner.classList.toggle("hidden", !isSold);

      if (!isSold) {
        return false;
      }

      autosaveEnabled = false;

      const form = document.getElementById("agentForm");
      if (form) {
        form.querySelectorAll("input, select, textarea, button").forEach(el => { el.disabled = true; });
      }

      const promoBtn = document.getElementById("applyPromoBtn");
      if (promoBtn) promoBtn.disabled = true;

      setAutosaveUI("locked");
      return true;
    }

    // ===== EDIT 4: commitSoldNow with Status History Tracking =====
    async function commitSoldNow() {
      if (!listingId) return false;
      if (soldLocked) return true;

      setAutosaveUI("saving");
      try {
        const payload = buildAutosavePayload();
        payload.status = "Sold";
        payload.updatedAt = serverTimestamp();

        // ===== Track status change to Sold =====
        try {
          var snapSold = await getDoc(doc(db, "listings", listingId));
          if (snapSold.exists()) {
            var oldSold = snapSold.data() || {};
            var dtSold = getDateTimeParts();
            var oldSoldStatus = String(oldSold.status || "").trim();
            if (oldSoldStatus !== "Sold") {
              if (!Array.isArray(oldSold.statusHistory) || oldSold.statusHistory.length === 0) {
                if (oldSoldStatus) {
                  payload.statusHistory = arrayUnion(
                    { date: dtSold.date, time: dtSold.time, label: "Original", status: oldSoldStatus },
                    { date: dtSold.date, time: dtSold.time, label: "Changed", status: "Sold" }
                  );
                } else {
                  payload.statusHistory = arrayUnion(
                    { date: dtSold.date, time: dtSold.time, label: "Original", status: "Sold" }
                  );
                }
              } else {
                payload.statusHistory = arrayUnion(
                  { date: dtSold.date, time: dtSold.time, label: "Changed", status: "Sold" }
                );
              }
            }
          }
        } catch (e) { console.warn("[commitSoldNow] history tracking failed:", e); }

        await updateDoc(doc(db, "listings", listingId), payload);

        // Ensure geo in background
        ensureLatLng(listingId, $("fullAddress")?.value || "");

        // Now lock UI permanently
        checkSoldLock("Sold");
        setStatus("Saved SOLD status. Listing is now locked.", true);
        return true;
      } catch (e) {
        console.warn("[sold] commit failed", e);
        setAutosaveUI("error");
        setStatus("Could not save SOLD status. Listing remains editable.", false);
        setTimeout(() => setAutosaveUI("waiting"), 3000);
        return false;
      }
    }

    function computePhotoHelp() {
      const remaining = Math.max(0, maxPhotos - (photos?.length || 0));
      $("photoHelp").textContent = isPlus
        ? `You can add up to ${remaining} more ${plural(remaining,'photo','photos')}.`
        : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
    }

    function clampPrimary() {
      if (!Array.isArray(photos) || photos.length === 0) { primaryIndex = 0; return; }
      if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;
    }

    function renderThumbs() {
      clampPrimary();
      const grid = $("photoGrid");
      grid.innerHTML = "";

      if (!photos.length) {
        const p = document.createElement("p");
        p.className = "text-sm text-gray-600";
        p.textContent = "No photos yet.";
        grid.appendChild(p);
        return;
      }

      const ordered = photos.map((u, i) => ({u, i}));
      if (primaryIndex > 0) {
        const [prim] = ordered.splice(primaryIndex,1);
        ordered.unshift(prim);
      }

      ordered.forEach(({u, i}, displayIdx) => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-3";

        const img = new Image();
        img.src = u;
        img.alt = "Photo " + (displayIdx + 1);
        img.className = "thumb border " + (i === primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (i === primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", async () => {
          if (soldLocked) return;
          primaryIndex = i;
          await savePhotosField(true);
        });

        const btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        if (i === primaryIndex) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "Primary";
          btns.appendChild(badge);
        } else {
          const bPrimary = document.createElement("button");
          bPrimary.type = "button";
          bPrimary.className = "px-2 py-1 border rounded";
          bPrimary.textContent = "Set Primary";
          bPrimary.onclick = async () => { if (soldLocked) return; primaryIndex = i; await savePhotosField(true); };
          btns.appendChild(bPrimary);
        }

        const bReplace = document.createElement("button");
        bReplace.type = "button";
        bReplace.className = "px-2 py-1 border rounded";
        bReplace.textContent = "Replace";
        bReplace.onclick = () => {
          if (soldLocked) return;
          const input = document.createElement("input");
          input.type = "file"; input.accept = "image/*";
          input.onchange = async (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            setAutosaveUI("saving");
            setStatus("Uploading replacement…");
            try {
              const urlNew = await uploadOne(file);
              photos[i] = urlNew;
              await savePhotosField(true);
              setAutosaveUI("saved");
              setTimeout(() => setAutosaveUI("waiting"), 1800);
            } catch (err) {
              console.warn(err);
              setAutosaveUI("error");
              setStatus("Could not replace photo.", false);
              setTimeout(() => setAutosaveUI("waiting"), 3000);
            }
          };
          input.click();
        };

        const bDelete = document.createElement("button");
        bDelete.type = "button";
        bDelete.className = "px-2 py-1 border rounded";
        bDelete.textContent = "Delete";
        bDelete.onclick = async () => {
          if (soldLocked) return;
          if (!confirm("Remove this photo from the listing?")) return;
          setAutosaveUI("saving");
          photos.splice(i, 1);
          if (primaryIndex >= photos.length) primaryIndex = Math.max(0, photos.length - 1);
          await savePhotosField(true);
          setAutosaveUI("saved");
          setTimeout(() => setAutosaveUI("waiting"), 1800);
        };

        btns.appendChild(bReplace);
        btns.appendChild(bDelete);

        row.appendChild(img);
        row.appendChild(btns);
        document.getElementById("photoGrid").appendChild(row);
      });

      computePhotoHelp();
    }

    async function refreshFromServer(note="") {
      if (!listingId) { setStatus("No listing selected (missing id).", false); return; }
      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) { setStatus("Listing not found on server.", false); return; }
        const d = snap.data() || {};

        plan = d.plan || plan;
        isPlus = (plan === "Listed Property Plus");
        maxPhotos = isPlus ? 20 : 1;

        paidUpgrades = d.paidUpgrades || {};
        commissionChangeUsed = d.commissionChangeUsed || false;
        currentZipOnDoc = String(d.zip || "");

        $("planPill").textContent = plan;
        $("fullAddress").value = d.address || "";
        $("status").value = d.status || "";
        $("price").value = d.price ?? "";
        $("commission").value = d.commission ?? "";
        $("commissionType").value = d.commissionType || "%";
        $("apn").value = d.apn || "";
        $("bedrooms").value = d.bedrooms ?? "";
        $("bathrooms").value = d.bathrooms ?? "";
        $("sqft").value = d.sqft ?? "";
        $("yearBuilt").value = d.yearBuilt ?? "";
        $("lotSize").value = d.lotSize ?? "";
        $("propertyType").value = d.propertyType ?? "";
        $("description").value = d.description ?? "";
        $("bannerText").value = d.bannerText ?? "";
        $("preferredArea").value = d.preferredArea ?? "";
        $("pinArea").value = d.pinArea ?? "";
        $("brokerage").value = d.brokerage || "";
        $("agentName").value = d.agentName || "";
        $("agentEmail").value = d.agentEmail || "";
        $("agentPhone").value = d.agentPhone || "";

        photos = Array.isArray(d.photos) ? d.photos.slice(0, maxPhotos) : [];
        primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;

        if (!isPlus) {
          $("description").classList.add("dimmed");
          $("description").setAttribute("disabled","disabled");
          $("descGateNote").classList.remove("hidden");
        } else {
          $("description").classList.remove("dimmed");
          $("description").removeAttribute("disabled");
          $("descGateNote").classList.add("hidden");
        }

        renderThumbs();
        setStatus(note || "Loaded from server.", true);

        ensureLatLng(listingId, d.address);

        // Sold lock last
        if (checkSoldLock(d.status)) return;

        autosaveEnabled = true;
        setAutosaveUI("waiting");
      } catch (e) {
        console.warn("[agent-detail] refresh failed:", e);
        setStatus("Could not load from server.", false);
        setAutosaveUI("error");
        setTimeout(() => setAutosaveUI("waiting"), 3000);
      }
    }

    // ===== Soft Autosave (debounced) =====
    function parseZipFromAddressEnd(addr) {
      var m = String(addr || "").match(/\b(\d{5})(?:-\d{4})?\s*$/);
      if (m && m[1]) return m[1];
      var m2 = String(addr || "").match(/\b(\d{5})(?:-\d{4})?\b/);
      return m2 ? m2[1] : "";
    }

    // ===== EDIT 2: Date/Time helper for history entries =====
    function getDateTimeParts() {
      var now = new Date();
      var date = (now.getMonth()+1) + "/" + now.getDate() + "/" + now.getFullYear();
      var h = now.getHours();
      var m = String(now.getMinutes()).padStart(2, "0");
      var ampm = h >= 12 ? "PM" : "AM";
      var h12 = h % 12 || 12;
      var time = h12 + ":" + m + " " + ampm;
      return { date: date, time: time };
    }

    function buildAutosavePayload() {
      var payload = {
        updatedAt: serverTimestamp(),
        status: $("status").value || "",
        price: Number($("price").value || 0) || "",
        apn: $("apn").value || "",
        bedrooms: $("bedrooms").value || "",
        bathrooms: $("bathrooms").value || "",
        sqft: $("sqft").value || "",
        yearBuilt: $("yearBuilt").value || "",
        lotSize: $("lotSize").value || "",
        propertyType: $("propertyType").value || "",
        description: $("description").value || "",
        bannerText: $("bannerText").value || "",
        preferredArea: $("preferredArea").value || "",
        pinArea: $("pinArea").value || "",
        brokerage: $("brokerage").value || "",
        agentName: $("agentName").value || "",
        agentEmail: $("agentEmail").value || "",
        agentPhone: $("agentPhone").value || ""
      };

      if (!currentZipOnDoc) {
        var addr = ($("fullAddress")?.value || "").trim();
        var z = parseZipFromAddressEnd(addr);
        if (z) payload.zip = z;
      }

      return payload;
    }

    // ===== EDIT 3: AUTOSAVE WITH HISTORY TRACKING =====
    async function doAutosave() {
      if (!autosaveEnabled) return;
      if (!listingId) return;
      if (soldLocked || checkSoldLock($("status")?.value)) return;

      setAutosaveUI("saving");
      try {
        var payload = buildAutosavePayload();

        // ===== HISTORY TRACKING: detect price/status changes =====
        var snap = await getDoc(doc(db, "listings", listingId));
        if (snap.exists()) {
          var oldData = snap.data() || {};
          var dt = getDateTimeParts();

          // --- Price History ---
          var oldPriceNum = Number(oldData.price) || 0;
          var newPriceNum = Number(payload.price) || 0;
          if (newPriceNum > 0 && oldPriceNum !== newPriceNum) {
            if (!Array.isArray(oldData.priceHistory) || oldData.priceHistory.length === 0) {
              if (oldPriceNum > 0) {
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", price: oldPriceNum },
                  { date: dt.date, time: dt.time, label: "Changed", price: newPriceNum }
                );
              } else {
                // First price ever entered
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", price: newPriceNum }
                );
              }
            } else {
              payload.priceHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Changed", price: newPriceNum }
              );
            }
          }

          // --- Status History ---
          var oldStatus = String(oldData.status || "").trim();
          var newStatus = String(payload.status || "").trim();
          if (newStatus && oldStatus !== newStatus) {
            if (!Array.isArray(oldData.statusHistory) || oldData.statusHistory.length === 0) {
              if (oldStatus) {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: oldStatus },
                  { date: dt.date, time: dt.time, label: "Changed", status: newStatus }
                );
              } else {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: newStatus }
                );
              }
            } else {
              payload.statusHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Changed", status: newStatus }
              );
            }
          }
        }
        // ===== END HISTORY TRACKING =====

        await updateDoc(doc(db, "listings", listingId), payload);
        if (payload.zip) currentZipOnDoc = String(payload.zip);

        setAutosaveUI("saved");
        setTimeout(() => { if (!soldLocked) setAutosaveUI("waiting"); }, 1800);
      } catch (e) {
        console.warn("[autosave] failed", e);
        setAutosaveUI("error");
        setTimeout(() => { if (!soldLocked) setAutosaveUI("waiting"); }, 3000);
      }
    }

    var autosaveDebounced = debounce(doAutosave, 1500);

    function wireAutosaveListeners() {
      var form = document.getElementById("agentForm");
      if (!form) return;

      var fields = form.querySelectorAll("input, select, textarea");
      fields.forEach(function(el) {
        var type = (el.getAttribute("type") || "").toLowerCase();
        if (type === "file") return;
        if (el.hasAttribute("readonly")) return;
        if (el.hasAttribute("disabled")) return;
        if (el.id === "commission" || el.id === "commissionType") return;

        el.addEventListener("input", function(){ autosaveDebounced(); });
        el.addEventListener("change", function(){ autosaveDebounced(); });
      });
    }

    // Storage bucket (preserved)
    const BUCKET_URL = "gs://guaranteedcommission-d4d91.firebasestorage.app";

    async function uploadOne(file) {
      const storage = getStorage(undefined, BUCKET_URL);
      const safeName = String(file.name || "photo").replace(/[^\w\-.]+/g,"_");
      const path = `listings/${listingId}/photos/${Date.now()}_${safeName}`;
      const r = ref(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      return url;
    }

    async function savePhotosField(thenRefresh=false) {
      if (!listingId) return;
      if (soldLocked) return;
      try {
        clampPrimary();
        await updateDoc(doc(db, "listings", listingId), {
          photos: photos.slice(0, maxPhotos),
          primaryIndex: (typeof primaryIndex === "number" ? primaryIndex : 0),
          updatedAt: serverTimestamp()
        });
        if (thenRefresh) await refreshFromServer("Photos saved.");
      } catch (e) {
        console.warn("[agent-detail] photos update failed", e);
        setStatus("Photos could not be saved.", false);
      }
    }

    $("photoInput").addEventListener("change", async (e) => {
      if (soldLocked) return;
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      try {
        const remaining = Math.max(0, maxPhotos - photos.length);
        if (remaining <= 0) { alert(`You have reached the photo limit for your plan (${maxPhotos}).`); e.target.value = ""; return; }
        const toUpload = files.slice(0, remaining);

        setAutosaveUI("saving");
        setStatus("Uploading photo(s)…");

        for (const f of toUpload) {
          try {
            const url = await uploadOne(f);
            photos.push(url);
          } catch (err) {
            console.warn("Upload failed", err);
            setStatus("Upload failed for one or more files.", false);
          }
        }
        await savePhotosField(true);

        setAutosaveUI("saved");
        setTimeout(() => { if (!soldLocked) setAutosaveUI("waiting"); }, 1800);
      } catch (err) {
        setAutosaveUI("error");
        setStatus("Upload failed.", false);
        setTimeout(() => { if (!soldLocked) setAutosaveUI("waiting"); }, 3000);
      } finally {
        e.target.value = "";
      }
    });

    // Status change: if Sold selected, force-save immediately then lock
    $("status")?.addEventListener("change", async () => {
      if (soldLocked) return;

      const v = String($("status")?.value || "").trim();
      if (v.toLowerCase() === "sold") {
        await commitSoldNow();
        return;
      }

      // otherwise normal autosave
      autosaveDebounced();
    });

    // ---- Monthly Promo (preserved, now blocked when Sold) ----
    function getCurrentPromoMonth() {
      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const now = new Date();
      return months[now.getMonth()];
    }

    function getCurrentYear() {
      return new Date().getFullYear();
    }

    function isAgentPromoActive() {
      try {
        const year = getCurrentYear();
        const roleRaw = (localStorage.getItem("userRole") || "").trim().toLowerCase();
        const isAgentContext = (location.pathname || "").toLowerCase().includes("agent-detail");
        const isAgentRole = roleRaw.includes("agent") || isAgentContext;
        console.log("[promo] Role check:", roleRaw, "isAgent:", isAgentRole, "year:", year, "agentContext:", isAgentContext);
        return isAgentRole && (year === 2026 || year === 2027);
      } catch { return false; }
    }

    let checkoutData = getJSON("checkoutData", null) || {
      plan,
      base: (plan === "Listed Property Plus" ? 20 : 0),
      upgrades: { upgradeToPlus:false, banner:false, premium:false, pin:false },
      prices:  { plus:20, banner:10, premium:10, pin:50 },
      meta: {},
      payer: "agent"
    };
    checkoutData.payer = "agent";

    function paintPromoState() {
      const promoMonth = getCurrentPromoMonth();
      const year = getCurrentYear();
      const active = isAgentPromoActive();

      $("promoMonth").textContent = promoMonth;
      $("promoMonth2").textContent = promoMonth;
      $("promoMonth3").textContent = promoMonth;
      if ($("promoYear")) $("promoYear").textContent = year;

      const badge = $("promoBadge");
      const btn = $("applyPromoBtn");

      if (active) {
        badge.classList.remove("hidden");
        badge.textContent = "Active";
        badge.style.backgroundColor = "#4DA6FF";
      } else {
        badge.classList.add("hidden");
      }

      // If sold, force disable
      if (soldLocked) {
        btn.disabled = true;
      } else {
        btn.disabled = !active;
      }

      btn.style.backgroundColor = "#4DA6FF";

      $("promoNote").textContent = active
        ? `Click to apply free pricing (Plus, Banner, Premium, Pin set to $0) for ${promoMonth} ${year}.`
        : `Promo applies during 2026-2027 when upgrades are paid by the agent.`;
    }

    function applyFreePromo() {
      if (soldLocked || checkSoldLock($("status")?.value)) {
        alert("This listing is SOLD and locked. Promo cannot be applied.");
        return;
      }

      if (!isAgentPromoActive()) {
        alert("Promo is not active for this account.");
        return;
      }

      const newPlan = "Listed Property Plus";

      checkoutData = {
        plan: newPlan,
        base: 0,
        upgrades: { upgradeToPlus:false, banner:false, premium:false, pin:false },
        prices:  { plus:0, banner:0, premium:0, pin:0 },
        meta: {},
        payer: "agent"
      };

      checkoutData.meta[getCurrentPromoMonth().toLowerCase() + "AgentFree"] = true;
      checkoutData.total = 0;

      setJSON("checkoutData", checkoutData);

      plan = newPlan;
      isPlus = true;
      maxPhotos = 20;
      localStorage.setItem("selectedPlan", newPlan);

      $("planPill").textContent = newPlan;
      $("description").classList.remove("dimmed");
      $("description").removeAttribute("disabled");
      $("descGateNote").classList.add("hidden");
      computePhotoHelp();

      if (listingId) {
        updateDoc(doc(db, "listings", listingId), {
          plan: newPlan,
          updatedAt: serverTimestamp()
        }).then(() => {
          setStatus("Upgraded to Plus (FREE via promo)!", true);
        }).catch(err => {
          console.warn("[promo] Firestore update failed:", err);
          setStatus("Local upgrade succeeded, but server update failed.", false);
        });
      }

      alert(`${getCurrentPromoMonth()} ${getCurrentYear()} Free applied. Upgraded to Listed Property Plus + all upgrades are now $0 for agent-paid upgrades this month.`);
    }

    $("applyPromoBtn")?.addEventListener("click", applyFreePromo);

    // ---- Boot ----
    (async function boot(){
      const fd = getJSON("formData", {});
      if (fd.address && !$("fullAddress").value) $("fullAddress").value = fd.address;

      await refreshFromServer();
      computePhotoHelp();
      wireAutosaveListeners();

      // If server says sold, lock already happened in refreshFromServer()
      if (!soldLocked) setAutosaveUI("waiting");

      paintPromoState();
    })();
  </script>
</body>
</html>
