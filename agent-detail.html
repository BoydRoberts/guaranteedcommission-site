<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail Intake (Agent)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 6px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-6xl mx-auto mt-8 px-3">
    <div class="flex items-start justify-between">
      <h1 class="text-2xl font-bold">Listing Detail Intake</h1>
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">Back to Home</a>
    </div>
  </div>

  <div class="max-w-6xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6 px-3">
    <!-- LEFT: Intake form -->
    <section class="lg:col-span-2 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm">
          Plan:
          <span id="planPill" class="pill">—</span>
        </p>
        <p id="payerBadge" class="text-xs text-gray-600"></p>
      </div>

      <hr class="my-4"/>

      <form id="agentForm" class="space-y-5" autocomplete="off">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Address</label>
          <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
          <select id="status" class="w-full border p-2 rounded" required>
            <option value="">Select…</option>
            <option>Active</option>
            <option>In Contract</option>
            <option>Sold</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
            <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
            <div class="flex gap-2">
              <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
              <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50 text-center" readonly>
            </div>
            <p class="text-xs text-gray-500 mt-1">To change commission, cancel this listing and create a new Plus listing.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Property Facts</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
              <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
              <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
              <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 2000" class="w-full border p-2 rounded">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Year Built</span>
              <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1998" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
              <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 6000" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Property Type</span>
              <select id="propertyType" class="w-full border p-2 rounded">
                <option value="">Select…</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
          <input id="apn" class="w-full border p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Photos</label>
          <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>
          <input id="photoInput" type="file" accept="image/*" multiple class="block">
          <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
          <p class="text-xs text-gray-500 mt-2">Tip: click the thumbnail or use buttons to set primary, replace, or delete.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Description</label>
          <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full border p-2 rounded"></textarea>
          <p id="descGateNote" class="lock-note mt-1 hidden">Upgrade to Listed Property Plus to enable Description.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
          <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1–4)" class="w-full border p-2 rounded">
          <p id="bannerGateNote" class="lock-note mt-1 hidden">Purchase Banner to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
          <input id="preferredArea" placeholder="e.g., Laguna Beach, Top of the World" class="w-full border p-2 rounded">
          <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
          <input id="pinArea" placeholder="e.g., Laguna Beach, Village" class="w-full border p-2 rounded">
          <p id="pinGateNote" class="lock-note mt-1 hidden">Purchase Pin Placement to enable this field.</p>
        </div>

        <!-- Agent contact (auto-populate) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
            <input id="brokerage" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
            <input id="agentName" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
            <input id="agentEmail" type="email" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
            <input id="agentPhone" class="w-full border p-2 rounded">
          </div>
        </div>

        <div class="pt-2 flex items-center gap-2">
          <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
          <a id="previewBtn" href="/listing.html" class="bg-green-600 text-white px-4 py-2 rounded">Preview Full Listing Detail</a>
        </div>
      </form>
    </section>

    <aside class="space-y-4">
      <section class="bg-white rounded shadow p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">September Free Promo</h2>
          <span id="promoBadge" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">Inactive</span>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          Listing agents can upgrade <strong>Banner</strong>, <strong>Premium</strong>, and <strong>Pin</strong> for <strong>FREE</strong> during September 2025.
        </p>
        <button id="applyPromoBtn" class="mt-3 w-full bg-blue-600 text-white px-3 py-2 rounded disabled:opacity-50">
          Apply September Free Upgrades
        </button>
        <p id="promoNote" class="text-xs text-gray-500 mt-2"></p>
      </section>

      <section class="bg-white rounded shadow p-5">
        <h2 class="text-lg font-semibold">Upgrades</h2>
        <p class="text-sm text-gray-600">Agent can turn on upgrades here. Free pricing applies if September Promo is active.</p>
        <div id="upgradesBox" class="mt-4 space-y-3 text-sm"></div>

        <div class="mt-4 flex items-center gap-2">
          <button id="updateUpgradesBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Update Upgrades</button>
          <button id="goCheckoutBtn" class="px-3 py-2 rounded border">Go to Checkout</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Purchases are final. Paid items show “paid by agent.”</p>
      </section>
    </aside>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const formData = getJSON("formData", {});
    const agentListing = getJSON("agentListing", {});
    const now = new Date();
    const isSept2025 = (now.getFullYear() === 2025 && now.getMonth() === 8);

    const checkoutData = getJSON("checkoutData", null) || {
      plan,
      base: plan === "FSBO Plus" ? 100 : (plan === "Listed Property Plus" ? 20 : 0),
      upgrades: { upgradeToPlus:false, banner:false, premium:false, pin:false, confidential:false },
      prices:  { plus:20, banner:10, premium:10, pin:50, fsbo:100, confidential:100 },
      meta: {},
      payer: "agent"
    };

    const flags = getJSON("intakeFollowups", {});
    const isPlus = plan === "Listed Property Plus" || plan === "FSBO Plus";

    $("planPill").textContent = plan;
    $("payerBadge").textContent = "";

    $("fullAddress").value = formData.address || "";
    $("status").value = agentListing.status || "";
    $("price").value = agentListing.price ?? "";

    const commission = agentListing.commission ?? (formData.commission || "");
    const commissionType = agentListing.commissionType ?? (formData.commissionType || "%");
    $("commission").value = commission; $("commissionType").value = commissionType;

    // Property facts
    $("bedrooms").value     = agentListing.bedrooms ?? "";
    $("bathrooms").value    = agentListing.bathrooms ?? "";
    $("sqft").value         = agentListing.sqft ?? "";
    $("yearBuilt").value    = agentListing.yearBuilt ?? "";
    $("lotSize").value      = agentListing.lotSize ?? "";
    $("propertyType").value = agentListing.propertyType ?? "";
    $("apn").value          = formData.apn || agentListing.apn || "";

    // Auto-populate agent contact at the bottom (email + phone) from account if empty
    (function autoAgentContact(){
      const email = (localStorage.getItem('loggedInEmail') || '').trim().toLowerCase();
      const accounts = (function(){ try { return JSON.parse(localStorage.getItem('accounts')||'{}'); } catch { return {}; }})();
      const acct = accounts[email] || {};
      if (!agentListing.agentEmail && email) $("agentEmail").value = email;
      else $("agentEmail").value = agentListing.agentEmail || "";
      if (!agentListing.agentPhone && acct.phone) $("agentPhone").value = acct.phone;
      else $("agentPhone").value = agentListing.agentPhone || "";
      $("brokerage").value  = formData.brokerage || agentListing.brokerage || "";
      $("agentName").value  = formData.agent || agentListing.agentName || "";
    })();

    // Photos
    const photos = Array.isArray(agentListing.photos) ? agentListing.photos : [];
    let primaryIndex = (typeof agentListing.primaryIndex === "number" ? agentListing.primaryIndex : 0);
    const maxPhotos = isPlus ? 20 : 1;
    $("photoHelp").textContent = isPlus ? "You can upload up to 20 photos." : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";

    function renderThumbs() {
      const grid = $("photoGrid");
      grid.innerHTML = "";
      (photos || []).forEach((src, idx) => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-3";

        const img = new Image();
        img.src = src; img.alt = "Photo " + (idx + 1);
        img.className = "thumb border " + (idx === primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (idx === primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", () => { primaryIndex = idx; saveDraft(); renderThumbs(); });

        const btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        const bPrimary = document.createElement("button");
        bPrimary.type = "button";
        bPrimary.className = "px-2 py-1 border rounded";
        bPrimary.textContent = "Set Primary";
        bPrimary.onclick = () => { primaryIndex = idx; saveDraft(); renderThumbs(); };

        const bReplace = document.createElement("button");
        bReplace.type = "button";
        bReplace.className = "px-2 py-1 border rounded";
        bReplace.textContent = "Replace";
        bReplace.onclick = () => {
          const input = document.createElement("input");
          input.type = "file"; input.accept = "image/*";
          input.onchange = async (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            const r = new FileReader();
            r.onload = () => { photos[idx] = r.result; saveDraft(); renderThumbs(); };
            r.readAsDataURL(file);
          };
          input.click();
        };

        const bDelete = document.createElement("button");
        bDelete.type = "button";
        bDelete.className = "px-2 py-1 border rounded";
        bDelete.textContent = "Delete";
        bDelete.onclick = () => {
          photos.splice(idx, 1);
          if (primaryIndex >= photos.length) primaryIndex = Math.max(0, photos.length - 1);
          saveDraft(); renderThumbs();
        };

        btns.appendChild(bPrimary);
        btns.appendChild(bReplace);
        btns.appendChild(bDelete);

        row.appendChild(img);
        row.appendChild(btns);
        grid.appendChild(row);
      });
    }
    renderThumbs();

    $("photoInput").addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      let spaceLeft = maxPhotos - (photos.length || 0);
      if (spaceLeft <= 0) { alert(`You have reached the photo limit for your plan (${maxPhotos}).`); e.target.value = ""; return; }
      const toRead = files.slice(0, spaceLeft);
      const readAsDataURL = (file) => new Promise((res, rej) => { const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
      for (const f of toRead) { try { photos.push(await readAsDataURL(f)); } catch(e){} }
      saveDraft(); renderThumbs(); e.target.value = "";
    });

    $("description").value = agentListing.description ?? "";
    if (!isPlus) { $("description").classList.add("dimmed"); $("description").setAttribute("disabled","disabled"); $("descGateNote").classList.remove("hidden"); }

    $("bannerText").value = agentListing.bannerText ?? "";
    if (!checkoutData.upgrades.banner) { $("bannerText").classList.add("dimmed"); $("bannerText").setAttribute("disabled","disabled"); $("bannerGateNote").classList.remove("hidden"); }

    $("preferredArea").value = agentListing.preferredArea ?? checkoutData.meta.preferredArea ?? flags.preferredArea ?? "";
    if (!checkoutData.upgrades.premium && !checkoutData.upgrades.pin) { $("preferredArea").classList.add("dimmed"); $("preferredArea").setAttribute("disabled","disabled"); $("premiumGateNote").classList.remove("hidden"); }

    $("pinArea").value = agentListing.pinArea ?? checkoutData.meta.pinArea ?? flags.pinArea ?? "";
    if (!checkoutData.upgrades.pin) { $("pinArea").classList.add("dimmed"); $("pinArea").setAttribute("disabled","disabled"); $("pinGateNote").classList.remove("hidden"); }

    ["status","price","description","bannerText","preferredArea","pinArea","brokerage","agentName","agentEmail","agentPhone","apn",
      "bedrooms","bathrooms","sqft","yearBuilt","lotSize","propertyType"
    ].forEach(id=>{
      const el = $(id); if (!el) return;
      el.addEventListener("input", saveDraft); el.addEventListener("change", saveDraft);
    });

    function saveDraft() {
      const payload = {
        status: $("status").value || "",
        price: $("price").value || "",
        commission: commission,
        commissionType: commissionType,
        apn: $("apn").value || "",
        description: $("description").disabled ? (agentListing.description || "") : ($("description").value || ""),
        bannerText: $("bannerText").disabled ? (agentListing.bannerText || "") : ($("bannerText").value || ""),
        preferredArea: $("preferredArea").disabled ? (agentListing.preferredArea || "") : ($("preferredArea").value || ""),
        pinArea: $("pinArea").disabled ? (agentListing.pinArea || "") : ($("pinArea").value || ""),
        brokerage: $("brokerage").value || "",
        agentName: $("agentName").value || "",
        agentEmail: $("agentEmail").value || "",
        agentPhone: $("agentPhone").value || "",
        photos: photos.slice(0, maxPhotos),
        primaryIndex: primaryIndex,
        bedrooms: $("bedrooms").value || "",
        bathrooms: $("bathrooms").value || "",
        sqft: $("sqft").value || "",
        yearBuilt: $("yearBuilt").value || "",
        lotSize: $("lotSize").value || "",
        propertyType: $("propertyType").value || ""
      };
      localStorage.setItem("agentListing", JSON.stringify(payload));
    }

    $("saveBtn").addEventListener("click", () => { saveDraft(); alert("Saved."); });

    const promoBadge = $("promoBadge");
    const applyPromoBtn = $("applyPromoBtn");
    const promoNote = $("promoNote");

    function paintPromoState() {
      const active = isSept2025 && checkoutData.payer === "agent";
      promoBadge.textContent = active ? "Active" : "Inactive";
      promoBadge.className = active
        ? "text-xs px-2 py-1 rounded bg-green-100 text-green-800"
        : "text-xs px-2 py-1 rounded bg-gray-100 text-gray-700";
      applyPromoBtn.disabled = !active;
      promoNote.textContent = active
        ? "Click to apply free pricing (Banner, Premium, Pin set to $0) for September when paid by agent."
        : "Promo applies only during September 2025 and only when upgrades are paid by the agent.";
    }

    function applySeptemberFree() {
      checkoutData.prices.banner = 0;
      checkoutData.prices.premium = 0;
      checkoutData.prices.pin = 0;
      checkoutData.meta = checkoutData.meta || {};
      checkoutData.meta.septemberAgentFree = true;
      setJSON("checkoutData", checkoutData);
      alert("September Free applied. Banner, Premium, and Pin are now $0 for agent-paid upgrades this month.");
      paintUpgrades();
    }

    applyPromoBtn.addEventListener("click", applySeptemberFree);
    paintPromoState();

    function row(label, price, key, opts={}) {
      const checked = !!checkoutData.upgrades[key];
      const paid = opts.paid === true;
      const priceLabel = (price === 0) ? "FREE" : `$${price}`;
      const extraNote = opts.note ? `<span class="text-indigo-700 ml-2">${opts.note}</span>` : "";
      const note = paid ? `<span class="text-green-700 ml-2">(paid by agent)</span>` : extraNote;
      return `
        <label class="flex items-center justify-between border rounded-lg px-3 py-2 ${paid?'bg-gray-50':''}">
          <div>
            <span class="font-medium">${label}</span>
            <span class="text-gray-500"> — ${priceLabel}</span>
            ${note}
          </div>
          <input type="checkbox" data-key="${key}" class="h-4 w-4" ${checked?'checked':''} ${paid?'disabled':''}/>
        </label>
      `;
    }

    function paintUpgrades() {
      const box = $("upgradesBox");
      const isBasic = plan === "Listed Property Basic";

      let displayPlusPrice = (checkoutData.prices && typeof checkoutData.prices.plus === "number") ? checkoutData.prices.plus : 20;
      let plusNote = "";
      try {
        if (checkoutData.payer === "agent" && isSept2025) {
          displayPlusPrice = 0;
          plusNote = "September promo — free for agents";
        }
      } catch (e) {}

      const p = checkoutData.prices || {};
      const html = [
        isBasic || checkoutData.upgrades.upgradeToPlus
          ? row("Upgrade to Listed Property Plus", displayPlusPrice, "upgradeToPlus", {paid:false, note: plusNote})
          : "",
        row("Banner", (p.banner ?? 10), "banner", {paid: checkoutData.upgrades.banner}),
        row("Premium Placement", (p.premium ?? 10), "premium", {paid: checkoutData.upgrades.premium}),
        row("Pin Placement", (p.pin ?? 50), "pin", {paid: checkoutData.upgrades.pin}),
        plan.includes("FSBO") ? row("Confidential FSBO Upgrade", (p.confidential ?? 100), "confidential", {paid: checkoutData.upgrades.confidential}) : ""
      ].join("");
      box.innerHTML = html;

      box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const k = e.target.getAttribute("data-key");
          const checked = e.target.checked;
          if (k === "upgradeToPlus") {
            checkoutData.upgrades.upgradeToPlus = checked;
            localStorage.setItem("selectedPlan", checked ? "Listed Property Plus" : "Listed Property Basic");
          } else if (k === "banner") {
            checkoutData.upgrades.banner = checked;
          } else if (k === "premium") {
            checkoutData.upgrades.premium = checked && !checkoutData.upgrades.pin;
          } else if (k === "pin") {
            checkoutData.upgrades.pin = checked;
            if (checked) checkoutData.upgrades.premium = true;
          } else if (k === "confidential") {
            checkoutData.upgrades.confidential = checked;
          }
          setJSON("checkoutData", checkoutData);
          if (k === "banner") {
            $("bannerText").disabled = !checked && !isPlus;
            $("bannerText").classList.toggle("dimmed", (!checked && !isPlus));
          }
          if (k === "premium" || k === "pin") {
            const premOn = checkoutData.upgrades.premium || checkoutData.upgrades.pin;
            $("preferredArea").disabled = !premOn;
            $("preferredArea").classList.toggle("dimmed", !premOn);
            $("pinArea").disabled = !checkoutData.upgrades.pin;
            $("pinArea").classList.toggle("dimmed", !checkoutData.upgrades.pin);
          }
        });
      });
    }
    paintUpgrades();

    $("updateUpgradesBtn").addEventListener("click", () => {
      checkoutData.meta.preferredArea = $("preferredArea").value || checkoutData.meta.preferredArea || "";
      checkoutData.meta.pinArea = $("pinArea").value || checkoutData.meta.pinArea || "";
      checkoutData.payer = "agent";
      setJSON("checkoutData", checkoutData);
      alert("Upgrades updated. Go to Checkout to pay (if needed).");
    });

    $("goCheckoutBtn").addEventListener("click", () => { window.location.href = "/checkout.html"; });

    // Preview button should pass ?id=
    (function wirePreview(){
      const a = document.getElementById('previewBtn');
      const id = localStorage.getItem('lastListingId') || '';
      if (id) a.href = `/listing.html?id=${encodeURIComponent(id)}`;
    })();
  </script>

  <!-- Firestore SAVE TO SERVER for agent -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    async function saveToFirestoreAgent() {
      try {
        const listingId = localStorage.getItem("lastListingId");
        if (!listingId) { alert("No listing ID found for this session."); return; }
        const payload = JSON.parse(localStorage.getItem("agentListing") || "{}");
        const form = JSON.parse(localStorage.getItem("formData") || "{}");

        const update = {
          updatedAt: serverTimestamp(),
          price: payload.price ?? "",
          bedrooms: payload.bedrooms ?? "",
          bathrooms: payload.bathrooms ?? "",
          sqft: payload.sqft ?? "",
          propertyType: payload.propertyType ?? "",
          bannerText: payload.bannerText ?? "",
          photos: Array.isArray(payload.photos) ? payload.photos.slice(0, 20) : [],
          primaryIndex: (typeof payload.primaryIndex === "number" ? payload.primaryIndex : 0),
          status: payload.status || "Active",
          brokerage: payload.brokerage || form.brokerage || "",
          agentName: payload.agentName || form.agent || "",
          agentPhone: payload.agentPhone || form.agentPhone || "",
          agentEmail: payload.agentEmail || (localStorage.getItem('loggedInEmail') || '')
        };
        await updateDoc(doc(db, "listings", listingId), update);
        alert("Saved to server.");
      } catch (e) {
        console.warn("[agent-detail] update failed", e);
        alert("Could not save to server. Saved locally.");
      }
    }

    document.getElementById("saveBtn")?.addEventListener("click", async () => {
      try { await saveToFirestoreAgent(); } catch {}
    });
  </script>
</body>
</html>
