<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent: Manage Listing Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <div class="flex items-start justify-between">
      <h1 class="text-2xl font-bold">Agent: Manage Listing Details</h1>
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">Back to Home</a>
    </div>

    <p class="text-sm text-gray-600 mt-1">
      Enter the details below. Changes auto-save to your browser. Use ‚ÄúPreview‚Äù to see the public tile.
    </p>

    <hr class="my-5"/>

    <!-- Status -->
    <div id="planPill" class="inline-block text-xs font-semibold px-2 py-1 rounded bg-gray-200 text-gray-700"></div>

    <form id="agentForm" class="mt-4 space-y-4" autocomplete="off">
      <!-- Address (read-only from seller) -->
      <div>
        <label class="block text-sm font-semibold mb-1">Full Property Address</label>
        <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
      </div>

      <!-- Price & Commission -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
          <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Commission</label>
          <div class="flex gap-2">
            <input id="commission" type="number" min="0" step="0.01" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            <select id="commissionType" class="border p-2 rounded">
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>
          <!-- üëá moved helper BELOW so it doesn‚Äôt collide with the price field -->
          <p class="text-xs text-gray-500 mt-1">Kept in sync with price above for the calculated amount.</p>
        </div>
      </div>

      <!-- Calculated Commission -->
      <div class="bg-gray-50 border rounded p-3 text-sm">
        <strong>Calculated Commission: </strong>
        <span id="commissionCalc">$0</span>
      </div>

      <!-- Description (Plus only) -->
      <div id="descBlock">
        <label class="block text-sm font-semibold mb-1">Full Property Description (Plus)</label>
        <textarea id="description" rows="6" placeholder="Enter full property description (Plus only)" class="w-full border p-2 rounded"></textarea>
        <p class="text-xs text-gray-500 mt-1">Up to 2,500 characters.</p>
      </div>

      <!-- Banner text (optional upsell) -->
      <div>
        <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
        <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1‚Äì4)" class="w-full border p-2 rounded">
        <p class="text-xs text-gray-500 mt-1">Appears as a small ribbon on the listing tile.</p>
      </div>

      <!-- Photos -->
      <div>
        <label class="block text-sm font-semibold mb-2">Photos</label>
        <div class="text-xs text-gray-600 mb-2" id="photoHelp"></div>
        <input id="photoInput" type="file" accept="image/*" multiple class="block">
        <div id="photoGrid" class="flex flex-wrap gap-2 mt-3"></div>
        <p class="text-xs text-gray-500 mt-2">Tip: click a thumbnail to set it as the primary photo.</p>
      </div>

      <!-- Upsell (Agent Pays) -->
      <div class="bg-blue-50 border border-blue-200 rounded p-3">
        <p class="text-sm">
          <strong>Upgrade (Agent Pays):</strong>
          <span class="text-gray-700">Upgrade to Listed Property Plus ($20) to display full property description and 20 photos.</span>
        </p>
        <div class="mt-2">
          <button id="upgradePlusBtn" type="button" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Upgrade to Plus</button>
        </div>
      </div>

      <div class="flex items-center gap-2 pt-2">
        <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
        <a href="/agent-preview.html" class="bg-green-600 text-white px-4 py-2 rounded">Preview</a>
      </div>
    </form>
  </div>

  <script>
    // ---------- State ----------
    const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const formData = JSON.parse(localStorage.getItem("formData") || "{}"); // source of address + seller entries
    const AGENT_KEY = "agentListing";

    // load agent draft or init
    const agentListing = JSON.parse(localStorage.getItem(AGENT_KEY) || "{}");

    // helpers
    const $ = (id) => document.getElementById(id);

    // ---------- Init ----------
    function init() {
      // Plan pill
      $("planPill").textContent = plan;

      // Address from seller
      $("fullAddress").value = formData.address || "";

      // Price
      $("price").value = agentListing.price ?? "";

      // Commission + type (fallback to seller-entered commission)
      $("commission").value = agentListing.commission ?? (formData.commission || "");
      $("commissionType").value = agentListing.commissionType ?? (formData.commissionType || "%");

      // Description gate based on plan
      const isPlus = plan === "Listed Property Plus" || plan === "FSBO Plus";
      $("descBlock").style.display = isPlus ? "block" : "none";
      $("description").value = agentListing.description ?? "";

      // Banner
      $("bannerText").value = agentListing.bannerText ?? "";

      // Photos help & limit
      const canUpload = isPlus ? 20 : 1;
      $("photoHelp").textContent = isPlus
        ? "You can upload up to 20 photos."
        : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";

      // Render thumbnails
      renderThumbs(agentListing.photos || [], agentListing.primaryIndex || 0);

      // After initial fill, compute commission
      computeCommission();
    }

    function renderThumbs(photos, primaryIndex) {
      const grid = $("photoGrid");
      grid.innerHTML = "";
      photos.forEach((src, idx) => {
        const img = new Image();
        img.src = src;
        img.alt = "Photo " + (idx + 1);
        img.className = "thumb border " + (idx === primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (idx === primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", () => {
          agentListing.primaryIndex = idx;
          saveAgentListing();
          renderThumbs(agentListing.photos || [], agentListing.primaryIndex || 0);
        });
        grid.appendChild(img);
      });
    }

    function computeCommission() {
      const price = Number($("price").value || 0);
      const comm = Number($("commission").value || 0);
      const type = $("commissionType").value;
      let calc = 0;
      if (type === "%") {
        calc = Math.round(price * (comm / 100));
      } else {
        calc = Math.round(comm);
      }
      $("commissionCalc").textContent = `$${(calc || 0).toLocaleString()}`;
    }

    function saveAgentListing() {
      // Clamp photo count based on plan
      const isPlus = plan === "Listed Property Plus" || plan === "FSBO Plus";
      const maxPhotos = isPlus ? 20 : 1;

      const payload = {
        price: $("price").value,
        commission: $("commission").value,
        commissionType: $("commissionType").value,
        description: $("description").value,
        bannerText: $("bannerText").value,
        photos: (agentListing.photos || []).slice(0, maxPhotos),
        primaryIndex: (agentListing.primaryIndex || 0)
      };
      localStorage.setItem(AGENT_KEY, JSON.stringify(payload));
    }

    // ---------- Events ----------
    ["price","commission","commissionType","description","bannerText"].forEach(id => {
      $(id).addEventListener("input", () => {
        if (id === "price" || id === "commission" || id === "commissionType") {
          computeCommission();
        }
        saveAgentListing();
      });
    });

    $("saveBtn").addEventListener("click", () => {
      saveAgentListing();
      alert("Saved.");
    });

    $("photoInput").addEventListener("change", async (e) => {
      const isPlus = plan === "Listed Property Plus" || plan === "FSBO Plus";
      const maxPhotos = isPlus ? 20 : 1;

      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const existing = agentListing.photos || [];
      let spaceLeft = maxPhotos - existing.length;
      if (spaceLeft <= 0) {
        alert(`You have reached the photo limit for your plan (${maxPhotos}).`);
        e.target.value = "";
        return;
      }

      const toRead = files.slice(0, spaceLeft);

      const readAsDataURL = (file) => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      for (const f of toRead) {
        try {
          const dataUrl = await readAsDataURL(f);
          existing.push(dataUrl);
        } catch (err) {
          console.error("Failed to read file", err);
        }
      }

      agentListing.photos = existing.slice(0, maxPhotos);
      if (typeof agentListing.primaryIndex !== "number") agentListing.primaryIndex = 0;

      saveAgentListing();
      renderThumbs(agentListing.photos, agentListing.primaryIndex);

      e.target.value = "";
    });

    $("upgradePlusBtn").addEventListener("click", () => {
      // Build a minimal checkout payload for an agent upgrade to Plus
      const checkoutData = {
        plan: "Listed Property Plus",
        upgrades: [],            // no add-ons here; pure plan upgrade
        totalCost: 20,
        payer: "agent"           // üëà this returns to agent-detail after Stripe
      };
      localStorage.setItem("checkoutData", JSON.stringify(checkoutData));
      window.location.href = "/checkout.html";
    });

    // ---------- Start ----------
    init();
  </script>
  <script src="/intake-followups.js"></script>

</body>
</html>
