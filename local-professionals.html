<!DOCTYPE html>
<!-- Build: 2026-01-16 (Bulk ZIP subscription checkout - Local Professionals | License REQUIRED | Green Pay Button) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Professionals | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hint { font-size: 11px; color:#6b7280; }
    .chip { font-size: 12px; padding: 4px 8px; border-radius: 9999px; background:#f3f4f6; color:#374151; }
    .chip-bad { background:#fee2e2; color:#991b1b; }
    .chip-good { background:#dcfce7; color:#166534; }
    /* Full business card preview - shows complete rectangle */
    .card-preview { width: auto; max-width: 100%; height: auto; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header (matches home page) -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

        <div class="text-center">
          <div class="flex items-end justify-center gap-0">
            <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
            <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
          <a href="/login.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Log In</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-2xl font-bold text-center">Become a Local Professional</h2>
      <p class="text-sm text-center text-gray-700 mt-1">
        <strong>$5 per month per ZIP</strong>. Display your business card on listing detail pages in your selected ZIPs.
      </p>

      <div id="status" class="hidden mt-4 text-sm rounded-lg p-3"></div>

      <form id="proForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" autocomplete="off">
        <div>
          <label class="block text-sm font-semibold">I am a <span class="text-red-600">*</span></label>
          <select id="role" class="w-full border rounded px-3 py-2" required>
            <option value="">Selectâ€¦</option>
            <option value="real_estate_agent">Real Estate Agent</option>
            <option value="lender">Lender</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold">Name <span class="text-red-600">*</span></label>
          <input id="personalName" class="w-full border rounded px-3 py-2" placeholder="Your name" required>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Company Name <span class="text-red-600">*</span></label>
          <input id="name" class="w-full border rounded px-3 py-2" placeholder="Full Company Name" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Email <span class="text-red-600">*</span></label>
          <input id="email" type="email" class="w-full border rounded px-3 py-2" placeholder="you@example.com" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Phone <span class="text-red-600">*</span></label>
          <input id="phone" class="w-full border rounded px-3 py-2" placeholder="123-456-7890" inputmode="numeric" required>
          <p class="hint mt-1">Format: 123-456-7890</p>
        </div>

        <!-- âœ… REQUIRED LICENSE -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">License # (agents/lenders) <span class="text-red-600">*</span></label>
          <input id="license" class="w-full border rounded px-3 py-2" placeholder="license # / DRE # / NMLS # (required)" required>
          <p class="hint mt-1">Required by state law for advertising.</p>
        </div>

        <!-- âœ… BULK ZIP INPUT -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">ZIP Codes (up to 3) <span class="text-red-600">*</span></label>
          <input id="zipBulk" class="w-full border rounded px-3 py-2"
                 placeholder="Enter ZIPs separated by commas or spaces (e.g., 92651, 92657, 92660)" required>
          <p class="hint mt-1">Maximum 3 ZIP codes. We will validate and de-duplicate.</p>
          <div class="mt-2 flex flex-wrap gap-2" id="zipChips"></div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Business Card (optional image)</label>
          <input id="photo" type="file" accept=".png,.jpg,.jpeg,image/png,image/jpeg" class="w-full">
          <div id="photoPreview" class="mt-2"></div>
          <p class="hint mt-1">PNG/JPG recommended.</p>
        </div>

        <!-- âœ… REAL-TIME TOTAL + GREEN PAY BUTTON -->
        <div class="md:col-span-2 flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-2">
          <div class="text-sm text-gray-700">
            Monthly total: <span id="total" class="font-semibold">$0/month</span>
            <span id="countNote" class="text-gray-500"></span>
          </div>

          <button id="checkoutBtn" type="button"
                  class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-semibold">
            Proceed to Checkout
          </button>
        </div>

        <div class="md:col-span-2 text-xs text-gray-600 mt-1">
          All purchases subject to quality control review.
        </div>
      </form>

      <section id="thanks" class="hidden bg-emerald-50 rounded-2xl border border-emerald-200 p-5 mt-6 text-emerald-800">
        <h3 class="text-lg font-semibold">Thank you!</h3>
        <p class="text-sm mt-1">Your Local Professional subscription checkout completed successfully.</p>
      </section>
    </section>
  </main>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import { addDoc, collection, doc, updateDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const PRICE_ID_LOCAL_PRO = "price_1SQXeOPTiT2zuxx08ruzwpb6"; // $5/mo per ZIP
    const PRICE_PER_ZIP = 5;
    const MAX_ZIPS = 3;
    const MAX_AGENTS_PER_ZIP = 3;
    const MAX_LENDERS_PER_ZIP = 1;

    const $ = (id) => document.getElementById(id);

    // Waitlist state
    let isWaitlistMode = false;
    let soldOutZips = [];

    function setStatus(msg, ok=true){
      const el = $('status'); el.classList.remove('hidden');
      el.className = ok ? 'mt-4 text-sm rounded-lg p-3 bg-green-50 text-green-700'
                        : 'mt-4 text-sm rounded-lg p-3 bg-red-50 text-red-700';
      el.textContent = msg;
    }

    // Check ZIP availability based on role (3 agents or 1 lender per ZIP)
    async function checkZipAvailability(zips, role) {
      const soldOut = [];
      const maxSlots = role === 'lender' ? MAX_LENDERS_PER_ZIP : MAX_AGENTS_PER_ZIP;
      
      for (const zip of zips) {
        if (!zip) continue;
        try {
          const q = query(
            collection(db, "localPros"),
            where("status", "==", "active"),
            where("role", "==", role),
            where("zips", "array-contains", zip)
          );
          const snap = await getDocs(q);
          if (snap.size >= maxSlots) {
            soldOut.push(zip);
          }
        } catch (e) {
          console.warn("[checkZip] error for", zip, e);
        }
      }
      return soldOut;
    }

    // Update button state based on availability
    function updateButtonState(soldOut, zipCodes) {
      const btn = $('checkoutBtn');
      soldOutZips = soldOut;
      
      if (soldOut.length > 0 && zipCodes.length > 0) {
        // Some ZIPs are sold out - switch to waitlist mode
        isWaitlistMode = true;
        btn.textContent = 'Join Waitlist';
        btn.className = 'px-4 py-2 rounded text-white font-semibold';
        btn.style.backgroundColor = '#4DA6FF';
        $('total').textContent = '$0 due today';
        $('countNote').textContent = ' (Waitlist)';
        
        // Show which ZIPs are sold out
        setStatus(`ZIP ${soldOut.join(', ')} is currently full. You can join the waitlist to be notified when a spot opens.`, true);
      } else {
        // All ZIPs available - normal checkout mode
        isWaitlistMode = false;
        btn.textContent = 'Proceed to Checkout';
        btn.className = 'px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-semibold';
        btn.style.backgroundColor = '';
        $('status').classList.add('hidden');
      }
    }

    // Debounced availability check
    let checkTimeout = null;
    async function debouncedAvailabilityCheck() {
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(async () => {
        const role = $('role').value.trim();
        const { zipCodes } = updateTotal(false); // Don't re-trigger check
        
        if (role && zipCodes.length > 0) {
          const soldOut = await checkZipAvailability(zipCodes, role);
          updateButtonState(soldOut, zipCodes);
        } else {
          updateButtonState([], zipCodes);
        }
      }, 500);
    }

    function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }
    function formatPhone(s){
      const d = onlyDigits(s).slice(0,10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0,3) + '-' + d.slice(3);
      return d.slice(0,3) + '-' + d.slice(3,6) + '-' + d.slice(6);
    }

    function parseZipList(raw) {
      const parts = String(raw || "")
        .replace(/[\n\r]/g, " ")
        .split(/[, ]+/)
        .map(s => s.trim())
        .filter(Boolean);

      const seen = new Set();
      const good = [];
      const bad = [];

      for (const p of parts) {
        const z = p.replace(/\D/g,'').slice(0,5);
        if (!/^\d{5}$/.test(z)) { bad.push(p); continue; }
        if (seen.has(z)) continue;
        seen.add(z);
        good.push(z);
      }
      return { good, bad };
    }

    function fmtMoney(n){ return '$' + Number(n||0).toLocaleString(); }

    function renderZipChips(good, bad) {
      const host = $('zipChips');
      host.innerHTML = '';
      good.forEach(z => {
        const d = document.createElement('span');
        d.className = 'chip chip-good';
        d.textContent = z;
        host.appendChild(d);
      });
      bad.forEach(x => {
        const d = document.createElement('span');
        d.className = 'chip chip-bad';
        d.textContent = `Invalid: ${x}`;
        host.appendChild(d);
      });
    }

    function updateTotal(triggerCheck = true) {
      const raw = $('zipBulk').value;
      const { good, bad } = parseZipList(raw);

      if (good.length > MAX_ZIPS) {
        const extra = good.slice(MAX_ZIPS);
        good.length = MAX_ZIPS;
        extra.forEach(x => bad.push(x));
      }

      renderZipChips(good, bad);

      // Only update total if not in waitlist mode (will be overridden by availability check)
      if (!isWaitlistMode) {
        const total = good.length * PRICE_PER_ZIP;
        $('total').textContent = `${fmtMoney(total)}/month`;
        $('countNote').textContent = good.length ? ` (${good.length} ZIP${good.length===1?'':'s'})` : '';
      }
      
      // Trigger availability check
      if (triggerCheck) {
        debouncedAvailabilityCheck();
      }
      
      return { zipCodes: good, invalid: bad };
    }

    $('phone')?.addEventListener('input', (e) => { e.target.value = formatPhone(e.target.value); });
    $('zipBulk')?.addEventListener('input', () => updateTotal(true));
    $('role')?.addEventListener('change', debouncedAvailabilityCheck);
    updateTotal(false);

    // ========== DRAFT RESTORATION (Auth Gate Support) ==========
    // If user was redirected to login and came back, restore their form data
    (function restoreDraft() {
      try {
        const draftJson = localStorage.getItem('localProFormDraft');
        if (!draftJson) return;
        
        const draft = JSON.parse(draftJson);
        console.log('[local-pros] Restoring form draft:', draft);
        
        // Restore form fields
        if (draft.role && $('role')) $('role').value = draft.role;
        if (draft.personalName && $('personalName')) $('personalName').value = draft.personalName;
        if (draft.name && $('name')) $('name').value = draft.name;
        if (draft.email && $('email')) $('email').value = draft.email;
        if (draft.phone && $('phone')) $('phone').value = formatPhone(draft.phone);
        if (draft.license && $('license')) $('license').value = draft.license;
        if (draft.zipBulk && $('zipBulk')) $('zipBulk').value = draft.zipBulk;
        
        // Trigger total/chips update and availability check
        updateTotal(true);
        
        // Show status message
        setStatus('Welcome back! Your form has been restored. Please click "Proceed to Checkout" to continue.', true);
        
        // Clear the draft (one-time restore)
        localStorage.removeItem('localProFormDraft');
        
        // Clear the return path if we're back
        if (localStorage.getItem('nextAfterLogin') === window.location.href) {
          localStorage.removeItem('nextAfterLogin');
        }
      } catch (e) {
        console.warn('[local-pros] Draft restore failed:', e);
        localStorage.removeItem('localProFormDraft');
      }
    })();

    // Helper to check if user is logged in
    function isLoggedIn() {
      const email = (localStorage.getItem('loggedInEmail') || '').trim();
      return email.length > 0;
    }

    // Helper to save form draft for auth gate
    function saveFormDraft() {
      const draft = {
        role: $('role')?.value || '',
        personalName: $('personalName')?.value || '',
        name: $('name')?.value || '',
        email: $('email')?.value || '',
        phone: $('phone')?.value || '',
        license: $('license')?.value || '',
        zipBulk: $('zipBulk')?.value || '',
        savedAt: Date.now()
      };
      localStorage.setItem('localProFormDraft', JSON.stringify(draft));
      console.log('[local-pros] Form draft saved for auth gate');
    }

    $('photo')?.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => { $('photoPreview').innerHTML = `<img src="${r.result}" alt="Business Card Preview" class="card-preview">`; };
      r.readAsDataURL(f);
    });

    async function maybeUploadPhoto(draftId) {
      try {
        const file = $('photo')?.files?.[0];
        if (!file) return "";
        const storage = getStorage(undefined, STORAGE_BUCKET_GS);
        const safe = String(file.name || "local_pro_card").replace(/[^\w\-.]+/g,"_");
        const path = `localPros/${draftId}/card_${Date.now()}_${safe}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        return await getDownloadURL(r);
      } catch (e) {
        console.warn("[local-pros] photo upload failed:", e);
        return "";
      }
    }

    function loggedInEmail() {
      return (localStorage.getItem('loggedInEmail') || localStorage.getItem('verifyTarget') || '').trim();
    }

    // Success handling with fallback activation
    (async function(){
      const u = new URL(location.href);
      if (u.searchParams.get('status') === 'success') {
        $('thanks')?.classList.remove('hidden');
        
        // Fallback activation: If pendingLocalProId exists, activate immediately
        const pendingId = localStorage.getItem("pendingLocalProId");
        if (pendingId) {
          try {
            await updateDoc(doc(db, "localPros", pendingId), {
              status: "active",
              activatedAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            console.log("[local-pros] Fallback activation successful:", pendingId);
            
            // Clean up localStorage
            localStorage.removeItem("pendingLocalProId");
            localStorage.removeItem("pendingLocalProEmail");
            localStorage.removeItem("localProDraftId");
            
            // Update success message
            const thanksEl = $('thanks');
            if (thanksEl) {
              thanksEl.innerHTML = `
                <h3 class="text-lg font-semibold">Thank you!</h3>
                <p class="text-sm mt-1">Your Local Professional subscription checkout completed successfully. Your business card is now live in the requested ZIP code.</p>
              `;
            }
          } catch (e) {
            console.warn("[local-pros] Fallback activation failed:", e);
          }
        }
      }
    })();

    $('checkoutBtn')?.addEventListener('click', async () => {
      const btn = $('checkoutBtn');
      try {
        btn.disabled = true;
        btn.textContent = isWaitlistMode ? 'Joining waitlistâ€¦' : 'Starting checkoutâ€¦';

        const role = $('role').value.trim();
        const personalName = $('personalName').value.trim();
        const name = $('name').value.trim();
        const email = $('email').value.trim().toLowerCase();
        const phoneDigits = onlyDigits($('phone').value);
        const phone = formatPhone($('phone').value.trim());
        const license = $('license').value.trim();
        const { zipCodes } = updateTotal(false);

        // ========== STEP 1: VALIDATION ==========
        if (!role || !personalName || !name || !email) {
          setStatus('Please complete role, personal name, company name, and email.', false);
          return;
        }
        if (!/^\S+@\S+\.\S{2,}$/.test(email)) {
          setStatus('Please enter a valid email address.', false);
          return;
        }
        if (phoneDigits.length !== 10) {
          setStatus('Please enter a valid 10-digit phone number.', false);
          return;
        }
        if (!license) {
          setStatus('License # is required for advertising.', false);
          return;
        }
        if (!zipCodes.length) {
          setStatus('Please enter at least one valid 5-digit ZIP code.', false);
          return;
        }
        if (zipCodes.length > MAX_ZIPS) {
          setStatus('Maximum 3 ZIP codes per checkout.', false);
          return;
        }

        // ========== STEP 2: AUTH GATE ==========
        // User must be logged in before proceeding to payment or waitlist
        if (!isLoggedIn()) {
          setStatus('Please log in or create an account to continue. Redirecting...', true);
          
          // Save form data for restoration after login
          saveFormDraft();
          
          // Set return path so login redirects back here
          localStorage.setItem('nextAfterLogin', window.location.href);
          
          // Redirect to login page
          setTimeout(() => {
            window.location.href = '/login.html?tab=create';
          }, 1000);
          
          return;
        }

        // ========== STEP 3: WAITLIST MODE ==========
        if (isWaitlistMode) {
          const waitlistData = {
            role,
            personalName,
            name,
            email,
            emailLower: email.toLowerCase(),
            phone,
            license,
            waitlistZips: soldOutZips,
            allRequestedZips: zipCodes,
            status: "waiting",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          // Upload photo if provided
          let photoUrl = "";
          const photoFile = $('photo')?.files?.[0];
          if (photoFile) {
            try {
              const storage = getStorage(undefined, STORAGE_BUCKET_GS);
              const safe = String(photoFile.name || "waitlist_card").replace(/[^\w\-.]+/g,"_");
              const path = `waitlist_localPros/${email.replace(/[^a-z0-9]/g,'_')}/card_${Date.now()}_${safe}`;
              const r = ref(storage, path);
              await uploadBytes(r, photoFile);
              photoUrl = await getDownloadURL(r);
              waitlistData.photoUrl = photoUrl;
            } catch (e) {
              console.warn("[waitlist] photo upload failed:", e);
            }
          }

          await addDoc(collection(db, "waitlist_localPros"), waitlistData);
          console.log("[local-pros] Added to waitlist");

          // Show success message
          const thanksEl = $('thanks');
          if (thanksEl) {
            thanksEl.innerHTML = `
              <h3 class="text-lg font-semibold">You're on the Waitlist!</h3>
              <p class="text-sm mt-1">ZIP ${soldOutZips.join(', ')} is currently full. You have been added to the priority waitlist. We will notify you at <strong>${email}</strong> when a spot opens.</p>
            `;
            thanksEl.classList.remove('hidden');
          }
          $('status').classList.add('hidden');
          $('proForm').classList.add('hidden');
          return;
        }

        // ========== STEP 4: NORMAL CHECKOUT MODE ==========
        const draft = {
          role,
          personalName,
          name,
          email,
          phone,
          license,
          zips: zipCodes,
          photoUrl: "",
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const refDoc = await addDoc(collection(db, "localPros"), draft);
        
        // Store for activation on checkout-success.html
        localStorage.setItem("pendingLocalProId", refDoc.id);
        localStorage.setItem("pendingLocalProEmail", email);
        localStorage.setItem("localProDraftId", refDoc.id); // Legacy key

        const photoUrl = await maybeUploadPhoto(refDoc.id);
        if (photoUrl) {
          await updateDoc(doc(db, "localPros", refDoc.id), { photoUrl, updatedAt: serverTimestamp() });
        }

        const payload = {
          roleType: "local_pro",
          zipCodes: zipCodes,
          priceId: PRICE_ID_LOCAL_PRO,
          successUrl: window.location.origin + "/local-professionals.html?status=success",
          cancelUrl:  window.location.origin + "/local-professionals.html?status=cancel",
          metadata: {
            email: loggedInEmail() || email,
            name: name,
            personalName: personalName,
            license: license,
            draftId: refDoc.id
          }
        };

        const resp = await fetch("/api/create-subscription-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const ct = resp.headers.get("content-type") || "";
        const out = ct.includes("application/json") ? await resp.json() : { error: "Non-JSON server response" };
        if (!resp.ok) throw new Error(out.error || out.message || "Subscription session failed.");
        if (out.url) { window.location.href = out.url; return; }
        throw new Error("Server did not return checkout url.");
      } catch (e) {
        console.error(e);
        setStatus(e.message || "Checkout error.", false);
      } finally {
        btn.disabled = false;
        btn.textContent = isWaitlistMode ? "Join Waitlist" : "Proceed to Checkout";
      }
    });
  </script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail Intake (Seller)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
    .badge { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#ecfccb; color:#166534; border:1px solid #bbf7d0; }

    /* ===== Soft Autosave indicator ===== */
    #autosaveIndicator {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 9999px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    #autosaveDot {
      width: 9px;
      height: 9px;
      border-radius: 9999px;
      background: #9ca3af;
      box-shadow: 0 0 0 2px rgba(156,163,175,0.15);
    }
    #autosaveText { color: #374151; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <div id="autosaveIndicator" aria-live="polite">
    <span id="autosaveDot"></span>
    <span id="autosaveText">Waitingâ€¦</span>
  </div>

  <header class="bg-white shadow">
    <div class="relative flex items-center justify-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="absolute left-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">Home</a>

      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>
    </div>
  </header>

  <div id="soldLockBanner" class="hidden max-w-6xl mx-auto px-3 mt-4">
    <div class="bg-red-50 border border-red-200 text-red-800 rounded-lg p-3 text-sm font-semibold">
      Locked: This listing is closed and can no longer be edited.
    </div>
  </div>

  <main class="max-w-6xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6 px-3">

    <section class="lg:col-span-2 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm">
          <span class="text-gray-600">Plan:</span> <span id="planPill" class="pill">â€”</span>
        </p>
        <p id="whoLine" class="text-xs text-gray-600"></p>
      </div>

      <hr class="my-4"/>

      <form id="sellerForm" class="space-y-5" autocomplete="off">
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Address</label>
          <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
          <select id="status" class="w-full border p-2 rounded" required>
            <option value="">Select...</option>
            <option>Active</option>
            <option>In Contract</option>
            <option>Sold</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
            <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
            <div class="flex gap-2">
              <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
              <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50 text-center" readonly>
            </div>
            <p id="commissionLockNote" class="text-xs text-gray-500 mt-1">Commission is locked. Use "Change Commission" upgrade to modify.</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Property Facts</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
              <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
              <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
              <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 1860" class="w-full border p-2 rounded">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Year Built</span>
              <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1972" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
              <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 6000" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-sm font-semibold mb-1">Property Type</span>
              <select id="propertyType" class="w-full border p-2 rounded">
                <option value="">Select...</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
          <input id="apn" class="w-full border p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
          <p id="apnReqMsg" class="text-xs text-gray-500 mt-1">FSBO requires an APN/Parcel value.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Photos</label>
          <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>
          <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" multiple class="block">
          <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
          <p class="text-xs text-gray-500 mt-2">Click a thumbnail or use the buttons to set primary, replace, or delete.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Description</label>
          <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full border p-2 rounded"></textarea>
          <p id="descGateNote" class="lock-note mt-1 hidden">Upgrade to Listed Property Plus to enable Description.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
          <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1-4)" class="w-full border p-2 rounded">
          <p id="bannerGateNote" class="lock-note mt-1 hidden">Purchase Banner upgrade to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
          <input id="preferredArea" placeholder="e.g., Newport Beach, Harbor View Homes" class="w-full border p-2 rounded">
          <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
          <input id="pinArea" placeholder="e.g., Newport Beach, Eastbluff" class="w-full border p-2 rounded">
          <p id="pinGateNote" class="lock-note mt-1 hidden">Purchase Pin Placement to enable this field.</p>
        </div>

        <div id="listedBlock">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
              <input id="brokerage" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
              <input id="agentName" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
              <input id="agentEmail" type="email" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
              <input id="agentPhone" class="w-full border p-2 rounded">
            </div>
          </div>
        </div>

        <div class="pt-2 mt-4">
          <a id="previewLink" href="/listing.html" class="block w-full text-center py-2 rounded bg-[#4DA6FF] text-white hover:bg-blue-500">Preview Full Listing Detail</a>
        </div>
      </form>
    </section>

    <aside class="space-y-4">

      <section class="bg-white rounded shadow p-5">
        <h2 class="text-lg font-semibold">Upgrade your listing</h2>
        <div id="upgradesBox" class="mt-4 space-y-3 text-sm"></div>
        <div class="mt-4">
          <button id="goCheckoutBtn" class="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Go to Checkout</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Purchases are final.</p>
      </section>

      <section id="prosSidebar" class="bg-white rounded shadow p-5">
        <div class="mb-3">
          <h3 class="font-semibold">Local Professionals in <span id="prosZip">â€”</span></h3>
        </div>
        <div id="prosList" class="space-y-3"></div>
      </section>
    </aside>

    <section id="brokerStrip" class="lg:col-span-3 bg-white rounded shadow p-5">
      <div class="mb-3">
        <h3 class="text-lg font-semibold">Local Real Estate Brokerage in <span id="brokerZip">â€”</span></h3>
      </div>
      <div id="brokerAd" class="max-h-[400px] overflow-y-auto min-h-[140px] flex items-center justify-center bg-gray-50 rounded border border-gray-200"></div>
    </section>

    <!-- Local Service Providers Strip -->
    <section id="serviceProvidersStrip" class="lg:col-span-3 bg-white rounded shadow p-5" style="display:none;">
      <div class="mb-3">
        <h3 class="text-lg font-semibold">Local Service Providers in <span id="serviceProvidersZip">â€”</span></h3>
      </div>
      <div id="serviceProvidersGrid" class="max-h-[400px] overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <div id="changeCommissionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md relative p-6">
      <button onclick="closeChangeCommissionModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>

      <h2 class="text-lg font-bold mb-4">Change Commission</h2>
      <p class="text-sm text-gray-600 mb-4">Enter your new commission amount and type. After payment, you will sign a new Irrevocable Seller Communication with the updated commission.</p>

      <div class="space-y-4">
        <div class="flex gap-2">
          <input type="text" id="newCommission" placeholder="Commission amount (e.g., 2.5 or 5000)" class="flex-1 border p-2 rounded">
          <select id="newCommissionType" class="border p-2 rounded w-20">
            <option value="%">%</option>
            <option value="$">$</option>
          </select>
        </div>

        <div class="flex items-center justify-end gap-2">
          <button type="button" onclick="closeChangeCommissionModal()" class="px-4 py-2 rounded border">Cancel</button>
          <button id="confirmCommissionBtn" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Confirm New Commission</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sold Details Modal -->
  <div id="soldDetailsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md relative p-6">
      <button onclick="closeSoldModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>

      <h2 class="text-lg font-bold mb-2">ðŸŽ‰ Congratulations!</h2>
      <p class="text-sm text-gray-600 mb-4">Please enter the final closing details before we lock this listing.</p>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Sold Price ($) <span class="text-red-600">*</span></label>
          <input type="number" id="soldPrice" min="0" step="1000" placeholder="e.g., 875000" class="w-full border p-2 rounded">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Closing Date <span class="text-red-600">*</span></label>
          <input type="date" id="soldDate" class="w-full border p-2 rounded">
        </div>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" onclick="closeSoldModal()" class="px-4 py-2 rounded border">Cancel</button>
          <button id="confirmSoldBtn" type="button" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Confirm Sold</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openChangeCommissionModal() { document.getElementById('changeCommissionModal').classList.remove('hidden'); }
    function closeChangeCommissionModal() { document.getElementById('changeCommissionModal').classList.add('hidden'); }
    function openSoldModal() { document.getElementById('soldDetailsModal').classList.remove('hidden'); }
    function closeSoldModal() {
      document.getElementById('soldDetailsModal').classList.add('hidden');
      // Revert dropdown to previous status
      if (window.__preSoldStatus != null) {
        var el = document.getElementById('status');
        if (el) el.value = window.__preSoldStatus;
      }
    }
  </script>

  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import { updatePaidUpgradesAfterPayment } from "/scripts/paid-upgrades-handler.js";

    import {
      doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // =========================================================================
    // Mapbox geocoding for lat/lng (non-blocking with timeout)
    // =========================================================================
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtaW1idDMwbjFjMWUzZHE3ZzY4ZjBob3IifQ.lF5BvHIsT_SVe0f6mT5nRw";
    const GEO_TIMEOUT_MS = 3000;

    async function geocodeAddress(address) {
      const failResult = { lat:null, lng:null, placeName:null, status:"failed", provider:"mapbox" };
      if (!address || !MAPBOX_TOKEN) { failResult.status = "skipped"; return failResult; }

      try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?limit=1&access_token=${MAPBOX_TOKEN}`;
        const fetchPromise = fetch(url);
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), GEO_TIMEOUT_MS));

        const resp = await Promise.race([fetchPromise, timeoutPromise]);
        if (!resp.ok) { failResult.status = "http_error"; return failResult; }

        const data = await resp.json();
        const feature = data?.features?.[0];
        if (!feature?.center) { failResult.status = "no_results"; return failResult; }

        return { lng: feature.center[0], lat: feature.center[1], placeName: feature.place_name || null, status: "ok", provider: "mapbox" };
      } catch (e) {
        console.warn("[geocodeAddress] failed:", e.message || e);
        failResult.status = (e.message === "timeout") ? "timeout" : "error";
        return failResult;
      }
    }

    async function ensureLatLng(listingId, address) {
      if (!listingId || !address) return false;
      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) return false;
        const d = snap.data() || {};

        const hasLat = typeof d.lat === "number" && !isNaN(d.lat);
        const hasLng = typeof d.lng === "number" && !isNaN(d.lng);
        if (hasLat && hasLng && d.geoStatus === "ok") return false;

        const geo = await geocodeAddress(address);
        const geoUpdate = { lat: geo.lat, lng: geo.lng, geoStatus: geo.status, geoProvider: geo.provider, updatedAt: serverTimestamp() };
        if (geo.placeName) geoUpdate.geoPlaceName = geo.placeName;
        if (geo.status === "ok") geoUpdate.geoUpdatedAt = serverTimestamp();
        await updateDoc(doc(db, "listings", listingId), geoUpdate);
        return geo.status === "ok";
      } catch (e) {
        console.warn("[Task E] ensureLatLng failed:", e);
        return false;
      }
    }

    // Paid upgrades processing moved into boot() for proper sequencing

    // utilities
    var $ = function(id) { return document.getElementById(id); };
    var getJSON = function(k, fb) { try { return JSON.parse(localStorage.getItem(k)) || fb; } catch(e) { return fb; } };
    var setJSON = function(k, v) { localStorage.setItem(k, JSON.stringify(v)); };
    var plural = function(n, a, b) { return (n===1 ? a : b); };

    // ===== Autosave UI =====
    function setAutosaveUI(state) {
      var dot = document.getElementById("autosaveDot");
      var txt = document.getElementById("autosaveText");
      if (!dot || !txt) return;

      if (state === "saving") {
        dot.style.background = "#f59e0b";
        txt.textContent = "Savingâ€¦";
      } else if (state === "saved") {
        dot.style.background = "#10b981";
        txt.textContent = "All changes saved";
      } else if (state === "error") {
        dot.style.background = "#ef4444";
        txt.textContent = "Save failed";
      } else if (state === "locked") {
        dot.style.background = "#ef4444";
        txt.textContent = "Locked";
      } else {
        dot.style.background = "#9ca3af";
        txt.textContent = "Waitingâ€¦";
      }
    }

    function debounce(fn, waitMs) {
      var t = null;
      return function() {
        var ctx = this, args = arguments;
        if (t) clearTimeout(t);
        t = setTimeout(function() { fn.apply(ctx, args); }, waitMs);
      };
    }

    function setStatus(msg, ok) {
      if (ok === undefined) ok = true;
      var el = document.getElementById("statusBar");
      if (!el) {
        el = document.createElement("p");
        el.id = "statusBar";
        el.className = "mt-2 text-sm";
        var main = document.querySelector('main');
        if (main && main.parentNode) main.parentNode.insertBefore(el, main);
      }
      el.textContent = msg || "";
      el.className = ok ? "max-w-6xl mx-auto px-3 mt-2 text-sm text-gray-600" : "max-w-6xl mx-auto px-3 mt-2 text-sm text-red-700";
    }

    // ===== SOLD LOCK =====
    var soldLocked = false;
    function checkSoldLock(statusValue) {
      var isSold = String(statusValue || "").trim().toLowerCase() === "sold";
      soldLocked = !!isSold;

      var banner = document.getElementById("soldLockBanner");
      if (banner) banner.classList.toggle("hidden", !isSold);

      if (!isSold) {
        if (!soldLocked) setAutosaveUI("waiting");
        return false;
      }

      // Disable all form controls
      var form = document.getElementById("sellerForm");
      if (form) {
        form.querySelectorAll("input, select, textarea, button").forEach(function(el){
          el.disabled = true;
        });
      }

      // Disable upgrades checkout button
      var goCheckoutBtn = document.getElementById("goCheckoutBtn");
      if (goCheckoutBtn) goCheckoutBtn.disabled = true;

      setAutosaveUI("locked");
      return true;
    }

    // ZIP helper (prefer end-of-string ZIP)
    function parseZipFromAddressEnd(addr) {
      var m = String(addr || "").match(/\b(\d{5})(?:-\d{4})?\s*$/);
      if (m && m[1]) return m[1];
      var m2 = String(addr || "").match(/\b(\d{5})(?:-\d{4})?\b/);
      return m2 ? m2[1] : "";
    }

    // Local pros / brokers helpers (kept)
    function parseZipFromAddress(addr) {
      addr = addr || "";
      var m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
      return m ? m[1] : "";
    }

    async function loadLocalPros(zip) {
      try {
        var q1 = query(collection(db, "localPros"), where("status", "==", "active"), where("zips", "array-contains", zip));
        var snap = await getDocs(q1);
        var all = [];
        snap.forEach(function(d) { all.push({ id: d.id, ...d.data() }); });
        var agents  = all.filter(function(p) { return String(p.role||"").toLowerCase()==="real_estate_agent"; }).slice(0,3);
        var lenders = all.filter(function(p) { return String(p.role||"").toLowerCase()==="lender"; }).slice(0,1);
        return { agents: agents, lenders: lenders };
      } catch (e) {
        console.warn("[pros] fetch failed:", e);
        return { agents: [], lenders: [] };
      }
    }

    function renderProsSidebar(zip, agents, lenders) {
      agents = agents || [];
      lenders = lenders || [];
      var card = $("prosSidebar");
      if (!card) return;

      var currentPlan = plan.trim();
      var isFSBO = currentPlan.includes("FSBO");
      if (!isFSBO) { card.style.display = "none"; return; }

      // Hide entire box if no results
      if (agents.length === 0 && lenders.length === 0) {
        card.style.display = "none";
        return;
      }

      $("prosZip").textContent = zip || "â€”";

      var list = $("prosList");
      list.innerHTML = "";

      function noImageFSBO(){
        var ph = document.createElement("div");
        ph.className = "w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
        ph.textContent = "No Image";
        return ph;
      }

      function tileFSBO(p){
        var div = document.createElement("div");
        div.className = "overflow-hidden bg-white rounded-lg shadow-sm";
        var src = p.photoUrl || p.photo || "";
        if (src) {
          var img = document.createElement("img");
          img.src = src;
          img.alt = "Local Professional";
          img.className = "w-full h-40 object-contain bg-white";
          img.onerror = function() { img.replaceWith(noImageFSBO()); };
          div.appendChild(img);
        } else {
          div.appendChild(noImageFSBO());
        }
        return div;
      }

      var tiles = [];
      agents.forEach(function(a) { tiles.push(tileFSBO(a)); });
      lenders.forEach(function(l) { tiles.push(tileFSBO(l)); });

      tiles.forEach(function(t) { list.appendChild(t); });
      card.style.display = "block";
    }

    async function loadLocalBroker(zip) {
      try {
        var q1 = query(collection(db, "localBrokers"), where("status","==","active"), where("zip","==", zip));
        var s1 = await getDocs(q1);
        if (!s1.empty) {
          var x = s1.docs[0].data() || {};
          return { id: s1.docs[0].id, ...x };
        }
        var q2 = query(collection(db, "localBrokers"), where("status","==","active"), where("zips","array-contains", zip));
        var s2 = await getDocs(q2);
        if (!s2.empty) {
          var x2 = s2.docs[0].data() || {};
          return { id: s2.docs[0].id, ...x2 };
        }
        return null;
      } catch (e) {
        console.warn("[broker] fetch failed:", e);
        return null;
      }
    }

    function renderBrokerStrip(zip, broker) {
      var strip = $("brokerStrip");
      if (!strip) return;

      var currentPlan = plan.trim();
      var isFSBO = currentPlan.includes("FSBO");
      if (!isFSBO) { strip.style.display = "none"; return; }

      // Hide entire box if no broker
      if (!broker || (!broker.photoUrl && !broker.name)) {
        strip.style.display = "none";
        return;
      }

      $("brokerZip").textContent = zip || "â€”";

      var ad = $("brokerAd");
      ad.innerHTML = "";

      var img = document.createElement("img");
      img.src = broker.photoUrl || "";
      img.alt = broker.name || "Local Brokerage";
      img.className = "max-h-44 object-contain";
      img.onerror = function() {
        var ph = document.createElement("div");
        ph.className = "w-full h-44 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
        ph.textContent = "No Logo";
        ad.appendChild(ph);
      };
      ad.appendChild(img);

      strip.style.display = "block";
    }

    // ========== LOCAL SERVICE PROVIDERS ==========
    async function loadLocalServiceProviders(zip) {
      try {
        var q1 = query(
          collection(db, "localServiceProviders"),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        var snap = await getDocs(q1);
        var results = [];
        snap.forEach(function(d) {
          var x = d.data() || {};
          results.push({
            id: d.id,
            name: x.name || "",
            company: x.company || "",
            role: x.role || "Service Provider",
            phone: x.phone || "",
            email: x.email || "",
            photoUrl: x.photoUrl || x.photo || x.cardUrl || ""
          });
        });

        // Deduplicate by id
        var seen = {};
        var dedup = [];
        for (var i = 0; i < results.length; i++) {
          var r = results[i];
          if (seen[r.id]) continue;
          seen[r.id] = true;
          dedup.push(r);
        }

        // Return up to 8
        return dedup.slice(0, 8);
      } catch (e) {
        console.warn("[local-service-providers] fetch failed:", e);
        return [];
      }
    }

    function renderServiceProvidersStrip(zip, providers) {
      var strip = $("serviceProvidersStrip");
      if (!strip) return;

      var currentPlan = plan.trim();
      var isFSBO = currentPlan.includes("FSBO");
      if (!isFSBO) { strip.style.display = "none"; return; }

      // Hide entire box if no providers
      if (!providers || providers.length === 0) {
        strip.style.display = "none";
        return;
      }

      $("serviceProvidersZip").textContent = zip || "â€”";

      var grid = $("serviceProvidersGrid");
      grid.innerHTML = "";

      providers.forEach(function(sp) {
        var card = document.createElement("div");
        card.className = "bg-gray-50 rounded-lg border border-gray-200 overflow-hidden";

        var photoSrc = sp.photoUrl || "";
        if (photoSrc) {
          var img = document.createElement("img");
          img.src = photoSrc;
          img.alt = sp.company || sp.name || "Service Provider";
          img.className = "w-full h-28 object-contain bg-white";
          img.onerror = function() {
            var ph = document.createElement("div");
            ph.className = "w-full h-28 bg-gray-100 flex items-center justify-center text-xs text-gray-500";
            ph.textContent = "No Image";
            img.replaceWith(ph);
          };
          card.appendChild(img);
        } else {
          var ph = document.createElement("div");
          ph.className = "w-full h-28 bg-gray-100 flex items-center justify-center text-xs text-gray-500";
          ph.textContent = "No Image";
          card.appendChild(ph);
        }

        var body = document.createElement("div");
        body.className = "p-2";
        body.innerHTML = 
          '<p class="font-semibold text-sm truncate">' + (sp.company || sp.name || "Service Provider") + '</p>' +
          '<p class="text-xs text-gray-600 truncate">' + (sp.role || "Service Provider") + '</p>' +
          (sp.phone ? '<p class="text-xs text-gray-500 mt-1">' + sp.phone + '</p>' : '');
        card.appendChild(body);

        grid.appendChild(card);
      });

      strip.style.display = "block";
    }

    // ID context
    function cleanId(raw) {
      var m = String(raw || "").trim().match(/^[A-Za-z0-9_-]+/);
      return m ? m[0] : "";
    }
    (function ensureId(){
      var u = new URL(location.href);
      var raw = u.searchParams.get("id") || localStorage.getItem("lastListingId") || "";
      var cleaned = cleanId(raw);
      if (cleaned) {
        localStorage.setItem("lastListingId", cleaned);
        if (raw !== cleaned) {
          u.searchParams.set("id", cleaned);
          history.replaceState({}, "", u.toString());
        }
      }
    })();

    var listingId = (localStorage.getItem("lastListingId") || "").trim();

    if ($("previewLink") && listingId) {
      $("previewLink").href = "/listing.html?id=" + encodeURIComponent(listingId);
    }

    // state
    var plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    var isFSBO = plan.includes("FSBO");
    var isPlus = (plan === "Listed Property Plus" || isFSBO);
    var maxPhotos = isPlus ? 20 : 1;

    var photos = [];
    var primaryIndex = 0;
    var paidUpgrades = {};
    var currentZipOnDoc = "";

    // ===== Local price/status tracking for history accuracy =====
    var __lastRenderedPrice = 0;   // set in refreshFromServer from Firestore
    var __lastRenderedStatus = "";  // set in refreshFromServer from Firestore

    function computePhotoHelp() {
      var remaining = Math.max(0, maxPhotos - (photos ? photos.length : 0));
      var el = $("photoHelp");
      if (el) {
        el.textContent = isPlus
          ? "You can add up to " + remaining + " more " + plural(remaining, "photo","photos") + "."
          : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
      }
    }

    function clampPrimary(){
      if (!Array.isArray(photos) || photos.length === 0) { primaryIndex = 0; return; }
      if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;
    }

    function renderThumbs(){
      clampPrimary();
      var grid = $("photoGrid");
      if (!grid) return;
      grid.innerHTML = "";

      if (!photos.length) {
        var p = document.createElement("div");
        p.className = "text-sm text-gray-600";
        p.textContent = "No photos yet.";
        grid.appendChild(p);
        computePhotoHelp();
        return;
      }

      var ordered = photos.map(function(u,i) { return {u:u,i:i}; });
      if (primaryIndex > 0) {
        var prim = ordered.splice(primaryIndex,1)[0];
        ordered.unshift(prim);
      }

      ordered.forEach(function(item){
        var u = item.u;
        var i = item.i;
        var row = document.createElement("div");
        row.className = "flex items-center gap-3";

        var img = new Image();
        img.src = u;
        img.alt = "Photo";
        img.className = "thumb border " + (i===primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (i===primaryIndex) ? "Primary photo" : "Click to set as primary";

        img.addEventListener("click", async function(){
          if (soldLocked) return;
          primaryIndex = i;
          await savePhotosField(true);
        });

        var btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        if (i===primaryIndex) {
          var badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "Primary";
          btns.appendChild(badge);
        } else {
          var bPrimary = document.createElement("button");
          bPrimary.type="button"; bPrimary.className="px-2 py-1 border rounded";
          bPrimary.textContent="Set Primary";
          bPrimary.onclick = async function(){
            if (soldLocked) return;
            primaryIndex = i; await savePhotosField(true);
          };
          btns.appendChild(bPrimary);
        }

        var bReplace = document.createElement("button");
        bReplace.type="button"; bReplace.className="px-2 py-1 border rounded";
        bReplace.textContent="Replace";
        bReplace.onclick = function(){
          if (soldLocked) return;
          var input = document.createElement("input");
          input.type="file"; input.accept="image/*";
          input.onchange = async function(e){
            var file = e.target.files ? e.target.files[0] : null; if (!file) return;
            setStatus("Uploading replacement...");
            try {
              var urlNew = await uploadOne(file);
              photos[i] = urlNew;
              await savePhotosField(true);
            } catch (err) {
              console.warn(err);
              setStatus("Could not replace photo.", false);
            }
          };
          input.click();
        };

        var bDelete = document.createElement("button");
        bDelete.type="button"; bDelete.className="px-2 py-1 border rounded";
        bDelete.textContent = "Delete";
        bDelete.onclick = async function(){
          if (soldLocked) return;
          if (!confirm("Remove this photo from the listing?")) return;
          photos.splice(i,1);
          if (primaryIndex >= photos.length) primaryIndex = Math.max(0, photos.length-1);
          await savePhotosField(true);
        };

        btns.appendChild(bReplace);
        btns.appendChild(bDelete);

        row.appendChild(img);
        row.appendChild(btns);
        grid.appendChild(row);
      });

      computePhotoHelp();
    }

    async function uploadOne(file){
      var storage = getStorage(undefined, STORAGE_BUCKET_GS);
      var safeName = String(file.name || "photo").replace(/[^\w\-.]+/g,"_");
      var path = "listings/" + listingId + "/photos/" + Date.now() + "_" + safeName;
      var r = ref(storage, path);
      await uploadBytes(r, file);
      var url = await getDownloadURL(r);
      return url;
    }

    async function savePhotosField(){
      if (!listingId) return;
      if (soldLocked) return;
      try {
        clampPrimary();
        await updateDoc(doc(db, "listings", listingId), {
          photos: photos.slice(0, maxPhotos),
          primaryIndex: (typeof primaryIndex === "number" ? primaryIndex : 0),
          updatedAt: serverTimestamp()
        });
        renderThumbs();
        computePhotoHelp();
        setStatus("Photos saved.", true);
      } catch (e) {
        console.warn("[seller] photos update failed", e);
        setStatus("Photos could not be saved.", false);
      }
    }

    var photoInput = $("photoInput");
    if (photoInput) {
      photoInput.addEventListener("change", async function(e){
        if (soldLocked) return;

        var files = Array.from(e.target.files || []);
        if (!files.length) return;

        try {
          var remaining = Math.max(0, maxPhotos - photos.length);
          if (remaining <= 0) {
            alert("You have reached the photo limit for your plan (" + maxPhotos + ").");
            e.target.value="";
            return;
          }
          var toUpload = files.slice(0, remaining);

          setStatus("Uploading photo(s)...");
          for (var idx = 0; idx < toUpload.length; idx++) {
            var f = toUpload[idx];
            try {
              var url = await uploadOne(f);
              photos.push(url);
            } catch (err) {
              console.warn("Upload failed", err);
              setStatus("Upload failed for one or more files.", false);
            }
          }
          await savePhotosField(true);
        } catch (err) {
          setStatus("Upload failed.", false);
        } finally {
          e.target.value = "";
        }
      });
    }

    // FIELD LOCKING LOGIC
    function applyFieldLocking(planName, paidUpgrades) {
      var isBasic = planName === "Listed Property Basic";
      paidUpgrades = paidUpgrades || {};

      var descEl = $("description");
      var descNote = $("descGateNote");
      if (isBasic) {
        if (descEl) { descEl.classList.add("dimmed"); descEl.setAttribute("disabled","disabled"); }
        if (descNote) descNote.classList.remove("hidden");
      } else {
        if (descEl) { descEl.classList.remove("dimmed"); descEl.removeAttribute("disabled"); }
        if (descNote) descNote.classList.add("hidden");
      }

      var bannerEl = $("bannerText");
      var bannerNote = $("bannerGateNote");
      var bannerUnlocked = !!paidUpgrades.banner;
      if (bannerUnlocked) {
        if (bannerEl) { bannerEl.classList.remove("dimmed"); bannerEl.removeAttribute("disabled"); }
        if (bannerNote) bannerNote.classList.add("hidden");
      } else {
        if (bannerEl) { bannerEl.classList.add("dimmed"); bannerEl.setAttribute("disabled","disabled"); }
        if (bannerNote) bannerNote.classList.remove("hidden");
      }

      var premiumEl = $("preferredArea");
      var premiumNote = $("premiumGateNote");
      var premiumUnlocked = !!paidUpgrades.premium || !!paidUpgrades.pin;
      if (premiumUnlocked) {
        if (premiumEl) { premiumEl.classList.remove("dimmed"); premiumEl.removeAttribute("disabled"); }
        if (premiumNote) premiumNote.classList.add("hidden");
      } else {
        if (premiumEl) { premiumEl.classList.add("dimmed"); premiumEl.setAttribute("disabled","disabled"); }
        if (premiumNote) premiumNote.classList.remove("hidden");
      }

      var pinEl = $("pinArea");
      var pinNote = $("pinGateNote");
      var pinUnlocked = !!paidUpgrades.pin;
      if (pinUnlocked) {
        if (pinEl) { pinEl.classList.remove("dimmed"); pinEl.removeAttribute("disabled"); }
        if (pinNote) pinNote.classList.add("hidden");
      } else {
        if (pinEl) { pinEl.classList.add("dimmed"); pinEl.setAttribute("disabled","disabled"); }
        if (pinNote) pinNote.classList.remove("hidden");
      }
    }

    // ===== Date/Time helper for history entries =====
    function getDateTimeParts() {
      var now = new Date();
      var date = (now.getMonth()+1) + "/" + now.getDate() + "/" + now.getFullYear();
      var h = now.getHours();
      var m = String(now.getMinutes()).padStart(2, "0");
      var ampm = h >= 12 ? "PM" : "AM";
      var h12 = h % 12 || 12;
      var time = h12 + ":" + m + " " + ampm;
      return { date: date, time: time };
    }

    function buildAutosavePayload() {
      var planNow = (localStorage.getItem("selectedPlan") || plan || "").trim();

      var payload = {
        updatedAt: serverTimestamp(),
        status: $("status").value || "",
        price: Number($("price").value || 0) || "",
        apn: $("apn").value || "",
        bedrooms: $("bedrooms").value || "",
        bathrooms: $("bathrooms").value || "",
        sqft: $("sqft").value || "",
        yearBuilt: $("yearBuilt").value || "",
        lotSize: $("lotSize").value || "",
        propertyType: $("propertyType").value || "",
        description: $("description").value || "",
        bannerText: $("bannerText").value || "",
        preferredArea: $("preferredArea").value || "",
        pinArea: $("pinArea").value || ""
      };

      if (!planNow.includes("FSBO")) {
        payload.brokerage = $("brokerage").value || "";
        payload.agentName = $("agentName").value || "";
        payload.agentEmail = $("agentEmail").value || "";
        payload.agentPhone = $("agentPhone").value || "";
      }

      if (!currentZipOnDoc) {
        var addr = ($("fullAddress")?.value || "").trim();
        var z = parseZipFromAddressEnd(addr);
        if (z) payload.zip = z;
      }

      return payload;
    }

    // ===== AUTOSAVE WITH HISTORY TRACKING =====
    async function doAutosave() {
      if (!listingId) return;
      if (soldLocked) return;
      if (checkSoldLock($("status")?.value)) return;

      // =========================================================================
      // SMART THRESHOLD: Prevent saving "junk" partial prices (e.g. "$2")
      // =========================================================================
      var activeEl = document.activeElement;
      if (activeEl && activeEl.id === "price") {
        var currentVal = Number(String(activeEl.value).replace(/[^0-9.]/g, '') || 0);
        if (currentVal < 10000) {
          console.log("[autosave] Skipping partial price input:", currentVal);
          return;
        }
      }

      setAutosaveUI("saving");
      try {
        var payload = buildAutosavePayload();

        // ===== HISTORY TRACKING: detect price/status changes =====
        var snap = await getDoc(doc(db, "listings", listingId));
        if (snap.exists()) {
          var oldData = snap.data() || {};
          var dt = getDateTimeParts();

          // --- Price History ---
          var firestoreOldPrice = Number(oldData.price) || 0;
          var effectiveOldPrice = firestoreOldPrice > 0 ? firestoreOldPrice : __lastRenderedPrice;
          var newPriceNum = Number(payload.price) || 0;

          console.log("[autosave] Price check â€” Firestore:", firestoreOldPrice, "| Local:", __lastRenderedPrice, "| Effective old:", effectiveOldPrice, "| New:", newPriceNum);

          if (newPriceNum > 0 && effectiveOldPrice !== newPriceNum) {
            if (!Array.isArray(oldData.priceHistory) || oldData.priceHistory.length === 0) {
              if (effectiveOldPrice > 0) {
                console.log("[autosave] Seeding priceHistory: Original", effectiveOldPrice, "â†’ Changed", newPriceNum);
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", price: effectiveOldPrice },
                  { date: dt.date, time: dt.time, label: "Changed", price: newPriceNum }
                );
              } else {
                console.log("[autosave] First price ever:", newPriceNum);
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", price: newPriceNum }
                );
              }
            } else {
              console.log("[autosave] Appending price change:", newPriceNum);
              payload.priceHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Changed", price: newPriceNum }
              );
            }
          }

          // --- Status History ---
          var firestoreOldStatus = String(oldData.status || "").trim();
          var effectiveOldStatus = firestoreOldStatus || __lastRenderedStatus;
          var newStatus = String(payload.status || "").trim();

          if (newStatus && effectiveOldStatus !== newStatus) {
            if (!Array.isArray(oldData.statusHistory) || oldData.statusHistory.length === 0) {
              if (effectiveOldStatus) {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: effectiveOldStatus },
                  { date: dt.date, time: dt.time, label: "Changed", status: newStatus }
                );
              } else {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: newStatus }
                );
              }
            } else {
              payload.statusHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Changed", status: newStatus }
              );
            }
          }
        }
        // ===== END HISTORY TRACKING =====

        await updateDoc(doc(db, "listings", listingId), payload);
        if (payload.zip) currentZipOnDoc = String(payload.zip);

        // Update local tracking after successful save
        var savedPrice = Number(payload.price) || 0;
        if (savedPrice > 0) __lastRenderedPrice = savedPrice;
        var savedStatus = String(payload.status || "").trim();
        if (savedStatus) __lastRenderedStatus = savedStatus;

        setAutosaveUI("saved");
        setTimeout(function(){ if (!soldLocked) setAutosaveUI("waiting"); }, 1800);
      } catch (e) {
        console.warn("[autosave] failed", e);
        setAutosaveUI("error");
        setTimeout(function(){ if (!soldLocked) setAutosaveUI("waiting"); }, 3000);
      }
    }

    var autosaveDebounced = debounce(doAutosave, 1500);

    function wireAutosaveListeners() {
      var form = document.getElementById("sellerForm");
      if (!form) return;

      var fields = form.querySelectorAll("input, select, textarea");
      fields.forEach(function(el) {
        var type = (el.getAttribute("type") || "").toLowerCase();
        if (type === "file") return;
        if (el.hasAttribute("readonly")) return;
        if (el.hasAttribute("disabled")) return;
        if (el.id === "commission" || el.id === "commissionType") return;

        el.addEventListener("input", function(){ autosaveDebounced(); });
        el.addEventListener("change", function(){ autosaveDebounced(); });
      });
    }

    async function refreshFromServer(note){
      if (!listingId) { setStatus("No listing selected (missing id).", false); return; }

      try {
        var snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) { setStatus("Listing not found on server.", false); return; }
        var d = snap.data() || {};

        plan = d.plan || plan;
        isFSBO = plan.includes("FSBO");
        isPlus = (plan === "Listed Property Plus" || isFSBO);
        maxPhotos = isPlus ? 20 : 1;

        paidUpgrades = d.paidUpgrades || {};
        currentZipOnDoc = String(d.zip || "");

        $("planPill").textContent = plan || "â€”";
        $("fullAddress").value = d.address || "";
        $("status").value = d.status || "";
        $("price").value = d.price != null ? d.price : "";

        // Track what Firestore has so doAutosave can compare accurately
        __lastRenderedPrice = Number(d.price) || 0;
        __lastRenderedStatus = String(d.status || "").trim();

        $("commission").value = d.commission != null ? d.commission : "";
        $("commissionType").value = d.commissionType || "%";
        $("apn").value = d.apn || "";
        $("bedrooms").value = d.bedrooms != null ? d.bedrooms : "";
        $("bathrooms").value = d.bathrooms != null ? d.bathrooms : "";
        $("sqft").value = d.sqft != null ? d.sqft : "";
        $("yearBuilt").value = d.yearBuilt != null ? d.yearBuilt : "";
        $("lotSize").value = d.lotSize != null ? d.lotSize : "";
        $("propertyType").value = d.propertyType || "";
        $("description").value = d.description || "";
        $("bannerText").value = d.bannerText || "";
        $("preferredArea").value = d.preferredArea || "";
        $("pinArea").value = d.pinArea || "";
        $("brokerage").value = d.brokerage || "";
        $("agentName").value = d.agentName || "";
        $("agentEmail").value = d.agentEmail || "";
        $("agentPhone").value = d.agentPhone || "";

        if (plan.includes("FSBO")) {
          var block = $("listedBlock");
          if (block) block.style.display = "none";
        } else {
          var block2 = $("listedBlock");
          if (block2) block2.style.display = "block";
        }

        photos = Array.isArray(d.photos) ? d.photos.slice(0, maxPhotos) : [];
        primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;

        applyFieldLocking(plan, paidUpgrades);
        renderUpgradesBox(d);

        renderThumbs();
        setStatus(note || "Loaded from server.", true);

        ensureLatLng(listingId, d.address);

        try {
          var zip = d.zip || parseZipFromAddress($("fullAddress").value || "");
          if (zip) {
            var prosData = await loadLocalPros(zip);
            renderProsSidebar(zip, prosData.agents, prosData.lenders);

            var broker = await loadLocalBroker(zip);
            renderBrokerStrip(zip, broker);

            // Load and render Local Service Providers
            var serviceProviders = await loadLocalServiceProviders(zip);
            renderServiceProvidersStrip(zip, serviceProviders);
          }
        } catch (e) {
          console.warn("[local-pros] sidebar/strip skipped:", e);
        }

        checkSoldLock(d.status);

        if (!soldLocked) setAutosaveUI("waiting");
      } catch (e) {
        console.warn("[seller] load failed", e);
        setStatus("Could not load from server.", false);
        if (!soldLocked) setAutosaveUI("error");
      }
    }

    // ===== SOLD MODAL: intercept status change to "Sold" =====
    var preSoldStatus = "";

    $("status")?.addEventListener("change", function(){
      var val = String($("status")?.value || "").trim();

      if (val.toLowerCase() === "sold") {
        // Store previous status for Cancel revert
        preSoldStatus = String(window.__preSoldStatus || "Active");
        window.__preSoldStatus = preSoldStatus;

        // Pre-fill sold date with today
        var sdEl = document.getElementById("soldDate");
        if (sdEl && !sdEl.value) {
          var today = new Date();
          var yyyy = today.getFullYear();
          var mm = String(today.getMonth() + 1).padStart(2, "0");
          var dd = String(today.getDate()).padStart(2, "0");
          sdEl.value = yyyy + "-" + mm + "-" + dd;
        }

        // Pre-fill sold price with current listing price
        var spEl = document.getElementById("soldPrice");
        var curPrice = $("price")?.value;
        if (spEl && !spEl.value && curPrice) spEl.value = curPrice;

        openSoldModal();
        return;
      }

      // Track previous status for next time
      window.__preSoldStatus = val;
      checkSoldLock(val);
      autosaveDebounced();
    });

    // Track initial status after load
    setTimeout(function(){
      var initStatus = $("status")?.value || "";
      if (initStatus && initStatus.toLowerCase() !== "sold") {
        window.__preSoldStatus = initStatus;
      }
    }, 2000);

    // ===== commitSold(): saves sold details + history, then locks =====
    async function commitSold() {
      var soldPriceEl = document.getElementById("soldPrice");
      var soldDateEl = document.getElementById("soldDate");

      var soldPriceVal = Number(soldPriceEl?.value || 0);
      var soldDateVal = (soldDateEl?.value || "").trim();

      if (!soldPriceVal || soldPriceVal <= 0) {
        alert("Please enter the final sold price.");
        if (soldPriceEl) soldPriceEl.focus();
        return;
      }
      if (!soldDateVal) {
        alert("Please enter the closing date.");
        if (soldDateEl) soldDateEl.focus();
        return;
      }

      if (!listingId) return;

      setAutosaveUI("saving");
      try {
        var payload = buildAutosavePayload();
        payload.status = "Sold";
        payload.soldPrice = soldPriceVal;
        payload.soldDate = soldDateVal;
        payload.updatedAt = serverTimestamp();

        // ===== Status History: record transition to Sold =====
        var snap = await getDoc(doc(db, "listings", listingId));
        if (snap.exists()) {
          var oldData = snap.data() || {};
          var dt = getDateTimeParts();

          var oldStatus = String(oldData.status || "").trim();
          if (oldStatus !== "Sold") {
            if (!Array.isArray(oldData.statusHistory) || oldData.statusHistory.length === 0) {
              if (oldStatus) {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: oldStatus },
                  { date: dt.date, time: dt.time, label: "Changed", status: "Sold" }
                );
              } else {
                payload.statusHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", status: "Sold" }
                );
              }
            } else {
              payload.statusHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Changed", status: "Sold" }
              );
            }
          }

          // ===== Price History: record sold price if different =====
          var oldPriceNum = Number(oldData.price) || 0;
          var effectiveOldPriceSold = oldPriceNum > 0 ? oldPriceNum : __lastRenderedPrice;
          if (soldPriceVal > 0 && effectiveOldPriceSold !== soldPriceVal) {
            if (!Array.isArray(oldData.priceHistory) || oldData.priceHistory.length === 0) {
              if (effectiveOldPriceSold > 0) {
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Original", price: effectiveOldPriceSold },
                  { date: dt.date, time: dt.time, label: "Sold", price: soldPriceVal }
                );
              } else {
                payload.priceHistory = arrayUnion(
                  { date: dt.date, time: dt.time, label: "Sold", price: soldPriceVal }
                );
              }
            } else {
              payload.priceHistory = arrayUnion(
                { date: dt.date, time: dt.time, label: "Sold", price: soldPriceVal }
              );
            }
          }
        }

        await updateDoc(doc(db, "listings", listingId), payload);

        // Close modal, lock the page
        document.getElementById("soldDetailsModal").classList.add("hidden");
        checkSoldLock("Sold");
        setAutosaveUI("locked");
        setStatus("Listing marked as SOLD. Locked.", true);

      } catch (e) {
        console.warn("[commitSold] failed", e);
        setAutosaveUI("error");
        setStatus("Could not save sold details.", false);
        setTimeout(function(){ if (!soldLocked) setAutosaveUI("waiting"); }, 3000);
      }
    }

    // Wire the Confirm Sold button
    (function wireSoldBtn(){
      var btn = document.getElementById("confirmSoldBtn");
      if (btn) btn.addEventListener("click", commitSold);
    })();

    function renderUpgradesBox(listingData) {
      var checkoutData = getJSON("checkoutData", null) || {};

      var currentPlan = (listingData.plan || plan || "Listed Property Basic").trim();
      var isFSBONow = currentPlan.includes("FSBO");
      var isPlusNow = currentPlan === "Listed Property Plus";
      var isBasicNow = currentPlan === "Listed Property Basic";

      var paidUpgradesNow = listingData.paidUpgrades || {};
      var agentUpgradesNow = listingData.agentUpgrades || {};

      function isAgentPaid(k) {
        return agentUpgradesNow[k] === true || String(paidUpgradesNow[k]).toLowerCase() === "agent";
      }
      function isSellerPaid(k) {
        return !!paidUpgradesNow[k] && String(paidUpgradesNow[k]).toLowerCase() !== "agent";
      }

      function row(label, price, key, sellerPaid, description, agentPaid) {
        var isPaid = sellerPaid || agentPaid;
        var checked = isPaid || !!(checkoutData.upgrades && checkoutData.upgrades[key]);
        var disabled = isPaid ? "disabled" : "";
        var grayedClass = isPaid ? "bg-gray-100 opacity-60" : "";
        var paidLabel = "";
        if (agentPaid) {
          paidLabel = "<span class=\"text-[10px] text-green-600 font-bold ml-2\">Upgraded by Agent</span>";
        } else if (sellerPaid) {
          paidLabel = "<span class=\"text-[10px] text-green-600 font-bold ml-2\">Paid</span>";
        }
        var desc = description ? "<div class=\"text-xs text-gray-500\">" + description + "</div>" : "";

        var inputId = (key === "changeCommission") ? "changeCommissionChk" : "";

        return "<label class=\"flex items-center justify-between border rounded-lg px-3 py-2 " + grayedClass + "\">" +
          "<div>" +
            "<span class=\"font-medium\">" + label + "</span>" +
            "<span class=\"text-gray-500\"> - $" + price + "</span>" +
            paidLabel + desc +
          "</div>" +
          "<input type=\"checkbox\" id=\"" + inputId + "\" data-key=\"" + key + "\" class=\"h-4 w-4\" " +
            (checked?"checked":"") + " " + disabled + "/>" +
        "</label>";
      }

      var box = $("upgradesBox");
      if (!box) return;

      var upgrades = [];

      var sPlus = isSellerPaid("upgradeToPlus");
      var aPlus = isAgentPaid("upgradeToPlus");
      if (isBasicNow) upgrades.push(row("Listed Property Plus", 20, "upgradeToPlus", sPlus, "20 photos + full property description", aPlus));
      if (isPlusNow) upgrades.push(row("Listed Property Plus", 20, "upgradeToPlus", !aPlus, "", aPlus));

      upgrades.push(row("Banner", 10, "banner", isSellerPaid("banner"), "", isAgentPaid("banner")));
      upgrades.push(row("Premium Placement", 10, "premium", isSellerPaid("premium"), "", isAgentPaid("premium")));
      upgrades.push(row("Pin Placement", 50, "pin", isSellerPaid("pin"), "", isAgentPaid("pin")));

      if (isFSBONow) {
        upgrades.push(row("Confidential FSBO Upgrade", 100, "confidential", isSellerPaid("confidential"), "", isAgentPaid("confidential")));
        upgrades.push(row("Change Commission", 50, "changeCommission", false, "", false));
      } else {
        upgrades.push(row("Change Commission", 10, "changeCommission", false, "", false));
      }

      box.innerHTML = upgrades.join("");

      var cc = document.getElementById("changeCommissionChk");
      if (cc) {
        cc.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (soldLocked || checkSoldLock($("status")?.value)) {
            alert("This listing is SOLD and locked. Upgrades are disabled.");
            return;
          }
          openChangeCommissionModal();
        });
      }

      var inputs = box.querySelectorAll('input[type="checkbox"]');
      for (var i = 0; i < inputs.length; i++) {
        var el = inputs[i];
        var k = el.getAttribute("data-key");
        if (!k) continue;
        if (k === "changeCommission") continue;
        if (el.disabled) continue;

        el.addEventListener("change", function(e) {
          if (soldLocked || checkSoldLock($("status")?.value)) {
            e.target.checked = false;
            alert("This listing is SOLD and locked. Upgrades are disabled.");
            return;
          }

          var key = e.target.getAttribute("data-key");
          var checked = !!e.target.checked;

          var cd = getJSON("checkoutData", {}) || {};
          cd.upgrades = cd.upgrades || {};
          cd.meta = cd.meta || {};
          cd.meta.fromSellerDetail = true;

          if (key === "upgradeToPlus") cd.upgrades.upgradeToPlus = checked;
          if (key === "banner") cd.upgrades.banner = checked;

          if (key === "premium") {
            cd.upgrades.premium = checked && !cd.upgrades.pin;
          }
          if (key === "pin") {
            cd.upgrades.pin = checked;
            if (checked) cd.upgrades.premium = true;
          }

          if (key === "confidential") cd.upgrades.confidential = checked;

          setJSON("checkoutData", cd);
        });
      }

      var checkoutBtn = $("goCheckoutBtn");
      if (checkoutBtn && !checkoutBtn.dataset.wired) {
        checkoutBtn.dataset.wired = "true";
        checkoutBtn.addEventListener("click", function() {
          if (soldLocked || checkSoldLock($("status")?.value)) {
            alert("This listing is SOLD and locked. Upgrades are disabled.");
            return;
          }
          var cd = getJSON("checkoutData", {}) || {};
          cd.meta = cd.meta || {};
          cd.meta.fromSellerDetail = true;
          setJSON("checkoutData", cd);
          window.location.href = "/checkout.html";
        });
      }
    }

    (function wireConfirmCommissionOnce() {
      var btn = document.getElementById("confirmCommissionBtn");
      if (!btn) return;

      btn.addEventListener("click", function() {
        if (soldLocked || checkSoldLock(document.getElementById("status")?.value)) {
          alert("This listing is SOLD and locked. It cannot be edited.");
          closeChangeCommissionModal();
          return;
        }

        var newComm = (document.getElementById("newCommission")?.value || "").trim();
        var newType = (document.getElementById("newCommissionType")?.value || "%").trim();

        if (!newComm) {
          alert("Please enter a commission amount.");
          return;
        }

        var lid = (localStorage.getItem("lastListingId") || "").trim();
        if (!lid) {
          alert("Missing listing ID. Please open this listing from Welcome (Edit) so the ID is set.");
          return;
        }

        var cd = getJSON("checkoutData", {}) || {};
        cd.upgrades = cd.upgrades || {};
        cd.meta = cd.meta || {};

        cd.upgrades.changeCommission = true;
        cd.meta.fromChangeCommission = true;
        cd.meta.fromSellerDetail = true;
        cd.meta.newCommission = newComm;
        cd.meta.newCommissionType = newType;

        cd.payer = "seller";

        setJSON("checkoutData", cd);

        closeChangeCommissionModal();
        window.location.href = "/checkout.html";
      });
    })();

    // Boot
    (async function boot(){
      var who = (localStorage.getItem("loggedInEmail") || "").trim();
      $("whoLine").textContent = who ? "Logged in as " + who : "";

      var formData = getJSON("formData", {});
      if (formData.address && !$("fullAddress").value) $("fullAddress").value = formData.address;

      // Process paid upgrades FIRST (before fetching data)
      try {
        const result = await updatePaidUpgradesAfterPayment();
        if (result?.processed) console.log('[seller-detail] Upgrades processed successfully');
      } catch (e) {
        console.warn('[seller-detail] paid-upgrades-handler failed:', e);
      }

      await refreshFromServer();

      computePhotoHelp();
      wireAutosaveListeners();
      if (!soldLocked) setAutosaveUI("waiting");
    })();
  </script>
<script src="/scripts/global-nav.js"></script>
</body>
</html>
</body>
</html>
