<!DOCTYPE html>
<!-- checkout.html - Review cart and proceed to Stripe -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Review & Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="text-xs hover:underline" style="color:#4DA6FF;">Home</a>
      <div class="text-center">
        <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      </div>
      <a href="/advertise.html" class="text-xs hover:underline" style="color:#4DA6FF;">Advertise</a>
    </div>
  </header>

  <div class="max-w-3xl mx-auto mt-6 bg-white p-6 rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Review Your Order</h2>

    <div id="errorBox" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-900 mb-4">
      <p class="font-semibold">Error</p>
      <p class="text-sm mt-1" id="errorMsg">Unable to load checkout data.</p>
      <div class="mt-3">
        <a href="/index.html" class="inline-block px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Return Home</a>
      </div>
    </div>

    <div id="reviewBox" class="hidden">
      <!-- Base Plan -->
      <div class="mb-6">
        <h3 class="font-semibold text-lg mb-2">Plan</h3>
        <div class="bg-gray-50 p-4 rounded border">
          <div class="flex justify-between items-center">
            <span id="planName" class="font-medium"></span>
            <span id="planPrice" class="font-semibold"></span>
          </div>
        </div>
      </div>

      <!-- Upgrades -->
      <div id="upgradesSection" class="hidden mb-6">
        <h3 class="font-semibold text-lg mb-2">Upgrades</h3>
        <div id="upgradesList" class="bg-gray-50 p-4 rounded border space-y-2"></div>
      </div>

      <!-- Total -->
      <div class="border-t pt-4 mb-6">
        <div class="flex justify-between items-center text-xl font-bold">
          <span>Total</span>
          <span id="totalPrice"></span>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex justify-between">
        <button id="btnBack" class="px-6 py-2 rounded border border-gray-300 hover:bg-gray-50">
          Back
        </button>
        <button id="btnCheckout" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
          Proceed to Checkout
        </button>
      </div>

      <!-- Processing State -->
      <div id="processingBox" class="hidden mt-6 text-center">
        <div class="animate-pulse">
          <svg class="mx-auto h-12 w-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          <p class="mt-2 font-semibold">Redirecting to secure checkout...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb) => { 
      try { return JSON.parse(localStorage.getItem(k)) ?? fb; } 
      catch { return fb; } 
    };

    // Stripe publishable key
    const STRIPE_PK = "pk_test_51QSAS5P3z9edGxAeILLtT7kz9YEt6HZ3SdePLTI6Q1K36tfOmElNcuPSZZqOsK4UvnkrvK5GZ85T7bV3pIm05yrF00Y1VmWdgm";

    (async function initReview() {
      try {
        const checkoutData = getJSON("checkoutData", {});
        
        if (!checkoutData || !checkoutData.plan) {
          throw new Error("No checkout data found");
        }

        console.log("[checkout] Loading data:", checkoutData);

        // Get listing ID
        const listingId = (localStorage.getItem("lastListingId") || "").trim();
        if (!listingId) {
          throw new Error("No listing ID found");
        }

        // Get base price (support both 'base' and 'basePrice' properties)
        const base = (typeof checkoutData.base === "number")
          ? checkoutData.base
          : (typeof checkoutData.basePrice === "number" ? checkoutData.basePrice : 0);

        // Display plan
        $("planName").textContent = checkoutData.plan;
        $("planPrice").textContent = `$${base.toFixed(2)}`;

        let total = base;

        // Display upgrades
        if (checkoutData.upgrades && Object.keys(checkoutData.upgrades).some(k => checkoutData.upgrades[k])) {
          const upgradeMap = {
            banner: { name: "Banner Upgrade", price: 10 },
            premium: { name: "Premium Placement", price: 10 },
            pin: { name: "Pin Placement", price: 50 },
            confidential: { name: "Confidential FSBO Upgrade", price: 100 },
            upgradeToPlus: { name: "Upgrade to Plus", price: 20 },
            changeCommission: { 
              name: "Change Commission", 
              price: 10
            }
          };

          const upgradesHTML = [];
          for (const [key, details] of Object.entries(upgradeMap)) {
            if (checkoutData.upgrades[key]) {
              upgradesHTML.push(`
                <div class="flex justify-between items-center">
                  <span>${details.name}</span>
                  <span class="font-semibold">$${details.price.toFixed(2)}</span>
                </div>
              `);
              total += details.price;
            }
          }

          if (upgradesHTML.length > 0) {
            $("upgradesSection").classList.remove("hidden");
            $("upgradesList").innerHTML = upgradesHTML.join("");
          }
        }

        // Display total
        $("totalPrice").textContent = `$${total.toFixed(2)}`;

        // Show review box
        $("reviewBox").classList.remove("hidden");

        // Back button
        $("btnBack").addEventListener("click", () => {
          window.history.back();
        });

        // Checkout button
        $("btnCheckout").addEventListener("click", async () => {
          try {
            $("btnCheckout").disabled = true;
            $("processingBox").classList.remove("hidden");

            // Build line items for Stripe
            const lineItems = [];

            // Get base price (support both 'base' and 'basePrice' properties)
            const base = (typeof checkoutData.base === "number")
              ? checkoutData.base
              : (typeof checkoutData.basePrice === "number" ? checkoutData.basePrice : 0);

            // Base plan
            if (checkoutData.plan && base) {
              lineItems.push({
                price_data: {
                  currency: "usd",
                  product_data: {
                    name: checkoutData.plan,
                    description: "Base listing plan"
                  },
                  unit_amount: Math.round(base * 100)
                },
                quantity: 1
              });
            }

            // Upgrades
            if (checkoutData.upgrades) {
              const upgradeMap = {
                banner: { name: "Banner Upgrade", price: 10 },
                premium: { name: "Premium Placement", price: 10 },
                pin: { name: "Pin Placement", price: 50 },
                confidential: { name: "Confidential FSBO Upgrade", price: 100 },
                upgradeToPlus: { name: "Upgrade to Plus", price: 20 },
                changeCommission: { 
                  name: "Change Commission", 
                  price: 10
                }
              };

              for (const [key, details] of Object.entries(upgradeMap)) {
                if (checkoutData.upgrades[key]) {
                  lineItems.push({
                    price_data: {
                      currency: "usd",
                      product_data: {
                        name: details.name,
                        description: `${key} upgrade`
                      },
                      unit_amount: Math.round(details.price * 100)
                    },
                    quantity: 1
                  });
                }
              }
            }

            if (lineItems.length === 0) {
              throw new Error("No items to charge");
            }

            console.log("[checkout] Creating session with items:", lineItems);

            // Create Stripe checkout session via backend
            const response = await fetch("https://us-central1-guaranteedcommission-a1f47.cloudfunctions.net/createCheckoutSession", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                lineItems,
                listingId,
                checkoutData,
                successUrl: `${window.location.origin}/signature.html?id=${encodeURIComponent(listingId)}&session_id={CHECKOUT_SESSION_ID}`,
                cancelUrl: `${window.location.origin}/upsell.html?id=${encodeURIComponent(listingId)}`
              })
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Server error: ${errorText}`);
            }

            const { sessionId } = await response.json();
            
            if (!sessionId) {
              throw new Error("No session ID returned from server");
            }

            console.log("[checkout] Session created:", sessionId);

            // Store payment intent in Firestore for tracking
            try {
              await addDoc(collection(db, "payments"), {
                listingId,
                sessionId,
                amount: total,
                currency: "usd",
                status: "pending",
                checkoutData,
                createdAt: serverTimestamp()
              });
              console.log("[checkout] Payment intent logged to Firestore");
            } catch (e) {
              console.warn("[checkout] Failed to log payment intent:", e);
            }

            // Redirect to Stripe
            const stripe = Stripe(STRIPE_PK);
            const { error } = await stripe.redirectToCheckout({ sessionId });

            if (error) {
              throw new Error(error.message);
            }

          } catch (e) {
            console.error("[checkout] Checkout error:", e);
            $("processingBox").classList.add("hidden");
            $("btnCheckout").disabled = false;
            $("errorBox").classList.remove("hidden");
            $("errorMsg").textContent = e.message || "Unable to process checkout";
          }
        });

      } catch (e) {
        console.error("[checkout] Review error:", e);
        $("errorBox").classList.remove("hidden");
        $("errorMsg").textContent = e.message || "Unable to load checkout data";
      }
    })();
  </script>

</body>
</html>
