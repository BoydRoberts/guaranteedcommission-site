<!DOCTYPE html>
<!-- Build: 2026-01-16 (Welcome: multi-role aware; Local Brokers ZIP overflow fix applied correctly) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Helps prevent long dropdown text from breaking layout (browser support varies for <option>) */
    select.truncate-option { max-width: 100%; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header (matches home/search/listing) -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

        <div class="text-center">
          <div class="flex items-end justify-center gap-0">
            <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
            <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
          <a href="/search.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Search</a>
          <button id="logoutBtn" class="text-sm px-3 py-1 rounded border hover:bg-gray-50">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-1">Welcome <span id="who">there</span></h2>
      <p class="text-sm text-gray-600 mb-4">What would you like to do next?</p>

      <!-- Optional role summary (hidden by default) -->
      <p id="roleSummary" class="hidden text-xs text-gray-500 mb-4"></p>

      <div id="blocksHost" class="space-y-4">

        <!-- ======================
             SELLER: Enter new listing (SELLERS ONLY)
             ====================== -->
        <div id="blkSellerNew" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Enter a new listing</h3>
          <div class="flex items-center gap-2 flex-wrap">
            <label class="text-sm">Plan</label>
            <select id="sellerNewPlan" class="border rounded px-2 py-1 text-sm">
              <option>Listed Property Basic</option>
              <option>Listed Property Plus</option>
              <option>FSBO Plus</option>
            </select>
            <button id="sellerNewGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Continue</button>
          </div>
        </div>

        <!-- ======================
             SELLER: Edit listing as Seller (SELLERS ONLY)
             ====================== -->
        <div id="blkSellerEdit" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Edit a current listing</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="sellerListings" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your listing…</option>
            </select>
            <div class="flex gap-2">
              <button id="sellerEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <a id="sellerPreview" class="px-3 py-2 rounded border text-sm hover:bg-gray-50" href="#" target="_blank" rel="noopener">Preview</a>
            </div>
          </div>
          <p id="sellerNoListings" class="hidden text-sm text-gray-700 mt-2">No seller listings found for your account.</p>
          <p class="text-[11px] text-gray-500 mt-2">
            Seller edit = seller intake (commission locked; commission change is a paid flow).
          </p>
        </div>

        <!-- ======================
             AGENT: Edit listing as Agent (AGENTS ONLY)
             ====================== -->
        <div id="blkAgentEdit" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Edit a current listing (as Agent)</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="agentListings" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your listing…</option>
            </select>
            <div class="flex gap-2">
              <button id="agentEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <a id="agentPreview" class="px-3 py-2 rounded border text-sm hover:bg-gray-50" href="#" target="_blank" rel="noopener">Preview</a>
            </div>
          </div>
          <p id="agentNoListings" class="hidden text-sm text-gray-700 mt-2">No agent listings found for your account.</p>
          <p class="text-[11px] text-gray-500 mt-2">
            Agent edit = agent intake (commission locked; agents can apply free upgrades per promo rules).
          </p>
        </div>

        <!-- ======================
             SEARCH (SELLERS + AGENTS)
             ====================== -->
        <div id="blkSearch" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Search Guaranteed Commissions</h3>
          <button id="searchGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Open Search with filters</button>
        </div>

        <!-- ======================
             SAVED SEARCHES / AUTO NOTIFICATIONS (SELLERS + AGENTS)
             ====================== -->
        <div id="blkSavedSearches" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">View / edit a current saved search or auto notification</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="savedSearches" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select a saved search…</option>
            </select>
            <div class="flex gap-2">
              <button id="savedEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <button id="savedDeleteGo" class="px-3 py-2 rounded border text-sm hover:bg-gray-50">Delete</button>
            </div>
          </div>
          <p id="noSavedSearches" class="hidden text-sm text-gray-700 mt-2">No saved searches found.</p>
        </div>

        <!-- ======================
             LOCAL PROFESSIONALS (shown for agents, or users with profiles)
             UI only for now
             ====================== -->
        <div id="blkLocalPros" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Local Professionals</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="proProfiles" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your Local Professional profile…</option>
            </select>
            <div class="flex gap-2">
              <a id="proManageBtn" class="px-3 py-2 rounded text-white text-sm text-center" style="background:#4DA6FF;" href="/local-professionals.html?mode=search">Manage</a>
              <a id="proApplyBtn" class="px-3 py-2 rounded border text-sm hover:bg-gray-50 text-center" href="/local-professionals.html?mode=apply">Add / Apply</a>
            </div>
          </div>
          <p id="noProProfiles" class="hidden text-sm text-gray-700 mt-2">No Local Professional profiles found.</p>
          <p class="text-[11px] text-gray-500 mt-2">($5/month per ZIP — UI only here for now)</p>
        </div>

        <!-- ======================
             LOCAL BROKERS (shown for agents, or users with profiles)
             UI only for now
             ====================== -->
        <div id="blkLocalBrokers" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Local Brokers</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <!-- ✅ FIX: add truncate-option class -->
            <select id="brokerProfiles" class="border rounded px-2 py-2 text-sm grow truncate-option">
              <option value="">Select your Local Broker profile…</option>
            </select>
            <div class="flex gap-2">
              <a id="brokerManageBtn" class="px-3 py-2 rounded text-white text-sm text-center" style="background:#4DA6FF;" href="/local-brokers.html?mode=search">Manage</a>
              <a id="brokerApplyBtn" class="px-3 py-2 rounded border text-sm hover:bg-gray-50 text-center" href="/local-brokers.html?mode=apply">Add / Apply</a>
            </div>
          </div>
          <p id="noBrokerProfiles" class="hidden text-sm text-gray-700 mt-2">No Local Broker profiles found.</p>
          <p class="text-[11px] text-gray-500 mt-2">(One broker per ZIP — ~$99/month per ZIP — UI only here for now)</p>
        </div>

      </div>
    </section>

    <!-- Unified listings table (permission-gated links) -->
    <section id="listSection" class="mt-6 bg-white rounded-2xl shadow p-6 hidden">
      <h3 class="font-semibold mb-2">Your listings</h3>
      <div id="listingsTable" class="text-sm text-gray-800"></div>
    </section>
  </main>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, getDocs, query, where, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const norm = (s)=>String(s||'').trim().toLowerCase();

    const emailRaw = (localStorage.getItem('loggedInEmail') || localStorage.getItem('verifyTarget') || '').trim();
    const emailLower = norm(emailRaw);
    $("who").textContent = emailRaw || 'there';

    // Logout
    $("logoutBtn")?.addEventListener('click', () => {
      try {
        ['isLoggedIn','loggedInEmail','userRole','verificationCode','verifyTarget','nextAfterLogin','nextAfterVerify','lastListingId','lastListingAddress']
          .forEach(k=>localStorage.removeItem(k));
      } catch {}
      location.href = '/index.html';
    });

    // Seller new listing
    $("sellerNewGo")?.addEventListener('click', ()=> {
      const plan = $("sellerNewPlan").value;
      localStorage.setItem('selectedPlan', plan);
      location.href = '/index.html#strip2Search';
      window.scrollTo(0,0);
    });

    // Search button (single listener)
    $("searchGo")?.addEventListener('click', ()=> location.href='/search.html?open=filters&prompt=save');

    // Saved searches (localStorage)
    function getSavedSearches() {
      try { return JSON.parse(localStorage.getItem('savedSearches') || '[]'); }
      catch { return []; }
    }
    function setSavedSearches(arr) {
      try { localStorage.setItem('savedSearches', JSON.stringify(arr || [])); }
      catch {}
    }
    function fillSavedSearchDropdown(selectEl, list) {
      selectEl.innerHTML = `<option value="">Select a saved search…</option>`;

      const searches   = list.filter(s => !String(s.name||'').startsWith('Auto-Email:') && !String(s.name||'').startsWith('Auto-Text:'));
      const autoEmails = list.filter(s =>  String(s.name||'').startsWith('Auto-Email:'));
      const autoTexts  = list.filter(s =>  String(s.name||'').startsWith('Auto-Text:'));

      function addGroup(label, arr, stripPrefix) {
        if (!arr.length) return;
        const grp = document.createElement('optgroup');
        grp.label = label;
        arr.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = stripPrefix ? String(s.name||'').replace(stripPrefix, '') : (s.name || '(unnamed)');
          grp.appendChild(opt);
        });
        selectEl.appendChild(grp);
      }

      addGroup('Saved Searches', searches, '');
      addGroup('Auto-Email Notifications', autoEmails, 'Auto-Email: ');
      addGroup('Auto-Text Notifications', autoTexts, 'Auto-Text: ');

      if (list.length) selectEl.value = list[0].id;
    }

    function wireSavedSearchControls() {
      const selectEl = $('savedSearches');
      const editBtn = $('savedEditGo');
      const deleteBtn = $('savedDeleteGo');
      if (!selectEl) return;

      editBtn?.addEventListener('click', () => {
        const list = getSavedSearches(); // fresh
        const id = selectEl.value;
        const saved = list.find(s => s.id === id);
        if (!saved) { alert('Please select a saved search first.'); return; }

        if (saved.q) localStorage.setItem('lastSearch', saved.q);
        else localStorage.removeItem('lastSearch');

        if (saved.filters) localStorage.setItem('lastFilters', JSON.stringify(saved.filters));
        else localStorage.removeItem('lastFilters');

        location.href = '/search.html';
      });

      deleteBtn?.addEventListener('click', () => {
        const list = getSavedSearches(); // fresh
        const id = selectEl.value;
        if (!id) { alert('Please select a saved search first.'); return; }
        if (!confirm('Delete this saved search?')) return;

        setSavedSearches(list.filter(s => s.id !== id));
        location.reload();
      });
    }

    // Sorting helper
    function tsMillis(x) {
      try {
        if (!x) return 0;
        if (typeof x.toMillis === "function") return x.toMillis();
        if (typeof x.toDate === "function") return x.toDate().getTime();
        if (typeof x === "number") return x;
        return 0;
      } catch { return 0; }
    }

    // Listings fetch (seller + agent roles)
    async function fetchMyLists() {
      if (!db) return { owner: [], agent: [], all: [] };

      const owner = [], agent = [];
      const lastLid = (localStorage.getItem('lastListingId') || '').trim();

      function upsert(list, id, data) {
        if (!id) return;
        if (!list.some(x => x.id === id)) list.push({ id, ...data });
      }

      if (emailLower) {
        try {
          const q1 = query(collection(db, "listings"), where("ownerEmailLower", "==", emailLower), limit(50));
          (await getDocs(q1)).forEach(d => upsert(owner, d.id, d.data()));
        } catch {}

        try {
          const q2 = query(collection(db, "listings"), where("agentEmailLower", "==", emailLower), limit(50));
          (await getDocs(q2)).forEach(d => upsert(agent, d.id, d.data()));
        } catch {}

        // Legacy fallback
        try {
          const q1b = query(collection(db, "listings"), where("ownerEmail", "==", emailLower), limit(50));
          (await getDocs(q1b)).forEach(d => upsert(owner, d.id, d.data()));
        } catch {}

        try {
          const q2b = query(collection(db, "listings"), where("agentEmail", "==", emailLower), limit(50));
          (await getDocs(q2b)).forEach(d => upsert(agent, d.id, d.data()));
        } catch {}
      }

      if (lastLid) {
        try {
          const snap = await getDoc(doc(db, "listings", lastLid));
          if (snap.exists()) {
            const data = snap.data() || {};
            if (!owner.some(x=>x.id===lastLid) && !agent.some(x=>x.id===lastLid)) upsert(owner, lastLid, data);
          }
        } catch {}
      }

      const byId = {};
      [...owner, ...agent].forEach(it => byId[it.id] = it);
      const all = Object.values(byId);

      all.sort((a,b) => {
        const au = tsMillis(a.updatedAt);
        const bu = tsMillis(b.updatedAt);
        const ac = tsMillis(a.createdAt);
        const bc = tsMillis(b.createdAt);
        return (bu - au) || (bc - ac);
      });

      return { owner, agent, all };
    }

    function optionLabel(it) {
      const addr = it.address || '[address]';
      const status = it.status || 'Draft';
      return `${addr} — ${status}`;
    }

    function safePreviewHref(it) {
      if (it && it.id) return '/listing.html?id=' + encodeURIComponent(it.id);
      const addr = (it.address || '').trim();
      return addr ? '/listing.html?addr=' + encodeURIComponent(addr) : '#';
    }

    function fillDropdown(selectEl, list, previewLinkEl) {
      selectEl.innerHTML = `<option value="">Select…</option>`;
      list.forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = optionLabel(it);
        selectEl.appendChild(opt);
      });

      if (list.length) {
        selectEl.value = list[0].id;
        if (previewLinkEl) previewLinkEl.href = safePreviewHref(list[0]);
      }
    }

    function wireEditor(selectEl, editBtn, previewA, list, mode) {
      if (!selectEl || !editBtn || !previewA) return;

      selectEl.addEventListener('change', () => {
        const it = list.find(x => x.id === selectEl.value);
        previewA.href = it ? safePreviewHref(it) : '#';
      });

      editBtn.addEventListener('click', () => {
        const it = list.find(x => x.id === selectEl.value);
        if (!it) { alert('Pick a listing first.'); return; }
        localStorage.setItem('lastListingId', it.id);

        if (mode === 'seller') {
          localStorage.setItem('userRole','seller');
          location.href = '/seller-detail.html?id=' + encodeURIComponent(it.id);
        } else {
          localStorage.setItem('userRole','listing_agent');
          location.href = '/agent-detail.html?id=' + encodeURIComponent(it.id);
        }
      });
    }

    // Local role profiles: Firestore collections that exist now:
    // localPros, localBrokers (localServices intentionally omitted)
    async function safeQueryByEmail(colName) {
      if (!db || !emailLower) return [];
      const out = [];
      try {
        const q1 = query(collection(db, colName), where("email", "==", emailLower), limit(50));
        (await getDocs(q1)).forEach(d => out.push({ id: d.id, ...d.data() }));
      } catch {}
      try {
        const q2 = query(collection(db, colName), where("emailLower", "==", emailLower), limit(50));
        (await getDocs(q2)).forEach(d => { if (!out.some(x => x.id === d.id)) out.push({ id: d.id, ...d.data() }); });
      } catch {}
      return out;
    }

    function canEditAsSeller(it) {
      const o = norm(it.ownerEmailLower || it.ownerEmail || '');
      return !!emailLower && o === emailLower;
    }
    function canEditAsAgent(it) {
      const a = norm(it.agentEmailLower || it.agentEmail || '');
      return !!emailLower && a === emailLower;
    }

    // ✅ UPDATED: support {text,title} labels (used for broker ZIP truncation)
    function fillProfileDropdown(selectEl, items, labelFn) {
      selectEl.innerHTML = `<option value="">Select…</option>`;
      items.forEach(x => {
        const opt = document.createElement('option');
        const label = labelFn(x);
        opt.value = x.id;

        if (label && typeof label === 'object') {
          opt.textContent = label.text || '';
          opt.title = label.title || '';
        } else {
          opt.textContent = String(label || '');
          opt.title = String(label || '');
        }

        selectEl.appendChild(opt);
      });
      if (items.length) selectEl.value = items[0].id;
    }

    function proLabel(x) {
      const nm = x.name || x.personalName || 'Local Professional';
      const z = Array.isArray(x.zips) ? x.zips.join(', ') : '';
      const full = z ? `${nm} — ZIPs: ${z}` : nm;
      // keep as simple string for pros
      return full;
    }

    // ✅ FIX: brokers return {text,title} so dropdown doesn’t blow out margins
    function brokerLabel(x) {
      const nm = x.name || 'Local Broker';
      const z = x.zip ? String(x.zip) : (Array.isArray(x.zips) ? x.zips.join(', ') : '');
      const full = z ? `${nm} — ${z}` : nm;

      // Hard truncate for dropdown display (reliable vs browser option wrapping)
      const MAX = 46;
      const text = full.length > MAX ? (full.slice(0, MAX) + '…') : full;

      return { text, title: full };
    }

    (async function boot(){
      const [{ owner, agent, all }, pros, brokers] = await Promise.all([
        fetchMyLists(),
        safeQueryByEmail("localPros"),
        safeQueryByEmail("localBrokers")
      ]);

      const hasSeller  = owner.length > 0;
      const hasAgent   = agent.length > 0;
      const hasPros    = pros.length > 0;
      const hasBrokers = brokers.length > 0;

      // Show blocks based on roles
      if (hasSeller) {
        $('blkSellerNew').classList.remove('hidden');
        $('blkSellerEdit').classList.remove('hidden');
      }

      if (hasAgent) {
        $('blkAgentEdit').classList.remove('hidden');
        // Realtors also see local pros/brokers blocks (even if empty)
        $('blkLocalPros').classList.remove('hidden');
        $('blkLocalBrokers').classList.remove('hidden');
      }

      // Local roles show blocks too (even if user is not an agent)
      if (hasPros && !hasAgent) $('blkLocalPros').classList.remove('hidden');
      if (hasBrokers && !hasAgent) $('blkLocalBrokers').classList.remove('hidden');

      // Search + saved searches for sellers and agents
      if (hasSeller || hasAgent) {
        $('blkSearch').classList.remove('hidden');
        $('blkSavedSearches').classList.remove('hidden');
      }

      // Seller dropdown
      if (hasSeller) {
        const sellerSel = $('sellerListings');
        const sellerPrev = $('sellerPreview');
        const sellerGo = $('sellerEditGo');
        if (owner.length) {
          $('sellerNoListings')?.classList.add('hidden');
          fillDropdown(sellerSel, owner, sellerPrev);
        } else {
          $('sellerNoListings')?.classList.remove('hidden');
        }
        wireEditor(sellerSel, sellerGo, sellerPrev, owner, 'seller');
      }

      // Agent dropdown (agents edit only their agent listings)
      if (hasAgent) {
        const agentSel = $('agentListings');
        const agentPrev = $('agentPreview');
        const agentGo = $('agentEditGo');
        if (agent.length) {
          $('agentNoListings')?.classList.add('hidden');
          fillDropdown(agentSel, agent, agentPrev);
        } else {
          $('agentNoListings')?.classList.remove('hidden');
        }
        wireEditor(agentSel, agentGo, agentPrev, agent, 'agent');
      }

      // Saved searches dropdown
      const saved = getSavedSearches();
      if (saved.length) {
        $('noSavedSearches')?.classList.add('hidden');
        fillSavedSearchDropdown($('savedSearches'), saved);
      } else {
        $('noSavedSearches')?.classList.remove('hidden');
      }
      wireSavedSearchControls();

      // Local pros dropdown (simple)
      if (pros.length) {
        $('noProProfiles')?.classList.add('hidden');
        fillProfileDropdown($('proProfiles'), pros, proLabel);
      } else {
        $('noProProfiles')?.classList.remove('hidden');
      }

      // Local brokers dropdown (truncated + tooltip)
      if (brokers.length) {
        $('noBrokerProfiles')?.classList.add('hidden');
        fillProfileDropdown($('brokerProfiles'), brokers, brokerLabel);
      } else {
        $('noBrokerProfiles')?.classList.remove('hidden');
      }

      // Unified listings table (permission gated)
      if (all.length) {
        const host = $('listingsTable');
        const sec = $('listSection');
        if (host && sec) {
          sec.classList.remove('hidden');
          host.innerHTML = `
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-3 py-2 text-left">Address</th>
                    <th class="px-3 py-2 text-left">Status</th>
                    <th class="px-3 py-2 text-left">Plan</th>
                    <th class="px-3 py-2 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${all.map(it=>{
                    const previewHref = it.id ? ('/listing.html?id=' + encodeURIComponent(it.id)) : '#';
                    const links = [
                      (canEditAsSeller(it) ? `<a class="text-blue-600 underline" href="/seller-detail.html?id=${encodeURIComponent(it.id)}">Edit as Seller</a>` : ``),
                      (canEditAsAgent(it)  ? `<a class="text-blue-600 underline" href="/agent-detail.html?id=${encodeURIComponent(it.id)}">Edit as Agent</a>` : ``),
                      `<a class="text-blue-600 underline" href="${previewHref}" target="_blank" rel="noopener">Preview</a>`
                    ].filter(Boolean).join(` <span class="text-gray-300">|</span> `);

                    return `
                      <tr>
                        <td class="px-3 py-2">${it.address || ''}</td>
                        <td class="px-3 py-2">${it.status || 'Draft'}</td>
                        <td class="px-3 py-2">${it.plan || ''}</td>
                        <td class="px-3 py-2">${links}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      }

      // Optional role summary (hidden)
      const rs = $('roleSummary');
      if (rs) {
        rs.textContent = `roles: seller=${hasSeller} agent=${hasAgent} localPros=${hasPros} localBrokers=${hasBrokers}`;
        // rs.classList.remove('hidden'); // enable for debugging
      }

      console.log('[welcome] roles', { hasSeller, hasAgent, hasPros, hasBrokers });
    })();
  </script>
</body>
</html>
