<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <header class="bg-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">&larr; Home</a>
      <h1 class="text-lg font-semibold">Welcome</h1>
      <div class="flex items-center gap-3">
        <a href="/search.html" class="text-sm text-blue-600 hover:underline">Search</a>
        <button id="logoutBtn" class="text-sm px-3 py-1 rounded border">Log out</button>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-1">Hi <span id="who">there</span></h2>
      <p class="text-sm text-gray-600 mb-4">What would you like to do next?</p>

      <!-- Seller Prompt (auto-inserted here if exactly one match or resume is available) -->
      <div id="sellerPromptHost" class="mb-4"></div>

      <div id="roleBoxes" class="space-y-4">

        <!-- Seller -->
        <div id="boxSeller" class="hidden space-y-4">
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Enter a new listing</h3>
            <div class="flex items-center gap-2">
              <label class="text-sm">Plan</label>
              <select id="sellerNewPlan" class="border rounded px-2 py-1 text-sm">
                <option>Listed Property Basic</option>
                <option>Listed Property Plus</option>
                <option>FSBO Plus</option>
              </select>
              <button id="sellerNewGo" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Continue</button>
            </div>
          </div>

          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Edit a current listing</h3>
            <div id="sellerEditRow" class="flex flex-col gap-2 md:flex-row md:items-center">
              <select id="sellerListings" class="border rounded px-2 py-2 text-sm grow">
                <option value="">Select your listing…</option>
              </select>
              <div class="flex gap-2">
                <button id="sellerEditGo" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Edit</button>
                <a id="sellerPreview" class="px-3 py-2 rounded border text-sm" href="#" target="_blank" rel="noopener">Preview</a>
              </div>
            </div>
            <p id="sellerNoListings" class="hidden text-sm text-gray-700 mt-2">
              No listings found for your account.
            </p>
          </div>

          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Search commissions / create auto-email search</h3>
            <button id="sellerSearchGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Search with filters</button>
          </div>
        </div>

        <!-- Listing Agent -->
        <div id="boxAgent" class="hidden space-y-4">
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Edit a current listing</h3>
            <div id="agentEditRow" class="flex flex-col gap-2 md:flex-row md:items-center">
              <select id="agentListings" class="border rounded px-2 py-2 text-sm grow">
                <option value="">Select your listing…</option>
              </select>
              <div class="flex gap-2">
                <button id="agentEditGo" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Edit</button>
                <a id="agentPreview" class="px-3 py-2 rounded border text-sm" href="#" target="_blank" rel="noopener">Preview</a>
              </div>
            </div>
            <p id="agentNoListings" class="hidden text-sm text-gray-700 mt-2">
              No listings found for your account.
            </p>
          </div>

          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Become a Local Professional</h3>
            <button id="agentProApply" class="px-3 py-2 rounded bg-amber-600 text-white text-sm">Apply</button>
          </div>

          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Search commissions / create auto-email search</h3>
            <button id="agentSearchGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Search with filters</button>
          </div>
        </div>

        <!-- Buyer’s Agent -->
        <div id="boxBuyersAgent" class="hidden space-y-4">
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Become a Local Professional</h3>
            <button id="bAgentProApply" class="px-3 py-2 rounded bg-amber-600 text-white text-sm">Apply</button>
          </div>
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Create a new automatic search</h3>
            <button id="bAgentSearchGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Search with filters</button>
          </div>
        </div>

        <!-- Buyer -->
        <div id="boxBuyer" class="hidden space-y-4">
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Search Local Professionals by ZIP</h3>
            <button id="buyerProsGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Local Professionals</button>
          </div>
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Search commissions / create auto-email search</h3>
            <button id="buyerSearchGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Search with filters</button>
          </div>
        </div>

        <!-- Other / Fallback -->
        <div id="boxOther" class="hidden space-y-4">
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-2">Search commissions</h3>
            <button id="otherSearchGo" class="px-3 py-2 rounded bg-gray-700 text-white text-sm">Open Search with filters</button>
          </div>
        </div>

      </div>
    </section>

    <!-- Listing table -->
    <section id="listSection" class="mt-6 bg-white rounded-2xl shadow p-6 hidden">
      <h3 class="font-semibold mb-2">Your listings</h3>
      <div id="listingsTable" class="text-sm text-gray-800"></div>
    </section>
  </main>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      collection, getDocs, query, where, orderBy, limit, doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);

    // Who + role (use lower-case for matching)
    const emailRaw = (localStorage.getItem('loggedInEmail') || '').trim();
    const email = emailRaw.toLowerCase();
    const role  = (localStorage.getItem('userRole') || '').trim();
    $("who").textContent = emailRaw || 'there';

    // Logout
    $("logoutBtn")?.addEventListener('click', () => {
      try {
        ['isLoggedIn','loggedInEmail','userRole','verificationCode','verifyTarget','nextAfterLogin','nextAfterVerify','lastListingId','lastListingAddress']
          .forEach(k=>localStorage.removeItem(k));
      } catch {}
      location.href = '/index.html';
    });

    // Show role box
    const show = (id)=>$(id).classList.remove('hidden');
    if (role === 'seller') show('boxSeller');
    else if (role === 'listing_agent') show('boxAgent');
    else if (role === 'buyers_agent') show('boxBuyersAgent');
    else if (role === 'buyer') show('boxBuyer');
    else show('boxOther');

    // New Listing plan
    $("sellerNewGo")?.addEventListener('click', ()=>{
      const plan = $("sellerNewPlan").value;
      localStorage.setItem('selectedPlan', plan);
      location.href = '/index.html#strip2Search';
      window.scrollTo(0,0);
    });

    // Shared search buttons
    $("sellerSearchGo")?.addEventListener('click', ()=> location.href='/search.html?open=filters&prompt=save');
    $("agentSearchGo")?.addEventListener('click',  ()=> location.href='/search.html?open=filters&prompt=save');
    $("bAgentSearchGo")?.addEventListener('click', ()=> location.href='/search.html?open=filters&prompt=save');
    $("buyerSearchGo")?.addEventListener('click',  ()=> location.href='/search.html?open=filters&prompt=save');
    $("buyerProsGo")?.addEventListener('click',    ()=> location.href='/local-professionals.html?mode=search');
    $("bAgentProApply")?.addEventListener('click', ()=> location.href='/local-professionals.html?mode=apply');
    $("agentProApply")?.addEventListener('click',  ()=> location.href='/local-professionals.html?mode=apply');

    // Fetch listings for this user (owner OR agent) with dedupe
    async function fetchMyListings() {
      if (!email || !db) return [];

      const items = [];
      try {
        // Query ownerEmail == login lower
        const q1 = query(collection(db, "listings"), where("ownerEmail", "==", email), limit(75));
        const s1 = await getDocs(q1);
        s1.forEach(d => items.push({ id: d.id, ...d.data() }));

        // Query agentEmail == login lower (in case the agent also logs in here)
        const q2 = query(collection(db, "listings"), where("agentEmail", "==", email), limit(75));
        const s2 = await getDocs(q2);
        s2.forEach(d => items.push({ id: d.id, ...d.data() }));

        // Fallback (older mixed-case emails)
        if (items.length === 0) {
          const q3 = query(collection(db, "listings"), orderBy("createdAt","desc"), limit(75));
          const s3 = await getDocs(q3);
          s3.forEach(d => {
            const data = d.data() || {};
            const oe = (data.ownerEmail || '').toLowerCase();
            const ae = (data.agentEmail || '').toLowerCase();
            if (oe === email || ae === email) items.push({ id: d.id, ...data });
          });
        }
      } catch (e) {
        console.warn("[welcome] fetch error:", e);
      }

      // De-dupe by id + address (defensive)
      const byKey = {};
      for (const it of items) {
        const addrKey = (it.address || '').trim().toLowerCase();
        const key = it.id + '|' + addrKey;
        byKey[key] = it;
      }
      const list = Object.keys(byKey).map(k => byKey[k]);

      // Sort by updatedAt then createdAt (desc)
      list.sort((a,b) => {
        const au = a.updatedAt?.toMillis?.() ? a.updatedAt.toMillis() : 0;
        const bu = b.updatedAt?.toMillis?.() ? b.updatedAt.toMillis() : 0;
        const ac = a.createdAt?.toMillis?.() ? a.createdAt.toMillis() : 0;
        const bc = b.createdAt?.toMillis?.() ? b.createdAt.toMillis() : 0;
        return (bu - au) || (bc - ac);
      });

      return list;
    }

    function optionLabel(it) {
      const addr = it.address || '[address]';
      const status = it.status || 'Draft';
      return `${addr} — ${status}`;
    }

    function fillDropdown(selectEl, list) {
      selectEl.innerHTML = `<option value="">Select your listing…</option>`;
      list.forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = optionLabel(it);
        selectEl.appendChild(opt);
      });

      // Auto-select the newest one and pre-wire Preview
      if (list.length) {
        selectEl.value = list[0].id;
        const prev = selectEl.id === 'sellerListings' ? $('sellerPreview') : $('agentPreview');
        if (prev) prev.href = '/listing.html?id=' + encodeURIComponent(list[0].id);
      }
    }

    // Ensure links always have id (fallback to addr)
    function safePreviewHref(it) {
      if (it && it.id) return '/listing.html?id=' + encodeURIComponent(it.id);
      const addr = (it.address || '').trim();
      return addr ? '/listing.html?addr=' + encodeURIComponent(addr) : '#';
    }

    function wireEditor(selectEl, editBtn, previewA, list) {
      if (!selectEl || !editBtn || !previewA) return;

      selectEl.addEventListener('change', () => {
        const it = list.find(x => x.id === selectEl.value);
        previewA.href = it ? safePreviewHref(it) : '#';
      });

      editBtn.addEventListener('click', () => {
        const it = list.find(x => x.id === selectEl.value);
        if (!it) { alert('Pick a listing first.'); return; }
        localStorage.setItem('lastListingId', it.id);
        // Route to correct editor by role
        if (role === 'seller') {
          location.href = '/seller-detail.html?id=' + encodeURIComponent(it.id);
        } else if (role === 'listing_agent') {
          location.href = '/agent-detail.html?id=' + encodeURIComponent(it.id);
        } else {
          location.href = '/agent-detail.html?id=' + encodeURIComponent(it.id);
        }
      });
    }

    async function archiveListing(id) {
      try {
        await updateDoc(doc(db, "listings", id), { status: "Archived", updatedAt: serverTimestamp() });
        alert("Listing archived.");
        location.reload();
      } catch (e) {
        console.warn("[welcome] archive failed:", e);
        alert("Could not archive. Try again.");
      }
    }

    // === Seller Prompt helpers ===
    function renderSellerPromptCard(it, reason) {
      const host = $("sellerPromptHost");
      if (!host) return;
      const addr = it.address || 'Your listing';
      const id = it.id;
      host.innerHTML = `
        <div class="border rounded-xl p-4 mb-4 bg-indigo-50 border-indigo-200">
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold">Continue your listing</div>
              <div class="text-sm text-gray-700 mt-0.5">${addr}</div>
              ${reason ? `<div class="text-xs text-gray-500 mt-1">${reason}</div>` : ``}
            </div>
            <div class="flex gap-2">
              <a href="/seller-detail.html?id=${encodeURIComponent(id)}" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Edit</a>
              <a href="/listing.html?id=${encodeURIComponent(id)}" target="_blank" rel="noopener" class="px-3 py-2 rounded border text-sm">Preview</a>
            </div>
          </div>
        </div>
      `;
    }

    (async function boot(){
      const list = await fetchMyListings();

      // If seller role, show prompt when exactly one owner match, or resume by lastListingId
      if (role === 'seller') {
        const ownerMatches = list.filter(it => (String(it.ownerEmail || '').toLowerCase() === email));
        if (ownerMatches.length === 1) {
          // Auto-prompt to edit that listing
          renderSellerPromptCard(ownerMatches[0], "We found this listing on your account.");
          // Also set lastListingId so downstream pages have it
          localStorage.setItem('lastListingId', ownerMatches[0].id);
        } else if (ownerMatches.length === 0) {
          // Try resume from lastListingId if present
          const lastId = (localStorage.getItem('lastListingId') || '').trim();
          if (lastId) {
            const resume = list.find(it => it.id === lastId);
            if (resume) {
              renderSellerPromptCard(resume, "Resume where you left off.");
            }
          }
        }
      }

      // Seller box
      const sellerSel  = $("sellerListings");
      const sellerGo   = $("sellerEditGo");
      const sellerPrev = $("sellerPreview");
      if (sellerSel) {
        if (list.length) {
          $("sellerNoListings")?.classList.add('hidden');
          // Prefer seller-owned listings in the dropdown first
          const ownerFirst = [...list].sort((a,b) => {
            const ao = String(a.ownerEmail||'').toLowerCase() === email ? -1 : 0;
            const bo = String(b.ownerEmail||'').toLowerCase() === email ? -1 : 0;
            return ao - bo;
          });
          fillDropdown(sellerSel, ownerFirst);
        } else {
          $("sellerNoListings")?.classList.remove('hidden');
        }
        wireEditor(sellerSel, sellerGo, sellerPrev, list);
      }

      // Agent box
      const agentSel  = $("agentListings");
      const agentGo   = $("agentEditGo");
      const agentPrev = $("agentPreview");
      if (agentSel) {
        if (list.length) {
          $("agentNoListings")?.classList.add('hidden');
          fillDropdown(agentSel, list);
        } else {
          $("agentNoListings")?.classList.remove('hidden');
        }
        wireEditor(agentSel, agentGo, agentPrev, list);
      }

      // Table (with Archive helper)
      if (list.length) {
        const host = $("listingsTable");
        const sec  = $("listSection");
        if (host && sec) {
          sec.classList.remove('hidden');
          host.innerHTML = `
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-3 py-2 text-left">Address</th>
                    <th class="px-3 py-2 text-left">Status</th>
                    <th class="px-3 py-2 text-left">Plan</th>
                    <th class="px-3 py-2 text-left">Updated</th>
                    <th class="px-3 py-2 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  ${
                    list.map(it=>{
                      const upd = it.updatedAt?.toDate ? it.updatedAt.toDate() : null;
                      const upds = upd ? upd.toLocaleDateString() : '';
                      const href = safePreviewHref(it);
                      const isDup = list.filter(x => (x.address||'').trim().toLowerCase() === (it.address||'').trim().toLowerCase()).length > 1;
                      return `
                        <tr>
                          <td class="px-3 py-2">${it.address || ''}</td>
                          <td class="px-3 py-2">${it.status || 'Draft'}</td>
                          <td class="px-3 py-2">${it.plan || ''}</td>
                          <td class="px-3 py-2">${upds}</td>
                          <td class="px-3 py-2 flex gap-3">
                            <a class="text-blue-600 underline" href="${href}" target="_blank" rel="noopener">Preview</a>
                            ${isDup ? `<button class="underline text-red-600" data-archive="${it.id}">Archive duplicate</button>` : ``}
                          </td>
                        </tr>
                      `;
                    }).join('')
                  }
                </tbody>
              </table>
            </div>
          `;

          // Wire archive buttons
          host.querySelectorAll('[data-archive]').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const id = e.currentTarget.getAttribute('data-archive');
              if (confirm("Archive this duplicate listing?")) archiveListing(id);
            });
          });
        }
      }
    })();
  </script>
</body>
</html>
