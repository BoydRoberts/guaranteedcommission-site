<!DOCTYPE html>
<!-- Build: 2026-02-06 (Status dropdown added to listings table for quick status updates) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Helps prevent long dropdown text from breaking layout */
    select.truncate-option { max-width: 100%; }
    
    /* Status dropdown styling */
    .status-select {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
    }
    .status-select:focus {
      outline: none;
      border-color: #4DA6FF;
      box-shadow: 0 0 0 2px rgba(77, 166, 255, 0.2);
    }
    .status-select.status-active { border-color: #22c55e; background: #f0fdf4; }
    .status-select.status-pending { border-color: #1f2937; background: #f9fafb; }
    .status-select.status-sold { border-color: #dc2626; background: #fef2f2; }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #1f2937;
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success { background: #22c55e; }
    .toast.error { background: #dc2626; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header (matches home/search/listing) -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

        <div class="text-center">
          <div class="flex items-end justify-center gap-0">
            <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
            <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
          <a href="/search.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Search</a>
          <button id="logoutBtn" class="text-sm px-3 py-1 rounded border hover:bg-gray-50">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-1">Welcome <span id="who">there</span></h2>
      <p id="subtitle" class="text-sm text-gray-600 mb-4">What would you like to do next?</p>

      <!-- Optional role summary (hidden by default) -->
      <p id="roleSummary" class="hidden text-xs text-gray-500 mb-4"></p>

      <div id="blocksHost" class="space-y-4">

        <!-- ======================
             GET STARTED (shown for new users with no listings/subscriptions)
             ====================== -->
        <div id="blkGetStarted" class="hidden border-2 border-dashed border-blue-300 bg-blue-50 rounded-lg p-5">
          <h3 class="font-semibold mb-3 text-blue-900">Get Started</h3>
          <p class="text-sm text-blue-800 mb-4">Welcome to GuaranteedCommission.com! Here's how you can get started:</p>
          <div class="flex flex-wrap gap-3">
            <a href="/index.html#strip2Search" class="px-4 py-2 rounded text-white text-sm font-medium" style="background:#4DA6FF;">List a Property</a>
            <a href="/search.html" class="px-4 py-2 rounded text-white text-sm font-medium bg-green-600 hover:bg-green-700">Search Listings</a>
            <a href="/advertise.html" class="px-4 py-2 rounded border text-sm font-medium hover:bg-gray-50">Advertise Your Business</a>
          </div>
        </div>

        <!-- ======================
             SELLER: Enter new listing (ALL LOGGED-IN USERS)
             ====================== -->
        <div id="blkSellerNew" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Enter a new listing</h3>
          <div class="flex items-center gap-2 flex-wrap">
            <label class="text-sm">Plan</label>
            <select id="sellerNewPlan" class="border rounded px-2 py-1 text-sm">
              <option>Listed Property Basic</option>
              <option>Listed Property Plus</option>
              <option>FSBO Plus</option>
            </select>
            <button id="sellerNewGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Continue</button>
          </div>
        </div>

        <!-- ======================
             SELLER: Edit listing as Seller (ONLY if user has seller listings)
             ====================== -->
        <div id="blkSellerEdit" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Edit a current listing</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="sellerListings" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your listing…</option>
            </select>
            <div class="flex gap-2">
              <button id="sellerEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <a id="sellerPreview" class="px-3 py-2 rounded border text-sm hover:bg-gray-50" href="#" target="_blank" rel="noopener">Preview</a>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-2">
            Seller edit = seller intake (commission locked; commission change is a paid flow).
          </p>
        </div>

        <!-- ======================
             AGENT: Edit listing as Agent (ONLY if user has agent listings)
             ====================== -->
        <div id="blkAgentEdit" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Edit a current listing (as Agent)</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="agentListings" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your listing…</option>
            </select>
            <div class="flex gap-2">
              <button id="agentEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <a id="agentPreview" class="px-3 py-2 rounded border text-sm hover:bg-gray-50" href="#" target="_blank" rel="noopener">Preview</a>
            </div>
          </div>
          <p class="text-[11px] text-gray-500 mt-2">
            Agent edit = agent intake (commission locked; agents can apply free upgrades per promo rules).
          </p>
        </div>

        <!-- ======================
             SEARCH (ALL LOGGED-IN USERS)
             ====================== -->
        <div id="blkSearch" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Search Guaranteed Commissions</h3>
          <button id="searchGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Open Search with filters</button>
        </div>

        <!-- ======================
             SAVED SEARCHES / AUTO NOTIFICATIONS (shown if user has saved searches)
             ====================== -->
        <div id="blkSavedSearches" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">View / edit a current saved search or auto notification</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="savedSearches" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select a saved search…</option>
            </select>
            <div class="flex gap-2">
              <button id="savedEditGo" class="px-3 py-2 rounded text-white text-sm" style="background:#4DA6FF;">Edit</button>
              <button id="savedDeleteGo" class="px-3 py-2 rounded border text-sm hover:bg-gray-50">Delete</button>
            </div>
          </div>
        </div>

        <!-- ======================
             LOCAL PROFESSIONALS SUBSCRIPTION (shown if user has pro profiles)
             ====================== -->
        <div id="blkLocalPros" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Your Local Professional Subscription</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="proProfiles" class="border rounded px-2 py-2 text-sm grow">
              <option value="">Select your Local Professional profile…</option>
            </select>
            <div class="flex gap-2">
              <a id="proManageBtn" class="px-3 py-2 rounded text-white text-sm text-center" style="background:#4DA6FF;" href="#manage-stripe-pro">Manage Subscription</a>
              <a id="proApplyBtn" class="px-3 py-2 rounded border text-sm hover:bg-gray-50 text-center" href="/local-professionals.html">Add ZIP</a>
            </div>
          </div>
          <p id="proStatusText" class="text-xs text-gray-600 mt-2"></p>
        </div>

        <!-- ======================
             LOCAL BROKERS SUBSCRIPTION (shown if user has broker profiles)
             ====================== -->
        <div id="blkLocalBrokers" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Your Local Broker Subscription</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="brokerProfiles" class="border rounded px-2 py-2 text-sm grow truncate-option">
              <option value="">Select your Local Broker profile…</option>
            </select>
            <div class="flex gap-2">
              <a id="brokerManageBtn" class="px-3 py-2 rounded text-white text-sm text-center" style="background:#4DA6FF;" href="#manage-stripe-broker">Manage Subscription</a>
              <a id="brokerApplyBtn" class="px-3 py-2 rounded border text-sm hover:bg-gray-50 text-center" href="/local-brokers.html">Add ZIP</a>
            </div>
          </div>
          <p id="brokerStatusText" class="text-xs text-gray-600 mt-2"></p>
        </div>

        <!-- ======================
             LOCAL SERVICE PROVIDERS SUBSCRIPTION (shown if user has service provider profiles)
             ====================== -->
        <div id="blkServiceProviders" class="hidden border rounded-lg p-4">
          <h3 class="font-semibold mb-2">Your Service Provider Subscription</h3>
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <select id="serviceProviderProfiles" class="border rounded px-2 py-2 text-sm grow truncate-option">
              <option value="">Select your Service Provider profile…</option>
            </select>
            <div class="flex gap-2">
              <a id="serviceProviderManageBtn" class="px-3 py-2 rounded text-white text-sm text-center" style="background:#4DA6FF;" href="#manage-stripe-service">Manage Subscription</a>
              <a id="serviceProviderApplyBtn" class="px-3 py-2 rounded border text-sm hover:bg-gray-50 text-center" href="/local-service-providers.html">Add ZIP</a>
            </div>
          </div>
          <p id="serviceProviderStatusText" class="text-xs text-gray-600 mt-2"></p>
        </div>

      </div>
    </section>

    <!-- Unified listings table (permission-gated links) - HIDDEN BY DEFAULT -->
    <section id="listSection" class="mt-6 bg-white rounded-2xl shadow p-6 hidden">
      <h3 class="font-semibold mb-2">Your listings</h3>
      <div id="listingsTable" class="text-sm text-gray-800"></div>
    </section>
  </main>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import { collection, getDocs, query, where, limit, doc, getDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    const norm = (s)=>String(s||'').trim().toLowerCase();

    // SECURITY: Only trust server-verified data, not localStorage
    const emailRaw = (localStorage.getItem('loggedInEmail') || localStorage.getItem('verifyTarget') || '').trim();
    const emailLower = norm(emailRaw);
    
    // If no email, user is not logged in - redirect to login
    if (!emailLower) {
      location.href = '/login.html';
    }
    
    $("who").textContent = emailRaw || 'there';

    // ========================================
    // TOAST NOTIFICATION
    // ========================================
    function showToast(message, type = 'success') {
      // Remove any existing toasts
      document.querySelectorAll('.toast').forEach(t => t.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Auto-remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ========================================
    // UPDATE LISTING STATUS
    // Quick status change directly from dashboard
    // ========================================
    async function updateListingStatus(listingId, newStatus, selectEl) {
      if (!listingId || !newStatus) return;
      
      try {
        const docRef = doc(db, "listings", listingId);
        
        // Update status and timestamp
        await updateDoc(docRef, {
          status: newStatus,
          updatedAt: serverTimestamp()
        });
        
        // Update dropdown styling based on new status
        updateStatusDropdownStyle(selectEl, newStatus);
        
        showToast(`Status updated to "${newStatus}"`, 'success');
        console.log('[welcome] Status updated:', listingId, newStatus);
        
      } catch (error) {
        console.error('[welcome] Failed to update status:', error);
        showToast('Failed to update status. Please try again.', 'error');
        
        // Revert dropdown to previous value on error
        // (We'd need to track the old value, but for simplicity just reload)
      }
    }

    // Update dropdown visual style based on status
    function updateStatusDropdownStyle(selectEl, status) {
      if (!selectEl) return;
      selectEl.classList.remove('status-active', 'status-pending', 'status-sold');
      
      const statusLower = String(status || '').toLowerCase();
      if (statusLower === 'active') {
        selectEl.classList.add('status-active');
      } else if (statusLower === 'in contract' || statusLower === 'in_contract' || statusLower === 'pending') {
        selectEl.classList.add('status-pending');
      } else if (statusLower === 'sold') {
        selectEl.classList.add('status-sold');
      }
    }

    // Get status class for initial render
    function getStatusClass(status) {
      const statusLower = String(status || '').toLowerCase();
      if (statusLower === 'active') return 'status-active';
      if (statusLower === 'in contract' || statusLower === 'in_contract' || statusLower === 'pending') return 'status-pending';
      if (statusLower === 'sold') return 'status-sold';
      return '';
    }

    // Make updateListingStatus available globally for inline handlers
    window.updateListingStatus = updateListingStatus;

    // Logout - clear session data
    $("logoutBtn")?.addEventListener('click', () => {
      try {
        ['isLoggedIn','loggedInEmail','userRole','verificationCode','verifyTarget','nextAfterLogin','nextAfterVerify','lastListingId','lastListingAddress']
          .forEach(k=>localStorage.removeItem(k));
      } catch {}
      location.href = '/index.html';
    });

    // Seller new listing
    $("sellerNewGo")?.addEventListener('click', ()=> {
      const plan = $("sellerNewPlan").value;
      localStorage.setItem('selectedPlan', plan);
      location.href = '/index.html#strip2Search';
      window.scrollTo(0,0);
    });

    // Search button
    $("searchGo")?.addEventListener('click', ()=> location.href='/search.html?open=filters&prompt=save');

    // Saved searches - NOW FROM FIRESTORE (not localStorage)
    // This prevents cross-user data leaks on shared computers
    // The safeQueryByEmail function will be used to fetch from "savedSearches" collection
    
    function fillSavedSearchDropdown(selectEl, list) {
      selectEl.innerHTML = `<option value="">Select a saved search…</option>`;

      const searches   = list.filter(s => !String(s.name||'').startsWith('Auto-Email:') && !String(s.name||'').startsWith('Auto-Text:'));
      const autoEmails = list.filter(s =>  String(s.name||'').startsWith('Auto-Email:'));
      const autoTexts  = list.filter(s =>  String(s.name||'').startsWith('Auto-Text:'));

      function addGroup(label, arr, stripPrefix) {
        if (!arr.length) return;
        const grp = document.createElement('optgroup');
        grp.label = label;
        arr.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = stripPrefix ? String(s.name||'').replace(stripPrefix, '') : (s.name || '(unnamed)');
          grp.appendChild(opt);
        });
        selectEl.appendChild(grp);
      }

      addGroup('Saved Searches', searches, '');
      addGroup('Auto-Email Notifications', autoEmails, 'Auto-Email: ');
      addGroup('Auto-Text Notifications', autoTexts, 'Auto-Text: ');

      if (list.length) selectEl.value = list[0].id;
    }

    // Wire saved search controls - uses Firestore data passed from boot()
    let savedSearchesList = []; // Will be populated from Firestore
    
    function wireSavedSearchControls() {
      const selectEl = $('savedSearches');
      const editBtn = $('savedEditGo');
      const deleteBtn = $('savedDeleteGo');
      if (!selectEl) return;

      editBtn?.addEventListener('click', () => {
        const id = selectEl.value;
        const saved = savedSearchesList.find(s => s.id === id);
        if (!saved) { alert('Please select a saved search first.'); return; }

        // Store search params for search.html to pick up
        if (saved.q) localStorage.setItem('lastSearch', saved.q);
        else localStorage.removeItem('lastSearch');

        if (saved.filters) localStorage.setItem('lastFilters', JSON.stringify(saved.filters));
        else localStorage.removeItem('lastFilters');

        location.href = '/search.html';
      });

      deleteBtn?.addEventListener('click', async () => {
        const id = selectEl.value;
        if (!id) { alert('Please select a saved search first.'); return; }
        if (!confirm('Delete this saved search?')) return;

        try {
          // Delete from Firestore
          await deleteDoc(doc(db, "savedSearches", id));
          console.log('[welcome] Deleted saved search:', id);
          location.reload();
        } catch (e) {
          console.error('[welcome] Failed to delete saved search:', e);
          alert('Failed to delete. Please try again.');
        }
      });
    }

    // Sorting helper
    function tsMillis(x) {
      try {
        if (!x) return 0;
        if (typeof x.toMillis === "function") return x.toMillis();
        if (typeof x.toDate === "function") return x.toDate().getTime();
        if (typeof x === "number") return x;
        return 0;
      } catch { return 0; }
    }

    // ========================================
    // SECURITY: Strict ownership-based listings fetch
    // NO localStorage trust - only server-verified email ownership
    // ========================================
    async function fetchMyLists() {
      if (!db || !emailLower) return { owner: [], agent: [], all: [] };

      const owner = [], agent = [];

      function upsert(list, id, data) {
        if (!id) return;
        if (!list.some(x => x.id === id)) list.push({ id, ...data });
      }

      // Query by ownerEmailLower (strict ownership)
      try {
        const q1 = query(collection(db, "listings"), where("ownerEmailLower", "==", emailLower), limit(50));
        (await getDocs(q1)).forEach(d => upsert(owner, d.id, d.data()));
      } catch {}

      // Query by agentEmailLower (strict ownership)
      try {
        const q2 = query(collection(db, "listings"), where("agentEmailLower", "==", emailLower), limit(50));
        (await getDocs(q2)).forEach(d => upsert(agent, d.id, d.data()));
      } catch {}

      // Legacy fallback queries (for older records without "Lower" fields)
      try {
        const q1b = query(collection(db, "listings"), where("ownerEmail", "==", emailLower), limit(50));
        (await getDocs(q1b)).forEach(d => upsert(owner, d.id, d.data()));
      } catch {}

      try {
        const q2b = query(collection(db, "listings"), where("agentEmail", "==", emailLower), limit(50));
        (await getDocs(q2b)).forEach(d => upsert(agent, d.id, d.data()));
      } catch {}

      // SECURITY: DO NOT trust lastListingId from localStorage
      // Only server-verified ownership (via email match) is allowed
      // This prevents users from seeing listings they don't own

      const byId = {};
      [...owner, ...agent].forEach(it => byId[it.id] = it);
      const all = Object.values(byId);

      all.sort((a,b) => {
        const au = tsMillis(a.updatedAt);
        const bu = tsMillis(b.updatedAt);
        const ac = tsMillis(a.createdAt);
        const bc = tsMillis(b.createdAt);
        return (bu - au) || (bc - ac);
      });

      return { owner, agent, all };
    }

    function optionLabel(it) {
      const addr = it.address || '[address]';
      const status = it.status || 'Draft';
      return `${addr} — ${status}`;
    }

    function safePreviewHref(it) {
      if (it && it.id) return '/listing.html?id=' + encodeURIComponent(it.id);
      const addr = (it.address || '').trim();
      return addr ? '/listing.html?addr=' + encodeURIComponent(addr) : '#';
    }

    function fillDropdown(selectEl, list, previewLinkEl) {
      selectEl.innerHTML = `<option value="">Select…</option>`;
      list.forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = optionLabel(it);
        selectEl.appendChild(opt);
      });

      if (list.length) {
        selectEl.value = list[0].id;
        if (previewLinkEl) previewLinkEl.href = safePreviewHref(list[0]);
      }
    }

    function wireEditor(selectEl, editBtn, previewA, list, mode) {
      if (!selectEl || !editBtn || !previewA) return;

      selectEl.addEventListener('change', () => {
        const it = list.find(x => x.id === selectEl.value);
        previewA.href = it ? safePreviewHref(it) : '#';
      });

      editBtn.addEventListener('click', () => {
        const it = list.find(x => x.id === selectEl.value);
        if (!it) { alert('Pick a listing first.'); return; }
        localStorage.setItem('lastListingId', it.id);

        if (mode === 'seller') {
          localStorage.setItem('userRole','seller');
          location.href = '/seller-detail.html?id=' + encodeURIComponent(it.id);
        } else {
          localStorage.setItem('userRole','listing_agent');
          location.href = '/agent-detail.html?id=' + encodeURIComponent(it.id);
        }
      });
    }

    // ========================================
    // SUBSCRIPTION QUERIES: Strict email-based ownership
    // ========================================
    async function safeQueryByEmail(colName) {
      if (!db || !emailLower) return [];
      const out = [];
      try {
        const q1 = query(collection(db, colName), where("email", "==", emailLower), limit(50));
        (await getDocs(q1)).forEach(d => out.push({ id: d.id, ...d.data() }));
      } catch {}
      try {
        const q2 = query(collection(db, colName), where("emailLower", "==", emailLower), limit(50));
        (await getDocs(q2)).forEach(d => { if (!out.some(x => x.id === d.id)) out.push({ id: d.id, ...d.data() }); });
      } catch {}
      return out;
    }

    function canEditAsSeller(it) {
      const o = norm(it.ownerEmailLower || it.ownerEmail || '');
      return !!emailLower && o === emailLower;
    }
    function canEditAsAgent(it) {
      const a = norm(it.agentEmailLower || it.agentEmail || '');
      return !!emailLower && a === emailLower;
    }

    // Profile label functions with truncation for dropdowns
    function fillProfileDropdown(selectEl, items, labelFn) {
      selectEl.innerHTML = `<option value="">Select…</option>`;
      items.forEach(x => {
        const opt = document.createElement('option');
        const label = labelFn(x);
        opt.value = x.id;

        if (label && typeof label === 'object') {
          opt.textContent = label.text || '';
          opt.title = label.title || '';
        } else {
          opt.textContent = String(label || '');
          opt.title = String(label || '');
        }

        selectEl.appendChild(opt);
      });
      if (items.length) selectEl.value = items[0].id;
    }

    function proLabel(x) {
      const nm = x.name || x.personalName || 'Local Professional';
      const z = Array.isArray(x.zips) ? x.zips.join(', ') : '';
      const status = x.status || 'pending';
      return z ? `${nm} — ZIPs: ${z} (${status})` : `${nm} (${status})`;
    }

    function brokerLabel(x) {
      const nm = x.name || 'Local Broker';
      const z = x.zip ? String(x.zip) : (Array.isArray(x.zips) ? x.zips.join(', ') : '');
      const status = x.status || 'pending';
      const full = z ? `${nm} — ${z} (${status})` : `${nm} (${status})`;

      const MAX = 46;
      const text = full.length > MAX ? (full.slice(0, MAX) + '…') : full;

      return { text, title: full };
    }

    function serviceProviderLabel(x) {
      const nm = x.company || x.name || 'Service Provider';
      const role = x.role || '';
      const z = Array.isArray(x.zips) ? x.zips.join(', ') : '';
      const status = x.status || 'pending';
      const full = `${nm}${role ? ' (' + role + ')' : ''} — ZIPs: ${z || 'none'} (${status})`;

      const MAX = 50;
      const text = full.length > MAX ? (full.slice(0, MAX) + '…') : full;

      return { text, title: full };
    }

    function getStatusSummary(items, type) {
      const active = items.filter(x => x.status === 'active').length;
      const pending = items.filter(x => x.status === 'pending').length;
      const total = items.length;
      
      const parts = [];
      if (active) parts.push(`${active} active`);
      if (pending) parts.push(`${pending} pending`);
      
      return parts.length ? parts.join(', ') : `${total} profile(s)`;
    }

    // ========================================
    // STRIPE CUSTOMER PORTAL
    // Calls Cloud Function to generate Stripe Portal URL
    // ========================================
    async function openStripePortal(email, subscriptionType) {
      if (!email) {
        alert('Please log in to manage your subscription.');
        return;
      }

      try {
        // Show loading state
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'portalLoading';
        loadingMsg.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        loadingMsg.innerHTML = `
          <div class="bg-white rounded-lg p-6 text-center">
            <p class="text-gray-700">Opening ${subscriptionType} subscription portal...</p>
            <p class="text-sm text-gray-500 mt-2">Please wait...</p>
          </div>
        `;
        document.body.appendChild(loadingMsg);

        // Call Cloud Function via HTTP endpoint
        const response = await fetch('/api/createPortalSession', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            returnUrl: window.location.href
          })
        });

        // Remove loading overlay
        document.getElementById('portalLoading')?.remove();

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to open subscription portal');
        }

        const data = await response.json();
        
        if (data.url) {
          // Redirect to Stripe Customer Portal
          window.location.href = data.url;
        } else {
          throw new Error('No portal URL returned');
        }

      } catch (error) {
        document.getElementById('portalLoading')?.remove();
        console.error('[openStripePortal] Error:', error);
        
        // Show user-friendly error
        if (error.message.includes('No subscription found')) {
          alert(`No active subscription found for ${email}.\n\nIf you recently subscribed, please wait a few minutes and try again.\n\nFor help, contact support@guaranteedcommission.com`);
        } else {
          alert(`Unable to open subscription portal.\n\nError: ${error.message}\n\nPlease try again or contact support@guaranteedcommission.com`);
        }
      }
    }

    // ========================================
    // RENDER LISTINGS TABLE WITH STATUS DROPDOWN
    // ========================================
    function renderListingsTable(all, canEditAsSeller, canEditAsAgent) {
      const host = $('listingsTable');
      const sec = $('listSection');
      if (!host || !sec || !all.length) return;

      sec.classList.remove('hidden');
      
      // Build table HTML
      let tableHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 text-gray-600">
              <tr>
                <th class="px-3 py-2 text-left">Address</th>
                <th class="px-3 py-2 text-left">Status</th>
                <th class="px-3 py-2 text-left">Plan</th>
                <th class="px-3 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y">
      `;

      all.forEach(it => {
        const previewHref = it.id ? ('/listing.html?id=' + encodeURIComponent(it.id)) : '#';
        const currentStatus = it.status || 'Draft';
        const statusClass = getStatusClass(currentStatus);
        
        // Build action links
        const links = [
          (canEditAsSeller(it) ? `<a class="text-blue-600 underline" href="/seller-detail.html?id=${encodeURIComponent(it.id)}">Edit as Seller</a>` : ``),
          (canEditAsAgent(it)  ? `<a class="text-blue-600 underline" href="/agent-detail.html?id=${encodeURIComponent(it.id)}">Edit as Agent</a>` : ``),
          `<a class="text-blue-600 underline" href="${previewHref}" target="_blank" rel="noopener">Preview</a>`
        ].filter(Boolean).join(` <span class="text-gray-300">|</span> `);

        // Status dropdown with current value selected
        const statusDropdown = `
          <select 
            class="status-select ${statusClass}" 
            data-listing-id="${it.id}"
            onchange="window.handleStatusChange(this)"
          >
            <option value="Active" ${currentStatus === 'Active' ? 'selected' : ''}>Active</option>
            <option value="In Contract" ${currentStatus === 'In Contract' || currentStatus === 'in_contract' ? 'selected' : ''}>In Contract</option>
            <option value="Sold" ${currentStatus === 'Sold' ? 'selected' : ''}>Sold</option>
          </select>
        `;

        tableHTML += `
          <tr>
            <td class="px-3 py-2">${it.address || ''}</td>
            <td class="px-3 py-2">${statusDropdown}</td>
            <td class="px-3 py-2">${it.plan || ''}</td>
            <td class="px-3 py-2">${links}</td>
          </tr>
        `;
      });

      tableHTML += `
            </tbody>
          </table>
        </div>
      `;

      host.innerHTML = tableHTML;
    }

    // Global handler for status dropdown changes
    window.handleStatusChange = function(selectEl) {
      const listingId = selectEl.dataset.listingId;
      const newStatus = selectEl.value;
      
      if (listingId && newStatus) {
        updateListingStatus(listingId, newStatus, selectEl);
      }
    };

    // ========================================
    // MAIN BOOT: Zero Trust - only show data user owns
    // ========================================
    (async function boot(){
      // Fetch all data in parallel (strict email ownership)
      const [{ owner, agent, all }, pros, brokers, serviceProviders, savedDocs] = await Promise.all([
        fetchMyLists(),
        safeQueryByEmail("localPros"),
        safeQueryByEmail("localBrokers"),
        safeQueryByEmail("localServiceProviders"),
        safeQueryByEmail("savedSearches") // NOW FROM FIRESTORE
      ]);

      // Store saved searches for use by wireSavedSearchControls
      savedSearchesList = savedDocs;

      // Determine what the user has (server-verified only)
      const hasSeller = owner.length > 0;
      const hasAgent = agent.length > 0;
      const hasListings = all.length > 0;
      const hasPros = pros.length > 0;
      const hasBrokers = brokers.length > 0;
      const hasServiceProviders = serviceProviders.length > 0;
      const hasSubscriptions = hasPros || hasBrokers || hasServiceProviders;
      const hasSavedSearches = savedDocs.length > 0;

      // Determine if user is "new" (no data at all)
      const isNewUser = !hasListings && !hasSubscriptions && !hasSavedSearches;

      // ========================================
      // UI: Show blocks based on verified ownership
      // ========================================

      // NEW USER: Show "Get Started" block
      if (isNewUser) {
        $('blkGetStarted').classList.remove('hidden');
        $('subtitle').textContent = 'Get started with GuaranteedCommission.com';
      }

      // "Enter new listing" - ONLY for sellers (NOT agents)
      // Business Rule: Agents cannot create listings or sign the ISC
      // - New users see this (to list their first home)
      // - Sellers see this (to list another home)
      // - Agents do NOT see this (they cannot sign ISC)
      if (!hasAgent || hasSeller) {
        $('blkSellerNew').classList.remove('hidden');
      }
      
      // "Search" - ONLY for sellers, agents, or users with saved searches
      if (hasSeller || hasAgent || hasSavedSearches) {
        $('blkSearch').classList.remove('hidden');
      }

      // SELLER EDIT: Only if user owns seller listings
      if (hasSeller) {
        $('blkSellerEdit').classList.remove('hidden');
        const sellerSel = $('sellerListings');
        const sellerPrev = $('sellerPreview');
        const sellerGo = $('sellerEditGo');
        fillDropdown(sellerSel, owner, sellerPrev);
        wireEditor(sellerSel, sellerGo, sellerPrev, owner, 'seller');
      }

      // AGENT EDIT: Only if user owns agent listings
      if (hasAgent) {
        $('blkAgentEdit').classList.remove('hidden');
        const agentSel = $('agentListings');
        const agentPrev = $('agentPreview');
        const agentGo = $('agentEditGo');
        fillDropdown(agentSel, agent, agentPrev);
        wireEditor(agentSel, agentGo, agentPrev, agent, 'agent');
      }

      // SAVED SEARCHES: Only if user has saved searches (FROM FIRESTORE)
      if (hasSavedSearches) {
        $('blkSavedSearches').classList.remove('hidden');
        fillSavedSearchDropdown($('savedSearches'), savedDocs);
      }
      wireSavedSearchControls();

      // LOCAL PROFESSIONALS: Only if user has pro profiles
      if (hasPros) {
        $('blkLocalPros').classList.remove('hidden');
        fillProfileDropdown($('proProfiles'), pros, proLabel);
        $('proStatusText').textContent = getStatusSummary(pros, 'pro') + ' — $5/month per ZIP';
        
        // Manage Subscription button - calls Cloud Function to get Stripe Portal URL
        const manageBtn = $('proManageBtn');
        if (manageBtn) {
          manageBtn.href = '#';
          manageBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await openStripePortal(emailLower, 'Local Professional');
          });
        }
      }

      // LOCAL BROKERS: Only if user has broker profiles
      if (hasBrokers) {
        $('blkLocalBrokers').classList.remove('hidden');
        fillProfileDropdown($('brokerProfiles'), brokers, brokerLabel);
        $('brokerStatusText').textContent = getStatusSummary(brokers, 'broker') + ' — $100/month per ZIP (exclusive)';
        
        // Manage Subscription button - calls Cloud Function
        const manageBtn = $('brokerManageBtn');
        if (manageBtn) {
          manageBtn.href = '#';
          manageBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await openStripePortal(emailLower, 'Local Broker');
          });
        }
      }

      // LOCAL SERVICE PROVIDERS: Only if user has service provider profiles
      if (hasServiceProviders) {
        $('blkServiceProviders').classList.remove('hidden');
        fillProfileDropdown($('serviceProviderProfiles'), serviceProviders, serviceProviderLabel);
        $('serviceProviderStatusText').textContent = getStatusSummary(serviceProviders, 'service') + ' — $5/month per ZIP';
        
        // Manage Subscription button - calls Cloud Function
        const manageBtn = $('serviceProviderManageBtn');
        if (manageBtn) {
          manageBtn.href = '#';
          manageBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await openStripePortal(emailLower, 'Service Provider');
          });
        }
      }

      // UNIFIED LISTINGS TABLE WITH STATUS DROPDOWN
      if (hasListings) {
        renderListingsTable(all, canEditAsSeller, canEditAsAgent);
      }

      // Debug role summary (hidden by default)
      const rs = $('roleSummary');
      if (rs) {
        rs.textContent = `roles: seller=${hasSeller} agent=${hasAgent} localPros=${hasPros} localBrokers=${hasBrokers} serviceProviders=${hasServiceProviders} savedSearches=${hasSavedSearches}`;
        // rs.classList.remove('hidden'); // enable for debugging
      }

      console.log('[welcome] SECURE dashboard loaded', { 
        email: emailLower,
        hasSeller, hasAgent, hasListings, 
        hasPros, hasBrokers, hasServiceProviders, hasSubscriptions,
        hasSavedSearches, isNewUser
      });
    })();
  </script>
</body>
</html>
