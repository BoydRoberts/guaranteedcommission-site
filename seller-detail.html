<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ..thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 6px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
    .note { font-size: 12px; }
    .chip { font-size: 11px; padding:2px 6px; border-radius:9999px; background:#f3f4f6; color:#374151; }
    .badge { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#ecfccb; color:#166534; border:1px solid #bbf7d0; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <!-- Back button -->
      <button id="backBtnHdr" type="button" class="text-sm text-blue-600 hover:underline">&larr; Back</button>
      <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Top row: 40 | 20 | 40 (we're using 2/3 + 1/3 here for seller flow) -->
    <section id="topRow" class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start">

      <!-- Left: LISTING DETAILS -->
      <article id="tileCard" class="lg:col-span-3 card relative">
        <div class="tile-body space-y-1">
          <div class="flex items-center justify-between text-[16px] sm:text-[18px] font-semibold">
            <div id="tilePrice" class="truncate">$—</div>
            <div id="tileCommission" class="truncate text-red-600">Commission — | $—</div>
          </div>
          <div id="tileFacts" class="text-[12px] text-gray-700">— bds | — ba | — sqft | Draft</div>
          <div id="tileAddress" class="text-sm font-medium">[full address]</div>
          <div id="tileContact" class="text-[12px] text-gray-600">[LISTING BROKERAGE] — [listing agent] — [agent phone]</div>

          <div class="mt-4 border-t pt-4">
            <form id="sellerForm" class="space-y-5" autocomplete="off">

              <!-- Read-only address -->
              <div>
                <label class="block text-sm font-semibold mb-1">Full Property Address</label>
                <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
              </div>

              <!-- Status -->
              <div>
                <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
                <select id="status" class="w-full border p-2 rounded" required>
                  <option value="">Select…</option>
                  <option>Active</option>
                  <option>In Contract</option>
                  <option>Sold</option>
                </select>
              </div>

              <!-- Price & Commission -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
                  <input id="price" type="number" min="0" step="1000" placeholder="e.g., 2000000" class="w-full b}order p-2 rounded">
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
                  <div class="flex gap-2">
                    <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
                    <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50" readonly>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">To change commission, cancel this listing and create a new Plus listing.</p>
                </div>
              </div>

              <!-- Property Details -->
              <div>
                <label class="block text-sm font-semibold mb-1">Property Facts</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
                    <input id="breakfast" class="hidden" />
                    <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full b}order p-2 rounded">
                  </div>
                  <div>
                    <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
                    <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full b}order p-2 rounded">
                  </div>
                  <div>
                    <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
                    <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 1860" class="w-full b}order p-2 rounded">
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                  <span class="block text-xs text-gray-600 mb-1">Year Built</span>
                  <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1976" class="w-full b}order p-2 rounded">
                </div>
                <div>
                  <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
                  <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 5000" class="w-full b}order p-2 rounded">
                </div>
                <div>
                  <span class="block text-xs text-gray-600 mb-1">Property Type</span>
                  <input id="propertyType" class="w-full b}order p-2 rounded" placeholder="e.g., Single Family">
                </div>
              </div>

              <!-- APN -->
              <div>
                <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
                <input id="apn" class="w-full b}order p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
              </div>

              <!-- Photos -->
              <div>
                <label class="block text-sm font-semibold mb-1">Photos</label>
                <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>
                <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" multiple class="block">
                <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
                <p class="text-xs text-gray-500 mt-2">Click a thumbnail or use the buttons to set primary, replace, or delete.</p>
              </div>

              <!-- Description -->
              <div>
                <label class="block text-sm font-semibold mb-1">Full Property Description</label>
                <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full b}order p-2 rounded"></textarea>
                <p id="descGateNote" class="lock-note mt-1 hidden">Purchase Banner to enable this field.</p>
              </div>

              <!-- Banner / Placement -->
              <div>
                <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
                <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1–4)" class="w-full b}order p-2 rounded">
                <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
                <input id="preferredArea" placeholder="e.g., Newport Beach, Harbor View" class="w-full b}order p-2 rounded">
              </div>

              <div>
                <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
                <input id="pinArea" placeholder="e.g., Newport Beach, Eastbluff" class="w-full b}order p-2 rounded">
              </div>

              <!-- Seller/Agent info -->
              <div id="listedBlock" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
                  <input id="brokerage" class="w-full b}order p-2 rounded">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
                  <input id="agentName" class="w-full b}order p-2 rounded">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
                  <input id="agentEmail" type="email" class="w-full b}order p-2 rounded">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
                  <input id="agentPhone" class="w-full b}order p-2 rounded">
                </div>
              </div>

              <div class="pt-2 grid grid-cols-2 gap-2">
                <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
                <a id="previewLink" href="/listing.html" class="text-center px-4 py-2 rounded bg-green-600 text-white">Preview Full Listing Detail</a>
              </div>
            </form>
          </div>
        </div>
      </article>

      <!-- Right: PROMO / UPGRADES -->
      <aside class="lg:col-span-2">
        <!-- Promo -->
        <section class="bg-white rounded shadow p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">November Free Promo</h2>
            <span id="promoBadge" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">Inactive</span>
          </div>
          <p class="text-sm text-gray-600 mt-2">
            Listing agents can upgrade to Listed Property Plus, add a Banner, and Pin Placement for FREE in November.
          </p>
          <button id="upgradeToPlusBtn" class="mt-3 w-full bg-indigo-600 text-white px-3 py-2 rounded">
            Upgrade to Plus Now
          </button>
          <p class="text-xs text-gray-500 mt-2">This will update your plan immediately; charges (if any) are handled at Checkout.</p>
        </section>

        <!-- Upgrades -->
        <section class="bg-white rounded shadow p-5">
          <h2 class="text-lg font-semibold">Upgrades</h2>
          <p class="text-sm text-gray-600">Free pricing applies if November Promo is active (agent payer).</p>
          <div id="upgradesBox" class="mt-4 space-y-3 text-sm"></div>
          <div class="mt-4 flex items-center gap-2">
            <button id="updateUpgradesBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Update Upgrades</button>
            <button id="goVoteConf" class="hidden"></button>
            <button id="goCheckoutBtn" class="px-3 py-2 rounded border">Go to Checkout</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Purchases are final. Paid items show “paid by agent.”</p>
        </section>
      </aside>
    </section>

    <!-- LOWER SECTION: Local Pros -->
    <section class="card p-5 hidden" id="prosCard">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Local Professionals in <span id="prosZip">—</span></h3>
        <a id="prosCtaBtn" href="/local-professionals.html" class="text-sm px-3 py-1 rounded border hover:bg-gray-50">Local Professionals</a>
      </div>
      <div id="prosList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
      <div id="prosEmpty" class="hidden text-sm text-gray-600 mt-2">
        No local professionals yet. <a id="prosEmptyLink" class="underline text-blue-600" href="/local-professionals.html">Become a Local Professional</a>.
      </div>
    </section>

  </main>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <!-- Back button wiring -->
  <script>
    (function(){
      const btn = document.getElementById('backBtnHdr');
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          const ref = document.referrer || "";
          if (history.length > 1 && ref && ref !== location.href) {
            history.back();
          } else {
            window.location.href = "/index.html#strip2Search";
          }
        } catch (_) {
          window.location.href = "/index.html#strip2Search";
        }
      });
    })();
  </script>

  <!-- Seller page logic -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const plural = (n,a,b)=> n===1 ? a : b;

    function setStatus(msg, ok=true) {
      const el = $("statusBar");
      if (!el) return;
      el.textContent = msg || '';
      el.className = ok ? "mt-2 text-sm text-gray-600" : "mt-2 text-sm text-red-700";
    }

    function parseZipFromAddress(addr="") {
      const m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
      return m ? m[1] : "";
    }

    async function loadLocalPros(zip) {
      try {
        const q1 = query(
          collection(db, "localPros"),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        const snap = await getDocs(q1);
        const all = [];
        snap.forEach(d => all.push({ id: d.id, ...d.data() }));
        const agents = all.filter(p => String(p.role||"").toLowerCase()==="real_estate_agent").slice(0,3);
        const lenders = all.filter(p => String(p.role||"").toLowerCase()==="lender").slice(0,1);
        return { agents, lenders };
      } catch (e) {
        console.warn("[pros] fetch failed:", e);
        return { agents: [], lenders: [] };
      }
    }

    function renderProsSidebar(zip, agents=[], lenders=[]) {
      const card = $("prosList"); // using prosList as container for tiles
      const empty = $("prosEmpty");
      const zipSpan = $("prosZip");
      const ctaBtn = $("prosCtaBtn");

      if (zipSpan) zipSpan.textContent = zip || "—";
      if (ctažil) {}
    }
  </script>

  <!-- Seller logic continued -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.122.0/firebase-storage.js";

    // NOTE: This script extends the page logic for seller edit only (FSBO/Plus)

    const $s = (id) => document.getElementById(id);

    // ---------- ID hygiene ----------
    function cleanId(raw) {
      const m = String(raw || '').trim().match(/^[A-Za-z0-9_-]+/);
      return m ? m[0] : '';
    }

    const BUCKET_URL = "gs://guaranteedcommission-d4d91.firebasestorage.app";

    const listingId = localStorage.getItem("lastListingId") || "";
    if ($s("previewLink") && listingId) {
      $s("previewLink").href = "/listing.html?id=" + encodeURIComponent(listingId);
    }

    // ---------- Working state ----------
    let plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    let isPlus = (plan === "Listed Property Plus" || plan.includes("FSBO"));
    let maxPhotos = isPlus ? 20 : 1;
    let photos = [];
    let primaryIndex = 0;

    // ---------- Upload helper ----------
    // Use explicit bucket (matches your CORS setup)
    import { getStorage as gcsGetStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    const storage = gcsGetStorage(undefined, BUCKET_URL);

    async function uploadOne(file) {
      const safeName = String(file.name || "photo"); // keep original filename if present
      const path = `listings/${listingId}/photos/${Date.now()}_${safeName}`;
      const r = ref(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      return url;
    }

    function computePhotoHelp() {
      const remaining = Math.max(0, maxPhotos - (photos?.length || 0));
      const ph = $s("photoHelp");
      if (ph) {
        ph.textContent = isPlus
          ? `You can add up to ${remaining} more ${plural(remaining,"photo","photos")}.`
          : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
      }
    }

    function clampPrimary() {
      if (!Array.isArray(photos) || photos.length === 0) {
        primary = 0;
        return;
      }
      if (primary > photos.length - 1) {
        primary = Math.max(0, photos.length - 1);
      }
    }

    function renderThumbs() {
      const grid = $s("photoGrid");
      if (!grid) return;
      grid.innerHTML = "";

      if (!photos.length) {
        const p = document.createElement("p");
        p.className = "text-sm text-gray-600";
        p.textContent = "No photos yet.";
        grid.appendChild(p);
        computePhotoHelp();
        return;
      }

      const ordered = photos.map((u, i) => ({ u, i }));
      if (primaryIndex > 0) {
        const [p0] = ordered.splice(primaryIndex, 1);
        ordered.unshift(p0);
      }

      ordered.forEach(({ u, i }, idx) => {
        const row = document.createElement("div");
        row.className = "flex items center gap-3";

        const img = new Image();
        img.src = u;
        img.alt = `Photo ${idx + 1}`;
        img.className = "thumb border " + (i === primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = i === primaryIndex ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", async () => {
          primaryIndex = i;
          await savePhotosField(true);
        });

        const btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        if (i === primaryIndex) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "Primary";
          btns.appendChild(badge);
        } else {
          const bPrimary = document.createElement("button");
          bPrimary.type = "button";
          bPrimary.className = "px-2 py-1 border rounded";
          bPrimary.textContent = "Set Primary";
          bPrimary.onclick = async () => { primaryIndex = i; await savePhotosField(true); };
          btns.appendChild(bPrimary);
        }

        const bReplace = document.createElement("button");
        bප් = document.createElement("button");
      });
    }
  </script>
</body>
</html>
