<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Your Listing Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .font-cursive { font-family: "Brush Script MT", cursive; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded-2xl shadow">
    <div class="flex items-start justify-between">
      <h1 class="text-2xl font-bold">Complete Your Listing Details</h1>
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">Back to Home</a>
    </div>

    <p class="text-sm text-gray-600 mt-1">
      These details appear on your public listing. You can edit most fields later. (Commission changes require a new ISC.)
    </p>

    <hr class="my-5"/>

    <!-- Plan pill -->
    <div id="planPill" class="inline-block text-xs font-semibold px-2 py-1 rounded bg-gray-200 text-gray-700"></div>

    <!-- Optional upgrade card for Basic -->
    <div id="upgradeCard" class="hidden mt-4 bg-blue-50 border border-blue-200 rounded p-3">
      <p class="text-sm">
        <strong>Upgrade (Seller Pays):</strong>
        <span class="text-gray-700">Upgrade to Listed Property Plus ($20) to display a full property description and up to 20 photos.</span>
      </p>
      <div class="mt-2">
        <button id="upgradePlusBtn" type="button" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Upgrade to Plus</button>
      </div>
    </div>

    <form id="sellerForm" class="mt-4 space-y-4" autocomplete="off">
      <!-- Address (read-only from Box 2) -->
      <div>
        <label class="block text-sm font-semibold mb-1">Full Property Address</label>
        <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
      </div>

      <!-- APN / Parcel -->
      <div>
        <label class="block text-sm font-semibold mb-1">Parcel # / PIN # / Tax ID # / Folio # / APN #</label>
        <input id="apn" type="text" class="w-full border p-2 rounded" placeholder="Optional (required for FSBO Plus)">
        <p id="apnHelp" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <!-- Status (required) -->
      <div>
        <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
        <select id="status" required class="w-full border p-2 rounded">
          <option value="">Select status…</option>
          <option value="active">Active</option>
          <option value="in_contract">In Contract</option>
          <option value="sold">Sold</option>
        </select>
      </div>

      <!-- Price & Commission (commission locked; price editable) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
          <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
          <div class="flex gap-2">
            <input id="commission" type="number" min="0" step="0.01" class="w-full border p-2 rounded bg-gray-50" readonly>
            <select id="commissionType" class="border p-2 rounded bg-gray-50" disabled>
              <option value="%">%</option>
              <option value="$">$</option>
            </select>
          </div>
          <p class="text-xs text-gray-500 mt-1">To change commission, you must cancel and create a new listing.</p>
        </div>
      </div>

      <!-- Calculated Commission -->
      <div class="bg-gray-50 border rounded p-3 text-sm">
        <strong>Calculated Commission: </strong>
        <span id="commissionCalc">$0</span>
      </div>

      <!-- Description (Plus / FSBO Plus only) -->
      <div id="descBlock">
        <label class="block text-sm font-semibold mb-1">Full Property Description</label>
        <textarea id="description" rows="6" placeholder="Enter full property description (Plus only)" class="w-full border p-2 rounded"></textarea>
        <p class="text-xs text-gray-500 mt-1">Up to 2,500 characters.</p>
      </div>

      <!-- Banner (optional) -->
      <div>
        <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
        <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1–4)" class="w-full border p-2 rounded">
        <p class="text-xs text-gray-500 mt-1">Appears as a small ribbon on the listing tile.</p>
      </div>

      <!-- Beds / Baths / SqFt -->
      <div class="grid grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Bedrooms</label>
          <input id="beds" type="number" min="0" step="1" class="w-full border p-2 rounded" placeholder="e.g., 3">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Bathrooms</label>
          <input id="baths" type="number" min="0" step="0.5" class="w-full border p-2 rounded" placeholder="e.g., 2">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Square Feet</label>
          <input id="sqft" type="number" min="0" step="10" class="w-full border p-2 rounded" placeholder="e.g., 1800">
        </div>
      </div>

      <!-- Photos -->
      <div>
        <label class="block text-sm font-semibold mb-2">Photos</label>
        <div class="text-xs text-gray-600 mb-2" id="photoHelp"></div>
        <input id="photoInput" type="file" accept="image/*" multiple class="block">
        <div id="photoGrid" class="flex flex-wrap gap-2 mt-3"></div>
        <p class="text-xs text-gray-500 mt-2">Tip: click a thumbnail to set it as the primary photo.</p>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-2 pt-2">
        <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
        <a href="/seller-preview.html" class="bg-green-600 text-white px-4 py-2 rounded">Preview</a>
      </div>
    </form>
  </div>

  <script>
    // ---------- State / helpers ----------
    const PLAN = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const formData = (function(){ try { return JSON.parse(localStorage.getItem("formData") || "{}"); } catch { return {}; } })();
    const SELLER_KEY = "sellerListing";

    const sellerListing = (function(){
      try { return JSON.parse(localStorage.getItem(SELLER_KEY) || "{}"); }
      catch { return {}; }
    })();

    const $ = (id) => document.getElementById(id);

    function saveSellerListing(payload){
      localStorage.setItem(SELLER_KEY, JSON.stringify(payload || {}));
    }

    function computeCommissionAmount(price, commission, type){
      const p = Number(price || 0);
      const c = Number(commission || 0);
      if (type === "%") return Math.round(p * (c / 100));
      return Math.round(c);
    }

    // ---------- Init ----------
    function init(){
      $("planPill").textContent = PLAN;

      // Upgrade card shown only for Basic
      if (PLAN === "Listed Property Basic") {
        $("upgradeCard").classList.remove("hidden");
      }

      // Address from Box 2
      $("fullAddress").value = formData.address || "";

      // APN (prefill from Box 2 if present)
      $("apn").value = sellerListing.apn ?? (formData.apn || "");
      $("apnHelp").textContent = (PLAN === "FSBO Plus")
        ? "Required for FSBO Plus."
        : "Optional (your agent can add this later).";

      // Status
      $("status").value = sellerListing.status ?? "";

      // Commission (locked) from Box 2
      $("commission").value = sellerListing.commission ?? (formData.commission || "");
      $("commissionType").value = sellerListing.commissionType ?? (formData.commissionType || "%");

      // Price (editable)
      $("price").value = sellerListing.price ?? "";

      // Description gate (Plus / FSBO Plus only)
      const isPlus = (PLAN === "Listed Property Plus" || PLAN === "FSBO Plus");
      $("descBlock").style.display = isPlus ? "block" : "none";
      $("description").value = sellerListing.description ?? "";

      // Banner
      $("bannerText").value = sellerListing.bannerText ?? "";

      // Beds/Baths/Sqft
      $("beds").value  = sellerListing.beds ?? "";
      $("baths").value = sellerListing.baths ?? "";
      $("sqft").value  = sellerListing.sqft ?? "";

      // Photos help & limit
      const maxPhotos = isPlus ? 20 : 1;
      $("photoHelp").textContent = isPlus
        ? "You can upload up to 20 photos."
        : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";

      // Render thumbs
      renderThumbs(sellerListing.photos || [], sellerListing.primaryIndex || 0);

      // Initial commission calc
      refreshCommissionCalc();
    }

    function renderThumbs(photos, primaryIndex) {
      const grid = $("photoGrid");
      grid.innerHTML = "";
      photos.forEach((src, idx) => {
        const img = new Image();
        img.src = src;
        img.alt = "Photo " + (idx + 1);
        img.className = "thumb border " + (idx === primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (idx === primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", () => {
          const data = getPayload();
          data.primaryIndex = idx;
          saveSellerListing(data);
          renderThumbs(data.photos || [], data.primaryIndex || 0);
        });
        grid.appendChild(img);
      });
    }

    function getPayload(){
      const isPlus = (PLAN === "Listed Property Plus" || PLAN === "FSBO Plus");
      const maxPhotos = isPlus ? 20 : 1;

      const data = {
        // identity
        plan: PLAN,
        address: formData.address || "",
        // listing fields
        apn: $("apn").value.trim(),
        status: $("status").value,
        price: $("price").value,
        commission: $("commission").value,         // locked
        commissionType: $("commissionType").value, // locked
        description: $("description").value,
        bannerText: $("bannerText").value,
        beds: $("beds").value,
        baths: $("baths").value,
        sqft: $("sqft").value,
        // photos
        photos: (sellerListing.photos || []).slice(0, maxPhotos),
        primaryIndex: typeof sellerListing.primaryIndex === "number" ? sellerListing.primaryIndex : 0
      };
      return data;
    }

    function refreshCommissionCalc(){
      const amt = computeCommissionAmount($("price").value, $("commission").value, $("commissionType").value);
      $("commissionCalc").textContent = `$${(amt || 0).toLocaleString()}`;
    }

    // ---------- Events ----------
    ["status","price","description","bannerText","beds","baths","sqft","apn"].forEach(id => {
      $(id).addEventListener("input", () => {
        if (id === "price") refreshCommissionCalc();
        const data = getPayload();
        // For photos, we keep the existing arrays already in sellerListing; this keeps typed fields in sync
        data.photos = sellerListing.photos || [];
        data.primaryIndex = sellerListing.primaryIndex || 0;
        saveSellerListing(data);
      });
    });

    $("saveBtn").addEventListener("click", () => {
      // Validate APN for FSBO Plus
      if (PLAN === "FSBO Plus" && !$("apn").value.trim()) {
        alert("Please enter the Parcel / APN (required for FSBO Plus).");
        $("apn").focus();
        return;
      }
      // Validate status
      if (!$("status").value) {
        alert("Please select a Status (Active, In Contract, or Sold).");
        $("status").focus();
        return;
      }
      const data = getPayload();
      saveSellerListing(data);
      alert("Saved.");
    });

    $("photoInput").addEventListener("change", async (e) => {
      const isPlus = (PLAN === "Listed Property Plus" || PLAN === "FSBO Plus");
      const maxPhotos = isPlus ? 20 : 1;

      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const existing = sellerListing.photos || [];
      let spaceLeft = maxPhotos - existing.length;
      if (spaceLeft <= 0) {
        alert(`You have reached the photo limit for your plan (${maxPhotos}).`);
        e.target.value = "";
        return;
      }

      const toRead = files.slice(0, spaceLeft);
      const readAsDataURL = (file) => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      for (const f of toRead) {
        try {
          const dataUrl = await readAsDataURL(f);
          existing.push(dataUrl);
        } catch (err) {
          console.error("Failed to read file", err);
        }
      }

      sellerListing.photos = existing.slice(0, maxPhotos);
      if (typeof sellerListing.primaryIndex !== "number") sellerListing.primaryIndex = 0;

      // persist + re-render
      const data = getPayload();
      data.photos = sellerListing.photos;
      data.primaryIndex = sellerListing.primaryIndex;
      saveSellerListing(data);
      renderThumbs(data.photos, data.primaryIndex);

      e.target.value = "";
    });

    // Upgrade to Plus (Seller pays)
    $("upgradePlusBtn").addEventListener("click", () => {
      const checkoutData = {
        plan: "Listed Property Plus",
        upgrades: {},           // no add-ons here; pure plan upgrade
        prices: { plus:20, banner:10, premium:10, pin:50, fsbo:100, confidential:100 },
        base: 20,
        total: 20,
        payer: "seller"         // return path: seller-detail
      };
      localStorage.setItem("checkoutData", JSON.stringify(checkoutData));
      window.location.href = "/checkout.html";
    });

    // ---------- Start ----------
    init();
  </script>
</body>
</html>
