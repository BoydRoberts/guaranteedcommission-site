<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail Intake (Seller)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
    .badge { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#ecfccb; color:#166534; border:1px solid #bbf7d0; }

    /* Full-bleed business card in sidebar (Local Professionals) */
    .lp-card { position: relative; width:100%; aspect-ratio: 1.75; border-radius: 0.5rem; overflow: hidden; background:#fff; box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .lp-card img { width:100%; height:100%; object-fit: contain; display:block; background:#fff; }
    .lp-share { position:absolute; left:0.5rem; right:0.5rem; bottom:0.5rem; display:flex; justify-content:space-between; }
    .lp-btn { background:#fff; border:1px solid #e5e7eB; border-radius:6px; padding:.25rem .5rem; font-size:12px; box-shadow:0 1px 3px rgba(0,0,0,.12); }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="/index.html" class="text-sm text-blue-600 hover:underline">&larr; Home</a>
        <button
          class="text-sm px-2 py-1 rounded border hover:bg-gray-50"
          onclick="document.referrer ? history.back() : (window.location.href='/view.html')">
          Back
        </button>
      </div>
      <h1 class="text-lg font-semibold">Listing Detail Intake (Seller)</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6 px-3">

    <!-- LEFT: Intake form -->
    <section class="lg:col-span-2 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm">
          <span class="mr-2">Plan:</span><span id="planPill" class="pill">—</span>
        </p>
        <p id="whoLine" class="text-xs text-gray-600"></p>
      </div>

      <hr class="my-4"/>

      <form id="sellerForm" class="space-y-5" autocomplete="off">
        <!-- Address (read-only from Box 2) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Address</label>
          <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
        </div>

        <!-- Status (required) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
          <div class="mt-1">
            <select id="status" class="w-full border p-2 rounded" required>
              <option value="">Select…</option>
              <option>Active</option>
              <option>In Contract</option>
              <option>Sold</option>
            </select>
          </div>
        </div>

        <!-- Price & Commission (commission locked: change requires new listing) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
            <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
            <div class="flex gap-2">
              <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
              <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50 text-center" readonly>
            </div>
            <p class="text-xs text-gray-500 mt-1">To change commission, cancel this listing and create a new Plus listing.</p>
          </div>
        </div>

        <!-- Property Facts -->
        <div>
          <label class="block text-sm font-semibold mb-1">Property Facts</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
              <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
              <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
              <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 1860" class="w-full border p-2 rounded">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Year Built</span>
              <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1972" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
              <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 6000" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-sm font-semibold mb-1">Property Type</span>
              <select id="propertyType" class="w-full border p-2 rounded">
                <option value="">Select…</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- APN / Parcel (optional here; required earlier for FSBO) -->
        <div>
          <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
          <input id="apn" class="w-full border p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
          <p id="apnReqMsg" class="text-xs text-gray-500 mt-1 hidden">FSBO requires an APN/Parcel value.</p>
        </div>

        <!-- Photos -->
        <div>
          <label class="block text-sm font-semibold mb-1">Photos</label>
          <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>
          <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" multiple class="block">
          <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
          <p class="text-xs text-gray-500">Click a thumbnail or use the buttons to set primary, replace, or delete.</p>
        </div>

        <!-- Description (Plus/FSBO only; disabled for Listed Basic) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Description</label>
          <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full border p-2 rounded"></textarea>
          <p id="descGuild" class="lock-note mt-1 hidden">Upgrade to Listed Property Plus to enable Description.</p>
        </div>

        <!-- Banner / Preferred / Pin -->
        <div>
          <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
          <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1–4)" class="w-full border p-2 rounded">
          <p id="bannerGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
          <input id="preferredArea" placeholder="e.g., Newport Beach, Harbor View Homes" class="w-full border p-2 rounded">
          <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
          <input id="pinArea" placeholder="e.g., Newport Beach, Eastbluff" class="w-full border p-2 rounded">
          <p id="pinGateNote" class="lock-note mt-1 hidden">Purchase Pin Placement to enable this field.</p>
        </div>

        <!-- Listed-only: Brokerage/Agent confirms -->
        <div id="listedBlock" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
            <input id="brokerage" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
            <input id="agentName" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
            <input id="agentEmail" type="email" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
            <input id="agentPhone" class="w-full border p-2 rounded">
          </div>
        </div>

        <div class="pt-2 grid grid-cols-2 gap-2">
          <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
          <a id="previewLink" href="/listing.html" class="text-center px-4 py-2 rounded bg-green-600 text-white">Preview Full Listing Detail</a>
        </div>
      </form>
    </section>

    <!-- RIGHT: Sidebars -->
    <aside class="space-y-4">
      <!-- Upgrade to Plus (will be hidden on FSBO in JS) -->
      <section id="upgradePlusCard" class="bg-white rounded shadow p-5">
        The current changes did not work. please redo it again
        <h2 class="text-lg font-semibold">The current changes did not work. please redo it again</h2>
        <p class="text-sm text-gray-600 mt-2">
          Unlock full description and up to 20 photos. You can still choose optional placements on Checkout.
        </p>
        <button id="upgradeToPlusBtn" class="mt-3 w-full bg-indigo-600 text-white px-3 py-2 rounded">
          Upgrade to Listed Property Plus Now
        </button>
        <p class="text-xs text-gray-500 mt-2">Charges (if any) are handled at Checkout.</p>
      </section>

      <!-- Local Professionals (vertical image-only + share buttons) -->
      <section id="prosSidebar" class="bg-white rounded shadow p-5 hidden lg:sticky lg:top-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Local Professionals in <span id="prosZip">—</span></h3>
          <a id="prosCtaBtn" href="/local-professionals.html" class="text-sm px-3 py-1 rounded border hover:bg-gray-50">Local Professionals</a>
        </div>
        <div id="prosList" class="space-y-3"></div>
        <div id="prosEmpty" class="hidden text-sm text-gray-600 mt-2">
          Your business card here. <a id="prosEmptyLink" href="/local-professionals.html" class="underline text-blue-600">Become a Local Professional</a>.
        </div>
      </section>

      <!-- Local Broker strip (single ad, sized not to crowd header, + share buttons) -->
      <section id="brokerStrip" class="bg-white rounded shadow p-5 hidden">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Local Real Estate Brokerage in <span id="brokerZip">—</span></h3>
          <a id="brokerCtaBtn" href="/local-brokers.html" class="text-sm px-3 py-1 rounded border hover:bg-gray-50">Local Brokers</a>
        </div>
        <div class="relative">
          <div id="brokerAd" class="w-full"></div>
          <div id="brokerShare" class="lp-share" style="display:none">
            <button id="brokerShareEmail" class="lp-btn">Share Email</button>
            <button id="brokerShareText" class="lp-btn">Share Text</button>
          </div>
        </div>
        <div id="brokerEmpty" class="hidden text-sm text-gray-600 mt-2">
          Your brokerage here. <a id="brokerEmptyLink" href="/local-brokers.html" class="underline text-blue-600">Reserve this ZIP</a>.
        </div>
      </section>
    </aside>

  </main>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <!-- SELLER PAGE LOGIC (Firestore + Storage; original flow preserved) -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ===== helpers =====
    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const plural = (n, a, b) => (n===1 ? a : b);

    function setStatus(msg, ok=true) {
      let el = document.getElementById("statusBar");
      if (!el) {
        const hdr = document.querySelector("header") || document.body;
        el = document.createElement("p");
        el.id = "statusBar";
        el.className = "mt-2 text-sm";
        hdr.appendChild(el);
      }
      el.textContent = (msg || "").replace(/\u00A0/g,' ');
      el.className = ok ? "mt-2 text-sm text-gray-600" : "mt-2 text-sm text-red-700";
    }

    // Share helpers (simple)
    function shareEmail(subject, url){
      const a = document.createElement('a');
      a.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(url)}`;
      a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>{try{document.body.removeChild(a)}catch{}},0);
    }
    function shareText(label, url){
      const msg = `${label}\n\n${url}`;
      window.location.href = `sms:&body=${encodeURIComponent(msg)}`;
    }

    // START local-pros: helpers to parse ZIP and load pros/broker (unchanged)
    function parseZipFromAddress(addr="") {
      const m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
      return m ? m[1] : "";
    }

    async function loadLocalPros(zip) {
      try {
        const q1 = query(
          collection(db, "localPros"),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        const snap = await getDocs(q1);
        const all = [];
        snap.forEach(d => all.push({ id: d.id, ...d.data() }));
        const agents = all.filter(p => String(p.role||"").toLowerCase().includes("agent")).slice(0,3);
        const lenders = all.filter(p => String(p.role||"").toLowerCase().includes("lender")).slice(0,1);
        return { agents, lenders };
      } catch (e) {
        console.warn("[pros] fetch failed:", e);
        return { agents: [], lenders: [] };
      }
    }

    // Sidebar rendering: image-only + share, no name/phone under the card
    function renderProsSidebar(zip, agents=[], lenders=[]) {
      const card = $("prosSidebar");
      if (!card) return;
      $("prosZip").textContent = zip || "—";
      $("prosCtaBtn").href = `/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=search`;
      $("prosEmptyLink").href = `/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=apply`;

      const list = $("prosList");
      const empty = $("prosEmpty");
      list.innerHTML = "";

      const items = [...agents, ...lenders];
      if (!items.length) {
        empty.classList.remove("hidden");
        card.classList.remove("hidden");
        return;
      }

      items.forEach(p => {
        const wrap = document.createElement("div");
        wrap.className = "lp-card";

        const img = document.createElement("img");
        img.src = p.photoUrl || p.imageUrl || p.cardUrl || p.photo || "";
        img.alt = p.name || "Local Professional";
        img.onerror = () => { img.style.objectFit = 'contain'; img.alt = 'No Image'; };

        const bar = document.createElement("div");
        bar.className = "lp-share";
        const mail = document.createElement("button");
        mail.className = "lp-btn"; mail.textContent = "Share Email";
        mail.onclick = e => { e.preventDefault(); shareEmail(`Local Professional in ${zip}`, `${location.origin}/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=search`); };
        const sms = document.createElement("button");
        sms.className = "lp-btn"; sms.textContent = "Share Text";
        sms.onclick = e => { e.preventDefault(); shareText(`Local Professional in ${zip}`, `${location.origin}/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=search`); };

        bar.appendChild(mail); bar.appendChild(sms);
        wrap.appendChild(img); wrap.appendChild(bar);
        list.appendChild(wrap);
      });

      empty.classList.add("hidden");
      card.classList.remove("hidden");
    }

    async function loadLocalBroker(zip) {
      try {
        const q1 = query(
          collection(db, "localBrokers"),
          where("status", "==", "active"),
          where("zip", "==", zip)
        );
        const snap = await getDocs(q1);
        if (snap.empty) return null;
        const d = snap.docs[0].data() || {};
        return { id: snap.docs[0].id, ...d };
      } catch (e) {
        console.warn("[broker] fetch failed:", e);
        return null;
      }
    }

    function renderBrokerStrip(zip, broker) {
      const strip = $("brokerStrip");
      if (!strip) return;
      const ad = $("brokerAd");
      const empty = $("brokerEmpty");
      const zipEl = $("brokerZip");
      const cta = $("brokerCtaBtn");
      const emptyLink = $("brokerEmptyLink");
      const shareWrap = $("brokerShare");
      const btnMail = $("brokerShareEmail");
      const btnSms = $("brokerShareText");

      if (zipEl) zipEl.textContent = zip || "—";
      if (cta) cta.href = `/local-brokers.html?zip=${encodeURIComponent(zip)}`;
      if (emptyLink) emptyLink.href = `/local-brokers.html?zip=${encodeURIComponent(zip)}&mode=apply`;

      ad landscaped
      ad.innerHTML = "";
      if (broker && (broker.photoUrl || broker.logoUrl)) {
        const img = document.createElement("img");
        img.src = broker.photoUrl || broker.logoUrl;
        img.alt = "Local Brokerage";
        img.className = "w-full h-40 sm:h-56 md:h-64 object-contain";
        img.onerror = () => {
          const ph = document.createElement("div");
          ph.className = "w-full h-40 sm:h-56 md:h-64 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
          ph.textContent = "No Logo";
          ad.appendChild(ph);
        };
        ad.appendChild(img);

        if (shareWrap && btnMail && btnSms) {
          shareWrap.style.display = 'flex';
          const link = `${location.origin}/local-brokers.html?zip=${encodeURIComponent(zip)}`;
          btnMail.onclick = e => { e.preventDefault(); shareEmail(`Local Real Estate Broker in ${zip}`, link); };
          btnSms.onclick  = e => { e.preventDefault(); shareText(`Local Real Estate Broker in ${zip}`, link); };
        }
        if (empty) empty.classList.add("hidden");
        strip.classList.remove("hidden");
      } else {
        if (empty) empty.classList.remove("hidden");
        if (shareWrap) shareWrap.style.display = 'none';
        strip.classList.remove("hidden");
      }
    }
    // END local-pros/broker

    // ===== ID hygiene (unchanged) =====
    function cleanId(raw) {
      const m = String(raw || "").trim().match(/^[A-Za-z0-9_-]+/);
      return m ? m[1] : "";
    }
    (function ensureCleanId(){
      const u = new URL(location.href);
      let raw = u.searchParams.get("id") || localStorage.getItem("lastListingId") || "";
      const cleaned = cleanId(raw);
      if (cleaned) {
        localStorage.setItem("lastListingId", cleaned);
        if (raw !== cleaned) {
          u.searchParams.set("id", cleaned);
          history.replaceState({}, "", u.toString());
        }
      }
    })();

    const listingId = localStorage.getItem("lastListingId") || "";
    if ($("previewLink") && listingId) $("previewLink").href = "/listing.html?id=" + encodeURIComponent(listingId);

    // ===== working state (unchanged) =====
    let plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    const isFSBO = plan.toLowerCase().includes("fsbo");
    let isPlus = (plan === "Listed Property Plus" || isFSBO);
    let maxPhotos = isPlus ? 20 : 1;

    let photos = [];
    let primaryIndex = 0;

    function computePhotoHelp() {
      const remaining = Math.max(0, maxPhotos - (photos?.length || 0));
      $("photoHelp").textContent = isPlus
        ? `You can add up to ${remaining} more ${plural(remaining,'photo','photos')}.`
        : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
    }
    function clampPrimary(){
      if (!Array.isArray(photos) || photos.length === 0) { primaryIndex = 0; return; }
      if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;
    }
    async function savePhotosField(thenRefresh=false){
      if (!listingId) return;
      try {
        clampPrimary();
        await updateDoc(doc(db, "listings", listingId), {
          photos: photos.slice(0, maxPhotos),
          primaryIndex: (typeof primaryIndex === "number" ? primaryIndex : 0),
          updatedAt: serverTimestamp()
        });
        if (thenRefresh) await refreshFromServer("Photos saved.");
      } catch (e) {
        console.warn("[seller] photos update failed", e);
        setStatus("Photos could not be saved.", false);
      }
    }
    function renderThumbs(){
      clampPrimary();
      const grid = $("photoGrid");
      grid.innerHTML = "";

      if (!photos.length) {
        const p = document.createElement("p");
        p.className = "text-sm text-gray-600";
        p.textContent = "No photos yet.";
        grid.appendChild(p);
        computePhotoHelp();
        return;
      }

      const ordered = photos.map((u,i)=>({u,i}));
      if (primaryIndex > 0) {
        const [prim] = ordered.splice(primaryIndex,1);
        ordered.unshift(prim);
      }

      ordered.forEach(({u,i}, idxDisplay)=>{
        const row = document.createElement("div");
        row.className = "flex items-center gap-3";

        const img = new Image();
        img.src = u;
        img.alt = "Photo " + (idxDisplay+1);
        img.className = "thumb border " + (i===primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (i===primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", async ()=>{
          primaryIndex = i;
          await savePhotosField(true);
        });

        const btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        if (i===primaryIndex) {
          const b = document.createElement("span");
          b.className = "badge";
          b.textContent = "Primary";
          btns.appendChild(b);
        } else {
          const bPrimary = document.createElement("button");
          bPrimary.type="button"; bPrimary.className="px-2 py-1 border rounded";
          bPrimary.textContent="Set Primary";
          bPrimary.onclick = async ()=>{ primaryIndex = i; await savePhotosField(true); };
          btns.appendChild(bPrimary);
        }

        const bReplace = document.createElement("button");
        bReplace.type="button"; bReplace.className="px-2 py-1 border rounded";
        bReplace.textContent="Replace";
        bReplace.onclick = ()=>{
          const input = document.createElement("input");
          input.type="file"; input.accept="image/*";
          input.onchange = async (e)=>{
            const file = e.target.files?.[0]; if (!file) return;
            setStatus("Uploading replacement…");
            try {
              const storage = getStorage(undefined, "gs://guaranteedcommission-d4d91.firebasestorage.app");
              const safe = String(file.name||"photo").replace(/[^\w\-.]+/g,"_");
              const r = ref(storage, `listings/${listingId}/photos/${Date.now()}_${safe}`);
              await uploadBytes(r, file);
              const url = await getDownloadURL(r);
              photos[i] = url;
              await savePhotosField(true);
            } catch (err) {
              console.warn(err);
              setStatus("Could not replace photo.", false);
            }
          };
          input.click();
        };

        const bDelete = document.createElement("button");
        bDelete.type="button"; bDelete.className="px-2 py-1 border rounded";
        bDelete.textContent="Delete";
        bDelete.onclick = async ()=>{
          if (!confirm("Remove this photo from the listing?")) return;
          photos.splice(i,1);
          if (primaryIndex >= photos.length) primaryIndex = Math.max(0, photos.length-1);
          await savePhotosField(true);
        };

        row.appendChild(img);
        row.appendChild(btns);
        grid.appendChild(row);
      });

      computePhotoHelp();
    }

    $("photoInput").addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      try {
        const remaining = Math.max(0, maxPhotos - photos.length);
        if (remaining <= 0) { alert(`You have reached the photo limit for your plan (${maxPhotos}).`); e.target.value=""; return; }
        const toUpload = files.slice(0, Math.max(0, remaining));

        setStatus("Uploading photo(s)…");
        for (const f of toUpload) {
          try {
            const storage = getStorage(undefined, "gs://guaranteedcommission-d4d91.firebasestorage.app");
            const safe = String(f.name||"photo").replace(/[^\w\-.]+/g,"_");
            const r = ref(storage, `listings/${listingId}/photos/${Date.now()}_${safe}`);
            await uploadBytes(r, f);
            const url = await getDownloadURL(r);
            photos.push(url);
          } catch (err) {
            console.warn("Upload failed", err);
            setStatus("Upload failed for one or more files.", false);
          }
        }
        await savePhotosField(true);
      } catch (err) {
        setStatus("Upload failed.", false);
      } finally {
        e.target.value = "";
      }
    });

    // ===== refresh all fields from server (restored) =====
    async function refreshFromServer(note=""){
      if (!listingId) { setStatus("No listing selected (missing id).", false); return; }

      try {
        const snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) { setStatus("Listing not found on server.", false); return; }
        const d = snap.data() || {};

        // plan & gates
        plan = d.plan || plan;
        const fsbo = String(plan).toLowerCase().includes("fsbo");
        isPlus = (plan === "Listed Property Plus" || fsbo);
        maxPhotos = isPlus ? 20 : 1;

        $("planPill").textContent = plan;
        $("fullAddress").value = d.address || "";
        $("status").value = d.status || "";
        $("price").value = d.price ?? "";
        $("commission").value = d.commission ?? "";
        $("commissionType").value = d.commissionType || "%";
        $("apn").value = d.apn || "";
        $("bedrooms").value = d.bedrooms ?? "";
        $("bathrooms").value = d.bathrooms ?? "";
        $("sqft").value = d.sqft ?? "";
        $("yearBuilt").value = d.yearBuilt ?? "";
        $("lotSize").value = d.lotSize ?? "";
        $("propertyType").value = d.propertyType || "";
        $("description").value = d.description || "";
        $("bannerText").value = d.bannerText || "";
        $("preferredArea").value = d.preferredArea || "";
        $("pinArea").value = d.pinArea || "";

        // hide listed-only block if FSBO
        $("listedBlock").style.display = fsbo ? "none" : "";
        // hide the upgrade card on FSBO
        if (fsbo) { $("upgradePlusCard")?.classList.add("gone"); $("upgradePlusCard")?.classList.add("hidden"); }

        // photos
        photos = Array.isArray(d.fsc) ? d.fsc : Array.isArray(d.photos) ? d.photos.slice(0, maxPhotos) : [];
        primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;

        if (!isPlus) {
          $("description").classList.add("dimmed");
          $("description").setAttribute("disabled","disabled");
          $("descGuild").classList.remove("hidden");
          $("photoHelp").textContent = "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
        } else {
          $("description").classList.remove("dimmed");
          $("description").removeAttribute("disabled");
          $("descGuild").classList.add("hidden");
          computePhotoHelp();
        }

        renderThumbs();
        setStatus(note || "Loaded from server.", true);
      } catch (e) {
        console.warn("[seller] load failed", e);
        setStatus("Could not load from server.", false);
      }
    }

    // ===== Save button: write fields to Firestore (unchanged) =====
    $("saveBtn").addEventListener("click", async ()=>{
      if (!listingId) { alert("No listing ID in this session."); return; }

      const planNow = (localStorage.getItem("selectedPlan") || plan || "").trim();
      const isFsboNow = planNow.toLowerCase().includes("fsbo");

      const update = {
        updatedAt: serverTimestamp(),
        status: $("status").value || "",
        price: Number($("price").value || 0) || "",
        apn: $("apn").value || "",
        bedrooms: $("bedrooms").value || "",
        bathrooms: $("bathrooms").value || "",
        sqft: $("sqft").value || "",
        yearBuilt: $("yearBuilt").value || "",
        lotSize: $("lotSize").value || "",
        propertyType: $("propertyType").value || "",
        description: $("description").disabled ? $("description").value : ($("description").value || ""),
        bannerText: $("bannerText").value || "",
        preferredArea: $("preferredArea").value || "",
        pinArea: $("pinArea").value || "",
        // listed-only fields blanked for FSBO
        brokerage: isFsboNow ? "" : ($("brokerage").value || ""),
        agentName: isFsboNow ? "" : ($("agentName").value || ""),
        agentEmail: isFsboNow ? "" : ($("agentEmail").value || ""),
        agentPhone: isFsboNow ? "" : ($("agentPhone").value || "")
      };

      try {
        // one-time zip backfill
        const curSnap = await getDoc(doc(db, "listings", listingId));
        const cur = curSnap.exists() ? (curSnap.data() || {}) : {};
        if (!cur.zip) {
          const addr = $("fullAddress").value || "";
          const m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
          const zip = m ? m[1] : "";
          if (zip) update.zip = zip;
        }
      } catch (e) {
        console.warn("[seller] zip backfill skipped:", e);
      }

      try {
        await updateDoc(doc(db, "lists") || doc(db, "listings", listingId) , update);
        await updateDoc(doc(db, "listings", listingId), update);
        await refreshFromServer("Saved to server.");
        alert("Saved.");
      } catch (e) {
        console.warn("[seller] update failed", e);
        setStatus("Could not save to server.", false);
        alert("Could not save. Try again.");
      }
    });

    // ===== Boot (unchanged apart from FSBO upgrade-card hide + pros/broker calls) =====
    (async function boot(){
      const who = (localStorage.getItem("loggedInEmail") || "").trim();
      $("whoLine").textContent = who ? `Logged in as ${who}` : "";

      const formData = getJSON("formData", {});
      if (formData?.address && !$("fullAddress").value) $("fullAddress").value = (formData.address || "").replace(/\u00A0/g,' ');

      await refreshFromServer();

      try {
        const addr = $("fullAddress").value || "";
        const zip = parseZipFromAddress(addr);
        if (zip) {
          const { agents, lenders } = await loadLocalPros(zip);
          renderProsSidebar(zip, agents, lenders);

          const broker = await loadLocalBroker(zip);
          renderBrokerStrip(zip, broker);
        }
      } catch(e) {
        console.warn("[local-pros/broker] sidebar/strip", e);
      }
    })();

    // ===== Upgrades UI (unchanged) =====
    (function wireUpgrades(){
      const checkoutData = getJSON("checkoutData", null) || {};
      function row(label, price, key) {
        const checked = !!(checkoutData.upgrades && checkoutData.upgrades[key]);
        return `
          <label class="flex items-center justify-between border rounded-lg px-3 py-2">
            <div>
              <span class="font-medium">${label}</span>
              <span class="text-gray-500"> — $${price}</span>
            </div>
            <input type="checkbox" data-key="${key}" class="h-4 w-4" ${checked?'checked':''}/>
          </label>
        `;
      }
      const box = document.getElementById("upgradesBox");
      if (box && checkoutData.prices) {
        const html = [
          row("Banner", checkoutData.prices.banner ?? 10, "banner"),
          row("Premium Placement", checkoutData.prices.premium ?? 10, "premium"),
          row("Pin Placement", checkoutData.prices.pin ?? 50, "pin")
        ].join("");
        box.innerHTML = html;
        box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          cb.addEventListener("change", (e)=>{
            const k = e.target.getAttribute("data-key");
            const checked = e.target.checked;
            checkoutData.upgrades = checkoutData.upgrades || {};
            if (k === "banner")  checkoutData.upgrades.banner  = checked;
            if (k === "premium") checkoutData.upgrades.premium = checked && !checkoutData.upgrades.pin;
            if (k === "pin") { 
              checkoutData.upgrades.pin = checked; 
              if (checked) checkoutData.upgrades.premium = true; 
            }
            setJSON("checkoutData", checkoutData);

            if (k === "banner") {
              $("bannerText").disabled = !checked && !isPlus;
              $("bannerText").classList.toggle("dimmed", (!checked && !isPlus));
            }
            if (k === "premium" || k === "pin") {
              const premOn = (checkoutData.upgrades.premium || checkoutData.upgrades.pin);
              $("preferredArea").disabled = !premOn;
              $("preferredArea").classList.toggle("is-appointed to redo theme", !premOn);
              $("preferredArea").classList.toggle("dimmed", !premOn);
              $("pinArea").disabled = !checkoutData.upgrades.pin;
              $("pinArea").classList.toggle("dimmed", !checkoutData.upgrades.pin);
            }
          });
        });
      }
      document.getElementById("goCheckoutBtn")?.addEventListener("click", ()=>{ window.location.href = "/checkout.html"; });
    })();
  </script>

</body>
</html>
