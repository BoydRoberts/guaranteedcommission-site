<!DOCTYPE html>
<!-- seller-detail.html - Build 2025-12-18 (Fixed: Prevent Plus from carrying over to commission changes) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail Intake (Seller)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 72px; height: 72px; object-fit: cover; border-radius: 6px; }
    .dimmed { opacity: 0.5; pointer-events: none; }
    .lock-note { font-size: 12px; color:#6b7280; }
    .pill { font-size: 11px; padding: 2px 8px; border-radius: 9999px; background:#eef2ff; color:#3730a3; }
    .badge { font-size: 10px; padding:2px 6px; border-radius: 9999px; background:#ecfccb; color:#166534; border:1px solid #bbf7d0; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="/index.html" class="text-sm text-blue-600 hover:underline">Home</a>
      </div>
      <h1 class="text-lg font-semibold">Listing Detail Intake (Seller)</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-3 gap-6 px-3">

    <!-- LEFT: Intake form -->
    <section class="lg:col-span-2 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between">
        <p class="text-sm">
          <span class="text-gray-600">Plan:</span> <span id="planPill" class="pill">—</span>
        </p>
        <p id="whoLine" class="text-xs text-gray-600"></p>
      </div>

      <hr class="my-4"/>

      <form id="sellerForm" class="space-y-5" autocomplete="off">
        <!-- Address (read-only from Box 2) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Address</label>
          <input id="fullAddress" class="w-full border p-2 rounded bg-gray-50" type="text" readonly>
        </div>

        <!-- Status (required) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Status <span class="text-red-600">*</span></label>
          <select id="status" class="w-full border p-2 rounded" required>
            <option value="">Select...</option>
            <option>Active</option>
            <option>In Contract</option>
            <option>Sold</option>
          </select>
        </div>

        <!-- Price & Commission (commission locked: change requires payment) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Listing Price ($)</label>
            <input id="price" type="number" min="0" step="1000" placeholder="e.g., 850000" class="w-full border p-2 rounded">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Commission (locked)</label>
            <div class="flex gap-2">
              <input id="commission" class="w-full border p-2 rounded bg-gray-50" readonly>
              <input id="commissionType" class="w-20 border p-2 rounded bg-gray-50 text-center" readonly>
            </div>
            <p id="commissionLockNote" class="text-xs text-gray-500 mt-1">Commission is locked. Use "Change Commission" upgrade to modify.</p>
          </div>
        </div>

        <!-- Property Facts -->
        <div>
          <label class="block text-sm font-semibold mb-1">Property Facts</label>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bedrooms</span>
              <input id="bedrooms" type="number" min="0" step="1" placeholder="e.g., 3" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Bathrooms</span>
              <input id="bathrooms" type="number" min="0" step="0.5" placeholder="e.g., 2.5" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Square Footage</span>
              <input id="sqft" type="number" min="0" step="1" placeholder="e.g., 1860" class="w-full border p-2 rounded">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <span class="block text-xs text-gray-600 mb-1">Year Built</span>
              <input id="yearBuilt" type="number" min="1800" step="1" placeholder="e.g., 1972" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-xs text-gray-600 mb-1">Lot Size (sqft)</span>
              <input id="lotSize" type="number" min="0" step="1" placeholder="e.g., 6000" class="w-full border p-2 rounded">
            </div>
            <div>
              <span class="block text-sm font-semibold mb-1">Property Type</span>
              <select id="propertyType" class="w-full border p-2 rounded">
                <option value="">Select...</option>
                <option>Single Family</option>
                <option>Condo</option>
                <option>Townhouse</option>
                <option>Multi-Family</option>
                <option>Land</option>
                <option>Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- APN / Parcel (optional here; required earlier for FSBO) -->
        <div>
          <label class="block text-sm font-semibold mb-1">APN / Parcel #</label>
          <input id="apn" class="w-full border p-2 rounded" placeholder="Parcel # / Pin # / Tax ID # / Folio # / APN #">
          <p id="apnReqMsg" class="text-xs text-gray-500 mt-1">FSBO requires an APN/Parcel value.</p>
        </div>

        <!-- Photos -->
        <div>
          <label class="block text-sm font-semibold mb-1">Photos</label>
          <div id="photoHelp" class="text-xs text-gray-600 mb-2"></div>
          <input id="photoInput" type="file" accept=".png,.jpg,.jpeg" multiple class="block">
          <div id="photoGrid" class="flex flex-col gap-2 mt-3"></div>
          <p class="text-xs text-gray-500 mt-2">Click a thumbnail or use the buttons to set primary, replace, or delete.</p>
        </div>

        <!-- Description (Plus/FSBO only; disabled for Listed Basic) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Full Property Description</label>
          <textarea id="description" rows="6" placeholder="Enter full property description" class="w-full border p-2 rounded"></textarea>
          <p id="descGateNote" class="lock-note mt-1 hidden">Upgrade to Listed Property Plus to enable Description.</p>
        </div>

        <!-- Banner / Preferred / Pin -->
        <div>
          <label class="block text-sm font-semibold mb-1">Banner (optional)</label>
          <input id="bannerText" maxlength="30" placeholder="30 characters max (e.g., Open Sunday 1-4)" class="w-full border p-2 rounded">
          <p id="bannerGateNote" class="lock-note mt-1 hidden">Purchase Banner upgrade to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Preferred Placement Area (city/neighborhood)</label>
          <input id="preferredArea" placeholder="e.g., Newport Beach, Harbor View Homes" class="w-full border p-2 rounded">
          <p id="premiumGateNote" class="lock-note mt-1 hidden">Purchase Premium Placement to enable this field.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-1">Pin Placement Area (city/neighborhood)</label>
          <input id="pinArea" placeholder="e.g., Newport Beach, Eastbluff" class="w-full border p-2 rounded">
          <p id="pinGateNote" class="lock-note mt-1 hidden">Purchase Pin Placement to enable this field.</p>
        </div>

        <!-- Listed-only: Brokerage/Agent confirms -->
        <div id="listedBlock">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Brokerage</label>
              <input id="brokerage" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Name</label>
              <input id="agentName" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Email</label>
              <input id="agentEmail" type="email" class="w-full border p-2 rounded">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Listing Agent Phone</label>
              <input id="agentPhone" class="w-full border p-2 rounded">
            </div>
          </div>
        </div>

        <div class="pt-2 grid grid-cols-2 gap-2">
            <button id="saveBtn" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Save</button>
            <a id="previewLink" href="/listing.html" class="text-center px-4 py-2 rounded bg-[#4DA6FF] text-white hover:bg-blue-500">Preview Full Listing Detail</a>
        </div>
      </form>
    </section>

    <!-- RIGHT: Upgrades + Local Pros -->
    <aside class="space-y-4">

      <section class="bg-white rounded shadow p-5">
        <h2 class="text-lg font-semibold">Upgrade your listing</h2>
        <div id="upgradesBox" class="mt-4 space-y-3 text-sm"></div>
        <div class="mt-4">
          <button id="goCheckoutBtn" class="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Go to Checkout</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Purchases are final.</p>
      </section>

      <!-- Vertical Local Professionals (sticky) -->
      <section id="prosSidebar" class="bg-white rounded shadow p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Local Professionals in <span id="prosZip">—</span></h3>
          <a id="prosCtaBtn" href="/local-professionals.html" class="text-xs px-2 py-1 rounded bg-amber-600 text-white hover:bg-amber-700">Local Professionals</a>
        </div>
        <div id="prosList" class="space-y-3"></div>
        <div id="prosEmpty" class="hidden text-sm text-gray-600 mt-2">
          Your business card here. <a id="prosEmptyLink" href="/local-professionals.html" class="underline text-blue-600">Become a Local Professional</a>.
        </div>
      </section>
    </aside>

    <!-- Bottom Local Broker strip -->
    <section id="brokerStrip" class="lg:col-span-3 bg-white rounded shadow p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Local Real Estate Brokerage in <span id="brokerZip">—</span></h3>
        <a id="brokerCtaBtn" href="/local-brokers.html" class="text-sm px-3 py-1 rounded bg-amber-600 text-white hover:bg-amber-700">Local Brokers</a>
      </div>
      <div id="brokerAd" class="min-h-[140px] flex items-center justify-center bg-gray-50 rounded border border-gray-200"></div>
      <div id="brokerEmpty" class="hidden text-sm text-gray-600 mt-2">
        Your brokerage here. <a id="brokerEmptyLink" href="/local-brokers.html" class="underline text-blue-600">Reserve this ZIP</a>.
      </div>
    </section>

  </main>

  <!-- Change Commission Modal -->
  <div id="changeCommissionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md relative p-6">
      <button onclick="closeChangeCommissionModal()" class="absolute top-2 right-2 text-xl font-bold" aria-label="Close">&times;</button>
      
      <h2 class="text-lg font-bold mb-4">Change Commission</h2>
      <p class="text-sm text-gray-600 mb-4">Enter your new commission amount and type. After payment, you will sign a new Irrevocable Seller Communication with the updated commission.</p>
      
      <div class="space-y-4">
        <div class="flex gap-2">
          <input type="text" id="newCommission" placeholder="Commission amount (e.g., 2.5 or 5000)" class="flex-1 border p-2 rounded">
          <select id="newCommissionType" class="border p-2 rounded w-20">
            <option value="%">%</option>
            <option value="$">$</option>
          </select>
        </div>
        
        <div class="flex items-center justify-end gap-2">
          <button type="button" onclick="closeChangeCommissionModal()" class="px-4 py-2 rounded border">Cancel</button>
          <button id="confirmCommissionBtn" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Confirm New Commission</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Change Commission Modal helpers (non-module)
    function openChangeCommissionModal() {
      document.getElementById('changeCommissionModal').classList.remove('hidden');
    }
    function closeChangeCommissionModal() {
      document.getElementById('changeCommissionModal').classList.add('hidden');
    }
  </script>

  <!-- SELLER PAGE LOGIC (Firestore + Storage) -->
  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import { updatePaidUpgradesAfterPayment } from "/scripts/paid-upgrades-handler.js";
    
    import {
      doc, getDoc, updateDoc, serverTimestamp, collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Process paid upgrades FIRST (before any other logic)
    (async function() {
      if (window.__paidUpgradesHandled) return;
      window.__paidUpgradesHandled = true;
      
      try {
        const result = await updatePaidUpgradesAfterPayment();
        if (result.processed) {
          console.log('[seller-detail] Upgrades processed successfully');
        } else if (result.alreadyProcessed) {
          console.log('[seller-detail] Upgrades already processed');
        } else {
          console.log('[seller-detail] No paid upgrades to process');
        }
      } catch (e) {
        console.warn('[seller-detail] paid-upgrades-handler failed:', e);
      }
    })();

    // utilities
    var $ = function(id) { return document.getElementById(id); };
    var getJSON = function(k, fb) { try { return JSON.parse(localStorage.getItem(k)) || fb; } catch(e) { return fb; } };
    var setJSON = function(k, v) { localStorage.setItem(k, JSON.stringify(v)); };
    var plural = function(n, a, b) { return (n===1 ? a : b); };

    function setStatus(msg, ok) {
      if (ok === undefined) ok = true;
      var el = document.getElementById("statusBar");
      if (!el) {
        el = document.createElement("p");
        el.id = "statusBar";
        el.className = "mt-2 text-sm";
        var main = document.querySelector('main');
        if (main && main.parentNode) {
          main.parentNode.insertBefore(el, main);
        }
      }
      el.textContent = msg || "";
      el.className = ok ? "max-w-6xl mx-auto px-3 mt-2 text-sm text-gray-600" : "max-w-6xl mx-auto px-3 mt-2 text-sm text-red-700";
    }

    // Local pros / brokers helpers
    function parseZipFromAddress(addr) {
      addr = addr || "";
      var m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
      return m ? m[1] : "";
    }

    async function loadLocalPros(zip) {
      try {
        var q1 = query(
          collection(db, "localPros"),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        var snap = await getDocs(q1);
        var all = [];
        snap.forEach(function(d) { all.push({ id: d.id, ...d.data() }); });
        var agents  = all.filter(function(p) { return String(p.role||"").toLowerCase()==="real_estate_agent"; }).slice(0,3);
        var lenders = all.filter(function(p) { return String(p.role||"").toLowerCase()==="lender"; }).slice(0,1);
        return { agents: agents, lenders: lenders };
      } catch (e) {
        console.warn("[pros] fetch failed:", e);
        return { agents: [], lenders: [] };
      }
    }

    function renderProsSidebar(zip, agents, lenders) {
      agents = agents || [];
      lenders = lenders || [];
      var card = $("prosSidebar");
      if (!card) return;
      
      var currentPlan = plan.trim();
      var isFSBO = currentPlan.includes("FSBO");
      
      if (!isFSBO) {
        card.classList.add("hidden");
        return;
      }
      
      $("prosZip").textContent = zip || "—";
      $("prosCtaBtn").href = "/local-professionals.html?zip=" + encodeURIComponent(zip) + "&mode=search";
      $("prosEmptyLink").href = "/local-professionals.html?zip=" + encodeURIComponent(zip) + "&mode=apply";

      var list = $("prosList");
      var empty = $("prosEmpty");
      list.innerHTML = "";

      function noImageFSBO(){
        var ph = document.createElement("div");
        ph.className = "w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
        ph.textContent = "No Image";
        return ph;
      }
      
      function tileFSBO(p){
        var div = document.createElement("div");
        div.className = "overflow-hidden bg-white rounded-lg shadow-sm";
        var src = p.photoUrl || p.photo || "";
        if (src) {
          var img = document.createElement("img");
          img.src = src;
          img.alt = "Local Professional";
          img.className = "w-full h-40 object-contain bg-white";
          img.onerror = function() { img.replaceWith(noImageFSBO()); };
          div.appendChild(img);
        } else {
          div.appendChild(noImageFSBO());
        }
        return div;
      }

      var tiles = [];
      agents.forEach(function(a) { tiles.push(tileFSBO(a)); });
      lenders.forEach(function(l) { tiles.push(tileFSBO(l)); });

      if (tiles.length) {
        tiles.forEach(function(t) { list.appendChild(t); });
        empty.classList.add("hidden");
      } else {
        empty.classList.remove("hidden");
      }

      card.classList.remove("hidden");
    }

    async function loadLocalBroker(zip) {
      try {
        var q1 = query(
          collection(db, "localBrokers"),
          where("status","==","active"),
          where("zip","==", zip)
        );
        var s1 = await getDocs(q1);
        if (!s1.empty) {
          var x = s1.docs[0].data() || {};
          return { id: s1.docs[0].id, ...x };
        }
        var q2 = query(
          collection(db, "localBrokers"),
          where("status","==","active"),
          where("zips","array-contains", zip)
        );
        var s2 = await getDocs(q2);
        if (!s2.empty) {
          var x2 = s2.docs[0].data() || {};
          return { id: s2.docs[0].id, ...x2 };
        }
        return null;
      } catch (e) {
        console.warn("[broker] fetch failed:", e);
        return null;
      }
    }

    function renderBrokerStrip(zip, broker) {
      var strip = $("brokerStrip");
      if (!strip) return;
      
      var currentPlan = plan.trim();
      var isFSBO = currentPlan.includes("FSBO");
      
      if (!isFSBO) {
        strip.style.display = "none";
        return;
      }
      
      $("brokerZip").textContent = zip || "—";
      $("brokerCtaBtn").href = "/local-brokers.html?zip=" + encodeURIComponent(zip);
      $("brokerEmptyLink").href = "/local-brokers.html?zip=" + encodeURIComponent(zip) + "&mode=apply";

      var ad = $("brokerAd");
      var empty = $("brokerEmpty");
      ad.innerHTML = "";

      if (broker && (broker.photoUrl || broker.name)) {
        var img = document.createElement("img");
        img.src = broker.photoUrl || "";
        img.alt = broker.name || "Local Brokerage";
        img.className = "max-h-44 object-contain";
        img.onerror = function() {
          var ph = document.createElement("div");
          ph.className = "w-full h-44 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
          ph.textContent = "No Logo";
          ad.appendChild(ph);
        };
        ad.appendChild(img);
        empty.classList.add("hidden");
      } else {
        empty.classList.remove("hidden");
      }
      strip.style.display = "block";
    }

    // ID context
    function cleanId(raw) {
      var m = String(raw || "").trim().match(/^[A-Za-z0-9_-]+/);
      return m ? m[0] : "";
    }
    (function ensureId(){
      var u = new URL(location.href);
      var raw = u.searchParams.get("id") || localStorage.getItem("lastListingId") || "";
      var cleaned = cleanId(raw);
      if (cleaned) {
        localStorage.setItem("lastListingId", cleaned);
        if (raw !== cleaned) {
          u.searchParams.set("id", cleaned);
          history.replaceState({}, "", u.toString());
        }
      }
    })();

    var listingId = localStorage.getItem("lastListingId") || "";

    if ($("previewLink") && listingId) {
      $("previewLink").href = "/listing.html?id=" + encodeURIComponent(listingId);
    }

    // state
    var plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();
    var isFSBO = plan.includes("FSBO");
    var isPlus = (plan === "Listed Property Plus" || isFSBO);
    var maxPhotos = isPlus ? 20 : 1;

    var photos = [];
    var primaryIndex = 0;
    var paidUpgrades = {};

    function computePhotoHelp() {
      var remaining = Math.max(0, maxPhotos - (photos ? photos.length : 0));
      var el = $("photoHelp");
      if (el) {
        el.textContent = isPlus
          ? "You can add up to " + remaining + " more " + plural(remaining, "photo","photos") + "."
          : "Listed Property Basic: 1 primary photo allowed (upgrade to add more).";
      }
    }
    
    function clampPrimary(){
      if (!Array.isArray(photos) || photos.length === 0) { primaryIndex = 0; return; }
      if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;
    }
    
    function renderThumbs(){
      clampPrimary();
      var grid = $("photoGrid");
      if (!grid) return;
      grid.innerHTML = "";

      if (!photos.length) {
        var p = document.createElement("div");
        p.className = "text-sm text-gray-600";
        p.textContent = "No photos yet.";
        grid.appendChild(p);
        computePhotoHelp();
        return;
      }

      var ordered = photos.map(function(u,i) { return {u:u,i:i}; });
      if (primaryIndex > 0) {
        var prim = ordered.splice(primaryIndex,1)[0];
        ordered.unshift(prim);
      }

      ordered.forEach(function(item, idxDisplay){
        var u = item.u;
        var i = item.i;
        var row = document.createElement("div");
        row.className = "flex items-center gap-3";

        var img = new Image();
        img.src = u;
        img.alt = "Photo " + (idxDisplay+1);
        img.className = "thumb border " + (i===primaryIndex ? "border-green-500" : "border-gray-300");
        img.title = (i===primaryIndex) ? "Primary photo" : "Click to set as primary";
        img.addEventListener("click", async function(){
          primaryIndex = i;
          await savePhotosField(true);
        });

        var btns = document.createElement("div");
        btns.className = "flex items-center gap-2 text-xs";

        if (i===primaryIndex) {
          var badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = "Primary";
          btns.appendChild(badge);
        } else {
          var bPrimary = document.createElement("button");
          bPrimary.type="button"; bPrimary.className="px-2 py-1 border rounded";
          bPrimary.textContent="Set Primary";
          bPrimary.onclick = async function(){ primaryIndex = i; await savePhotosField(true); };
          btns.appendChild(bPrimary);
        }

        var bReplace = document.createElement("button");
        bReplace.type="button"; bReplace.className="px-2 py-1 border rounded";
        bReplace.textContent="Replace";
        bReplace.onclick = function(){
          var input = document.createElement("input");
          input.type="file"; input.accept="image/*";
          input.onchange = async function(e){
            var file = e.target.files ? e.target.files[0] : null; if (!file) return;
            setStatus("Uploading replacement...");
            try {
              var urlNew = await uploadOne(file);
              photos[i] = urlNew;
              await savePhotosField(true);
            } catch (err) {
              console.warn(err);
              setStatus("Could not replace photo.", false);
            }
          };
          input.click();
        };

        var bDelete = document.createElement("button");
        bDelete.type="button"; bDelete.className="px-2 py-1 border rounded";
        bDelete.textContent = "Delete";
        bDelete.onclick = async function(){
          if (!confirm("Remove this photo from the listing?")) return;
          photos.splice(i,1);
          if (primaryIndex >= photos.length) primaryIndex = Math.max(0, photos.length-1);
          await savePhotosField(true);
        };

        btns.appendChild(bReplace);
        btns.appendChild(bDelete);

        row.appendChild(img);
        row.appendChild(btns);
        grid.appendChild(row);
      });

      computePhotoHelp();
    }
    
    async function uploadOne(file){
      var storage = getStorage(undefined, STORAGE_BUCKET_GS);
      var safeName = String(file.name || "photo").replace(/[^\w\-.]+/g,"_");
      var path = "listings/" + listingId + "/photos/" + Date.now() + "_" + safeName;
      var r = ref(storage, path);
      await uploadBytes(r, file);
      var url = await getDownloadURL(r);
      return url;
    }

    async function savePhotosField(thenRefresh){
      if (!listingId) return;
      try {
        clampPrimary();
        await updateDoc(doc(db, "listings", listingId), {
          photos: photos.slice(0, maxPhotos),
          primaryIndex: (typeof primaryIndex === "number" ? primaryIndex : 0),
          updatedAt: serverTimestamp()
        });
        renderThumbs();
        computePhotoHelp();
        setStatus("Photos saved.", true);
      } catch (e) {
        console.warn("[seller] photos update failed", e);
        setStatus("Photos could not be saved.", false);
      }
    }

    var photoInput = $("photoInput");
    if (photoInput) {
      photoInput.addEventListener("change", async function(e){
        var files = Array.from(e.target.files || []);
        if (!files.length) return;

        try {
          var remaining = Math.max(0, maxPhotos - photos.length);
          if (remaining <= 0) { 
            alert("You have reached the photo limit for your plan (" + maxPhotos + ")."); 
            e.target.value=""; 
            return; 
          }
          var toUpload = files.slice(0, remaining);

          setStatus("Uploading photo(s)...");
          for (var idx = 0; idx < toUpload.length; idx++) {
            var f = toUpload[idx];
            try {
              var url = await uploadOne(f);
              photos.push(url);
            } catch (err) {
              console.warn("Upload failed", err);
              setStatus("Upload failed for one or more files.", false);
            }
          }
          await savePhotosField(true);
        } catch (err) {
          setStatus("Upload failed.", false);
        } finally {
          e.target.value = "";
        }
      });
    }

    // FIELD LOCKING LOGIC
    function applyFieldLocking(planName, paidUpgrades) {
      var isFSBO = planName.includes("FSBO");
      var isBasic = planName === "Listed Property Basic";
      var isPlus = planName === "Listed Property Plus";
      
      paidUpgrades = paidUpgrades || {};
      
      var descEl = $("description");
      var descNote = $("descGateNote");
      if (isBasic) {
        if (descEl) { descEl.classList.add("dimmed"); descEl.setAttribute("disabled","disabled"); }
        if (descNote) descNote.classList.remove("hidden");
      } else {
        if (descEl) { descEl.classList.remove("dimmed"); descEl.removeAttribute("disabled"); }
        if (descNote) descNote.classList.add("hidden");
      }
      
      var bannerEl = $("bannerText");
      var bannerNote = $("bannerGateNote");
      var bannerUnlocked = !!paidUpgrades.banner;
      
      if (bannerUnlocked) {
        if (bannerEl) { bannerEl.classList.remove("dimmed"); bannerEl.removeAttribute("disabled"); }
        if (bannerNote) bannerNote.classList.add("hidden");
      } else {
        if (bannerEl) { bannerEl.classList.add("dimmed"); bannerEl.setAttribute("disabled","disabled"); }
        if (bannerNote) bannerNote.classList.remove("hidden");
      }
      
      var premiumEl = $("preferredArea");
      var premiumNote = $("premiumGateNote");
      var premiumUnlocked = !!paidUpgrades.premium || !!paidUpgrades.pin;
      
      if (premiumUnlocked) {
        if (premiumEl) { premiumEl.classList.remove("dimmed"); premiumEl.removeAttribute("disabled"); }
        if (premiumNote) premiumNote.classList.add("hidden");
      } else {
        if (premiumEl) { premiumEl.classList.add("dimmed"); premiumEl.setAttribute("disabled","disabled"); }
        if (premiumNote) premiumNote.classList.remove("hidden");
      }
      
      var pinEl = $("pinArea");
      var pinNote = $("pinGateNote");
      var pinUnlocked = !!paidUpgrades.pin;
      
      if (pinUnlocked) {
        if (pinEl) { pinEl.classList.remove("dimmed"); pinEl.removeAttribute("disabled"); }
        if (pinNote) pinNote.classList.add("hidden");
      } else {
        if (pinEl) { pinEl.classList.add("dimmed"); pinEl.setAttribute("disabled","disabled"); }
        if (pinNote) pinNote.classList.remove("hidden");
      }
    }

    // refresh all fields from server
    async function refreshFromServer(note){
      if (!listingId) { 
        setStatus("No listing selected (missing id).", false); 
        return; 
      }

      try {
        var snap = await getDoc(doc(db, "listings", listingId));
        if (!snap.exists()) { 
          setStatus("Listing not found on server.", false); 
          return; 
        }
        var d = snap.data() || {};

        plan = d.plan || plan;
        isPlus = (plan === "Listed Property Plus" || plan.includes("FSBO"));
        isFSBO = plan.includes("FSBO");
        maxPhotos = isPlus ? 20 : 1;

        paidUpgrades = d.paidUpgrades || {};

        $("planPill").textContent = plan || "—";
        $("fullAddress").value = d.address || "";
        $("status").value = d.status || "";
        $("price").value = d.price != null ? d.price : "";
        $("commission").value = d.commission != null ? d.commission : "";
        $("commissionType").value = d.commissionType || "%";
        $("apn").value = d.apn || "";
        $("bedrooms").value = d.bedrooms != null ? d.bedrooms : "";
        $("bathrooms").value = d.bathrooms != null ? d.bathrooms : "";
        $("sqft").value = d.sqft != null ? d.sqft : "";
        $("yearBuilt").value = d.yearBuilt != null ? d.yearBuilt : "";
        $("lotSize").value = d.lotSize != null ? d.lotSize : "";
        $("propertyType").value = d.propertyType || "";
        $("description").value = d.description || "";
        $("bannerText").value = d.bannerText || "";
        $("preferredArea").value = d.preferredArea || "";
        $("pinArea").value = d.pinArea || "";
        $("brokerage").value = d.brokerage || "";
        $("agentName").value = d.agentName || "";
        $("agentEmail").value = d.agentEmail || "";
        $("agentPhone").value = d.agentPhone || "";

        if (plan.includes("FSBO")) {
          var block = $("listedBlock");
          if (block) block.style.display = "none";
        }

        photos = Array.isArray(d.photos) ? d.photos.slice(0, maxPhotos) : [];
        primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;

        applyFieldLocking(plan, paidUpgrades);

        renderThumbs();
        setStatus(note || "Loaded from server.", true);

        try {
          var zip = d.zip || parseZipFromAddress($("fullAddress").value || "");
          if (zip) {
            var prosData = await loadLocalPros(zip);
            renderProsSidebar(zip, prosData.agents, prosData.lenders);

            var broker = await loadLocalBroker(zip);
            renderBrokerStrip(zip, broker);
          }
        } catch (e) {
          console.warn("[local-pros] sidebar/strip skipped:", e);
        }
      } catch (e) {
        console.warn("[seller] load failed", e);
        setStatus("Could not load from server.", false);
      }
    }

    // Save button: write fields to Firestore
    var saveBtn = $("saveBtn");
    if (saveBtn) {
      saveBtn.addEventListener("click", async function(){
        if (!listingId) { 
          alert("No listing ID in this session."); 
          return; 
        }

        var planNow = (localStorage.getItem("selectedPlan") || plan || "").trim();

        var update = {
          updatedAt: serverTimestamp(),
          status: $("status").value || "",
          price: Number($("price").value || 0) || "",
          apn: $("apn").value || "",
          bedrooms: $("bedrooms").value || "",
          bathrooms: $("bathrooms").value || "",
          sqft: $("sqft").value || "",
          yearBuilt: $("yearBuilt").value || "",
          lotSize: $("lotSize").value || "",
          propertyType: $("propertyType").value || "",
          description: $("description").value || "",
          bannerText: $("bannerText").value || "",
          preferredArea: $("preferredArea").value || "",
          pinArea: $("pinArea").value || ""
        };

        if (!planNow.includes("FSBO")) {
          update.brokerage = $("brokerage").value || "";
          update.agentName = $("agentName").value || "";
          update.agentEmail = $("agentEmail").value || "";
          update.agentPhone = $("agentPhone").value || "";
        }

        try {
          var curSnap = await getDoc(doc(db, "listings", listingId));
          var cur = curSnap.exists() ? (curSnap.data() || {}) : {};
          if (!cur.zip) {
            var addr = $("fullAddress").value || "";
            var m = String(addr).match(/\b(\d{5})(?:-\d{4})?\b/);
            var zip = m ? m[1] : "";
            if (zip) update.zip = zip;
          }
        } catch (e) {
          console.warn("[seller] zip backfill skipped:", e);
        }

        try {
          await updateDoc(doc(db, "listings", listingId), update);
          await refreshFromServer("Saved to server.");
          alert("Saved.");
        } catch (e) {
          console.warn("[seller] update failed", e);
          setStatus("Could not save to server.", false);
          alert("Could not save. Try again.");
        }
      });
    }

    // Upgrades UI wiring
    (async function wireUpgrades(){
      var checkoutData = getJSON("checkoutData", null) || {};
      
      var listingData = {};
      if (listingId) {
        try {
          var snap = await getDoc(doc(db, "listings", listingId));
          if (snap.exists()) {
            listingData = snap.data() || {};
          }
        } catch (e) {
          console.warn("[upgrades] could not fetch listing data:", e);
        }
      }

      var currentPlan = plan.trim();
      var isFSBONow = currentPlan.includes("FSBO");
      var isPlusNow = currentPlan === "Listed Property Plus";
      var isBasicNow = currentPlan === "Listed Property Basic";

      var paidUpgradesNow = listingData.paidUpgrades || {};
      var commissionChangeUsed = listingData.commissionChangeUsed || false;

      function row(label, price, key, paid, description) {
        var checked = paid || !!(checkoutData.upgrades && checkoutData.upgrades[key]);
        var disabled = paid ? "disabled" : "";
        var grayedClass = paid ? "bg-gray-100 opacity-60" : "";
        var paidLabel = paid ? "<span class=\"text-xs text-green-600 ml-2\">Paid</span>" : "";
        var desc = description ? "<div class=\"text-xs text-gray-500\">" + description + "</div>" : "";
        
        return "<label class=\"flex items-center justify-between border rounded-lg px-3 py-2 " + grayedClass + "\">" +
          "<div>" +
            "<span class=\"font-medium\">" + label + "</span>" +
            "<span class=\"text-gray-500\"> - $" + price + "</span>" +
            paidLabel +
            desc +
          "</div>" +
          "<input type=\"checkbox\" data-key=\"" + key + "\" class=\"h-4 w-4\" " + (checked?"checked":"") + " " + disabled + "/>" +
        "</label>";
      }

      var box = $("upgradesBox");
      if (!box) return;

      var upgrades = [];

      if (isBasicNow) {
        upgrades.push(row(
          "Listed Property Plus",
          20,
          "upgradeToPlus",
          false,
          "20 photos + full property description"
        ));
      }

      if (isPlusNow) {
        upgrades.push(row(
          "Listed Property Plus",
          20,
          "upgradeToPlus",
          true,
          "Current Plan"
        ));
      }

      upgrades.push(row("Banner", 10, "banner", paidUpgradesNow.banner));
      upgrades.push(row("Premium Placement", 10, "premium", paidUpgradesNow.premium));
      upgrades.push(row("Pin Placement", 50, "pin", paidUpgradesNow.pin));

      if (isFSBONow) {
        upgrades.push(row("Confidential FSBO Upgrade", 100, "confidential", paidUpgradesNow.confidential));
        upgrades.push(row("Change Commission", 50, "changeCommission", false, ""));  // ✅ Always enabled - allow unlimited changes
      } else {
        upgrades.push(row("Change Commission", 10, "changeCommission", false, ""));  // ✅ Always enabled - allow unlimited changes
      }

      box.innerHTML = upgrades.join("");

      var checkboxes = box.querySelectorAll("input[type=\"checkbox\"]");
      for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].addEventListener("change", function(e) {
          var k = e.target.getAttribute("data-key");
          var checked = e.target.checked;
          checkoutData.upgrades = checkoutData.upgrades || {};

          if (k === "upgradeToPlus") {
            checkoutData.upgrades.upgradeToPlus = checked;
          } else if (k === "banner") {
            checkoutData.upgrades.banner = checked;
          } else if (k === "premium") {
            checkoutData.upgrades.premium = checked && !checkoutData.upgrades.pin;
          } else if (k === "pin") {
            checkoutData.upgrades.pin = checked;
            if (checked) checkoutData.upgrades.premium = true;
          } else if (k === "confidential") {
            checkoutData.upgrades.confidential = checked;
          } else if (k === "changeCommission") {
            if (checked) {
              openChangeCommissionModal();
              
              var confirmBtn = document.getElementById("confirmCommissionBtn");
              confirmBtn.onclick = function() {
                var newComm = document.getElementById("newCommission").value.trim();
                var newType = document.getElementById("newCommissionType").value;
                
                if (!newComm) {
                  alert("Please enter a commission amount.");
                  return;
                }
                
                // Store the new commission in checkoutData AND set flags
                checkoutData.upgrades.changeCommission = true;
                checkoutData.upgrades.upgradeToPlus = false;  // prevents Plus from carrying over
                checkoutData.meta = checkoutData.meta || {};
                checkoutData.meta.fromChangeCommission = true;
                checkoutData.meta.fromSellerDetail = true;
                checkoutData.meta.paidUpgrades = paidUpgradesNow;
                checkoutData.meta.newCommission = newComm;
                checkoutData.meta.newCommissionType = newType;
                setJSON("checkoutData", checkoutData);
                
                // ✅ CHANGE #1: Auto-redirect to checkout (skip return to seller-detail)
                window.location.href = "/checkout.html";
              };
            } else {
              checkoutData.upgrades.changeCommission = false;
              if (checkoutData.meta) {
                delete checkoutData.meta.fromChangeCommission;
                delete checkoutData.meta.newCommission;
                delete checkoutData.meta.newCommissionType;
              }
            }
          }
          
          setJSON("checkoutData", checkoutData);
        });
      }

      var checkoutBtn = $("goCheckoutBtn");
      if (checkoutBtn) {
        checkoutBtn.addEventListener("click", async function() {
          var checkoutData = getJSON("checkoutData", {});
          checkoutData.meta = checkoutData.meta || {};
          checkoutData.meta.fromSellerDetail = true;
          
          try {
            if (listingId && db) {
              var snap = await getDoc(doc(db, "listings", listingId));
              if (snap.exists()) {
                checkoutData.meta.paidUpgrades = snap.data().paidUpgrades || {};
              }
            }
          } catch (e) {
            console.warn("[goCheckout] Could not fetch paidUpgrades:", e);
          }
          
          setJSON("checkoutData", checkoutData);
          window.location.href = "/checkout.html";
        });
      }
    })();

    // Boot
    (async function boot(){
      var who = (localStorage.getItem("loggedInEmail") || "").trim();
      $("whoLine").textContent = who ? "Logged in as " + who : "";

      var formData = getJSON("formData", {});
      if (formData.address && !$("fullAddress").value) {
        $("fullAddress").value = formData.address;
      }

      await refreshFromServer();
      computePhotoHelp();

      try {
        var addr = $("fullAddress").value || "";
        var zip = parseZipFromAddress(addr);
        if (zip) {
          var prosData = await loadLocalPros(zip);
          renderProsSidebar(zip, prosData.agents, prosData.lenders);

          var broker = await loadLocalBroker(zip);
          renderBrokerStrip(zip, broker);
        }
      } catch (e) {
        console.warn("[local-pros] sidebar/strip skipped:", e);
      }
    })();
  </script>

</body>
</html>
