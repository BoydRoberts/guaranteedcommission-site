<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login / Create Account | GuaranteedCommission.com</title>
  <meta name="description" content="Secure login and account creation with strong password protection and verification." />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow p-6">
      <!-- Build/version badge -->
      <div class="text-center mb-2">
        <span class="inline-block text-[11px] px-2 py-1 rounded bg-gray-100 text-gray-600">build 2025-08-11f</span>
      </div>

      <!-- Header -->
      <div class="text-center mb-4">
        <h1 class="text-2xl font-bold">Secure Access</h1>
        <p class="text-sm text-gray-600 mt-1">State-of-the-art security & verification</p>
      </div>

      <!-- Tabs -->
      <div class="flex border-b mb-4" role="tablist" aria-label="Auth Tabs">
        <button type="button" id="tab-signin"
          class="flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700"
          aria-selected="true" aria-controls="panel-signin">
          Sign In
        </button>
        <button type="button" id="tab-create"
          class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700"
          aria-selected="false" aria-controls="panel-create">
          Create Account
        </button>
      </div>

      <!-- Status -->
      <div id="status" class="hidden mb-4 text-sm rounded-lg p-3" role="alert"></div>

      <!-- SIGN IN -->
      <form id="loginForm" class="space-y-4" autocomplete="off" aria-labelledby="tab-signin">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="email" name="email" type="email" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="you@example.com" />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
          <div class="relative mt-1">
            <input id="password" name="password" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Your password" />
            <button type="button" id="togglePwd"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <a href="/forgot-password.html" class="text-blue-600 hover:underline">Forgot password?</a>
          <a href="#" id="goCreate" class="text-blue-600 hover:underline">Create account</a>
        </div>

        <button type="submit"
                class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
          Log In
        </button>
      </form>

      <!-- CREATE ACCOUNT -->
      <form id="createForm" class="space-y-4 hidden" autocomplete="off" aria-labelledby="tab-create">
        <div>
          <label for="c_name" class="block text-sm font-medium text-gray-700">Full Name</label>
          <input id="c_name" type="text" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="First Last" />
        </div>

        <div>
          <label for="c_email" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="c_email" type="email" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="you@example.com" />
        </div>

        <div>
          <label for="c_password" class="block text-sm font-medium text-gray-700">Create Password</label>
          <div class="relative mt-1">
            <input id="c_password" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="At least 10 characters, letters, numbers, symbol" />
            <button type="button" id="togglePwdC1"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>

          <!-- Strength -->
          <div class="mt-2">
            <div class="h-2 w-full bg-gray-200 rounded" aria-hidden="true">
              <div id="strengthBar" class="h-2 w-0 rounded"></div>
            </div>
            <p id="strengthText" class="text-xs mt-1 text-gray-600">Password strength: —</p>
            <ul class="text-[11px] text-gray-600 mt-2 list-disc list-inside">
              <li>At least 10 characters</li>
              <li>Include UPPER &amp; lower case letters</li>
              <li>Include a number and a symbol</li>
            </ul>
          </div>
        </div>

        <div>
          <label for="c_password2" class="block text-sm font-medium text-gray-700">Confirm Password</label>
          <div class="relative mt-1">
            <input id="c_password2" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Re-type your password" />
            <button type="button" id="togglePwdC2"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>
          <p id="matchMsg" class="text-xs mt-1"></p>
        </div>

        <div class="flex items-center justify-between text-sm">
          <a href="#" id="goSignin" class="text-blue-600 hover:underline">Already have an account? Sign in</a>
        </div>

        <button type="submit"
                class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
          Create Account
        </button>
      </form>

      <p class="text-[11px] text-gray-500 text-center mt-4">
        We never sell your data. Used only for escrow &amp; identification.
      </p>
    </div>
  </div>

  <script>
    console.log('[login] build 2025-08-11f');

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const statusBox = $('status');

    function safeJSONParse(s) { try { return JSON.parse(s); } catch { return null; } }
    function setStatus(msg, ok=false) {
      statusBox.classList.remove('hidden');
      statusBox.textContent = msg;
      statusBox.className = ok
        ? 'mb-4 text-sm rounded-lg p-3 bg-green-50 text-green-700'
        : 'mb-4 text-sm rounded-lg p-3 bg-red-50 text-red-700';
    }

    // Storage accessors
    function getAccounts() { return safeJSONParse(localStorage.getItem('accounts')) || {}; }
    function saveAccounts(obj) { localStorage.setItem('accounts', JSON.stringify(obj || {})); }
    function getLegacyAccount() { return safeJSONParse(localStorage.getItem('userAccount')); }
    function setLegacyAccount(acct) { localStorage.setItem('userAccount', JSON.stringify(acct)); }

    // ---------- Remove any stale role field if present (defensive) ----------
    (function nukeRoleFieldEverywhere() {
      const idCandidates = ['role', 'roleSelect', 'userRole'];
      idCandidates.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentElement) el.parentElement.remove();
      });
      document.querySelectorAll('label').forEach(lab => {
        if (lab.textContent && /i am a/i.test(lab.textContent)) {
          const wrap = lab.closest('div') || lab;
          wrap.remove();
        }
      });
      document.querySelectorAll('select').forEach(sel => {
        const text = Array.from(sel.options).map(o => (o.text || '').toLowerCase()).join('|');
        if (/seller|agent|buyer/.test(text)) {
          const wrap = sel.closest('div') || sel;
          wrap.remove();
        }
      });
    })();

    // ---------- MIGRATE any old saved accounts into the new store ----------
    (function migrateOldAccounts() {
      const accounts = getAccounts();

      // 1) From old create-account.html (stored at "accountData")
      const ad = safeJSONParse(localStorage.getItem('accountData'));
      if (ad && ad.email && ad.password) {
        const email = String(ad.email).toLowerCase().trim();
        accounts[email] = { name: ad.name || '', email, password: ad.password };
      }

      // 2) From legacy single record ("userAccount")
      const legacy = getLegacyAccount();
      if (legacy && legacy.email && legacy.password) {
        const email = String(legacy.email).toLowerCase().trim();
        accounts[email] = { name: legacy.name || '', email, password: legacy.password };
      }

      // 3) Other possible keys from older tests
      const possibleKeys = ['acct','account','user','gc_user','gc_account'];
      possibleKeys.forEach(k => {
        const obj = safeJSONParse(localStorage.getItem(k));
        if (obj && obj.email && obj.password) {
          const email = String(obj.email).toLowerCase().trim();
          accounts[email] = { name: obj.name || '', email, password: obj.password };
        }
      });

      // Persist merged accounts map
      saveAccounts(accounts);
    })();

    // ---------- Tabs ----------
    const tabSignin = $('tab-signin');
    const tabCreate = $('tab-create');
    const loginForm = $('loginForm');
    const createForm = $('createForm');
    const goCreate = $('goCreate');
    const goSignin = $('goSignin');

    function showSignin() {
      tabSignin.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700';
      tabSignin.setAttribute('aria-selected', 'true');
      tabCreate.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
      tabCreate.setAttribute('aria-selected', 'false');
      loginForm.classList.remove('hidden');
      createForm.classList.add('hidden');
    }
    function showCreate() {
      tabCreate.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700';
      tabCreate.setAttribute('aria-selected', 'true');
      tabSignin.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
      tabSignin.setAttribute('aria-selected', 'false');
      createForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
    }

    tabSignin.addEventListener('click', showSignin);
    tabCreate.addEventListener('click', showCreate);
    if (goCreate) goCreate.addEventListener('click', (e)=>{ e.preventDefault(); showCreate(); });
    if (goSignin) goSignin.addEventListener('click', (e)=>{ e.preventDefault(); showSignin(); });

    // ---------- Prefill from Box 2 ----------
    (function prefillFromBox2() {
      const candidateKeysName = ['sellerName','ownerName','contactName','name'];
      const candidateKeysEmail = ['sellerEmail','email','contactEmail','pendingEmail'];

      let formData = safeJSONParse(localStorage.getItem('formData')) || {};
      let name = '';
      let email = '';

      for (const k of candidateKeysName) {
        if (formData[k]) { name = formData[k]; break; }
        const v = localStorage.getItem(k);
        if (v) { name = v; break; }
      }
      for (const k of candidateKeysEmail) {
        if (formData[k]) { email = formData[k]; break; }
        const v = localStorage.getItem(k);
        if (v) { email = v; break; }
      }

      if (name) { const f = $('c_name'); if (f) f.value = name; }
      if (email) {
        const ce = $('c_email'); if (ce) ce.value = email;
        const se = $('email');   if (se) se.value = email;
      }

      // If coming from Box 2, default to Create tab
      const reason = localStorage.getItem('nextAfterLogin');
      if (reason) showCreate();
    })();

    // ---------- Show/Hide toggles ----------
    function wireToggle(inputId, btnId) {
      const input = $(inputId);
      const btn = $(btnId);
      if (!input || !btn) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const showing = input.type === 'text';
        input.type = showing ? 'password' : 'text';
        btn.textContent = showing ? 'Show' : 'Hide';
        input.focus({ preventScroll: true });
      });
    }
    wireToggle('password','togglePwd');
    wireToggle('c_password','togglePwdC1');
    wireToggle('c_password2','togglePwdC2');

    // ---------- Strength meter + match ----------
    const cPwd = $('c_password');
    const cPwd2 = $('c_password2');
    const strengthBar = $('strengthBar');
    const strengthText = $('strengthText');
    const matchMsg = $('matchMsg');

    function scorePassword(p) {
      let score = 0;
      if (!p) return 0;
      if (p.length >= 10) score += 1;
      if (/[a-z]/.test(p) && /[A-Z]/.test(p)) score += 1;
      if (/\d/.test(p)) score += 1;
      if (/[^A-Za-z0-9]/.test(p)) score += 1;
      if (p.length >= 14) score += 1; // bonus
      return Math.min(score, 4);
    }
    function updateStrength() {
      if (!cPwd || !strengthBar || !strengthText) return;
      const s = scorePassword(cPwd.value);
      const widths = ['0%','25%','50%','75%','100%'];
      const colors = ['transparent','#fca5a5','#fbbf24','#60a5fa','#34d399'];
      const labels = ['—','Weak','Fair','Good','Strong'];
      strengthBar.style.width = widths[s];
      strengthBar.style.backgroundColor = colors[s];
      strengthText.textContent = 'Password strength: ' + labels[s];

      if (!cPwd2) return;
      if (cPwd2.value.length) {
        if (cPwd.value === cPwd2.value) {
          matchMsg.textContent = 'Passwords match';
          matchMsg.className = 'text-xs mt-1 text-green-600';
        } else {
          matchMsg.textContent = 'Passwords do not match';
          matchMsg.className = 'text-xs mt-1 text-red-600';
        }
      } else {
        matchMsg.textContent = '';
        matchMsg.className = 'text-xs mt-1';
      }
    }
    if (cPwd) cPwd.addEventListener('input', updateStrength);
    if (cPwd2) cPwd2.addEventListener('input', updateStrength);

    // ---------- CREATE ACCOUNT ----------
    $('createForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = $('c_name').value.trim();
      const email = $('c_email').value.trim().toLowerCase();
      const p1 = cPwd ? cPwd.value : '';
      const p2 = cPwd2 ? cPwd2.value : '';

      const s = scorePassword(p1);
      if (s < 3) { setStatus('Please use a stronger password (aim for Good or Strong).'); showCreate(); return; }
      if (p1 !== p2) { setStatus('Passwords do not match.'); showCreate(); return; }

      // Save into accounts map + legacy record
      const accounts = getAccounts();
      accounts[email] = { name, email, password: p1 };
      saveAccounts(accounts);
      setLegacyAccount({ name, email, password: p1 });

      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('loggedInEmail', email);

      setStatus('Account created. Sending verification code…', true);

      // Simulate code send
      const code = Math.floor(100000 + Math.random() * 900000);
      localStorage.setItem('verificationCode', String(code));
      localStorage.setItem('verifyTarget', email);

      const next = localStorage.getItem('nextAfterLogin') || '/verify-code.html';
      setTimeout(()=>{ window.location.href = next; }, 600);
    });

    // ---------- SIGN IN ----------
    $('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = $('email').value.trim().toLowerCase();
      const password = $('password').value;

      // Always migrate just before checking (catches any older keys just created)
      (function lateMigrate(){
        const accounts = getAccounts();
        const ad = safeJSONParse(localStorage.getItem('accountData'));
        if (ad && ad.email && ad.password) {
          const m = String(ad.email).toLowerCase().trim();
          accounts[m] = { name: ad.name || '', email: m, password: ad.password };
          saveAccounts(accounts);
        }
      })();

      const accounts = getAccounts();
      let acct = accounts[email];

      // Fallback to legacy record (upgrade it silently)
      if (!acct) {
        const legacy = getLegacyAccount();
        if (legacy && legacy.email && legacy.password && legacy.email.toLowerCase() === email) {
          acct = legacy;
          accounts[email] = legacy;
          saveAccounts(accounts);
        }
      }

      if (!acct) { setStatus('No account found. Please create an account first.'); showCreate(); return; }
      if (acct.password !== password) { setStatus('Invalid email or password.'); return; }

      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('loggedInEmail', email);
      setStatus('Login successful. Redirecting…', true);

      const next = localStorage.getItem('nextAfterLogin') || '/verify-code.html';
      setTimeout(()=>{ window.location.href = next; }, 500);
    });
  </script>
</body>
</html>
