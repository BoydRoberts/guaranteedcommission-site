<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login / Create Account | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge { font-size:11px; background:#f3f4f6; color:#4b5563; padding:.1rem .5rem; border-radius:.375rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="text-xs hover:underline" style="color:#4DA6FF;">Home</a>
      <div class="text-center">
        <h1 class="text-2xl font-bold">GuaranteedCommission.com</h1>
        <p class="text-xs text-gray-600">
          Guaranteeing commissions so your home will sell quickly at a higher price.
        </p>
      </div>
      <a href="/advertise.html" class="text-xs hover:underline" style="color:#4DA6FF;">Advertise</a>
    </div>
  </header>

  <main class="min-h-[calc(100vh-80px)] flex items-start justify-center px-4 py-8">
    <div class="w-full max-w-md bg-white rounded-2xl shadow p-6 relative">
      <div class="text-center mb-3">
        <span class="badge">Firebase Auth build 2026-01-11 (auto-redirect fixed)</span>
      </div>

      <!-- Tabs -->
      <div class="flex border-b mb-4" role="tablist" aria-label="Auth Tabs">
        <button type="button" id="tab-signin"
          class="flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700"
          aria-selected="true" aria-controls="panel-signin">
          Sign In
        </button>
        <button type="button" id="tab-create"
          class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700"
          aria-selected="false" aria-controls="panel-create">
          Create Account
        </button>
      </div>

      <!-- Status -->
      <div id="status" class="hidden mb-4 text-sm rounded-lg p-3" role="alert"></div>

      <!-- SIGN IN -->
      <form id="loginForm" class="space-y-4" autocomplete="off" aria-labelledby="tab-signin">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="email" name="email" type="email" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="you@example.com" />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
          <div class="relative mt-1">
            <input id="password" name="password" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Your password" />
            <button type="button" id="togglePwd"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <a href="/forgot-password.html" class="text-blue-600 hover:underline">Forgot password?</a>
          <a href="#" id="goCreate" class="text-blue-600 hover:underline">Create account</a>
        </div>

        <button type="submit" id="loginSubmitBtn"
                class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
          Log In
        </button>
      </form>

      <!-- CREATE ACCOUNT -->
      <form id="createForm" class="space-y-4 hidden" autocomplete="off" aria-labelledby="tab-create">
        <div>
          <label for="c_name" class="block text-sm font-medium text-gray-700">Full Name</label>
          <div class="relative mt-1">
            <input id="c_name" type="text" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="First Last" />
          </div>
        </div>

        <div>
          <label for="c_email" class="block text-sm font-medium text-gray-700">Email</label>
          <input id="c_email" type="email" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="you@example.com" />
        </div>

        <div>
          <label for="c_phone" class="block text-sm font-medium text-gray-700">Phone</label>
          <input id="c_phone" type="tel" required
                 class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="123-456-7890" inputmode="numeric" />
          <p class="text-xs text-gray-500 mt-1">Format: 123-456-7890</p>
        </div>

        <div>
          <label for="c_password" class="block text-sm font-medium text-gray-700">Create Password</label>
          <div class="relative mt-1">
            <input id="c_password" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="At least 10 characters, letters, numbers, symbol" />
            <button type="button" id="togglePwdC1"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>

          <!-- Strength -->
          <div class="mt-2">
            <div class="h-2 w-full bg-gray-200 rounded" aria-hidden="true">
              <div id="strengthBar" class="h-2 w-0 rounded"></div>
            </div>
            <p id="strengthText" class="text-xs mt-1 text-gray-600">Password strength: —</p>
            <ul class="text-[11px] text-gray-600 mt-2 list-disc list-inside">
              <li>At least 10 characters</li>
              <li>Include UPPER &amp; lower case letters</li>
              <li>Include a number and a symbol</li>
            </ul>
          </div>
        </div>

        <div>
          <label for="c_password2" class="block text-sm font-medium text-gray-700">Confirm Password</label>
          <div class="relative mt-1">
            <input id="c_password2" type="password" required
                   class="w-full border rounded-lg px-3 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-blue-500"
                   placeholder="Re-type your password" />
            <button type="button" id="togglePwdC2"
                    class="absolute inset-y-0 right-0 px-3 text-sm text-blue-600 hover:underline select-none">
              Show
            </button>
          </div>
          <p id="matchMsg" class="text-xs mt-1"></p>
        </div>

        <!-- Role -->
        <div>
          <label for="createRole" class="block text-sm font-medium text-gray-700">Role</label>
          <select id="createRole" class="mt-1 w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="seller">Seller</option>
            <option value="listing_agent">Listing Agent</option>
            <option value="buyers_agent">Buyer's Agent</option>
            <option value="buyer">Buyer</option>
            <option value="other">Other</option>
          </select>
          <div id="localProLink" class="hidden mt-2">
            <a href="/local-professionals.html" class="text-xs text-blue-600 underline">
              Become a Local Professional
            </a>
          </div>
        </div>

        <div class="flex items-center justify-between text-sm">
          <a href="#" id="goSignin" class="text-blue-600 hover:underline">Already have an account? Sign in</a>
        </div>

        <button type="submit" id="createSubmitBtn"
                class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
          Create Account
        </button>
      </form>

      <p class="text-[11px] text-gray-500 text-center mt-4">
        We never sell your data. Used only for escrow &amp; identification.
      </p>

      <!-- Debug toggle -->
      <button id="dbgToggle" class="absolute top-2 right-2 text-[11px] px-2 py-1 rounded border">Debug</button>
      <pre id="dbgPanel" class="hidden mt-2 text-[11px] bg-gray-50 border rounded p-2 whitespace-pre-wrap break-all"></pre>
    </div>
  </main>

  <!-- Firebase Auth -->
  <script type="module">
    import { auth, db } from "/scripts/firebase-init.js";
    import {
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    console.log('[login] Firebase Auth build 2026-01-11 (auto-redirect fixed)');

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const statusBox = $('status');

    function setStatus(msg, ok = false) {
      statusBox.classList.remove('hidden');
      statusBox.textContent = msg;
      statusBox.className = ok
        ? 'mb-4 text-sm rounded-lg p-3 bg-green-50 text-green-700'
        : 'mb-4 text-sm rounded-lg p-3 bg-red-50 text-red-700';
    }

    function clearStatus() {
      statusBox.classList.add('hidden');
      statusBox.textContent = '';
    }

    function onlyDigits(s) { return (s || '').replace(/\D/g, ''); }

    function formatPhone(s) {
      const d = onlyDigits(s).slice(0, 10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0, 3) + '-' + d.slice(3);
      return d.slice(0, 3) + '-' + d.slice(3, 6) + '-' + d.slice(6);
    }

    function normalizePhoneE164(s) {
      const digits = onlyDigits(s);
      if (digits.length === 10) return '+1' + digits;
      if (digits.length === 11 && digits.startsWith('1')) return '+' + digits;
      return null;
    }

    function isValidPhone(s) { return onlyDigits(s).length === 10; }

    function setLoading(btn, loading) {
      btn.disabled = loading;
      btn.style.opacity = loading ? '0.6' : '1';
    }

    // ---------- Tabs ----------
    const tabSignin = $('tab-signin');
    const tabCreate = $('tab-create');
    const loginForm = $('loginForm');
    const createForm = $('createForm');

    function showSignin() {
      tabSignin.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700';
      tabCreate.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
      loginForm.classList.remove('hidden');
      createForm.classList.add('hidden');
      tabSignin.setAttribute('aria-selected', 'true');
      tabCreate.setAttribute('aria-selected', 'false');
      clearStatus();
    }

    function showCreate() {
      tabCreate.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-blue-600 text-blue-700';
      tabSignin.className = 'flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700';
      createForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      tabCreate.setAttribute('aria-selected', 'true');
      tabSignin.setAttribute('aria-selected', 'false');
      clearStatus();
    }

    tabSignin.addEventListener('click', showSignin);
    tabCreate.addEventListener('click', showCreate);
    $('goCreate')?.addEventListener('click', (e) => { e.preventDefault(); showCreate(); });
    $('goSignin')?.addEventListener('click', (e) => { e.preventDefault(); showSignin(); });

    $('createRole')?.addEventListener('change', (e) => {
      const v = e.target.value;
      if (v === 'listing_agent' || v === 'buyers_agent') $('localProLink').classList.remove('hidden');
      else $('localProLink').classList.add('hidden');
    });

    function wireToggle(inputId, btnId) {
      const input = $(inputId);
      const btn = $(btnId);
      if (!input || !btn) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const vis = input.type === 'text';
        input.type = vis ? 'password' : 'text';
        btn.textContent = vis ? 'Show' : 'Hide';
        input.focus({ preventScroll: true });
      });
    }
    wireToggle('password', 'togglePwd');
    wireToggle('c_password', 'togglePwdC1');
    wireToggle('c_password2', 'togglePwdC2');

    function scorePassword(p) {
      let s = 0;
      if (!p) return 0;
      if (p.length >= 10) s++;
      if (/[a-z]/.test(p) && /[A-Z]/.test(p)) s++;
      if (/\d/.test(p)) s++;
      if (/[^A-Za-z0-9]/.test(p)) s++;
      if (p.length >= 14) s++;
      return Math.min(s, 4);
    }

    function updateStrength() {
      const p1 = $('c_password')?.value || '';
      const p2 = $('c_password2')?.value || '';
      const bar = $('strengthBar'), st = $('strengthText'), mm = $('matchMsg');
      if (!bar || !st || !mm) return;
      const s = scorePassword(p1);
      const widths = ['0%', '25%', '50%', '75%', '100%'];
      const colors = ['transparent', '#fca5a5', '#fbbf24', '#60a5fa', '#34d399'];
      const labels = ['—', 'Weak', 'Fair', 'Good', 'Strong'];
      bar.style.width = widths[s];
      bar.style.backgroundColor = colors[s];
      st.textContent = 'Password strength: ' + labels[s];
      if (!p2) { mm.textContent = ''; mm.className = 'text-xs mt-1'; return; }
      if (p1 === p2) { mm.textContent = 'Passwords match'; mm.className = 'text-xs mt-1 text-green-600'; }
      else { mm.textContent = 'Passwords do not match'; mm.className = 'text-xs mt-1 text-red-600'; }
    }
    $('c_password')?.addEventListener('input', updateStrength);
    $('c_password2')?.addEventListener('input', updateStrength);

    $('c_phone')?.addEventListener('input', () => {
      const el = $('c_phone');
      const cur = el.selectionStart;
      const before = el.value;
      el.value = formatPhone(before);
      el.selectionStart = el.selectionEnd = Math.min(cur + (el.value.length - before.length), el.value.length);
    });

    // ---------- Redirect helper ----------
    function handlePostLogin() {
      const pending = sessionStorage.getItem('pendingAction');
      if (pending) {
        try {
          const action = JSON.parse(pending);
          const url = new URL('/search.html', window.location.origin);
          if (action.q) url.searchParams.set('q', action.q);
          url.searchParams.set('pendingAction', 'true');
          window.location.href = url.toString();
          return;
        } catch (e) {
          console.warn('[login] Failed to parse pendingAction:', e);
        }
      }

      const next = localStorage.getItem('nextAfterLogin');
      if (next) {
        localStorage.removeItem('nextAfterLogin');
        window.location.href = next;
        return;
      }

      const origin = localStorage.getItem('loginOrigin');
      if (origin === 'box2') {
        localStorage.removeItem('loginOrigin');
        window.location.href = '/verify-code.html';
        return;
      }

      window.location.href = '/welcome.html';
    }

    function getAuthErrorMessage(code) {
      switch (code) {
        case 'auth/email-already-in-use': return 'An account with this email already exists. Please sign in.';
        case 'auth/invalid-email': return 'Please enter a valid email address.';
        case 'auth/weak-password': return 'Password is too weak. Please use at least 6 characters.';
        case 'auth/user-not-found': return 'No account found with this email. Please create an account.';
        case 'auth/wrong-password': return 'Incorrect password. Please try again.';
        case 'auth/invalid-credential': return 'Invalid email or password. Please try again.';
        case 'auth/too-many-requests': return 'Too many failed attempts. Please try again later.';
        default: return 'An error occurred. Please try again.';
      }
    }

    // ---------- SIGN IN ----------
    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('email').value.trim().toLowerCase();
      const password = $('password').value;
      const btn = $('loginSubmitBtn');

      if (!email || !password) {
        setStatus('Please enter email and password.');
        return;
      }

      setLoading(btn, true);
      clearStatus();

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);

        // Legacy flags (keep old flows alive)
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInEmail', email);

        try {
          const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
          if (userDoc.exists()) {
            const profile = userDoc.data();
            if (profile.role) localStorage.setItem('userRole', profile.role);
            if (profile.name) localStorage.setItem('userName', profile.name);
          }
        } catch (e2) {
          console.warn('[login] Could not fetch user profile:', e2);
        }

        setStatus('Login successful! Redirecting...', true);
        setTimeout(handlePostLogin, 300);

      } catch (error) {
        console.error('[login] Sign in error:', error.code, error.message);
        setStatus(getAuthErrorMessage(error.code));
        setLoading(btn, false);
      }
    });

    // ---------- CREATE ACCOUNT ----------
    $('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = $('c_name').value.trim();
      const email = $('c_email').value.trim().toLowerCase();
      const phone = $('c_phone').value.trim();
      const p1 = $('c_password').value;
      const p2 = $('c_password2').value;
      const role = $('createRole').value;
      const btn = $('createSubmitBtn');

      if (!name || !email || !phone || !p1) { setStatus('Please complete all fields.'); return; }
      if (!isValidPhone(phone)) { setStatus('Please enter a valid 10-digit phone number.'); $('c_phone').focus(); return; }
      if (p1 !== p2) { setStatus('Passwords do not match.'); return; }
      if (p1.length < 6) { setStatus('Password must be at least 6 characters.'); return; }

      const phoneE164 = normalizePhoneE164(phone);
      if (!phoneE164) { setStatus('Invalid phone number format.'); return; }

      setLoading(btn, true);
      clearStatus();

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, p1);
        const uid = userCredential.user.uid;

        await setDoc(doc(db, 'users', uid), {
          name, email, phone: phoneE164, role,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        // Legacy flags (keep old flows alive)
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInEmail', email);
        localStorage.setItem('userRole', role);
        localStorage.setItem('userName', name);

        setStatus('Account created successfully! Redirecting...', true);
        setTimeout(handlePostLogin, 300);

      } catch (error) {
        console.error('[login] Create account error:', error.code, error.message);
        setStatus(getAuthErrorMessage(error.code));
        setLoading(btn, false);
      }
    });

    // ---------- Debug panel ----------
    $('dbgToggle').addEventListener('click', async () => {
      const user = auth.currentUser;
      let firestoreData = null;
      if (user) {
        try {
          const docSnap = await getDoc(doc(db, 'users', user.uid));
          if (docSnap.exists()) firestoreData = docSnap.data();
        } catch (e) {
          firestoreData = { error: e.message };
        }
      }
      const dump = {
        authUser: user ? { uid: user.uid, email: user.email } : null,
        firestoreProfile: firestoreData,
        pendingAction: sessionStorage.getItem('pendingAction'),
        loggedInEmail: localStorage.getItem('loggedInEmail'),
        userRole: localStorage.getItem('userRole'),
        userName: localStorage.getItem('userName'),
        nextAfterLogin: localStorage.getItem('nextAfterLogin'),
        loginOrigin: localStorage.getItem('loginOrigin')
      };
      const p = $('dbgPanel');
      p.classList.toggle('hidden');
      p.textContent = JSON.stringify(dump, null, 2);
    });

    // =====================================================================
    // FIX: If already logged in and you visit /login.html, DO NOT sit here.
    // Route using the same post-login rules.
    // =====================================================================
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('[login] Already logged in:', user.email);
        setTimeout(handlePostLogin, 0);
      }
    });
  </script>
</body>
</html>
