<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* Listing tile (exact visual as before) */
    .tile-photo { width:100%; height: 20rem; object-fit: cover; background:#e5e7eb; }
    .tile-banner { position:absolute; top:12px; left:12px; background:rgba(0,0,0,.8); color:#fff; font-size:12px; font-weight:600; border-radius:9999px; padding:4px 8px; }
    .heart-btn { position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    /* Map should fill its card completely */
    .mapboxgl-canvas { display:block !important; }

    /* ISC: full area clickable; no extra borders around the container itself */
    .click-wrap { position: relative; width:100%; height:100%; }
    .click-wrap a.overlay { position:absolute; inset:0; z-index:10; text-indent:-9999px; }
    .isc-iframe { width:100%; height:100%; border:0; margin:0; display:block; background:#fff; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(0,0,0,.08); overflow:hidden; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Top bar -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/index.html#strip2Search" class="text-sm text-blue-600 hover:underline">&larr; Back to Search</a>
      <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- Top strip: 40 | 20 | 40  (all bottoms aligned to tile height) -->
    <section id="topRow" class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start">

      <!-- Left: LISTING TILE (reference height) -->
      <article id="tileCard" class="lg:col-span-2 card relative cursor-pointer">
        <div class="relative">
          <img id="tilePhoto" class="tile-photo" alt="Listing photo"/>
          <div id="tileBanner" class="tile-banner hidden"></div>
          <button id="tileHeart" type="button" class="heart-btn" aria-label="Like"></button>
        </div>
        <div class="p-4 space-y-1">
          <div class="flex items-center justify-between text-[16px] sm:text-[18px] font-semibold">
            <div id="tilePrice" class="truncate">$—</div>
            <div id="tileCommission" class="truncate text-red-600">Commission — | $—</div>
          </div>
          <div id="tileFacts" class="text-[12px] text-gray-700">— bds | — ba | — sqft | Active</div>
          <div id="tileAddress" class="text-sm font-medium">[full address]</div>
          <div id="tileContact" class="text-[12px] text-gray-600">[LISTING BROKERAGE] — [listing agent] — [agent phone]</div>
        </div>
        <a id="tileClick" href="#" class="absolute inset-0" aria-label="Open full listing detail"></a>
      </article>

      <!-- Middle: MAP (height forced to exactly match tile) -->
      <aside id="mapCard" class="lg:col-span-1 card overflow-hidden p-0" style="height:auto;">
        <div id="mapCanvas" style="width:100%; height:100%;"></div>
      </aside>

      <!-- Right: ISC (height forced to exactly match tile; inner iframe scrolls if longer) -->
      <aside id="iscCard" class="lg:col-span-2 overflow-hidden p-0 m-0" style="background:transparent; border:0; box-shadow:none; border-radius:0; height:auto;">
        <div class="click-wrap">
          <a class="overlay" href="/printable-isc.html" target="_blank" aria-label="Open full ISC PDF">Open</a>
          <iframe id="iscIframe" src="/printable-isc.html" class="isc-iframe"></iframe>
        </div>
      </aside>

    </section>

    <!-- LOWER SECTION: Photos & Description -->
    <section class="space-y-6">
      <div id="galleryCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Photos</h3>
        <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

      <div id="descCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Description</h3>
        <p id="dDescription" class="text-sm leading-relaxed whitespace-pre-line"></p>
      </div>
    </section>

  </main>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtZXJvbjduajA5MW8yanBvMTgxcWx2a2IifQ.dMBWViogHJkh0SgeVX5N_Q";
    if (MAPBOX_TOKEN && window.mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const getJSON = (k, fb={}) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const money = (n)=>{ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$—"; };
    const commissionAmt = (p, c, t)=>{ const P=Number(p||0), C=Number(c||0); if(!C) return 0; return t==='$'?Math.round(C):(P?Math.round(P*(C/100)):0); };
    const fmtPhone = (s)=>{ const d=String(s||'').replace(/\D/g,'').slice(0,10); return d.length===10?`${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`:(s||''); };

    // ----- Data -----
    const url = new URL(location.href);
    const addrParam = url.searchParams.get('addr');
    const formData = getJSON('formData', {});
    const agentListing = getJSON('agentListing', {});
    const plan = (localStorage.getItem('selectedPlan') || 'Listed Property Basic').trim();

    const fullAddress = decodeURIComponent(addrParam || formData.address || "[full address]");
    const price = agentListing.price ?? "";
    const cRaw = agentListing.commission ?? formData.commission ?? "";
    const cType= agentListing.commissionType ?? formData.commissionType ?? "%";
    const cAmt = (function(p,c,t){ const P=Number(p||0), C=Number(c||0); if(!C) return 0; return t==='$'?Math.round(C):(P?Math.round(P*(C/100)):0); })(price,cRaw,cType);
    const cPctLabel = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw)+'%')) : "—";
    const banner = (agentListing.bannerText||"").trim();
    let photos = Array.isArray(agentListing.photos) ? agentListing.photos : [];
    const primaryIndex = (typeof agentListing.primaryIndex === "number" ? agentListing.primaryIndex : 0);
    const photo = photos[primaryIndex] || "";
    const bds = agentListing.bedrooms ?? "—";
    const ba  = agentListing.bathrooms ?? "—";
    const sqft= agentListing.sqft ? Number(agentListing.sqft).toLocaleString() : "—";
    const pType= agentListing.propertyType || "";
    const status = agentListing.status || "Draft";
    const brokerage = formData.brokerage || (plan.includes("FSBO") ? "FOR SALE BY OWNER" : "[listing brokerage]");
    const agentName = formData.agent || (plan.includes("FSBO") ? "" : "[listing agent]");
    const agentPhone = fmtPhone(agentListing.agentPhone || formData.agentPhone || formData.phone || (plan.includes("FSBO") ? "" : "[agent phone]"));

    // ----- Paint tile “as before” -----
    (function paintTile(){
      $("tilePhoto").src = photo || "";
      const bEl = $("tileBanner");
      if (banner) { bEl.textContent = banner; bEl.classList.remove('hidden'); }

      const KEY='gcFavorites';
      const favs = ()=>{try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return[]}}; const setF = a=>{try{localStorage.setItem(KEY,JSON.stringify(a||[]))}catch{}};
      const isFav = id => favs().includes(id);
      const tog = id => { const a=favs(); const i=a.indexOf(id); if(i>=0)a.splice(i,1); else a.push(id); setF(a); return a.includes(id); };
      const svg = a => a?`<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>` :`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
      const id=(fullAddress||'').toLowerCase();
      $("tileHeart").innerHTML = svg(isFav(id));
      $("tileHeart").onclick=(e)=>{e.preventDefault();e.stopPropagation();$("tileHeart").innerHTML=svg(tog(id));};

      $("tilePrice").textContent = money(price);
      $("tileCommission").textContent = `Commission ${cPctLabel} | ${cAmt ? money(cAmt) : "$—"}`;
      $("tileFacts").textContent = `${bds} bds | ${ba} ba | ${sqft} sqft${pType?' | '+pType:''} | ${status}`;
      $("tileAddress").textContent = fullAddress;
      $("tileContact").textContent = `${(plan.includes("FSBO")?"FOR SALE BY OWNER":(brokerage||"[listing brokerage]")).toUpperCase()}${agentName?' — '+agentName:''}${agentPhone?' — '+agentPhone:''}`;
      $("tileClick").href = `/listing.html?addr=${encodeURIComponent(fullAddress)}`;
    })();

    // ----- Map -----
    let _mapInstance;
    (async function bootMap(){
      try{
        const center = await (async()=>{try{
          const r=await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(fullAddress)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
          const d=await r.json();
          return d?.features?.[0]?.center || [-117.7854,33.5427];
        }catch{return [-117.7854,33.5427]}})();
        _mapInstance = new mapboxgl.Map({
          container:'mapCanvas',
          style:'mapbox://styles/mapbox/streets-v12',
          center, zoom:14
        });
        _mapInstance.addControl(new mapboxgl.NavigationControl());
        new mapboxgl.Marker().setLngLat(center).addTo(_mapInstance);
        requestAnimationFrame(()=>_mapInstance.resize());
        setTimeout(()=>_mapInstance.resize(), 250);
      }catch{
        $("mapCanvas").innerHTML = '<div class="h-full w-full flex items-center justify-center text-gray-500 text-sm">Map unavailable</div>';
      }
    })();

    // ----- Height alignment: map & ISC match tile height exactly -----
    function alignToTileHeight(){
      const tile = $("tileCard");
      const mapCard = $("mapCard");
      const iscCard = $("iscCard");
      if (!tile || !mapCard || !iscCard) return;

      // Reset heights
      mapCard.style.height = iscCard.style.height = '';

      const h = tile.getBoundingClientRect().height; // tile’s rendered height
      mapCard.style.height = h + "px";
      iscCard.style.height = h + "px";

      // Make ISC iframe fit the box exactly (scroll inside if longer)
      const iscIframe = $("iscIframe");
      if (iscIframe) iscIframe.style.height = "100%";

      // Resize map to fit its new height
      if (typeof _mapInstance?.resize === "function") _mapInstance.resize();

      // *** NEW: strip any print buttons/margins inside the ISC iframe (no UI) ***
      try {
        const doc = $("iscIframe").contentDocument || $("iscIframe").contentWindow?.document;
        if (doc && !doc.querySelector('#__gc_strip_style')) {
          const style = doc.createElement('style');
          style.id = '__gc_strip_style';
          style.textContent = `
            html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
            button, .print, [data-print], #printBtn, #printButton { display:none !important; }
            #counters, .counters, #viewCounter { display:none !important; }
          `;
          doc.head.appendChild(style);
        }
      } catch(e) { /* cross-doc safe-guard; same-origin expected */ }
    }

    // Align after everything paints
    window.addEventListener('load', ()=> {
      setTimeout(alignToTileHeight, 50);
      setTimeout(alignToTileHeight, 300);
    });
    window.addEventListener('resize', alignToTileHeight);
    // Also align each time the ISC iframe loads/reloads
    $("iscIframe").addEventListener('load', ()=> {
      alignToTileHeight();
      setTimeout(alignToTileHeight, 200);
    });

    // ----- Gallery -----
    (function gallery(){
      const arr = Array.isArray(agentListing.photos)?agentListing.photos:[];
      const primaryIndex = (typeof agentListing.primaryIndex === "number" ? agentListing.primaryIndex : 0);
      const other = arr.filter((_,i)=>i!==primaryIndex);
      if (!other.length) return;
      const grid = $("galleryGrid");
      other.forEach(src=>{
        const img=document.createElement('img');
        img.src=src; img.alt='Listing photo';
        img.className='w-full h-32 object-cover rounded bg-gray-100';
        grid.appendChild(img);
      });
      $("galleryCard").classList.remove("hidden");
    })();

    // ----- Description -----
    (function desc(){
      const d=(agentListing.description||"").trim();
      if (!d) return;
      $("dDescription").textContent = d;
      $("descCard").classList.remove("hidden");
    })();
  </script>
</body>
</html>

