<!DOCTYPE html>
<!-- Build: 2026-01-17 (Sold state badge + inquiry lockdown; preserves existing logic) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* Listing tile */
    .tile-photo { width:100%; height: 20rem; object-fit: cover; background:#e5e7eb; }
    .tile-banner { position:absolute; top:12px; left:12px; background:rgba(0,0,0,.8); color:#fff; font-size:12px; font-weight:600; border-radius:9999px; padding:4px 8px; }
    .heart-btn { position:absolute; top:12px; right:12px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    /* SOLD badge (NEW) */
    .sold-badge {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #dc2626; /* red-600 */
      color: white;
      font-weight: 800;
      letter-spacing: .12em;
      padding: 6px 14px;
      border-radius: 9999px;
      box-shadow: 0 3px 12px rgba(220,38,38,.35);
      border: 2px solid rgba(255,255,255,.9);
      text-transform: uppercase;
      font-size: 12px;
      z-index: 20;
    }

    /* Share buttons over the photo */
    .share-btn { position:absolute; bottom:12px; padding:.35rem .6rem; font-size:12px; background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.12); }
    .share-left { left:12px; }
    .share-right{ right:12px; }

    .mapboxgl-canvas { display:block !important; }

    /* Card shells */
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(0,0,0,.08); overflow:hidden; }
    .tile-body, .isc-body { padding:1rem; }
    .tile-body > *:last-child,
    .isc-body > *:last-child { margin-bottom:0 !important; }

    /* ISC embed */
    .click-wrap { position: relative; width:100%; height:100%; }
    .click-wrap a.overlay { position:absolute; inset:0; z-index:10; text-indent:-9999px; }
    .isc-iframe { width:100%; border:0; margin:0; display:block; background:transparent; }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>

  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="GuaranteedCommission.com">
  <meta property="og:description" content="Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.">
  <meta property="og:image" content="https://guaranteedcommission.com/Logo.png">
  <meta property="og:url" content="https://guaranteedcommission.com/">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="GuaranteedCommission.com">
  <meta name="twitter:description" content="Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.">
  <meta name="twitter:image" content="https://guaranteedcommission.com/Logo.png">
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Top bar (matches home/search header) -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

        <div class="text-center">
          <div class="flex items-end justify-center gap-0">
            <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
            <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
          <a href="/login.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Log In</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- SOLD inquiry lockdown notice (NEW) -->
    <section id="soldInquiryNotice" class="hidden">
      <div class="bg-red-50 border border-red-200 text-red-800 rounded-xl p-4 text-sm font-semibold">
        This property has been sold and is no longer accepting inquiries.
      </div>
    </section>

    <!-- Top strip: 40 | 20 | 40 -->
    <section id="topRow" class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start hidden">

      <!-- Left: LISTING TILE -->
      <article id="tileCard" class="lg:col-span-2 card relative">
        <div class="relative">
          <img id="tilePhoto" class="tile-photo" alt="Listing photo"/>
          <div id="tileBanner" class="tile-banner hidden"></div>

          <!-- SOLD badge overlay -->
          <div id="soldBadge" class="sold-badge hidden">SOLD</div>

          <!-- Heart (like) -->
          <button id="tileHeart" type="button" class="heart-btn" aria-label="Like">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2" aria-hidden="true">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
          </button>

          <!-- Share buttons over the photo (bottom left / right) -->
          <button id="shareEmailBtn" class="share-btn share-left">Share Email</button>
          <button id="shareTextBtn"  class="share-btn share-right">Share Text</button>
        </div>

        <div class="tile-body space-y-1">
          <div class="flex items-center justify-between text-[16px] sm:text-[18px] font-semibold">
            <div id="tilePrice" class="truncate">$—</div>
            <div id="tileCommission" class="truncate text-red-600">Commission — | $—</div>
          </div>
          <div id="tileFacts" class="text-[12px] text-gray-700">— bds | — ba | — sqft | Draft</div>
          <div id="tileAddress" class="text-sm font-medium">[full address]</div>
          <div id="tileContact" class="text-[12px] text-gray-600">[LISTING BROKERAGE] - [listing agent] - [agent phone]</div>
          <!-- Centered "Viewed N times | Liked M times" -->
          <div id="tileStats" class="text-[12px] text-gray-500 text-center">Viewed — | Liked —</div>
        </div>
      </article>

      <!-- Middle: MAP -->
      <aside id="mapCard" class="lg:col-span-1 overflow-hidden p-0" style="height:auto;">
        <div id="mapCanvas" style="width:100%; height:100%;"></div>
      </aside>

      <!-- Right: ISC (iframe preview—auto fits content height, but clamped to tile) -->
      <aside id="iscCard" class="lg:col-span-2 card p-0 m-0" style="height:auto;">
        <div class="isc-body">
          <div class="click-wrap">
            <a id="iscOpenLink" class="overlay" href="/printable-isc.html" target="_blank" aria-label="Open full ISC">Open</a>
            <iframe id="iscIframe" src="/printable-isc.html" class="isc-iframe" scrolling="no"></iframe>
          </div>
        </div>
      </aside>
    </section>

    <!-- LOWER SECTION -->
    <section class="space-y-6">
      <div id="galleryCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Photos</h3>
        <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

      <div id="descCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Description</h3>
        <p id="dDescription" class="text-sm leading-relaxed whitespace-pre-line"></p>
      </div>

      <!-- START local-pros: Horizontal Local Professionals block under Description -->
      <section id="prosCard" class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Local Professionals in <span id="prosZip">—</span></h3>
          <a id="prosCtaBtn" href="/local-professionals.html" class="text-sm px-4 py-1.5 rounded text-white hover:opacity-90 text-center min-w-[200px]" style="background-color:#4DA6FF;">Local Professionals</a>
        </div>
        <div id="prosGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-3"></div>
      </section>
      <!-- END local-pros -->

      <!-- Horizontal Local Real Estate Brokers strip (below Pros) -->
      <section id="brokersCard" class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Local Brokers in <span id="brokersZip">—</span></h3>
          <a id="brokersCtaBtn" href="/local-brokers.html" class="text-sm px-4 py-1.5 rounded text-white hover:opacity-90 text-center min-w-[200px]" style="background-color:#4DA6FF;">Local Brokers</a>
        </div>
        <div id="brokersGrid" class="w-full"></div>
      </section>
      <!-- END brokers -->

      <!-- Local Service Providers strip (below Brokers) -->
      <section id="serviceProvidersCard" class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Local Service Providers in <span id="serviceProvidersZip">—</span></h3>
          <a id="serviceProvidersCtaBtn" href="/local-service-providers.html" class="text-sm px-4 py-1.5 rounded text-white hover:opacity-90 text-center min-w-[200px]" style="background-color:#4DA6FF;">Local Service Providers</a>
        </div>
        <div id="serviceProvidersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
      </section>
      <!-- END service providers -->

    </section>

  </main>

  <!-- Footer with legal disclaimer -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-7xl mx-auto px-4 py-4 text-center text-xs text-gray-500 space-y-2">
      <p>All purchases subject to quality control review.</p>
      <p class="text-gray-400">Local Professionals, Brokers, and Service Providers are third-party advertisers. Display on this site does not constitute an endorsement or recommendation by GuaranteedCommission.com. Verification of licenses and qualifications is the responsibility of the consumer.</p>
    </div>
  </footer>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtaW1idDMwbjFjMWUzZHE3ZzY4ZjBob3IifQ.lF5BvHIsT_SVe0f6mT5nRw";
    if (MAPBOX_TOKEN && window.mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const money = (n)=>{ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$—"; };

    // Clamp ISC iframe to tile height (avoid "lip"); match map to tile
    function alignHeights(){
      const tile = $("tileCard");
      const mapCard = $("mapCard");
      const iscCard = $("iscCard");
      const iscIframe = $("iscIframe");
      if (!tile || !mapCard || !iscCard) return;

      mapCard.style.height = iscCard.style.height = '';
      if (iscIframe) iscIframe.style.height = '';

      const h = Math.max(0, tile.getBoundingClientRect().height);

      mapCard.style.height = h + "px";

      iscCard.style.height = h + "px";
      const PAD_FUDGE = 24;
      if (iscIframe) {
        const inner = Math.max(0, h - PAD_FUDGE);
        iscIframe.style.height = inner + "px";
      }

      iscCard.style.overflow = "hidden";
    }

    // Heart wiring after we know the listing id
    function setupHeart(listingId, favKeyId) {
      const KEY='gcFavorites';
      const favs = ()=>{ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch { return []; } };
      const setF = a=>{ try { localStorage.setItem(KEY, JSON.stringify(a||[])); } catch {} };
      const isFav = id => favs().includes(id);
      const tog = id => { const a=favs(); const i=a.indexOf(id); if(i>=0)a.splice(i,1); else a.push(id); setF(a); return a.includes(id); };
      const svg = a => a
        ? `<svg viewBox="0 0 24 24" width="18" height="18" fill="#dc2626"><path d="M12 21s-6.716-4.584-9.428-7.296C.858 12.99.5 11.8.5 10.5.5 7.462 2.962 5 6 5c1.74 0 3.41.81 4.5 2.09C11.59 5.81 13.26 5 15 5c3.038 0 5.5 2.462 5.5 5.5 0 1.3-.358 2.49-2.072 3.204C18.716 16.416 12 21 12 21z"/></svg>`
        : `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#dc2626" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
      const btn = $("tileHeart");
      if (!btn) return;
      btn.innerHTML = svg(isFav(favKeyId));

      btn.onclick = async (e) => {
        e.preventDefault();
        const nowLiked = tog(favKeyId);
        btn.innerHTML = svg(nowLiked);

        try {
          const { updateDoc, doc, serverTimestamp, increment } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          const onceKey = 'likedOnce:' + listingId;
          if (nowLiked && !localStorage.getItem(onceKey)) {
            await updateDoc(doc(gc.db, "listings", listingId), { likes: increment(1), updatedAt: serverTimestamp() });
            localStorage.setItem(onceKey, '1');
            await paintStats(listingId);
          }
        } catch (err) {
          console.warn('[likes] increment failed', err);
        }
      };
    }

    // Map
    async function bootMapFor(fullAddress){
      try {
        const c = await geocode(fullAddress);
        const m = new mapboxgl.Map({
          container:'mapCanvas',
          style:'mapbox://styles/mapbox/streets-v12',
          center: c || [-117.7854,33.5427],
          zoom: c ? 14 : 12
        });
        m.addControl(new mapboxgl.NavigationControl());
        if (c) new mapboxgl.Marker().setLngLat(c).addTo(m);
        requestAnimationFrame(()=>{ m.resize(); alignHeights(); });
        setTimeout(()=>{ m.resize(); alignHeights(); }, 250);
        window.addEventListener('resize', alignHeights);
      } catch {
        $("mapCanvas").innerHTML = '<div class="h-full w-full flex items-center justify-center text-gray-500 text-sm">Map unavailable</div>';
      }
    }
    async function geocode(q) {
      if (!MAPBOX_TOKEN || !q) return null;
      try {
        const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
        const data = await resp.json();
        const f = data?.features?.[0];
        return f ? f.center : null;
      } catch { return null; }
    }
  </script>

  <!-- Loader + counters + share -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      getDoc, doc, getDocs, collection, query, where, limit, updateDoc, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);
    function money(n){ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$—"; }
    function dflt(v, dv) { return (v===undefined || v===null) ? dv : v; }
    function asNumOrEmpty(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string" && v.trim() !== "" && !isNaN(Number(v))) return Number(v);
      return "";
    }

    async function incrementViewsOnce(id) {
      try {
        const key = 'viewedOnce:' + id;
        if (sessionStorage.getItem(key)) return;
        const ref = doc(db, "listings", id);
        await updateDoc(ref, { views: increment(1), updatedAt: serverTimestamp() });
        sessionStorage.setItem(key, '1');
      } catch (e) {
        console.warn('[views] increment failed', e);
      }
    }

    async function paintStats(id) {
      try {
        const snap = await getDoc(doc(db, "listings", id));
        const d = snap.data() || {};
        const views = Number(d.views || 0);
        const likes = Number(d.likes || 0);
        const el = $("tileStats");
        if (el) el.textContent = `Viewed ${views.toLocaleString()} time${views===1?'':'s'} | Liked ${likes.toLocaleString()} time${likes===1?'':'s'}`;
      } catch {
        const el = $("tileStats");
        if (el) el.textContent = `Viewed — | Liked —`;
      }
    }

    function shareLimitOk() {
      try {
        const day = new Date().toISOString().slice(0,10);
        const key = 'shareCount:' + day;
        const n = Number(localStorage.getItem(key) || 0);
        if (n >= 5) { alert("Please log in to continue sharing."); return false; }
        localStorage.setItem(key, String(n + 1));
        return true;
      } catch { return true; }
    }
    function openEmail(address, url) {
      const subject = encodeURIComponent(address ? `Listing: ${address}` : `Listing`);
      const body = encodeURIComponent(`${address ? (address + " - ") : ""}commission posted with photos.\n\n${url}`);
      const a = document.createElement('a');
      a.href = `mailto:?subject=${subject}&body=${body}`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { try { document.body.removeChild(a); } catch {} }, 0);
    }
    function openText(address, url) {
      const msg = encodeURIComponent(`${address ? (address + " - ") : ""}commission posted with photos.\n\n${url}`);
      window.location.href = `sms:&body=${msg}`;
    }

    // Inquiry lockdown helper (NEW): if you later add inquiry buttons/forms, Sold will disable them
    function applyInquiryLockdown(isSold) {
      const notice = document.getElementById("soldInquiryNotice");
      if (notice) notice.classList.toggle("hidden", !isSold);

      const idsToDisable = [
        "contactSellerBtn",
        "inquireBtn",
        "scheduleTourBtn",
        "contactForm",
        "inquiryForm"
      ];
      idsToDisable.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (isSold) {
          el.classList.add("hidden");
          try { el.disabled = true; } catch {}
        } else {
          el.classList.remove("hidden");
          try { el.disabled = false; } catch {}
        }
      });
    }

    // --- ISC auto-fit ---
    window.addEventListener('message', (ev) => {
      try {
        const data = ev.data || {};
        if (data.type === 'gc-isc-embed-size') {
          const f = document.getElementById("iscIframe");
          const tile = document.getElementById("tileCard");
          if (f && tile) {
            const tileH = Math.max(0, tile.getBoundingClientRect().height);
            const PAD_FUDGE = 24;
            const desired = Math.max(0, Number(data.height || 0));
            const clamped = Math.max(0, Math.min(desired, tileH - PAD_FUDGE));
            f.style.height = clamped + 'px';
            alignHeights();
          }
        }
      } catch {}
    });

    function parseZipFromAddress(addr="") {
      const m = String(addr).match(/\b(\d{5})(?:-\d{4})?\s*$/);
      return m ? m[1] : "";
    }

    async function loadLocalPros(zip) {
      try {
        const results = [];
        const q1 = query(collection(db, "localPros"), where("zips", "array-contains", zip));
        const snap1 = await getDocs(q1);
        snap1.forEach(d => {
          const x = d.data() || {};
          const status = String(x.status || "active").toLowerCase();
          if (status !== "active") return;
          results.push({
            id: d.id,
            name: x.name || "",
            role: (String(x.role || "")).toLowerCase(),
            phone: x.phone || "",
            email: x.email || "",
            photoUrl: x.photoUrl || x.imageUrl || x.cardUrl || x.photo || ""
          });
        });

        const seen = new Set(); const dedup = [];
        for (const r of results) {
          const key = (r.name||"")+"|"+(r.email||"")+"|"+r.id;
          if (seen.has(key)) continue; seen.add(key); dedup.push(r);
        }

        const isAgent = (r="") => /agent|broker|real\s*estate/.test(String(r).toLowerCase());
        const isLender= (r="") => /lender|loan|mortgage/.test(String(r).toLowerCase());
        const agents = dedup.filter(p=>isAgent(p.role)).slice(0,3);
        const lenders= dedup.filter(p=>isLender(p.role)).slice(0,1);

        if (!agents.length && !lenders.length && dedup.length) return { agents: dedup.slice(0,4), lenders: [] };
        return { agents, lenders };
      } catch (e) {
        console.warn("[local-pros] fetch failed:", e);
        return { agents: [], lenders: [] };
      }
    }

    function renderPros(zip, agents = [], lenders = []) {
      const card = document.getElementById("prosCard");
      const grid = document.getElementById("prosGrid");
      const zipSpan = document.getElementById("prosZip");
      const ctaBtn = document.getElementById("prosCtaBtn");
      if (!card || !grid) return;

      zipSpan.textContent = zip || "—";
      ctaBtn.href = `/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=search`;

      grid.innerHTML = "";
      const tiles = [];

      function makeTile(p) {
        const div = document.createElement("div");
        div.className = "overflow-hidden bg-white rounded-lg shadow-sm";
        const src = p.photoUrl || p.photo || "";
        if (src) {
          const img = document.createElement("img");
          img.src = src;
          img.alt = "Local Professional";
          img.className = "w-full h-40 object-contain bg-white";
          img.onerror = () => { img.replaceWith(noImage()); };
          div.appendChild(img);
        } else {
          div.appendChild(noImage());
        }
        return div;
      }
      function noImage() {
        const ph = document.createElement("div");
        ph.className = "w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
        ph.textContent = "No Image";
        return ph;
      }
      function makeGhostCard() {
        const a = document.createElement("a");
        a.href = `/local-professionals.html?zip=${encodeURIComponent(zip)}&mode=apply`;
        a.className = "block overflow-hidden rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50 transition";
        const inner = document.createElement("div");
        inner.className = "w-full h-40 flex flex-col items-center justify-center text-center p-3";
        inner.innerHTML = `
          <div class="text-gray-500 text-sm font-medium">Your Card Here</div>
          <div class="text-xs text-gray-400 mt-1">Click to advertise</div>
        `;
        a.appendChild(inner);
        return a;
      }

      // Combine agents and lenders
      agents.forEach(a => tiles.push(makeTile(a)));
      lenders.forEach(l => tiles.push(makeTile(l)));

      // Always render 4 cards total (fill with ghost cards)
      const TOTAL_SLOTS = 4;
      tiles.forEach(t => grid.appendChild(t));
      for (let i = tiles.length; i < TOTAL_SLOTS; i++) {
        grid.appendChild(makeGhostCard());
      }
    }

    async function loadLocalBrokers(zip) {
      try {
        const results = [];

        const qA = query(collection(db, "localBrokers"), where("status","==","active"), where("zip","==", zip));
        const qB = query(collection(db, "localBrokers"), where("status","==","active"), where("zips","array-contains", zip));
        const [sA, sB] = await Promise.all([getDocs(qA), getDocs(qB)]);

        sA.forEach(d => {
          const x = d.data() || {};
          results.push({ id: d.id, name: x.name || "", phone: x.phone || "", photoUrl: x.photoUrl || x.logoUrl || "" });
        });

        sB.forEach(d => {
          const x = d.data() || {};
          if (!results.find(r => r.id === d.id)) results.push({ id: d.id, name: x.name || "", phone: x.phone || "", photoUrl: x.photoUrl || x.logoUrl || "" });
        });

        return results.slice(0,4);
      } catch (e) {
        console.warn("[local-brokers] fetch failed:", e);
        return [];
      }
    }

    function renderBrokers(zip, items = []) {
      const card = document.getElementById("brokersCard");
      const grid = document.getElementById("brokersGrid");
      const zipSpan = document.getElementById("brokersZip");
      const cta = document.getElementById("brokersCtaBtn");
      if (!card || !grid) return;

      zipSpan.textContent = zip || "—";
      cta.href = `/local-brokers.html?zip=${encodeURIComponent(zip)}`;

      grid.innerHTML = "";

      // If no broker, show full-width ghost placeholder
      if (!Array.isArray(items) || items.length === 0) {
        const ghostBanner = document.createElement("a");
        ghostBanner.href = `/local-brokers.html?zip=${encodeURIComponent(zip)}&mode=apply`;
        ghostBanner.className = "block w-full h-80 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 bg-gray-50 rounded-lg text-center hover:border-blue-400 hover:bg-blue-50 transition";
        ghostBanner.innerHTML = `
          <div class="text-gray-600 text-lg font-semibold">Exclusive Brokerage Slot Available</div>
          <div class="text-gray-500 text-sm mt-2">Reserve This ZIP - $100/month</div>
          <div class="text-xs text-gray-400 mt-1">Your 1200×320 banner ad will display here</div>
        `;
        grid.appendChild(ghostBanner);
        return;
      }

      // Show the broker ad
      const b = items[0];
      const tile = document.createElement("div");
      tile.className = "overflow-hidden bg-white w-full";

      const img = document.createElement("img");
      img.src = b.photoUrl || b.logoUrl || "";
      img.alt = "Local Brokerage";
      img.className = "w-full h-80 object-contain bg-gray-50 rounded";
      img.onerror = () => {
        const ph = document.createElement("div");
        ph.className = "w-full h-80 bg-gray-200 flex items-center justify-center text-xs text-gray-600 rounded";
        ph.textContent = "No Logo";
        img.replaceWith(ph);
      };

      tile.appendChild(img);
      grid.appendChild(tile);
    }

    // ========== LOCAL SERVICE PROVIDERS ==========
    async function loadLocalServiceProviders(zip) {
      try {
        const results = [];
        const q1 = query(
          collection(db, "localServiceProviders"),
          where("status", "==", "active"),
          where("zips", "array-contains", zip)
        );
        const snap = await getDocs(q1);
        snap.forEach(d => {
          const x = d.data() || {};
          results.push({
            id: d.id,
            name: x.name || "",
            company: x.company || "",
            role: x.role || "Service Provider",
            phone: x.phone || "",
            email: x.email || "",
            photoUrl: x.photoUrl || x.photo || x.cardUrl || ""
          });
        });

        // Deduplicate by id
        const seen = new Set();
        const dedup = [];
        for (const r of results) {
          if (seen.has(r.id)) continue;
          seen.add(r.id);
          dedup.push(r);
        }

        // Return up to 8
        return dedup.slice(0, 8);
      } catch (e) {
        console.warn("[local-service-providers] fetch failed:", e);
        return [];
      }
    }

    function renderServiceProviders(zip, items = []) {
      const card = document.getElementById("serviceProvidersCard");
      const grid = document.getElementById("serviceProvidersGrid");
      const zipSpan = document.getElementById("serviceProvidersZip");
      const ctaBtn = document.getElementById("serviceProvidersCtaBtn");
      if (!card || !grid) return;

      zipSpan.textContent = zip || "—";
      ctaBtn.href = `/local-service-providers.html?zip=${encodeURIComponent(zip)}`;

      grid.innerHTML = "";

      function makeGhostCard() {
        const a = document.createElement("a");
        a.href = `/local-service-providers.html?zip=${encodeURIComponent(zip)}`;
        a.className = "block overflow-hidden rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50 transition";
        const inner = document.createElement("div");
        inner.className = "w-full h-40 flex flex-col items-center justify-center text-center p-3";
        inner.innerHTML = `
          <div class="text-gray-500 text-sm font-medium">Your Service Here</div>
          <div class="text-xs text-gray-400 mt-1">Click to advertise</div>
        `;
        a.appendChild(inner);
        return a;
      }

      // Render actual service provider cards (image only - matches Local Pros style)
      const validItems = Array.isArray(items) ? items : [];
      validItems.forEach(sp => {
        const tile = document.createElement("div");
        tile.className = "overflow-hidden bg-white rounded-lg shadow-sm";

        const photoSrc = sp.photoUrl || "";
        if (photoSrc) {
          const img = document.createElement("img");
          img.src = photoSrc;
          img.alt = sp.company || sp.name || "Service Provider";
          img.className = "w-full h-40 object-contain bg-white";
          img.onerror = () => {
            const ph = document.createElement("div");
            ph.className = "w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
            ph.textContent = "No Image";
            img.replaceWith(ph);
          };
          tile.appendChild(img);
        } else {
          const ph = document.createElement("div");
          ph.className = "w-full h-40 bg-gray-200 flex items-center justify-center text-xs text-gray-600";
          ph.textContent = "No Image";
          tile.appendChild(ph);
        }

        grid.appendChild(tile);
      });

      // Always render 8 cards total (fill with ghost cards)
      const TOTAL_SLOTS = 8;
      for (let i = validItems.length; i < TOTAL_SLOTS; i++) {
        grid.appendChild(makeGhostCard());
      }
    }

    (async function boot(){
      try {
        const url = new URL(window.location.href);
        let idParam   = (url.searchParams.get('id')   || '').trim();
        let addrParam = (url.searchParams.get('addr') || '').trim();

        if (!idParam)  idParam  = (localStorage.getItem('lastListingId') || '').trim();
        if (!addrParam) addrParam = (localStorage.getItem('lastListingAddress') || '').trim();

        const openA = document.getElementById("iscOpenLink");
        const iscIframe = document.getElementById("iscIframe");
        const base = "/printable-isc.html?embed=1";
        if (openA) openA.href = idParam
          ? `/printable-isc.html?id=${encodeURIComponent(idParam)}`
          : (addrParam ? `/printable-isc.html?addr=${encodeURIComponent(addrParam)}` : `/printable-isc.html`);
        if (iscIframe) iscIframe.src = idParam
          ? `${base}&id=${encodeURIComponent(idParam)}`
          : (addrParam ? `${base}&addr=${encodeURIComponent(addrParam)}` : `/printable-isc.html`);

        let d = null;

        if (idParam && db) {
          try {
            const snap = await getDoc(doc(db, "listings", idParam));
            if (snap.exists()) d = snap.data();
          } catch {}
        }

        if (!d && addrParam && db) {
          try {
            const snap = await getDocs(query(collection(db,"listings"), where("address","==", addrParam), limit(1)));
            if (!snap.empty) { idParam = snap.docs[0].id; d = snap.docs[0].data(); }
          } catch {}
        }

        if (!d) {
          document.getElementById("topRow")?.classList.remove("hidden");
          document.getElementById("tileStats").textContent = "Viewed — | Liked —";
          document.getElementById("tileAddress").textContent = "[full address]";
          return;
        }

        if (idParam) await incrementViewsOnce(idParam);

        const address = String(d.address || "").trim();
        if (address) document.title = address + " | GuaranteedCommission.com";
        const plan = String(d.plan || "Listed Property Basic");
        const status = String(d.status || "Active");

        // SOLD state (NEW)
        const isSold = status.trim().toLowerCase() === "sold";
        applyInquiryLockdown(isSold);
        const soldBadge = document.getElementById("soldBadge");
        if (soldBadge) soldBadge.classList.toggle("hidden", !isSold);

        const price = asNumOrEmpty(d.price);
        const cRaw  = dflt(d.commission, "");
        const cType = (d.commissionType === "%" || d.commissionType === "$") ? d.commissionType : "%";
        const pType = String(d.propertyType || "");
        const bds = dflt(d.bedrooms, "");
        const ba  = dflt(d.bathrooms, "");
        const sqft= dflt(d.sqft, "");
        const brokerage = String(d.brokerage || (plan.includes("FSBO") ? "FOR SALE BY OWNER" : "[listing brokerage]"));
        const agentName = String(d.agentName || "");
        const agentPhone= String(d.agentPhone || "");
        const banner    = String(d.bannerText || "");
        const photos = Array.isArray(d.photos) ? d.photos.filter(u=>typeof u==="string" && u) : [];
        let primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;
        if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;

        let primaryPhoto = photos[primaryIndex] || "";
        if (!primaryPhoto) {
          try {
            const ag = JSON.parse(localStorage.getItem("agentListing") || "{}");
            if (Array.isArray(ag.photos) && ag.photos.length) {
              primaryPhoto = ag.photos[(typeof ag.primaryIndex==="number")?ag.primaryIndex:0] || "";
            }
          } catch {}
        }

        document.getElementById("tilePhoto").src = primaryPhoto || "";
        const bEl = document.getElementById("tileBanner");
        if (banner) { bEl.textContent = banner; bEl.classList.remove('hidden'); } else { bEl.classList.add('hidden'); }

        const cAmt = (function(p, c, t){
          const P=Number(p||0), C=Number(c||0);
          if(!C) return 0; return t==='$'?Math.round(C):(P?Math.round(P*(C/100)):0);
        })(price, cRaw, cType);
        const cPctLabel = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw)+'%')) : "—";

        document.getElementById("tilePrice").textContent = money(price);
        document.getElementById("tileCommission").textContent = `Commission ${cPctLabel} | ${cAmt ? money(cAmt) : "$—"}`;
        document.getElementById("tileFacts").textContent = `${bds || "—"} bds | ${ba || "—"} ba | ${sqft || "—"} sqft${pType ? " | "+pType : ""} | ${status}`;
        document.getElementById("tileAddress").textContent = address || "[full address]";

        const isFSBO = plan.includes("FSBO");
        const contactName = isFSBO ? String(d.ownerName || "") : agentName;
        const contactPhone = isFSBO ? String(d.ownerPhone || "") : agentPhone;
        const contactLabel = isFSBO ? "FOR SALE BY OWNER" : brokerage.toUpperCase();
        document.getElementById("tileContact").textContent = `${contactLabel}${contactName ? ' - ' + contactName : ''}${contactPhone ? ' - ' + contactPhone : ''}`;

        document.getElementById("topRow")?.classList.remove("hidden");

        if (address) bootMapFor(address);

        const desc = (d.description || "").trim();
        if (desc) {
          document.getElementById("dDescription").textContent = desc;
          document.getElementById("descCard").classList.remove("hidden");
        }
        const others = photos.filter((_, i) => i !== primaryIndex);
        if (others.length > 0) {
          const grid = document.getElementById("galleryGrid");
          grid.innerHTML = "";
          others.forEach(src => {
            const img = document.createElement("img");
            img.src = src; img.alt = "Listing photo";
            img.className = "w-full h-32 object-cover rounded bg-gray-100";
            grid.appendChild(img);
          });
          document.getElementById("galleryCard").classList.remove("hidden");
        }

        const zip = (d.zip && String(d.zip)) || parseZipFromAddress(address);
        
        // Always render the advertising sections (with ghost cards if no data)
        const { agents, lenders } = zip ? await loadLocalPros(zip) : { agents: [], lenders: [] };
        renderPros(zip || "—", agents, lenders);

        const brokers = zip ? await loadLocalBrokers(zip) : [];
        renderBrokers(zip || "—", brokers);

        // Load and render Local Service Providers
        const serviceProviders = zip ? await loadLocalServiceProviders(zip) : [];
        renderServiceProviders(zip || "—", serviceProviders);

        if (idParam) await paintStats(idParam);

        const favKeyId = idParam ? ('fav:'+idParam) : ('fav:'+address);
        setupHeart(idParam || address, favKeyId);

        const shareUrl = idParam
          ? (window.location.origin + '/listing.html?id=' + encodeURIComponent(idParam))
          : (window.location.origin + '/listing.html?addr=' + encodeURIComponent(address));

        const emailBtn = document.getElementById("shareEmailBtn");
        const textBtn  = document.getElementById("shareTextBtn");
        if (emailBtn) {
          emailBtn.addEventListener('click', (e)=> {
            e.preventDefault();
            if (!shareLimitOk()) return;
            openEmail(address, shareUrl);
          });
        }
        if (textBtn) {
          textBtn.addEventListener('click', (e)=> {
            e.preventDefault();
            if (!shareLimitOk()) return;
            openText(address, shareUrl);
          });
        }

        setTimeout(alignHeights, 80);
        window.addEventListener('resize', alignHeights);

      } catch (e) {
        console.warn(e);
        document.body.insertAdjacentHTML("afterbegin",
          `<div class="max-w-7xl mx-auto px-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-900">
              We couldn't load this listing. Please refresh.
            </div>
          </div>`);
      }
    })();
  </script>
</body>
</html>
