<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing Detail | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .font-cursive { font-family: 'Brush Script MT', cursive; }

    /* Listing tile */
    .tile-photo { width:100%; height: 20rem; object-fit: cover; background:#e5e7eb; }
    .tile-banner { position:absolute; top:12px; left:12px; background:rgba(0,0,0,.8); color:#fff; font-size:12px; font-weight:600; border-radius:9999px; padding:4px 8px; }
    .heart-btn { position:absolute; top:12px; right:12px; width: 32px; height: 32px; border-radius:9999px; background:rgba(255,255,255,.95); display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,.2); }

    .mapboxgl-canvas { display:block !important; }

    /* Right ISC: borderless like map; full-height via postMessage */
    .click-wrap { position: relative; width:100%; height:100%; }
    .click-wrap a.overlay { position:absolute; inset:0; z-index:10; text-indent:-9999px; }
    .isc-iframe { width:100%; border:0; margin:0; display:block; background:transparent; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(0,0,0,.08); overflow:hidden; }
    .isc-container { background:transparent !important; box-shadow:none !important; border:0 !important; border-radius:0 !important; }

    /* Message boxes */
    .info { background:#EFF6FF; color:#1E3A8A; border:1px solid #BFDBFE; }
    .warn { background:#FEF3C7; color:#92400E; border:1px solid #FDE68A; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Top bar -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/index.html#strip2Search" class="text-sm text-blue-600 hover:underline">&larr; Back to Search</a>
      <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-4">

    <!-- Visible diagnostics so we're never guessing -->
    <section id="debugBox" class="hidden info rounded-lg p-4 text-sm mono"></section>

    <!-- Friendly messages instead of blank page -->
    <section id="msgBox" class="hidden warn rounded-lg p-4 text-sm"></section>

    <!-- Top strip: 40 | 20 | 40 -->
    <section id="topRow" class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-start hidden">

      <!-- Left: LISTING TILE -->
      <article id="tileCard" class="lg:col-span-2 card relative">
        <div class="relative">
          <img id="tilePhoto" class="tile-photo" alt="Listing photo"/>
          <div id="tileBanner" class="tile-banner hidden"></div>
          <button id="tileHeart" type="button" class="heart-btn" aria-label="Like"></button>
        </div>
        <div class="p-4 space-y-1">
          <div class="flex items-center justify-between text-[16px] sm:text-[18px] font-semibold">
            <div id="tilePrice" class="truncate">$—</div>
            <div id="tileCommission" class="truncate text-red-600">Commission — | $—</div>
          </div>
          <div id="tileFacts" class="text-[12px] text-gray-700">— bds | — ba | — sqft | Draft</div>
          <div id="tileAddress" class="text-sm font-medium">[full address]</div>
          <div id="tileContact" class="text-[12px] text-gray-600">[LISTING BROKERAGE] — [listing agent] — [agent phone]</div>
        </div>
      </article>

      <!-- Middle: MAP -->
      <aside id="mapCard" class="lg:col-span-1 overflow-hidden p-0" style="height:auto;">
        <div id="mapCanvas" style="width:100%; height:100%;"></div>
      </aside>

      <!-- Right: ISC (iframe preview, borderless, auto-size) -->
      <aside id="iscCard" class="lg:col-span-2 isc-container p-0 m-0" style="height:auto;">
        <div class="click-wrap">
          <a id="iscOpenLink" class="overlay" href="/printable-isc.html" target="_blank" aria-label="Open full ISC">Open</a>
          <iframe id="iscIframe" src="/printable-isc.html" class="isc-iframe" scrolling="no"></iframe>
        </div>
      </aside>
    </section>

    <!-- LOWER SECTION -->
    <section class="space-y-6">
      <div id="galleryCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Photos</h3>
        <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

      <div id="descCard" class="card p-5 hidden">
        <h3 class="text-lg font-semibold mb-3">Description</h3>
        <p id="dDescription" class="text-sm leading-relaxed whitespace-pre-line"></p>
      </div>
    </section>

  </main>

  <!-- Firebase init -->
  <script type="module" src="/scripts/firebase-init.js"></script>

  <script>
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZ3VhcmFudGVlZGNvbW1pc3Npb24tY29tIiwiYSI6ImNtZXJvbjduajA5MW8yanBvMTgxcWx2a2IifQ.dMBWViogHJkh0SgeVX5N_Q";
    if (MAPBOX_TOKEN && window.mapboxgl) mapboxgl.accessToken = MAPBOX_TOKEN;

    const $ = (id) => document.getElementById(id);
    const money = (n)=>{ const v=Number(n||0); return v?("$"+v.toLocaleString()):"$—"; };

    function showMsg(txt) {
      const box = $("msgBox");
      box.innerHTML = txt;
      box.classList.remove("hidden");
    }
    function showDbg(lines) {
      const box = $("debugBox");
      box.innerHTML = Array.isArray(lines) ? lines.join("<br>") : String(lines || "");
      box.classList.remove("hidden");
    }

    function resizeIscToContent(h) {
      try {
        const iframe = $("iscIframe");
        const mapCard = $("mapCard");
        const tileCard = $("tileCard");
        if (!iframe || !mapCard || !tileCard) return;
        iframe.style.height = h + "px";
        mapCard.style.height = h + "px";
        tileCard.style.height = h + "px";
      } catch {}
    }

    window.addEventListener("message", (ev) => {
      if (!ev || !ev.data) return;
      if (ev.data.type === "gc-isc-embed-size" && typeof ev.data.height === "number") {
        const h = Math.max(0, ev.data.height);
        resizeIscToContent(h);
      }
    });

    // simple map boot
    async function bootMapFor(fullAddress){
      try {
        const c = await geocode(fullAddress);
        const m = new mapboxgl.Map({
          container:'mapCanvas',
          style:'mapbox://styles/mapbox/streets-v12',
          center: c || [-117.7854,33.5427],
          zoom: c ? 14 : 12
        });
        m.addControl(new mapboxgl.NavigationControl());
        if (c) new mapboxgl.Marker().setLngLat(c).addTo(m);
        requestAnimationFrame(()=>m.resize());
        setTimeout(()=>m.resize(), 250);
      } catch {
        $("mapCanvas").innerHTML = '<div class="h-full w-full flex items-center justify-center text-gray-500 text-sm">Map unavailable</div>';
      }
    }
    async function geocode(q) {
      if (!MAPBOX_TOKEN || !q) return null;
      try {
        const resp = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?limit=1&access_token=${MAPBOX_TOKEN}`);
        const data = await resp.json();
        const f = data?.features?.[0];
        return f ? f.center : null; // [lng, lat]
      } catch { return null; }
    }
  </script>

  <!-- Robust loader with defensive fallbacks and clear diagnostics -->
  <script type="module">
    import { db } from "/scripts/firebase-init.js";
    import {
      getDoc, doc, getDocs, collection, query, where, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = (id)=>document.getElementById(id);

    function dflt(v, dv) { return (v===undefined || v===null) ? dv : v; }
    function asNumOrEmpty(v) {
      if (typeof v === "number") return v;
      if (typeof v === "string" && v.trim() !== "" && !isNaN(Number(v))) return Number(v);
      return "";
    }

    (async function boot(){
      try {
        const url = new URL(window.location.href);
        let idParam   = (url.searchParams.get('id')   || '').trim();
        let addrParam = (url.searchParams.get('addr') || '').trim();

        if (!idParam)  idParam  = (localStorage.getItem('lastListingId') || '').trim();
        if (!addrParam) addrParam = (localStorage.getItem('lastListingAddress') || '').trim();

        showDbg([
          `id: ${idParam || "(none)"}`,
          `addr: ${addrParam || "(none)"}`
        ]);

        // Wire ISC (embed=1 for borderless)
        const openA = $("iscOpenLink");
        const iscIframe = $("iscIframe");
        const base = "/printable-isc.html?embed=1";
        if (openA) openA.href = idParam
          ? `/printable-isc.html?id=${encodeURIComponent(idParam)}`
          : (addrParam ? `/printable-isc.html?addr=${encodeURIComponent(addrParam)}` : `/printable-isc.html`);
        if (iscIframe) iscIframe.src = idParam
          ? `${base}&id=${encodeURIComponent(idParam)}`
          : (addrParam ? `${base}&addr=${encodeURIComponent(addrParam)}` : `/printable-isc.html`);

        let d = null, from = "";

        // 1) by id
        if (idParam && db) {
          try {
            const snap = await getDoc(doc(db, "listings", idParam));
            if (snap.exists()) { d = snap.data(); from = "id"; }
          } catch (e) { showDbg([`load by id failed: ${String(e)}`]); }
        }

        // 2) by exact address
        if (!d && addrParam && db) {
          try {
            const snap = await getDocs(query(collection(db,"listings"), where("address","==", addrParam), limit(1)));
            if (!snap.empty) { d = snap.docs[0].data(); from = "addr=="; }
          } catch (e) { showDbg([`load by addr failed: ${String(e)}`]); }
        }

        // 3) Local preview fallback
        if (!d) {
          const fd  = (function(){ try { return JSON.parse(localStorage.getItem('formData') || '{}'); } catch { return {}; } })();
          const ag  = (function(){ try { return JSON.parse(localStorage.getItem('agentListing') || '{}'); } catch { return {}; } })();
          if (fd && fd.address) {
            showDbg([`rendering local preview (no server match)`]);
            renderLocal(fd, ag);
            document.getElementById("topRow")?.classList.remove("hidden");
            return;
          }
          showMsg("We couldn't load this listing. If you just created it, try again in a moment.");
          return;
        }

        // Normalize safely
        const address = String(d.address || "").trim();
        const plan = String(d.plan || "Listed Property Basic");
        const status = String(d.status || "Active");
        const price = asNumOrEmpty(d.price);
        const cRaw  = dflt(d.commission, "");
        const cType = (d.commissionType === "%" || d.commissionType === "$") ? d.commissionType : "%";
        const pType = String(d.propertyType || "");
        const bds = dflt(d.bedrooms, "");
        const ba  = dflt(d.bathrooms, "");
        const sqft= dflt(d.sqft, "");
        const brokerage = String(d.brokerage || (plan.includes("FSBO") ? "FOR SALE BY OWNER" : "[listing brokerage]"));
        const agentName = String(d.agentName || "");
        const agentPhone= String(d.agentPhone || "");
        const banner    = String(d.bannerText || "");
        const photos = Array.isArray(d.photos) ? d.photos.filter(u=>typeof u==="string") : [];
        let primaryIndex = (typeof d.primaryIndex === "number") ? d.primaryIndex : 0;
        if (primaryIndex < 0 || primaryIndex >= photos.length) primaryIndex = 0;

        // If no server photo yet, try local one
        let primaryPhoto = photos[primaryIndex] || "";
        if (!primaryPhoto) {
          try {
            const ag = JSON.parse(localStorage.getItem("agentListing") || "{}");
            if (Array.isArray(ag.photos) && ag.photos.length) {
              primaryPhoto = ag.photos[(typeof ag.primaryIndex==="number")?ag.primaryIndex:0] || "";
            }
          } catch {}
        }

        // Paint
        $("tilePhoto").src = primaryPhoto || "";
        const bEl = $("tileBanner"); 
        if (banner) { bEl.textContent = banner; bEl.classList.remove('hidden'); } else { bEl.classList.add('hidden'); }

        const cAmt = (function(p, c, t){
          const P=Number(p||0), C=Number(c||0);
          if(!C) return 0; return t==='$'?Math.round(C):(P?Math.round(P*(C/100)):0);
        })(price, cRaw, cType);
        const cPctLabel = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw)+'%')) : "—";

        $("tilePrice").textContent = money(price);
        $("tileCommission").textContent = `Commission ${cPctLabel} | ${cAmt ? money(cAmt) : "$—"}`;
        $("tileFacts").textContent = `${bds || "—"} bds | ${ba || "—"} ba | ${sqft || "—"} sqft${pType ? " | "+pType : ""} | ${status}`;
        $("tileAddress").textContent = address || "[full address]";
        $("tileContact").textContent = `${(plan.includes("FSBO") ? "FOR SALE BY OWNER" : brokerage).toUpperCase()}${agentName ? ' — '+agentName : ''}${agentPhone ? ' — '+agentPhone : ''}`;

        document.getElementById("topRow")?.classList.remove("hidden");

        // Map
        if (address) bootMapFor(address);

        // Note where it came from
        showDbg([`loaded from: ${from}`, `rendered address: ${address || "(none)"}`]);

      } catch (e) {
        console.warn(e);
        showMsg("Unexpected error loading this listing. Please refresh.");
      }
    })();

    function renderLocal(fd, ag) {
      const $ = (id)=>document.getElementById(id);
      const address = fd.address || "[full address]";
      const price = ag.price ?? "";
      const cRaw = ag.commission ?? fd.commission ?? "";
      const cType= ag.commissionType ?? fd.commissionType ?? "%";
      const pType = ag.propertyType || "";
      const bds = ag.bedrooms ?? "—";
      const ba  = ag.bathrooms ?? "—";
      const sqft= ag.sqft ? Number(ag.sqft).toLocaleString() : (fd.sqft || "—");
      const status = ag.status || "Draft";
      const brokerage = fd.brokerage || (fd.plan && fd.plan.includes("FSBO") ? "FOR SALE BY OWNER" : "[listing brokerage]");
      const agentName = fd.agent || "[listing agent]";
      const agentPhone = fd.agentPhone || "[agent phone]";

      // Photo local
      const photos = Array.isArray(ag.photos) ? ag.photos : [];
      const primaryIndex = (typeof ag.primaryIndex === "number" ? ag.primaryIndex : 0);
      const primaryPhoto = photos[primaryIndex] || "";

      $("tilePhoto").src = primaryPhoto || "";
      const cAmt = (function(p, c, t){
        const P=Number(p||0), C=Number(c||0);
        if(!C) return 0; return t==='$'?Math.round(C):(P?Math.round(P*(C/100)):0);
      })(price, cRaw, cType);
      const cPctLabel = cRaw ? (cType === '$' ? money(cRaw) : (Number(cRaw)+'%')) : "—";

      $("tilePrice").textContent = money(price);
      $("tileCommission").textContent = `Commission ${cPctLabel} | ${cAmt ? money(cAmt) : "$—"}`;
      $("tileFacts").textContent = `${bds} bds | ${ba} ba | ${sqft} sqft${pType ? " | "+pType : ""} | ${status}`;
      $("tileAddress").textContent = address;
      $("tileContact").textContent = `${(fd.plan && fd.plan.includes("FSBO") ? "FOR SALE BY OWNER" : (brokerage||"[listing brokerage]")).toUpperCase()}${agentName ? ' — '+agentName : ''}${agentPhone ? ' — '+agentPhone : ''}`;

      // Map
      bootMapFor(address);

      // Let the ISC iframe size the row after it loads
      const ifr = $("iscIframe");
      ifr.addEventListener("load", () => {
        // the embedded page will post its height
      });
    }
  </script>
</body>
</html>
