<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listing | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .gc-hero { position: relative; border-radius: 0.75rem; overflow: hidden; }
    .gc-hero img { width: 100%; height: 22rem; object-fit: cover; background: #e5e7eb; }
    .gc-badge {
      position: absolute; top: 12px; left: 12px;
      background: rgba(0,0,0,0.7); color: #fff; padding: 6px 10px; border-radius: 8px;
      font-size: 13px;
    }
    .gc-ribbon {
      position: absolute; top: 12px; right: -10px; transform: rotate(10deg);
      background: #2563eb; color: #fff; padding: 8px 14px; border-radius: 8px;
      font-size: 12px; max-width: 200px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
    }
    .font-cursive { font-family: 'Brush Script MT', cursive; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Top bar -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/#strip2Search" class="text-sm text-blue-600 hover:underline">&larr; Back to Search</a>
      <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log in</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Address / Price -->
    <div class="mb-4">
      <h2 id="addrLine" class="text-2xl md:text-3xl font-bold">[Full Address]</h2>
      <p id="priceLine" class="text-xl text-gray-700 mt-1">$—</p>
    </div>

    <!-- Hero -->
    <div class="gc-hero mb-6">
      <img id="heroImg" alt="Main listing photo" />
      <div id="ribbon" class="gc-ribbon hidden"></div>
      <div id="commissionBadge" class="gc-badge hidden"></div>
    </div>

    <!-- Two columns -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Details -->
      <section class="lg:col-span-2 space-y-6">
        <!-- Quick facts -->
        <div class="bg-white rounded shadow p-4">
          <h3 class="text-lg font-semibold mb-3">Listing Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">Address:</span> <span id="detailAddress" class="font-medium"></span></div>
            <div><span class="text-gray-500">Listing Price:</span> <span id="detailPrice" class="font-medium"></span></div>
            <div><span class="text-gray-500">Commission:</span> <span id="detailCommission" class="font-medium"></span></div>
            <div><span class="text-gray-500">Estimated Commission (USD):</span> <span id="detailCommissionCalc" class="font-medium"></span></div>
            <div><span class="text-gray-500">APN / Parcel:</span> <span id="detailAPN" class="font-medium"></span></div>
            <div><span class="text-gray-500">Plan:</span> <span id="detailPlan" class="font-medium"></span></div>
          </div>
        </div>

        <!-- Description (only if present; usually Plus) -->
        <div id="descCard" class="bg-white rounded shadow p-4 hidden">
          <h3 class="text-lg font-semibold mb-3">Description</h3>
          <p id="detailDescription" class="text-sm leading-relaxed whitespace-pre-line"></p>
        </div>

        <!-- Gallery (if photos beyond primary) -->
        <div id="galleryCard" class="bg-white rounded shadow p-4 hidden">
          <h3 class="text-lg font-semibold mb-3">Photos</h3>
          <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        </div>
      </section>

      <!-- Right: Contact + Actions -->
      <aside class="space-y-4">
        <div class="bg-white rounded shadow p-4">
          <h3 class="text-lg font-semibold mb-2">Contact</h3>
          <!-- Listed -->
          <div id="listedContact" class="text-sm hidden">
            <div><span class="text-gray-500">Brokerage:</span> <span id="cBrokerage" class="font-medium"></span></div>
            <div><span class="text-gray-500">Agent:</span> <span id="cAgent" class="font-medium"></span></div>
            <div><span class="text-gray-500">Agent Phone:</span> <span id="cAgentPhone" class="font-medium"></span></div>
          </div>
          <!-- FSBO -->
          <div id="fsboContact" class="text-sm hidden">
            <div><span class="text-gray-500">Owner Phone:</span> <span id="cOwnerPhone" class="font-medium"></span></div>
            <div><span class="text-gray-500">Owner Email:</span> <span id="cOwnerEmail" class="font-medium"></span></div>
          </div>

          <div class="mt-4 flex flex-col gap-2">
            <a href="/printable-isc.html" class="w-full text-center bg-gray-700 text-white py-2 rounded">View / Print ISC</a>
            <a href="#" data-isc-pdf class="w-full text-center bg-blue-600 text-white py-2 rounded">Download ISC PDF</a>
            <a href="/login.html" class="w-full text-center bg-green-600 text-white py-2 rounded">Log in to Message</a>
          </div>
        </div>

        <div class="bg-white rounded shadow p-4 text-sm text-gray-600">
          <p><strong>Commission clarity helps homes sell.</strong> This listing states buyer’s agent compensation up front to improve showings and outcomes.</p>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // Utility
    const fmtUSD = (v) => {
      const n = Number(v || 0);
      if (!n) return "$—";
      return "$" + n.toLocaleString();
    };

    const url = new URL(window.location.href);
    const id = url.searchParams.get("id") || "local-preview";

    // Try local sources first (seller/agent flow); fall back to empty objects
    const formData = (() => { try { return JSON.parse(localStorage.getItem("formData") || "{}"); } catch { return {}; } })();
    const agentListing = (() => { try { return JSON.parse(localStorage.getItem("agentListing") || "{}"); } catch { return {}; } })();
    const plan = (localStorage.getItem("selectedPlan") || "Listed Property Basic").trim();

    // Compose display values with safe fallbacks (so cold visitors still see a complete page)
    const fullAddress = formData.address || "[full address]";
    const price = (agentListing.price ?? "");
    const commission = (agentListing.commission ?? (formData.commission || ""));
    const commissionType = (agentListing.commissionType ?? (formData.commissionType || "%"));
    const apn = formData.apn || "[Parcel # / Pin # / Tax ID # / Folio # / APN #]";
    const bannerText = (agentListing.bannerText || "").trim();
    const description = (agentListing.description || "").trim();

    const photos = Array.isArray(agentListing.photos) ? agentListing.photos : [];
    const primaryIndex = (typeof agentListing.primaryIndex === "number" ? agentListing.primaryIndex : 0);
    const primaryPhoto = photos[primaryIndex] || "";

    const commissionDisplay = commissionType === "$"
      ? (commission ? ("$" + Number(commission || 0).toLocaleString()) : "[commission]")
      : (commission ? (commission + "%") : "[commission]");

    let commissionEstimate = "—";
    const pNum = Number(price || 0);
    const cNum = Number(commission || 0);
    if (cNum) {
      if (commissionType === "$") {
        commissionEstimate = "$" + Math.round(cNum).toLocaleString();
      } else if (pNum) {
        commissionEstimate = "$" + Math.round(pNum * (cNum / 100)).toLocaleString();
      }
    }

    // Paint header
    document.getElementById("addrLine").textContent = fullAddress;
    document.getElementById("priceLine").textContent = fmtUSD(price);

    // Hero
    const heroImg = document.getElementById("heroImg");
    heroImg.src = primaryPhoto || "";
    const ribbon = document.getElementById("ribbon");
    const badge = document.getElementById("commissionBadge");

    if (bannerText) {
      ribbon.textContent = bannerText;
      ribbon.classList.remove("hidden");
    }
    if (cNum) {
      const badgeText = (commissionType === "$")
        ? `Commission: $${Math.round(cNum).toLocaleString()}`
        : `Commission: ${cNum}%${pNum ? ` (~$${Math.round(pNum * (cNum/100)).toLocaleString()})` : ""}`;
      badge.textContent = badgeText;
      badge.classList.remove("hidden");
    }

    // Details card
    document.getElementById("detailAddress").textContent = fullAddress;
    document.getElementById("detailPrice").textContent = fmtUSD(price);
    document.getElementById("detailCommission").textContent = commissionDisplay;
    document.getElementById("detailCommissionCalc").textContent = commissionEstimate;
    document.getElementById("detailAPN").textContent = apn;
    document.getElementById("detailPlan").textContent = plan || "—";

    // Description & Gallery cards
    const descCard = document.getElementById("descCard");
    const descEl = document.getElementById("detailDescription");
    if (description) {
      descEl.textContent = description;
      descCard.classList.remove("hidden");
    }

    const galleryCard = document.getElementById("galleryCard");
    const galleryGrid = document.getElementById("galleryGrid");
    const otherPhotos = photos.filter((_, i) => i !== primaryIndex);
    if (otherPhotos.length > 0) {
      otherPhotos.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Listing photo";
        img.className = "w-full h-32 object-cover rounded";
        galleryGrid.appendChild(img);
      });
      galleryCard.classList.remove("hidden");
    }

    // Contact (Listed vs FSBO)
    const isFSBO = (plan || "").includes("FSBO");
    const listedContact = document.getElementById("listedContact");
    const fsboContact = document.getElementById("fsboContact");

    if (isFSBO) {
      document.getElementById("cOwnerPhone").textContent = formData.agentPhone || "[owner/seller phone number]";
      document.getElementById("cOwnerEmail").textContent = formData.brokerage || "[owner/seller email]";
      fsboContact.classList.remove("hidden");
    } else {
      document.getElementById("cBrokerage").textContent = formData.brokerage || "[listing brokerage]";
      document.getElementById("cAgent").textContent = formData.agent || "[listing agent]";
      document.getElementById("cAgentPhone").textContent = formData.agentPhone || "[agent phone]";
      listedContact.classList.remove("hidden");
    }

    // ------ Provide a complete, public-safe ISC context for the PDF helper ------
    // Fallbacks ensure a cold visitor still downloads a coherent ISC.
    const sellerName = formData.name || formData.sellerName || "[Name]";
    const addressShort = (fullAddress || "").split(",")[0] || "[short address]";

    window.__ISC_CONTEXT = {
      // which template branch to render
      variant: isFSBO ? "fsbo" : "listed",

      // shared
      sellerName,
      signatureName: sellerName,
      addressFull: fullAddress,
      addressShort,
      apn: apn,

      commissionValue: String(commission || ""),
      commissionType: commissionType === "$" ? "$" : "%",

      // listed branch
      brokerage: formData.brokerage || "",
      agent: formData.agent || "",
      agentPhone: formData.agentPhone || "",

      // fsbo branch (we re-used these fields in Box 2)
      fsboPhone: formData.agentPhone || "",
      fsboEmail: formData.brokerage || "",

      // nice-to-haves for headers/footers
      plan,
      source: "listing.html",
      // a stable-ish key for per-ISC view counters, etc.
      counterKey: "iscViewCount:" + (fullAddress || "unknown")
    };

    // Optional: warn if helper script is missing
    document.querySelector('[data-isc-pdf]')?.addEventListener('click', (e) => {
      if (!window.gcBuildIscPdf) {
        e.preventDefault();
        alert("PDF helper not loaded yet. Please try again in a moment.");
      }
    });
  </script>

  <!-- jsPDF + ISC PDF Helper -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="/scripts/isc-pdf.js"></script>

  <!-- Title polish -->
  <script>
    (function(){
      try {
        const fd = JSON.parse(localStorage.getItem('formData') || '{}');
        const short = (fd.address || '').split(',')[0] || 'Listing';
        document.title = short + ' — Full Listing Detail';
      } catch {}
    })();
  </script>
</body>
</html>
