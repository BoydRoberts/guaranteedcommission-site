<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upgrade Your Listing | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 6px rgba(0,0,0,.08); padding:1rem 1.25rem; }
    .muted { color:#6b7280; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="flex justify-between items-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="text-xs hover:underline" style="color:#4DA6FF;">Home</a>
      <div class="text-center">
        <h1 class="text-lg font-semibold">GuaranteedCommission.com</h1>
        <p class="text-xs text-gray-600">Guaranteeing commissions so your home will sell quickly at a higher price.</p>
      </div>
      <a href="/advertise.html" class="text-xs hover:underline" style="color:#4DA6FF;">Advertise</a>
    </div>
  </header>

  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-2xl font-bold text-center">Upgrade Your Listing</h1>
    <p class="text-sm text-center muted mt-1">You will be able to review all upgrades and upsells at Review &amp; Checkout.</p>

    <div id="planRow" class="text-center text-xs muted mt-4"></div>
    <div id="prog" class="text-xs text-center muted mt-4"></div>
    <div id="stepHost" class="mt-4"></div>

    <div class="mt-6 flex items-center justify-end">
      <div class="flex gap-2">
        <button id="btnSkip" class="px-4 py-2 rounded border">Skip</button>
        <button id="btnAdd" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Add &amp; Continue</button>
        <a id="btnCheckout" href="/checkout.html" class="hidden px-5 py-2 rounded bg-green-600 text-white hover:bg-green-700">Review &amp; Checkout</a>
      </div>
    </div>
  </div>

  <script>
    // ----- Upsell wizard with CORRECT pricing -----
    const $ = s => document.querySelector(s);
    const getJSON = (k, fb) => { try { return JSON.parse(localStorage.getItem(k)) ?? fb; } catch { return fb; } };
    const setJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    const plan = (localStorage.getItem('selectedPlan') || 'Listed Property Basic').trim();
    if (!localStorage.getItem('originalPlan')) localStorage.setItem('originalPlan', plan);

    let data = getJSON('checkoutData', {
      plan,
      base: plan === 'FSBO Plus' ? 100 : (plan === 'Listed Property Plus' ? 20 : 0),
      upgrades: { upgradeToPlus:false, banner:false, premium:false, pin:false, confidential:false },
      prices:  { plus:20, banner:10, premium:10, pin:50, confidential:100 },
      meta: {},
      total: 0
    });

    const steps = (() => {
      if (plan === 'Listed Property Basic') return ['upgrade','banner','premium','pin'];
      if (plan === 'Listed Property Plus')  return ['banner','premium','pin'];
      if (plan === 'FSBO Plus')             return ['banner','premium','pin','confidential'];
      return ['banner','premium','pin'];
    })();
    let idx = 0;
    
    // ✅ Read step from URL if present (supports refresh/bookmark)
    const urlStep = Number(new URL(location.href).searchParams.get('step'));
    if (!Number.isNaN(urlStep) && urlStep >= 0 && urlStep < steps.length) {
      idx = urlStep;
    }

    // ✅ History management for Back button support
    function pushStepToHistory(stepIndex) {
      const state = { page: 'upsell', step: stepIndex };
      const url = new URL(window.location.href);
      url.searchParams.set('step', stepIndex);
      history.pushState(state, '', url.toString());
    }

    // ✅ Initialize first step in history (use replaceState to avoid extra entry)
    if (!history.state || history.state.page !== 'upsell') {
      const state = { page: 'upsell', step: idx };  // ✅ Use idx (may be from URL)
      const url = new URL(window.location.href);
      url.searchParams.set('step', String(idx));  // ✅ Use idx, not hardcoded 0
      history.replaceState(state, '', url.toString());
    } else if (typeof history.state.step === 'number') {
      idx = history.state.step;
    }

    // ✅ Handle browser Back button
    window.addEventListener('popstate', (event) => {
      if (event.state && event.state.page === 'upsell' && typeof event.state.step === 'number') {
        idx = event.state.step;
        renderStep();
      }
      // If no valid state, do nothing - let browser handle Back naturally
    });

    const copies = {
      upgrade:      { title:'Upgrade to Listed Property Plus ($20)', body:'Display full property description and up to 20 photos until your home is sold.', price:20, key:'upgradeToPlus' },
      banner:       { title:'Add Banner ($10)', body:'Add a 30-character banner. Highlight special features, open houses, or whatever you like – as often as you like – until your home is sold.', price:10, key:'banner' },
      premium:      { title:'Add Premium Placement ($10)', body:'Boost visibility so your listing is seen sooner by buyers and agents.', price:10, key:'premium' },
      pin:          { title:'Add Pin Placement ($50)', body:'Pin your listing to the top of results in key areas. Includes Premium Placement free.', price:50, key:'pin' },
      confidential: { title:'Confidential FSBO Upgrade ($100)', body:'Keep your contact information private and avoid solicitation. GuaranteedCommission.com will not sell your information to third parties.', price:100, key:'confidential' }
    };

    function renderStep() {
      const host = $('#stepHost');
      host.innerHTML = '';
      $('#prog').textContent = `Step ${idx+1} of ${steps.length}`;
      const sid = steps[idx];
      const c = copies[sid];

      const planRow = $('#planRow');
      if (plan === 'Listed Property Basic' && sid === 'upgrade') {
        planRow.innerHTML = `
          <div class="text-xs text-gray-700">
            <strong>Current plan: Listed Property Basic – FREE</strong><br>
            <span class="muted">(Includes: printable commission letter, map search, listing price, main photo, address, parcel #, sqft, beds, baths, listing brokerage, listing agent, agent phone. Does not include full description.)</span>
          </div>`;
        planRow.classList.remove('hidden');
      } else {
        planRow.classList.add('hidden');
        planRow.innerHTML = '';
      }

      const checked = !!data.upgrades[c.key];
      const el = document.createElement('section');
      el.className = 'card';
      el.innerHTML = `
        <h2 class="text-lg font-semibold">${c.title}</h2>
        <p class="text-sm muted mt-1">${c.body}</p>
        <div class="mt-3 flex items-center justify-between">
          <label class="flex items-center gap-2 text-sm">
            <input id="ck" type="checkbox" class="h-4 w-4" ${checked ? 'checked':''}/>
            <span>Select</span>
          </label>
          <span class="font-semibold">$${c.price}</span>
        </div>`;
      host.appendChild(el);

      $('#btnCheckout').classList.toggle('hidden', idx !== steps.length - 1);
    }

    function saveCurrent(addSelected) {
      const sid = steps[idx];
      const c = copies[sid];
      const uiChecked = !!document.querySelector('#ck')?.checked;
      const final = uiChecked;  // ✅ FIX: Checkbox state determines selection

      if (sid === 'upgrade') {
        data.upgrades.upgradeToPlus = !!final;
        
        if (final) {
          localStorage.setItem('selectedPlan', 'Listed Property Plus');
          data.plan = 'Listed Property Plus';
          data.base = 20;
        } else {
          // ✅ FIX: When unchecking upgrade, revert to Basic
          localStorage.setItem('selectedPlan', 'Listed Property Basic');
          data.plan = 'Listed Property Basic';
          data.base = 0;
        }
      } else if (sid === 'banner') data.upgrades.banner = !!final;
      else if (sid === 'premium') data.upgrades.premium = !!final;
      else if (sid === 'pin') { data.upgrades.pin = !!final; if (final) data.upgrades.premium = true; }
      else if (sid === 'confidential') data.upgrades.confidential = !!final;

      setJSON('checkoutData', data);
    }

    function nextStep() {
      if (idx >= steps.length - 1) { 
        setJSON('checkoutData', data); 
        window.location.href = '/checkout.html'; 
        return; 
      }
      idx++;
      pushStepToHistory(idx);  // ✅ Add history entry for this step
      renderStep();
    }

    $('#btnSkip').addEventListener('click', () => {
      // Force skip = NOT selected
      const ck = document.querySelector('#ck');
      if (ck) ck.checked = false;

      if (idx === steps.length - 1) {
        setJSON('checkoutData', data);
        window.location.href = '/checkout.html';
      } else {
        saveCurrent(false);
        nextStep();
      }
    });

    $('#btnAdd').addEventListener('click', () => {
      // Force add = selected
      const ck = document.querySelector('#ck');
      if (ck) ck.checked = true;

      saveCurrent(true);

      // If user just upgraded to Plus, reload at step 0 (Banner first)
      const sid = steps[idx];
      if (sid === 'upgrade') {
        // Use replace() to prevent Back button from returning to upgrade step
        window.location.replace('/upsell.html?step=0&fresh=1');
        return;
      }

      if (idx === steps.length - 1) window.location.href = '/checkout.html';
      else nextStep();
    });

    renderStep();
  </script>
</body>
</html>
