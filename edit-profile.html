<!DOCTYPE html>
<!-- Build: 2026-02-27 (Edit Profile for Local Pros, Brokers, Service Providers) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Profile | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-preview {
      width: auto;
      max-width: 100%;
      height: auto;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #1f2937;
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 2000;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success { background: #22c55e; }
    .toast.error { background: #dc2626; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="relative flex items-center justify-center max-w-7xl mx-auto px-4 py-4">
      <a href="/index.html" class="absolute left-4 text-xs font-semibold hover:underline" style="color:#4DA6FF;">Home</a>

      <div class="text-center">
        <div class="flex items-end justify-center gap-0">
          <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">GuaranteedCommission.com</h1>
        </div>
        <p class="text-sm text-red-600 font-semibold mt-1 whitespace-nowrap">
          Guaranteeing buyer's agent commissions so your home will sell quicker at a higher price.
        </p>
      </div>

      <div class="absolute right-4 flex items-center gap-4">
        <a href="/login.html" id="authLink" class="text-xs font-semibold hover:underline" style="color:#4DA6FF;">Log In</a>
      </div>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 py-6">

    <!-- Loading state -->
    <div id="loadingState" class="bg-white rounded-2xl shadow p-6 text-center">
      <p class="text-gray-500">Loading profile…</p>
    </div>

    <!-- Error state -->
    <div id="errorState" class="hidden bg-white rounded-2xl shadow p-6 text-center">
      <p class="text-red-600 font-semibold mb-2">Profile not found</p>
      <p class="text-sm text-gray-600 mb-4">The requested profile could not be loaded. It may have been deleted or you may not have access.</p>
      <a href="/welcome.html" class="inline-block px-4 py-2 rounded text-white text-sm font-medium" style="background:#4DA6FF;">Back to Dashboard</a>
    </div>

    <!-- Main edit form -->
    <section id="editSection" class="hidden bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-xl font-bold">Edit Profile</h2>
        <a href="/welcome.html" class="text-sm hover:underline" style="color:#4DA6FF;">← Back to Dashboard</a>
      </div>
      <p id="profileType" class="text-sm text-gray-600 mb-5"></p>

      <!-- Active ZIP Codes (read-only) -->
      <div class="mb-5 bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-semibold mb-1">Active ZIP Codes</h3>
        <div id="zipDisplay" class="flex flex-wrap gap-2 mb-2"></div>
        <p class="text-xs text-gray-500">To add or remove ZIP codes, please use the <strong>Manage Billing (Stripe)</strong> option on your dashboard.</p>
      </div>

      <form id="profileForm" class="space-y-4" autocomplete="off">

        <!-- Role (read-only display) -->
        <div id="roleRow">
          <label class="block text-sm font-semibold mb-1">Role</label>
          <input id="roleDisplay" class="w-full border rounded px-3 py-2 bg-gray-50 text-sm" readonly>
        </div>

        <!-- Personal Name -->
        <div>
          <label class="block text-sm font-semibold mb-1">Personal Name <span class="text-red-600">*</span></label>
          <input id="personalName" class="w-full border rounded px-3 py-2 text-sm" placeholder="Your name" required>
        </div>

        <!-- Company Name -->
        <div>
          <label class="block text-sm font-semibold mb-1">Company Name <span class="text-red-600">*</span></label>
          <input id="companyName" class="w-full border rounded px-3 py-2 text-sm" placeholder="Full company name" required>
        </div>

        <!-- Email (read-only) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Email</label>
          <input id="email" class="w-full border rounded px-3 py-2 bg-gray-50 text-sm" readonly>
          <p class="text-xs text-gray-500 mt-1">Email cannot be changed. Contact support if needed.</p>
        </div>

        <!-- Phone -->
        <div>
          <label class="block text-sm font-semibold mb-1">Phone <span class="text-red-600">*</span></label>
          <input id="phone" class="w-full border rounded px-3 py-2 text-sm" placeholder="123-456-7890" inputmode="numeric" required>
          <p class="text-xs text-gray-500 mt-1">Format: 123-456-7890</p>
        </div>

        <!-- License # -->
        <div>
          <label class="block text-sm font-semibold mb-1">License # <span class="text-red-600">*</span></label>
          <input id="license" class="w-full border rounded px-3 py-2 text-sm" placeholder="DRE # / NMLS # / License #" required>
          <p class="text-xs text-gray-500 mt-1">Required by state law for advertising.</p>
        </div>

        <!-- Business Card / Logo -->
        <div>
          <label class="block text-sm font-semibold mb-1">Business Card / Logo</label>
          <div id="currentPhoto" class="mb-3"></div>
          <input id="photoInput" type="file" accept=".png,.jpg,.jpeg,image/png,image/jpeg" class="w-full text-sm">
          <p class="text-xs text-gray-500 mt-1">PNG/JPG recommended. Leave blank to keep current image.</p>
          <div id="photoPreview" class="mt-2"></div>
        </div>

        <!-- Submit -->
        <div class="flex items-center gap-3 pt-2">
          <button
            id="saveBtn"
            type="submit"
            class="px-5 py-2 rounded bg-green-600 hover:bg-green-700 text-white text-sm font-semibold transition-colors"
          >
            Save Changes
          </button>
          <span id="saveStatus" class="text-sm text-gray-500"></span>
        </div>
      </form>
    </section>
  </main>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const $ = (id) => document.getElementById(id);

    // ========================================
    // TOAST
    // ========================================
    function showToast(message, type = 'success') {
      document.querySelectorAll('.toast').forEach(t => t.remove());
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ========================================
    // PHONE FORMATTER
    // ========================================
    function onlyDigits(s) { return String(s || '').replace(/\D/g, ''); }
    function formatPhone(s) {
      const d = onlyDigits(s).slice(0, 10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0, 3) + '-' + d.slice(3);
      return d.slice(0, 3) + '-' + d.slice(3, 6) + '-' + d.slice(6);
    }
    $('phone')?.addEventListener('input', (e) => { e.target.value = formatPhone(e.target.value); });

    // ========================================
    // PARSE URL PARAMS
    // ========================================
    const params = new URLSearchParams(window.location.search);
    const profileId = (params.get('id') || '').trim();
    const collectionName = (params.get('type') || '').trim();

    // Validate params
    const VALID_COLLECTIONS = ['localPros', 'localBrokers', 'localServiceProviders'];

    if (!profileId || !collectionName || !VALID_COLLECTIONS.includes(collectionName)) {
      $('loadingState').classList.add('hidden');
      $('errorState').classList.remove('hidden');
    }

    // Collection → friendly label
    const TYPE_LABELS = {
      'localPros': 'Local Professional',
      'localBrokers': 'Local Broker',
      'localServiceProviders': 'Service Provider'
    };

    // Role → friendly label
    const ROLE_LABELS = {
      'real_estate_agent': 'Real Estate Agent',
      'lender': 'Lender',
      'mortgage_broker': 'Mortgage Broker',
      'title_officer': 'Title Officer',
      'escrow_officer': 'Escrow Officer',
      'home_inspector': 'Home Inspector',
      'appraiser': 'Appraiser',
      'contractor': 'Contractor',
      'handyman': 'Handyman',
      'plumber': 'Plumber',
      'electrician': 'Electrician',
      'landscaper': 'Landscaper',
      'painter': 'Painter',
      'roofer': 'Roofer',
      'pest_control': 'Pest Control',
      'cleaner': 'House Cleaner',
      'mover': 'Mover',
      'stager': 'Home Stager',
      'photographer': 'Photographer'
    };

    // ========================================
    // PHOTO PREVIEW (new file selected)
    // ========================================
    $('photoInput')?.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) { $('photoPreview').innerHTML = ''; return; }
      const r = new FileReader();
      r.onload = () => {
        $('photoPreview').innerHTML = `<p class="text-xs text-green-600 mb-1 font-medium">New image selected:</p><img src="${r.result}" alt="New Business Card Preview" class="card-preview">`;
      };
      r.readAsDataURL(f);
    });

    // ========================================
    // LOAD PROFILE FROM FIRESTORE
    // ========================================
    async function loadProfile() {
      if (!profileId || !VALID_COLLECTIONS.includes(collectionName)) return;

      try {
        const snap = await getDoc(doc(db, collectionName, profileId));

        if (!snap.exists()) {
          $('loadingState').classList.add('hidden');
          $('errorState').classList.remove('hidden');
          return;
        }

        const d = snap.data() || {};

        // Set type label
        $('profileType').textContent = TYPE_LABELS[collectionName] || collectionName;

        // Fill form fields
        $('personalName').value = d.personalName || d.name || '';
        $('companyName').value = d.company || d.name || '';
        $('email').value = d.email || '';
        $('phone').value = formatPhone(d.phone || '');
        $('license').value = d.license || '';

        // Role display
        const roleRaw = d.role || '';
        if (roleRaw) {
          $('roleDisplay').value = ROLE_LABELS[roleRaw] || roleRaw;
        } else {
          $('roleRow').style.display = 'none';
        }

        // ZIP display (read-only chips)
        const zips = Array.isArray(d.zips) ? d.zips : (d.zip ? [d.zip] : []);
        const zipHost = $('zipDisplay');
        if (zips.length) {
          zipHost.innerHTML = zips.map(z =>
            `<span class="inline-block text-sm px-3 py-1 rounded-full bg-green-50 text-green-700 border border-green-200 font-medium">${z}</span>`
          ).join('');
        } else {
          zipHost.innerHTML = '<span class="text-sm text-gray-400">No ZIP codes found</span>';
        }

        // Current photo
        const photoUrl = d.photoUrl || d.photo || d.cardUrl || '';
        if (photoUrl) {
          $('currentPhoto').innerHTML = `
            <p class="text-xs text-gray-600 mb-1">Current image:</p>
            <img src="${photoUrl}" alt="Current Business Card" class="card-preview" onerror="this.parentElement.innerHTML='<p class=\\'text-xs text-gray-400\\'>Image could not be loaded</p>'">
          `;
        } else {
          $('currentPhoto').innerHTML = '<p class="text-xs text-gray-400">No image uploaded yet</p>';
        }

        // Show form, hide loading
        $('loadingState').classList.add('hidden');
        $('editSection').classList.remove('hidden');

      } catch (e) {
        console.error('[edit-profile] Load failed:', e);
        $('loadingState').classList.add('hidden');
        $('errorState').classList.remove('hidden');
      }
    }

    // ========================================
    // SAVE PROFILE
    // ========================================
    $('profileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = $('saveBtn');
      const statusEl = $('saveStatus');

      const personalName = ($('personalName').value || '').trim();
      const companyName = ($('companyName').value || '').trim();
      const phone = ($('phone').value || '').trim();
      const license = ($('license').value || '').trim();
      const phoneDigits = onlyDigits(phone);

      // Validate
      if (!personalName || !companyName) {
        showToast('Please fill in your name and company name.', 'error');
        return;
      }
      if (phoneDigits.length !== 10) {
        showToast('Please enter a valid 10-digit phone number.', 'error');
        $('phone').focus();
        return;
      }
      if (!license) {
        showToast('License # is required for advertising.', 'error');
        $('license').focus();
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Saving…';
      statusEl.textContent = '';

      try {
        // Build update payload
        const payload = {
          personalName: personalName,
          name: companyName,
          company: companyName,
          phone: phone,
          license: license,
          updatedAt: serverTimestamp()
        };

        // Upload new photo if selected
        const file = $('photoInput')?.files?.[0];
        if (file) {
          statusEl.textContent = 'Uploading image…';

          const storage = getStorage(undefined, STORAGE_BUCKET_GS);
          const safeName = String(file.name || 'card').replace(/[^\w\-.]+/g, '_');
          const storagePath = `${collectionName}/${profileId}/card_${Date.now()}_${safeName}`;
          const storageRef = ref(storage, storagePath);

          await uploadBytes(storageRef, file);
          const newUrl = await getDownloadURL(storageRef);
          payload.photoUrl = newUrl;

          console.log('[edit-profile] New photo uploaded:', storagePath);
        }

        // Update Firestore
        statusEl.textContent = 'Saving to database…';
        await updateDoc(doc(db, collectionName, profileId), payload);

        console.log('[edit-profile] Profile updated:', profileId);

        // Refresh the current photo display if new image was uploaded
        if (payload.photoUrl) {
          $('currentPhoto').innerHTML = `
            <p class="text-xs text-gray-600 mb-1">Current image:</p>
            <img src="${payload.photoUrl}" alt="Current Business Card" class="card-preview">
          `;
          $('photoPreview').innerHTML = '';
          $('photoInput').value = '';
        }

        showToast('Profile updated successfully!', 'success');
        statusEl.textContent = 'Saved ✓';
        setTimeout(() => { statusEl.textContent = ''; }, 3000);

      } catch (err) {
        console.error('[edit-profile] Save failed:', err);
        showToast('Failed to save. Please try again.', 'error');
        statusEl.textContent = '';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    });

    // ========================================
    // BOOT
    // ========================================
    loadProfile();
  </script>

  <!-- Global Nav Sync: smart login/logout/dashboard -->
  <script src="/scripts/global-nav.js"></script>
</body>
</html>
