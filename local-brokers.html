<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Brokers | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hint { font-size: 11px; color:#6b7280; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-white shadow">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm text-blue-600 hover:underline">Home</a>
      <h1 class="text-lg font-semibold">Local Brokers</h1>
      <a href="/login.html" class="text-sm text-blue-600 hover:underline">Log In</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-5">
      <h2 class="text-2xl font-bold text-center">Reserve Your Broker Ad</h2>
      <p class="text-sm text-center text-gray-700 mt-1">
        $100 per month per ZIP (1 broker per ZIP). Your brokerage ad displays on all listing detail pages in that ZIP in the "Local Real Estate Brokerage" section.
      </p>

      <!-- Top mode choice -->
      <div class="flex items-center justify-center gap-3 mt-4">
        <button id="modeSearchB" class="px-3 py-2 rounded border" style="background-color:#4DA6FF; color:white;">Search by ZIP</button>
      </div>

      <div id="status" class="hidden mt-4 text-sm rounded-lg p-3"></div>

      <form id="brokerForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" autocomplete="off">
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Brokerage Name</label>
          <input id="name" class="w-full border rounded px-3 py-2" placeholder="Your brokerage name" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Contact Name</label>
          <input id="contact" class="w-full border rounded px-3 py-2" placeholder="Primary contact" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Email</label>
          <input id="email" type="email" class="w-full border rounded px-3 py-2" placeholder="you@example.com" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Phone</label>
          <input id="phone" class="w-full border rounded px-3 py-2" placeholder="123-456-7890" inputmode="numeric" required>
          <p class="hint mt-1">Format: 123-456-7890</p>
        </div>

        <div>
          <label class="block text-sm font-semibold">Website (optional)</label>
          <input id="website" class="w-full border rounded px-3 py-2" placeholder="https://example.com">
        </div>

        <div>
          <label class="block text-sm font-semibold">ZIP Code</label>
          <input id="zip" class="w-full border rounded px-3 py-2 text-center" inputmode="numeric" maxlength="5" placeholder="e.g., 92660" required>
          <p class="hint mt-1">Enter a 5-digit ZIP. One broker per ZIP.</p>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Broker Ad (optional image)</label>
          <input id="photo" type="file" accept="image/*" class="w-full">
          <div id="photoPreview" class="mt-2"></div>
          <p class="hint mt-1">Recommended: horizontal image. JPG/PNG.</p>
        </div>

        <div class="md:col-span-2 flex items-center justify-between mt-2">
          <div class="text-sm text-gray-700">Your total: <span id="total">$100</span> / month</div>
          <button id="checkoutBtn" type="button" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">
            Proceed to Checkout
          </button>
        </div>

        <div class="md:col-span-2 text-xs text-gray-600 mt-1">
          All purchases subject to quality control review. Use "Search by ZIP" to check availability.
        </div>
      </form>

      <!-- Simple ZIP search area -->
      <div id="searchArea" class="hidden mt-8 border-t pt-5">
        <h3 class="font-semibold mb-2">Search Local Brokers by ZIP</h3>
        <div class="flex items-center gap-2">
          <input id="searchZip" class="border rounded px-3 py-2 w-40" placeholder="ZIP code">
          <button id="runZipSearch" class="px-3 py-2 rounded bg-gray-700 text-white">Search</button>
        </div>
        <div id="brokersResults" class="mt-4 grid grid-cols-1 gap-3"></div>
      </div>

    </section>

    <section id="thanks" class="hidden bg-emerald-50 rounded-2xl border border-emerald-200 p-5 mt-4 text-emerald-800">
      <h3 class="text-lg font-semibold">Thank you!</h3>
      <p class="text-sm mt-1">Your Local Broker subscription is being set up. Your ad will appear once activated.</p>
    </section>
  </main>

  <script type="module">
    // ✅ FIX #2: Import STORAGE_BUCKET_GS from single source of truth
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import {
      addDoc, collection, doc, updateDoc, serverTimestamp, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const $ = (id) => document.getElementById(id);
    function setStatus(msg, ok=true){
      const el = $('status'); el.classList.remove('hidden');
      el.className = ok ? 'mt-4 text-sm rounded-lg p-3 bg-green-50 text-green-700'
                        : 'mt-4 text-sm rounded-lg p-3 bg-red-50 text-red-700';
      el.textContent = msg;
    }
    function money(n){ return '$' + Number(n||0).toLocaleString(); }
    function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }
    function formatPhone(s){
      const d = onlyDigits(s).slice(0,10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0,3) + '-' + d.slice(3);
      return d.slice(0,3) + '-' + d.slice(3,6) + '-' + d.slice(6);
    }

    // Mode toggle via query or buttons
    (function(){
      const u = new URL(location.href);
      let mode = u.searchParams.get('mode') || 'apply';

      function show(mode){
        if (mode === 'search') {
          $('searchArea').classList.remove('hidden');
          $('brokerForm')?.classList.remove('hidden');
          $('searchZip').focus();
        }
      }

      show(mode);
      $('modeSearchB')?.addEventListener('click', ()=>{ location.href='?mode=search'; });
    })();

    // Price label (fixed $100/mo)
    (function(){ $('total').textContent = money(100); })();

    // Preview photo (guarded)
    const photoInput = $('photo');
    if (photoInput) {
      photoInput.addEventListener('change', (e) => {
        const f = e.target.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => { $('photoPreview').innerHTML = `<img src="${r.result}" alt="Ad" class="h-28 object-contain rounded border">`; };
        r.readAsDataURL(f);
      });
    }

    // If listing page passed a ZIP (convenience)
    (function(){
      const u = new URL(location.href);
      const z = (u.searchParams.get('zip') || '').trim().slice(0,5);
      if (/^\d{5}$/.test(z)) $('zip').value = z;
    })();

    // Stripe Checkout Link (test)
    const CHECKOUT_LINK_BASE_BROKER = "https://buy.stripe.com/test_28EaEZc8T4wO0on7zS4ow01";

    // ✅ FIX #2: Removed hardcoded BUCKET_URL - now using STORAGE_BUCKET_GS from firebase-init.js

    async function maybeUploadPhoto(draftId) {
      try {
        const file = $('photo')?.files?.[0];
        if (!file) return "";
        // ✅ FIX #2: Use STORAGE_BUCKET_GS from import
        const storage = getStorage(undefined, STORAGE_BUCKET_GS);
        const safe = String(file.name || "broker_ad").replace(/[^\w\-.]+/g,"_");
        const path = `localBrokers/${draftId}/ad_${Date.now()}_${safe}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        return url;
      } catch (e) {
        console.warn("[local-brokers] photo upload failed:", e);
        return "";
      }
    }

    $('checkoutBtn').addEventListener('click', async () => {
      try {
        $('checkoutBtn').disabled = true;
        $('checkoutBtn').textContent = 'Starting checkout…';

        const name = $('name').value.trim();
        const contact = $('contact').value.trim();
        const email = $('email').value.trim().toLowerCase();
        const phoneDigits = onlyDigits($('phone').value);
        const phone = formatPhone($('phone').value.trim());
        const website = $('website').value.trim();
        const zip = ($('zip').value || '').trim();
        
        if (!name || !contact || !email || !/^\d{5}$/.test(zip)) {
          setStatus('Please complete brokerage name, contact, email, and a 5-digit ZIP.', false);
          return;
        }
        
        if (!/^\S+@\S+\.\S{2,}$/.test(email)) {
          setStatus('Please enter a valid email address.', false);
          return;
        }
        
        if (phoneDigits.length !== 10) {
          setStatus('Please enter a valid 10-digit phone number.', false);
          return;
        }

        // Save draft first (pending)
        const draft = {
          name,
          contact,
          email,
          phone,
          website,
          zip,
          photoUrl: "",
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        const refDoc = await addDoc(collection(db, "localBrokers"), draft);
        localStorage.setItem("localBrokerDraftId", refDoc.id);

        // Optional: upload ad image, then patch the draft with photoUrl
        const photoUrl = await maybeUploadPhoto(refDoc.id);
        if (photoUrl) {
          await updateDoc(doc(db, "localBrokers", refDoc.id), { photoUrl, updatedAt: serverTimestamp() });
        }

        // Build params and redirect to Stripe
        const params = new URLSearchParams({
          prefilled_email: email,
          client_reference_id: JSON.stringify({ type: "broker", name, contact, email, phone, website, zip })
        });
        window.location.href = `${CHECKOUT_LINK_BASE_BROKER}?${params.toString()}`;
      } catch (e) {
        setStatus(e.message || "Checkout error.", false);
      } finally {
        $('checkoutBtn').disabled = false;
        $('checkoutBtn').textContent = 'Proceed to Checkout';
      }
    });

    // Finalize after Stripe returns
    (async function finalizeIfSuccess(){
      const u = new URL(location.href);
      if (u.searchParams.get('status') === 'success') {
        $('thanks').classList.remove('hidden');
        try {
          const id = localStorage.getItem("localBrokerDraftId");
          if (id) {
            await updateDoc(doc(db, "localBrokers", id), {
              status: "active",
              updatedAt: serverTimestamp()
            });
          }
        } catch (e) {
          console.warn("[local-brokers] finalize failed:", e);
        }
      }
    })();

    // Search by ZIP
    $('runZipSearch')?.addEventListener('click', async ()=>{
      const zip = $('searchZip').value.trim();
      if (!/^\d{5}$/.test(zip)) { setStatus('Enter a valid 5-digit ZIP to search.', false); return; }
      setStatus('Searching...', true);

      try {
        // Query Firestore for active brokers in this ZIP
        const q = query(
          collection(db, "localBrokers"),
          where("zip", "==", zip),
          where("status", "==", "active")
        );
        const snapshot = await getDocs(q);
        
        const brokers = [];
        snapshot.forEach(doc => {
          brokers.push({ id: doc.id, ...doc.data() });
        });

        const box = $('brokersResults'); 
        box.innerHTML='';
        $('status').classList.add('hidden');
        
        if (!brokers.length) {
          box.innerHTML = `<div class="text-sm text-gray-600">No Local Brokers reserved in ${zip} yet. This ZIP is available!</div>`;
          return;
        }
        
        brokers.forEach(b=>{
          const card = document.createElement('div');
          card.className = 'border rounded-lg p-3 bg-white';
          card.innerHTML = `
            <div class="text-sm font-semibold">${b.name || 'Brokerage'}</div>
            <div class="text-xs text-gray-600">${b.contact || ''}</div>
            <div class="text-xs text-gray-500 mt-1">ZIP: ${b.zip || ''}</div>
            ${b.website ? `<div class="text-xs text-blue-600 mt-1"><a href="${b.website}" target="_blank" class="hover:underline">${b.website}</a></div>` : ''}
          `;
          box.appendChild(card);
        });
      } catch (err) {
        console.error('Search error:', err);
        setStatus('Search failed. Please try again.', false);
      }
    });
  </script>
</body>
</html>
