<!DOCTYPE html>
<!-- Build: 2026-01-30 (Bulk ZIP subscription checkout - Local Brokers | License REQUIRED | Green Pay Button | Instant Activation) -->
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Brokers | GuaranteedCommission.com</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hint { font-size: 11px; color:#6b7280; }
    .chip { font-size: 12px; padding: 4px 8px; border-radius: 9999px; background:#f3f4f6; color:#374151; }
    .chip-bad { background:#fee2e2; color:#991b1b; }
    .chip-good { background:#dcfce7; color:#166534; }
    /* Full ad preview - shows complete rectangle */
    .card-preview { width: auto; max-width: 100%; height: auto; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header (matches home page) -->
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="/index.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Home</a>

        <div class="text-center">
          <div class="flex items-end justify-center gap-0">
            <img src="/Logo.png" alt="GuaranteedCommission Logo" class="h-10 w-10 object-contain -mr-1 -mb-1">
            <h1 class="text-3xl font-bold">GuaranteedCommission.com</h1>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/advertise.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Advertise</a>
          <a href="/login.html" class="text-sm font-medium hover:underline" style="color:#4DA6FF;">Log In</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-2xl font-bold text-center">Reserve Your Broker Ad</h2>
      <p class="text-sm text-center text-gray-700 mt-1">
        <strong>$100 per month per ZIP</strong> (1 broker per ZIP). Your brokerage ad displays on all listing detail pages in those ZIP codes.
      </p>

      <div id="status" class="hidden mt-4 text-sm rounded-lg p-3"></div>

      <form id="brokerForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4" autocomplete="off">
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Brokerage Name <span class="text-red-600">*</span></label>
          <input id="name" class="w-full border rounded px-3 py-2" placeholder="Your brokerage name" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Contact Name <span class="text-red-600">*</span></label>
          <input id="contact" class="w-full border rounded px-3 py-2" placeholder="Primary contact" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Email <span class="text-red-600">*</span></label>
          <input id="email" type="email" class="w-full border rounded px-3 py-2" placeholder="you@example.com" required>
        </div>

        <div>
          <label class="block text-sm font-semibold">Phone <span class="text-red-600">*</span></label>
          <input id="phone" class="w-full border rounded px-3 py-2" placeholder="123-456-7890" inputmode="numeric" required>
          <p class="hint mt-1">Format: 123-456-7890</p>
        </div>

        <!-- ✅ REQUIRED LICENSE -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">License # / DRE # <span class="text-red-600">*</span></label>
          <input id="license" class="w-full border rounded px-3 py-2" placeholder="Enter your Brokerage License # / DRE #" required>
          <p class="hint mt-1">Required by state law for advertising.</p>
        </div>

        <div>
          <label class="block text-sm font-semibold">Website (optional)</label>
          <input id="website" class="w-full border rounded px-3 py-2" placeholder="https://example.com">
        </div>

        <!-- ✅ BULK ZIP INPUT -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">ZIP Codes (up to 99) <span class="text-red-600">*</span></label>
          <input id="zipBulk" class="w-full border rounded px-3 py-2"
                 placeholder="Enter ZIPs separated by commas or spaces (e.g., 92651, 92657, 92660)" required>
          <p class="hint mt-1">We will validate and de-duplicate ZIPs. Example: "92651 92657 92660".</p>
          <div class="mt-2 flex flex-wrap gap-2" id="zipChips"></div>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold">Broker Ad (optional image)</label>
          <input id="photo" type="file" accept="image/*" class="w-full">
          <div id="photoPreview" class="mt-2"></div>
          <p class="hint mt-1">Recommended: horizontal image. JPG/PNG.</p>
        </div>

        <!-- ✅ REAL-TIME TOTAL + GREEN PAY BUTTON -->
        <div class="md:col-span-2 flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-2">
          <div class="text-sm text-gray-700">
            Monthly total: <span id="total" class="font-semibold">$0/month</span>
            <span id="countNote" class="text-gray-500"></span>
          </div>

          <button id="checkoutBtn" type="button"
                  class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-semibold">
            Proceed to Checkout
          </button>
        </div>

        <div class="md:col-span-2 text-xs text-gray-600 mt-1">
          All purchases subject to quality control review. (UI only on ZIP exclusivity enforcement for now.)
        </div>
      </form>

      <section id="thanks" class="hidden bg-emerald-50 rounded-2xl border border-emerald-200 p-5 mt-6 text-emerald-800">
        <h3 class="text-lg font-semibold">Thank you!</h3>
        <p class="text-sm mt-1">Your Local Broker subscription checkout completed successfully.</p>
      </section>
    </section>
  </main>

  <script type="module" src="/scripts/firebase-init.js"></script>

  <script type="module">
    import { db, STORAGE_BUCKET_GS } from "/scripts/firebase-init.js";
    import { addDoc, collection, doc, updateDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const PRICE_ID_LOCAL_BROKER = "price_1SQXmVPTiT2zuxx0bIP98lVs"; // $100/mo per ZIP
    const PRICE_PER_ZIP = 100;
    const MAX_ZIPS = 99;
    const MAX_BROKERS_PER_ZIP = 1; // Exclusive - only 1 broker per ZIP

    const $ = (id) => document.getElementById(id);

    // Waitlist state
    let isWaitlistMode = false;
    let soldOutZips = [];

    function setStatus(msg, ok=true){
      const el = $('status'); el.classList.remove('hidden');
      el.className = ok ? 'mt-4 text-sm rounded-lg p-3 bg-green-50 text-green-700'
                        : 'mt-4 text-sm rounded-lg p-3 bg-red-50 text-red-700';
      el.textContent = msg;
    }

    // Check ZIP availability (1 broker per ZIP - exclusive)
    async function checkZipAvailability(zips) {
      const soldOut = [];
      
      for (const zip of zips) {
        if (!zip) continue;
        try {
          const q = query(
            collection(db, "localBrokers"),
            where("status", "==", "active"),
            where("zips", "array-contains", zip)
          );
          const snap = await getDocs(q);
          if (snap.size >= MAX_BROKERS_PER_ZIP) {
            soldOut.push(zip);
          }
        } catch (e) {
          console.warn("[checkZip] error for", zip, e);
        }
      }
      return soldOut;
    }

    // Update button state based on availability
    function updateButtonState(soldOut, zipCodes) {
      const btn = $('checkoutBtn');
      soldOutZips = soldOut;
      
      if (soldOut.length > 0 && zipCodes.length > 0) {
        // Some ZIPs are sold out - switch to waitlist mode
        isWaitlistMode = true;
        btn.textContent = 'Join Waitlist';
        btn.className = 'px-4 py-2 rounded text-white font-semibold';
        btn.style.backgroundColor = '#4DA6FF';
        $('total').textContent = '$0 due today';
        $('countNote').textContent = ' (Waitlist)';
        
        // Show which ZIPs are sold out
        setStatus(`ZIP ${soldOut.join(', ')} already has a broker (1 per ZIP limit). You can join the waitlist to be notified when the spot opens.`, true);
      } else {
        // All ZIPs available - normal checkout mode
        isWaitlistMode = false;
        btn.textContent = 'Proceed to Checkout';
        btn.className = 'px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-semibold';
        btn.style.backgroundColor = '';
        $('status').classList.add('hidden');
      }
    }

    // Debounced availability check
    let checkTimeout = null;
    async function debouncedAvailabilityCheck() {
      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(async () => {
        const { zipCodes } = updateTotal(false); // Don't re-trigger check
        
        if (zipCodes.length > 0) {
          const soldOut = await checkZipAvailability(zipCodes);
          updateButtonState(soldOut, zipCodes);
        } else {
          updateButtonState([], zipCodes);
        }
      }, 500);
    }

    function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }
    function formatPhone(s){
      const d = onlyDigits(s).slice(0,10);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0,3) + '-' + d.slice(3);
      return d.slice(0,3) + '-' + d.slice(3,6) + '-' + d.slice(6);
    }

    function parseZipList(raw) {
      const parts = String(raw || "")
        .replace(/[\n\r]/g, " ")
        .split(/[, ]+/)
        .map(s => s.trim())
        .filter(Boolean);

      const seen = new Set();
      const good = [];
      const bad = [];

      for (const p of parts) {
        const z = p.replace(/\D/g,'').slice(0,5);
        if (!/^\d{5}$/.test(z)) { bad.push(p); continue; }
        if (seen.has(z)) continue;
        seen.add(z);
        good.push(z);
      }
      return { good, bad };
    }

    function fmtMoney(n){ return '$' + Number(n||0).toLocaleString(); }

    function renderZipChips(good, bad) {
      const host = $('zipChips');
      host.innerHTML = '';
      good.forEach(z => {
        const d = document.createElement('span');
        d.className = 'chip chip-good';
        d.textContent = z;
        host.appendChild(d);
      });
      bad.forEach(x => {
        const d = document.createElement('span');
        d.className = 'chip chip-bad';
        d.textContent = `Invalid: ${x}`;
        host.appendChild(d);
      });
    }

    function updateTotal(triggerCheck = true) {
      const raw = $('zipBulk').value;
      const { good, bad } = parseZipList(raw);

      if (good.length > MAX_ZIPS) {
        const extra = good.slice(MAX_ZIPS);
        good.length = MAX_ZIPS;
        extra.forEach(x => bad.push(x));
      }

      renderZipChips(good, bad);

      // Only update total if not in waitlist mode (will be overridden by availability check)
      if (!isWaitlistMode) {
        const total = good.length * PRICE_PER_ZIP;
        $('total').textContent = `${fmtMoney(total)}/month`;
        $('countNote').textContent = good.length ? ` (${good.length} ZIP${good.length===1?'':'s'})` : '';
      }
      
      // Trigger availability check
      if (triggerCheck) {
        debouncedAvailabilityCheck();
      }
      
      return { zipCodes: good, invalid: bad };
    }

    $('phone')?.addEventListener('input', (e) => { e.target.value = formatPhone(e.target.value); });
    $('zipBulk')?.addEventListener('input', () => updateTotal(true));
    updateTotal(false);

    // ========== DRAFT RESTORATION (Auth Gate Support) ==========
    // If user was redirected to login and came back, restore their form data
    (function restoreDraft() {
      try {
        const draftJson = localStorage.getItem('localBrokerFormDraft');
        if (!draftJson) return;
        
        const draft = JSON.parse(draftJson);
        console.log('[local-brokers] Restoring form draft:', draft);
        
        // Restore form fields
        if (draft.name && $('name')) $('name').value = draft.name;
        if (draft.contact && $('contact')) $('contact').value = draft.contact;
        if (draft.email && $('email')) $('email').value = draft.email;
        if (draft.phone && $('phone')) $('phone').value = formatPhone(draft.phone);
        if (draft.license && $('license')) $('license').value = draft.license;
        if (draft.website && $('website')) $('website').value = draft.website;
        if (draft.zipBulk && $('zipBulk')) $('zipBulk').value = draft.zipBulk;
        
        // Trigger total/chips update and availability check
        updateTotal(true);
        
        // Show status message
        setStatus('Welcome back! Your form has been restored. Please click "Proceed to Checkout" to continue.', true);
        
        // Clear the draft (one-time restore)
        localStorage.removeItem('localBrokerFormDraft');
        
        // Clear the return path if we're back
        if (localStorage.getItem('nextAfterLogin') === window.location.href) {
          localStorage.removeItem('nextAfterLogin');
        }
      } catch (e) {
        console.warn('[local-brokers] Draft restore failed:', e);
        localStorage.removeItem('localBrokerFormDraft');
      }
    })();

    // Helper to check if user is logged in
    function isLoggedIn() {
      const email = (localStorage.getItem('loggedInEmail') || '').trim();
      return email.length > 0;
    }

    // Helper to save form draft for auth gate
    function saveFormDraft() {
      const draft = {
        name: $('name')?.value || '',
        contact: $('contact')?.value || '',
        email: $('email')?.value || '',
        phone: $('phone')?.value || '',
        license: $('license')?.value || '',
        website: $('website')?.value || '',
        zipBulk: $('zipBulk')?.value || '',
        savedAt: Date.now()
      };
      localStorage.setItem('localBrokerFormDraft', JSON.stringify(draft));
      console.log('[local-brokers] Form draft saved for auth gate');
    }

    // Fix 1: Full ad preview (not cropped square)
    $('photo')?.addEventListener('change', (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => { $('photoPreview').innerHTML = `<img src="${r.result}" alt="Broker Ad Preview" class="card-preview">`; };
      r.readAsDataURL(f);
    });

    async function maybeUploadPhoto(draftId) {
      try {
        const file = $('photo')?.files?.[0];
        if (!file) return "";
        const storage = getStorage(undefined, STORAGE_BUCKET_GS);
        const safe = String(file.name || "broker_ad").replace(/[^\w\-.]+/g,"_");
        const path = `localBrokers/${draftId}/ad_${Date.now()}_${safe}`;
        const r = ref(storage, path);
        await uploadBytes(r, file);
        return await getDownloadURL(r);
      } catch (e) {
        console.warn("[local-brokers] photo upload failed:", e);
        return "";
      }
    }

    function loggedInEmail() {
      return (localStorage.getItem('loggedInEmail') || localStorage.getItem('verifyTarget') || '').trim();
    }

    // Fix 3 & 4: Success handling with fallback activation
    (async function(){
      const u = new URL(location.href);
      if (u.searchParams.get('status') === 'success') {
        $('thanks')?.classList.remove('hidden');
        
        // Fallback activation: If pendingBrokerId exists, activate immediately
        const pendingId = localStorage.getItem("pendingBrokerId");
        if (pendingId) {
          try {
            await updateDoc(doc(db, "localBrokers", pendingId), {
              status: "active",
              activatedAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            console.log("[local-brokers] Fallback activation successful:", pendingId);
            
            // Clean up localStorage
            localStorage.removeItem("pendingBrokerId");
            localStorage.removeItem("pendingBrokerEmail");
            localStorage.removeItem("localBrokerDraftId");
            
            // Update success message
            const thanksEl = $('thanks');
            if (thanksEl) {
              thanksEl.innerHTML = `
                <h3 class="text-lg font-semibold">Thank you!</h3>
                <p class="text-sm mt-1">Your Local Broker subscription checkout completed successfully. Your brokerage advertisement is now live in the requested ZIP code.</p>
              `;
            }
          } catch (e) {
            console.warn("[local-brokers] Fallback activation failed:", e);
          }
        }
      }
    })();

    $('checkoutBtn')?.addEventListener('click', async () => {
      const btn = $('checkoutBtn');
      try {
        btn.disabled = true;
        btn.textContent = isWaitlistMode ? 'Joining waitlist…' : 'Starting checkout…';

        const name = $('name').value.trim();
        const contact = $('contact').value.trim();
        const email = $('email').value.trim().toLowerCase();
        const phoneDigits = onlyDigits($('phone').value);
        const phone = formatPhone($('phone').value.trim());
        const license = $('license').value.trim();
        const website = $('website').value.trim();
        const { zipCodes } = updateTotal(false);

        // ========== STEP 1: VALIDATION ==========
        if (!name || !contact || !email) { setStatus('Please complete brokerage name, contact, and email.', false); return; }
        if (!/^\S+@\S+\.\S{2,}$/.test(email)) { setStatus('Please enter a valid email address.', false); return; }
        if (phoneDigits.length !== 10) { setStatus('Please enter a valid 10-digit phone number.', false); return; }
        if (!license) { setStatus('License # / DRE # is required for advertising.', false); return; }
        if (!zipCodes.length) { setStatus('Please enter at least one valid 5-digit ZIP code.', false); return; }
        if (zipCodes.length > MAX_ZIPS) { setStatus(`Maximum ${MAX_ZIPS} ZIP codes per checkout.`, false); return; }

        // ========== STEP 2: AUTH GATE ==========
        // User must be logged in before proceeding to payment or waitlist
        if (!isLoggedIn()) {
          setStatus('Please log in or create an account to continue. Redirecting...', true);
          
          // Save form data for restoration after login
          saveFormDraft();
          
          // Set return path so login redirects back here
          localStorage.setItem('nextAfterLogin', window.location.href);
          
          // Redirect to login page
          setTimeout(() => {
            window.location.href = '/login.html?tab=create';
          }, 1000);
          
          return;
        }

        // ========== STEP 3: WAITLIST MODE ==========
        if (isWaitlistMode) {
          const waitlistData = {
            role: 'local_broker', // Required for waitlist processing
            name,
            contact,
            email,
            emailLower: email.toLowerCase(),
            phone,
            license,
            website,
            waitlistZips: soldOutZips,
            allRequestedZips: zipCodes,
            status: "waiting",
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          // Upload photo if provided
          const photoFile = $('photo')?.files?.[0];
          if (photoFile) {
            try {
              const storage = getStorage(undefined, STORAGE_BUCKET_GS);
              const safe = String(photoFile.name || "waitlist_broker_ad").replace(/[^\w\-.]+/g,"_");
              const path = `waitlist_localBrokers/${email.replace(/[^a-z0-9]/g,'_')}/ad_${Date.now()}_${safe}`;
              const r = ref(storage, path);
              await uploadBytes(r, photoFile);
              waitlistData.photoUrl = await getDownloadURL(r);
            } catch (e) {
              console.warn("[waitlist] photo upload failed:", e);
            }
          }

          await addDoc(collection(db, "waitlist_localBrokers"), waitlistData);
          console.log("[local-brokers] Added to waitlist");

          // Show success message
          const thanksEl = $('thanks');
          if (thanksEl) {
            thanksEl.innerHTML = `
              <h3 class="text-lg font-semibold">You're on the Waitlist!</h3>
              <p class="text-sm mt-1">ZIP ${soldOutZips.join(', ')} already has a broker (1 per ZIP limit). You have been added to the priority waitlist. We will notify you at <strong>${email}</strong> when the spot opens.</p>
            `;
            thanksEl.classList.remove('hidden');
          }
          $('status').classList.add('hidden');
          $('brokerForm').classList.add('hidden');
          return;
        }

        // ========== STEP 4: NORMAL CHECKOUT MODE ==========
        const draft = {
          name, contact, email, phone, license, website,
          zips: zipCodes,
          photoUrl: "",
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const refDoc = await addDoc(collection(db, "localBrokers"), draft);
        
        // Store for activation on checkout-success.html
        localStorage.setItem("pendingBrokerId", refDoc.id);
        localStorage.setItem("pendingBrokerEmail", email);
        localStorage.setItem("localBrokerDraftId", refDoc.id); // Legacy key

        const photoUrl = await maybeUploadPhoto(refDoc.id);
        if (photoUrl) {
          await updateDoc(doc(db, "localBrokers", refDoc.id), { photoUrl, updatedAt: serverTimestamp() });
        }

        const payload = {
          roleType: "local_broker",
          zipCodes: zipCodes,
          priceId: PRICE_ID_LOCAL_BROKER,
          successUrl: window.location.origin + "/local-brokers.html?status=success",
          cancelUrl:  window.location.origin + "/local-brokers.html?status=cancel",
          metadata: {
            email: loggedInEmail() || email,
            name: name,
            contact: contact,
            license: license,
            draftId: refDoc.id
          }
        };

        const resp = await fetch("/api/create-subscription-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const ct = resp.headers.get("content-type") || "";
        const out = ct.includes("application/json") ? await resp.json() : { error: "Non-JSON server response" };
        if (!resp.ok) throw new Error(out.error || out.message || "Subscription session failed.");
        if (out.url) { window.location.href = out.url; return; }
        throw new Error("Server did not return checkout url.");
      } catch (e) {
        console.error(e);
        setStatus(e.message || "Checkout error.", false);
      } finally {
        btn.disabled = false;
        btn.textContent = isWaitlistMode ? "Join Waitlist" : "Proceed to Checkout";
      }
    });
  </script>
</body>
</html>
